<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ­ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <!-- tmi.js Ù„ØªÙˆÙŠØªØ´ -->
  <script src="tmi.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tmi.js@1.8.5/dist/tmi.min.js"></script>
  <style>
    :root{
      /* Ø£Ù„ÙˆØ§Ù† 2026 Ø§Ù„Ø¨Ø±ÙŠÙ…ÙŠÙˆÙ… */
      --bg:#15171d;
      --bg-soft:#1b1e26;
      --panel:rgba(26,29,38,0.96);
      --panel-soft:rgba(24,27,36,0.9);
      --card:#20232e;
      --line:#2f3440;
      --line-soft:#3a4050;

      /* Ø£Ù„ÙˆØ§Ù† Ù…ÙŠØ¯Ùˆ Ø§Ù„Ø¨Ø±ÙŠÙ…ÙŠÙˆÙ… */
      --accent:#ff3b3b;      /* Ø£Ø­Ù…Ø± DV ÙØ®Ù… */
      --accent-soft:#ff5555;
      --green:#22c58b;       /* Ø²Ù…Ø±Ø¯ÙŠ */
      --green-soft:#26d39a;
      --blue:#3a8fff;        /* Ø£Ø²Ø±Ù‚ ØªÙ‚Ù†ÙŠ Ù†Ø§Ø¹Ù… */
      --blue-soft:#5aa4ff;
      --yellow:#f1c75c;      /* Ø°Ù‡Ø¨ÙŠ Ù‡Ø§Ø¯ÙŠ */
      --text:#f2f4fb;
      --muted:#a3afc7;
      --muted-soft:#8d98b0;
      --danger:#ff6262;

      --radius-lg:16px;
      --radius-md:12px;
      --radius-sm:10px;
      --shadow-soft:0 14px 40px rgba(0,0,0,0.45);
      --shadow-subtle:0 8px 22px rgba(0,0,0,0.35);
      --border-1:1px solid var(--line);
    }

    *{
      box-sizing:border-box;
      -webkit-tap-highlight-color:transparent;
    }

    body{
      margin:0;
      min-height:100vh;
      color:var(--text);
      font-family:'Cairo',system-ui;
      display:flex;
      flex-direction:column;
      background:
        radial-gradient(circle at top left,#303646 0,#15171d 42%,#101218 82%);
      position:relative;
      overflow-x:hidden;
    }

    /* Ø·Ø¨Ù‚Ø© Ø®ÙÙŠÙØ© ÙÙˆÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ© */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:
        radial-gradient(circle at top right,rgba(255,59,59,0.07),transparent 55%),
        radial-gradient(circle at bottom left,rgba(58,143,255,0.06),transparent 60%);
      pointer-events:none;
      z-index:-1;
    }

    header{
      padding:14px 24px;
      border-bottom:1px solid rgba(53,59,75,0.8);
      background:linear-gradient(180deg,rgba(18,19,25,0.96),rgba(16,18,24,0.96));
      backdrop-filter: blur(14px);
      position:sticky;
      top:0;
      z-index:30;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      box-shadow:0 10px 32px rgba(0,0,0,0.65);
    }

    header .title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.4px;
      font-size:18px;
    }

    header .dot{
      width:11px;
      height:11px;
      border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 0 0 rgba(255,59,59,0.7);
      animation:dotPulse 2.3s ease-out infinite;
    }
    @keyframes dotPulse{
      0%{box-shadow:0 0 0 0 rgba(255,59,59,0.7);}
      70%{box-shadow:0 0 0 9px rgba(255,59,59,0);}
      100%{box-shadow:0 0 0 0 rgba(255,59,59,0);}
    }

    header .right{
      display:flex;
      gap:10px;
      color:var(--muted);
      font-size:14px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    header .status-pill{
      padding:6px 11px;
      border-radius:999px;
      border:1px solid rgba(66,72,89,0.9);
      background:linear-gradient(180deg,#181b24,#141720);
      color:var(--muted-soft);
      display:flex;
      align-items:center;
      gap:6px;
      font-size:13px;
      box-shadow:0 4px 14px rgba(0,0,0,0.5);
    }

    header .status-pill b{
      color:var(--accent-soft);
    }

    /* Ø¨Ø§Ø¯Ø¬Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ */
    .conn-badges{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .conn{
      display:flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      border:1px solid rgba(63,70,86,0.95);
      background:linear-gradient(180deg,#171a23,#141720);
      padding:6px 11px;
      font-size:13px;
      color:var(--muted);
      box-shadow:0 6px 16px rgba(0,0,0,0.6);
    }
    .conn span:last-child{
      opacity:.9;
    }
    .conn .led{
      width:9px;
      height:9px;
      border-radius:999px;
      background:#555;
      box-shadow:0 0 0 0 rgba(255,255,255,0);
    }
    .conn.ok .led{
      background:var(--green);
      animation:breath 2.2s ease-in-out infinite;
    }
    .conn.wait .led{
      background:var(--yellow);
      animation:pulse 1.4s ease-in-out infinite;
    }
    .conn.err .led{
      background:var(--danger);
      box-shadow:0 0 10px rgba(255,98,98,0.6);
    }
    @keyframes breath{
      0%,100%{box-shadow:0 0 0 0 rgba(34,197,139,.7);}
      50%{box-shadow:0 0 12px 4px rgba(34,197,139,.24);}
    }
    @keyframes pulse{
      0%,100%{opacity:.55;}
      50%{opacity:1;}
    }

    /* Ù…Ø±ÙƒØ² Ø§Ù„ØµÙØ­Ø© */
    .wrap{
      flex:1;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:18px 18px 26px;
    }
    .container{
      width:min(1200px,96vw);
      margin:0 auto;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:18px;
    }
    @media (max-width:980px){
      .container{grid-template-columns:1fr;}
    }

    /* Ø´Ø±ÙŠØ· ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­ÙŠÙ† */
    .login-inline{
      grid-column:1/-1;
      width:100%;
      margin:0 auto;
      background:linear-gradient(135deg,rgba(30,33,43,.96),rgba(22,25,34,.96));
      border-radius:var(--radius-lg);
      padding:12px 12px 10px;
      display:grid;
      gap:8px;
      grid-template-columns:130px 1fr 160px 1fr 160px;
      position:relative;
      border:1px solid rgba(66,73,92,0.95);
      box-shadow:var(--shadow-soft);
      overflow:hidden;
    }

    .login-inline::before{
      content:"";
      position:absolute;
      inset:-20%;
      background:
        radial-gradient(circle at 0% 0%,rgba(255,59,59,0.09),transparent 55%),
        radial-gradient(circle at 100% 100%,rgba(58,143,255,0.08),transparent 55%);
      opacity:.95;
      pointer-events:none;
    }

    .login-inline > *{
      position:relative;
      z-index:1;
    }

    .login-inline .lbl{
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:var(--radius-md);
      font-size:13px;
      padding:8px 6px;
      color:var(--muted-soft);
      border:1px solid rgba(75,82,104,0.9);
      background:radial-gradient(circle at top,#202430,#181b24);
      box-shadow:0 6px 18px rgba(0,0,0,0.5) inset;
    }

    .login-inline input,
    .login-inline select{
      background:radial-gradient(circle at top,#191c25,#13151d);
      border:1px solid rgba(69,76,98,0.95);
      color:var(--text);
      padding:8px 10px;
      border-radius:var(--radius-md);
      outline:none;
      width:100%;
      font-size:13px;
      box-shadow:0 6px 18px rgba(0,0,0,0.5) inset;
    }
    .login-inline input::placeholder{
      color:rgba(158,170,196,0.7);
    }
    .login-inline .status{
      grid-column:1/-1;
      font-size:13px;
      color:#b5f5d8;
      padding-top:2px;
    }

    @media (max-width:980px){
      .login-inline{
        grid-template-columns:1fr 1fr;
      }
      .login-inline .lbl{
        display:none;
      }
    }

    /* Ø¨Ø§Ù†Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ */
    .turn-banner{
      grid-column:1/-1;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background:linear-gradient(120deg,rgba(30,34,45,.98),rgba(26,29,40,.96));
      border-radius:var(--radius-lg);
      padding:12px 14px;
      position:relative;
      overflow:hidden;
      border:1px solid rgba(74,82,103,0.9);
      box-shadow:var(--shadow-subtle);
    }

    .turn-banner::before{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(120deg,rgba(255,59,59,0.12),rgba(58,143,255,0.04));
      mix-blend-mode:soft-light;
      opacity:.7;
      pointer-events:none;
    }

    .turn-banner .left{
      display:flex;
      align-items:center;
      gap:12px;
      position:relative;
      z-index:1;
    }

    .turn-badge{
      font-size:12px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(82,90,116,0.95);
      background:radial-gradient(circle at top,#202633,#171a23);
      color:#d7e1ff;
      letter-spacing:.2px;
    }

    .turn-name{
      font-weight:900;
      font-size:22px;
      letter-spacing:.3px;
      text-shadow:0 0 14px rgba(0,0,0,0.7);
    }

    .turn-banner .right{
      position:relative;
      z-index:1;
      font-size:12px;
      color:var(--muted-soft);
    }
    .turn-hint{
      font-size:12px;
      color:var(--muted-soft);
    }

    /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ù…Ø© */
    .btn{
      cursor:pointer;
      user-select:none;
      border-radius:var(--radius-md);
      border:1px solid rgba(74,82,103,0.95);
      padding:8px 12px;
      background:linear-gradient(180deg,#222634,#181b26);
      color:var(--text);
      font-weight:700;
      font-size:13px;
      transition:transform .12s ease,box-shadow .12s ease,background .12s ease,border-color .12s ease,opacity .12s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 8px 20px rgba(0,0,0,0.65);
    }
    .btn:active{
      transform:translateY(0);
      box-shadow:0 4px 10px rgba(0,0,0,0.7);
      opacity:.9;
    }

    .btn.success{
      background:linear-gradient(180deg,#1b3a30,#12241e);
      border-color:rgba(47,133,95,0.95);
      color:#c5f7e5;
    }
    .btn.success:hover{
      box-shadow:0 9px 22px rgba(15,118,84,0.65);
    }

    .btn.warn{
      background:linear-gradient(180deg,#3b331c,#201a11);
      border-color:rgba(149,116,50,0.95);
      color:#ffeab9;
    }

    .btn.accent{
      background:linear-gradient(180deg,#412024,#261114);
      border-color:rgba(200,76,89,0.95);
      color:#ffe0e0;
    }

    /* Ø§Ù„Ø£Ù„ÙˆØ§Ø­ Ø§Ù„ÙˆØ³Ø·ÙŠØ© */
    .panel{
      background:var(--panel-soft);
      border-radius:var(--radius-lg);
      padding:14px 14px 12px;
      box-shadow:var(--shadow-soft);
      position:relative;
      overflow:hidden;
      border:1px solid rgba(67,74,92,0.95);
    }

    .panel::before{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(135deg,rgba(255,255,255,0.009),rgba(255,255,255,0));
      pointer-events:none;
    }

    .panel-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
      font-weight:700;
      color:var(--muted);
      position:relative;
      z-index:1;
    }

    .title-left{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:14px;
    }

    .title-left span:first-child{
      font-weight:800;
      color:#e4e8f7;
    }

    .count-chip{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(83,92,116,0.95);
      background:radial-gradient(circle at top,#222736,#181b24);
      color:#d2ddff;
    }

    /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
    .grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(160px,1fr));
      gap:10px;
      position:relative;
      z-index:1;
    }
    @media (max-width:900px){
      .grid{grid-template-columns:repeat(2,minmax(140px,1fr));}
    }
    @media (max-width:620px){
      .grid{grid-template-columns:repeat(1,minmax(220px,1fr));}
    }

    .card{
      user-select:none;
      cursor:pointer;
      border-radius:14px;
      padding:16px 14px;
      min-height:74px;
      background:radial-gradient(circle at top,#262a38,#191c26);
      border:1px solid rgba(71,79,102,0.95);
      text-align:center;
      position:relative;
      box-shadow:0 10px 24px rgba(0,0,0,0.72);
      transition:transform .12s ease,box-shadow .12s ease,border-color .12s ease,background .12s ease,opacity .12s ease;
    }

    .card:hover{
      transform:translateY(-2px);
      box-shadow:0 14px 30px rgba(0,0,0,0.8);
    }

    .card .badge{
      position:absolute;
      top:8px;
      inset-inline-start:8px;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      color:#d7e2ff;
      background:rgba(17,20,29,0.96);
      border:1px solid rgba(86,95,122,0.95);
      letter-spacing:.1px;
    }

    .card .text{
      font-weight:800;
      font-size:20px;
      letter-spacing:.3px;
      text-shadow:0 0 12px rgba(0,0,0,0.8);
    }

    .card.selected{
      outline:2px solid var(--blue-soft);
      box-shadow:0 0 0 1px rgba(90,164,255,0.55),0 14px 32px rgba(26,115,232,0.55);
      border-color:rgba(110,171,255,0.95);
      background:radial-gradient(circle at top,#28344a,#1a2130);
    }

    .card.revealed{
      background:radial-gradient(circle at top,#1f3a30,#13231c);
      border-color:rgba(49,140,101,0.95);
      box-shadow:0 14px 36px rgba(16,120,84,0.7);
    }

    .card.revealed .badge{
      background:rgba(13,40,29,0.98);
      border-color:rgba(79,168,121,0.95);
      color:#c3f3de;
    }

    .card.wrong{
      animation:shake .32s;
      box-shadow:0 0 0 2px rgba(255,98,98,.7) inset,0 0 20px rgba(255,98,98,0.6);
      border-color:rgba(255,122,122,0.95);
      background:radial-gradient(circle at top,#3a2024,#241014);
    }

    @keyframes shake{
      10%,90%{transform:translateX(-1px);}
      20%,80%{transform:translateX(2px);}
      30%,50%,70%{transform:translateX(-4px);}
      40%,60%{transform:translateX(4px);}
      100%{transform:translateX(0);}
    }

    /* ÙÙ„Ø§Ø´ Ø£Ø­Ù…Ø± Ù„Ù„Ø®Ø·Ø£ */
    .flash-red{position:relative;}
    .flash-red::after{
      content:"";
      position:absolute;
      inset:0;
      background:rgba(255,0,0,.16);
      animation:fadeFlash .35s ease-out forwards;
      border-radius:14px;
    }
    @keyframes fadeFlash{
      from{opacity:1;}
      to{opacity:0;}
    }

    .status-bar{
      grid-column:1/-1;
      background:rgba(24,27,36,0.9);
      border-radius:var(--radius-lg);
      padding:10px 14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      border:1px dashed rgba(81,88,110,0.95);
      box-shadow:0 10px 26px rgba(0,0,0,0.65);
      position:relative;
      overflow:hidden;
    }

    .status-bar::before{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(120deg,rgba(255,255,255,0.01),rgba(255,255,255,0));
      pointer-events:none;
    }

    .status-bar > *{
      position:relative;
      z-index:1;
    }

    .chip{
      font-size:12px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(83,92,116,0.96);
      background:radial-gradient(circle at top,#202533,#181b23);
      color:#d3ddff;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .chip b{
      color:var(--accent-soft);
    }

    .hint{
      font-size:12px;
      color:var(--muted-soft);
    }

    /* Ø£Ø³Ø·ÙˆØ±Ø© Ø£Ù„ÙˆØ§Ù† */
    .legend{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .legend .lg{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(83,92,116,0.9);
      background:radial-gradient(circle at top,#202533,#181b23);
      color:#d3ddff;
    }
    .dot-sm{
      width:10px;
      height:10px;
      border-radius:50%;
      box-shadow:0 0 10px rgba(0,0,0,0.6);
    }
    .d-green{background:var(--green-soft);}
    .d-yellow{background:var(--yellow);}
    .d-blue{background:var(--blue-soft);}
    .d-red{background:var(--danger);}

    /* Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø± â€” Ù…Ø®ÙÙŠØ© Ø¹Ù† Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† */
    .gm{
      display:none;
    }
    .gm.open{
      display:block;
    }

    .gm .gm-panel{
      background:var(--panel-soft);
      border-radius:var(--radius-lg);
      padding:12px 12px 10px;
      margin-top:8px;
      border:1px solid rgba(74,82,103,0.95);
      box-shadow:var(--shadow-soft);
      position:relative;
      overflow:hidden;
    }

    .gm .gm-panel::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at top left,rgba(255,59,59,0.08),transparent 55%);
      opacity:.7;
      pointer-events:none;
    }

    .gm h3{
      margin:0 0 8px;
      font-size:16px;
      color:#f1f4ff;
      position:relative;
      z-index:1;
    }

    .gm .row{
      display:flex;
      gap:8px;
      margin-bottom:8px;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }

    .gm input,
    .gm select,
    .gm textarea{
      background:radial-gradient(circle at top,#191c25,#13151d);
      border:1px solid rgba(73,81,104,0.95);
      color:var(--text);
      padding:8px 10px;
      border-radius:var(--radius-md);
      outline:none;
      font-size:13px;
      box-shadow:0 6px 18px rgba(0,0,0,0.55) inset;
    }

    .gm textarea{
      resize:vertical;
    }

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 6px;
      font-size:13px;
    }

    .table td,
    .table th{
      padding:8px 10px;
      background:#151822;
      border:1px solid rgba(68,75,99,0.95);
    }

    .table th{
      color:var(--muted);
      font-weight:700;
      text-align:inherit;
      background:#181b26;
    }

    .table tr td:first-child,
    .table tr th:first-child{
      border-top-right-radius:10px;
      border-bottom-right-radius:10px;
    }
    .table tr td:last-child,
    .table tr th:last-child{
      border-top-left-radius:10px;
      border-bottom-left-radius:10px;
    }

    .gm .hint{
      color:var(--muted-soft);
    }

    /* Ø²Ø± ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø± */
    .gm-toggle{
      position:fixed;
      inset-inline-start:16px;
      bottom:16px;
      z-index:60;
      background:radial-gradient(circle at top,#262a38,#191c24);
      border-radius:var(--radius-lg);
      padding:9px 13px;
      color:var(--text);
      font-weight:800;
      cursor:pointer;
      opacity:.92;
      border:1px solid rgba(84,92,116,0.95);
      box-shadow:0 14px 32px rgba(0,0,0,0.8);
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .gm-toggle:hover{
      transform:translateY(-2px);
      box-shadow:0 18px 40px rgba(0,0,0,0.9);
    }

    /* Ø²Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª */
    .help-btn{
      cursor:pointer;
      border-radius:var(--radius-md);
      border:1px solid rgba(80,88,112,0.95);
      background:radial-gradient(circle at top,#1c2030,#151823);
      padding:7px 10px;
      font-weight:800;
      font-size:13px;
      color:#dde5ff;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 8px 20px rgba(0,0,0,0.65);
    }

    .help-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 26px rgba(0,0,0,0.8);
    }

    .help-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.72);
      backdrop-filter:blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:80;
    }

    .help-card{
      width:min(760px,92vw);
      background:radial-gradient(circle at top,#252938,#191b25);
      border-radius:var(--radius-lg);
      padding:16px 16px 14px;
      border:1px solid rgba(82,90,116,0.95);
      box-shadow:0 22px 60px rgba(0,0,0,0.95);
      color:var(--text);
    }

    .help-card h3{
      margin:0 0 10px;
      font-size:18px;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .help-steps{
      display:grid;
      gap:10px;
      margin-top:6px;
    }

    .help-step{
      display:flex;
      gap:10px;
      align-items:flex-start;
      border-radius:var(--radius-md);
      padding:10px;
      border:1px solid rgba(82,90,116,0.95);
      background:radial-gradient(circle at top,#212636,#171a23);
    }

    .help-step .num{
      width:28px;
      height:28px;
      border-radius:10px;
      background:radial-gradient(circle at top,#292f42,#1c1f2a);
      border:1px solid rgba(95,104,133,0.95);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:13px;
      color:#e8edff;
      box-shadow:0 6px 16px rgba(0,0,0,0.8);
    }

    .help-step div:last-child{
      font-size:13px;
      color:#d8def5;
    }

    .help-close{
      margin-top:10px;
      display:flex;
      justify-content:flex-end;
    }

    /* Ù„Ø§ØµÙ‚ Ø¢Ø®Ø± Ø­Ø¯Ø« */
    .last-event{
      position:fixed;
      inset-inline-end:16px;
      top:74px;
      z-index:50;
      min-width:220px;
      max-width:40vw;
      background:radial-gradient(circle at top,#252938,#191b25);
      border-radius:var(--radius-lg);
      padding:10px 10px 9px;
      border:1px solid rgba(82,90,116,0.95);
      box-shadow:0 18px 40px rgba(0,0,0,0.9);
      font-size:13px;
      color:#e7ebff;
    }

    .last-event .hd{
      display:flex;
      align-items:center;
      justify-content:space-between;
      color:var(--muted);
      margin-bottom:6px;
      gap:10px;
    }

    .last-event .hd span{
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:700;
      color:#d1d8f5;
    }

    .last-event .body{
      line-height:1.6;
      color:#e9edff;
    }

    /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„ÙØ±Ø§Øº */
    .empty{
      display:grid;
      gap:8px;
    }

    .empty .ghost{
      border-radius:14px;
      min-height:74px;
      background:
        linear-gradient(120deg,rgba(255,255,255,0.02),rgba(255,255,255,0.004)),
        repeating-linear-gradient(135deg,#191b24,#191b24 8px,#151821 8px,#151821 16px);
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted-soft);
      font-size:13px;
      border:1px dashed rgba(90,98,122,0.9);
      opacity:.9;
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª ØµØºÙŠØ±Ø© Ù„Ù„Ø¬ÙˆØ§Ù„ */
    @media (max-width:600px){
      header{
        padding:10px 14px;
      }
      .wrap{
        padding:14px 10px 22px;
      }
      .gm-toggle{
        inset-inline-start:10px;
        bottom:10px;
      }
      .last-event{
        inset-inline-end:10px;
        top:66px;
        max-width:80vw;
      }
      .turn-banner{
        padding-inline:10px;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="title">
    <span class="dot"></span>
    <span>ğŸ­ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©</span>
  </div>
  <div class="right">
    <span class="status-pill">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù†: <b id="turnLabel">-</b></span>
    <button id="helpBtn" class="help-btn">â” ØªØ¹Ù„ÙŠÙ…Ø§Øª</button>
    <div class="conn-badges">
      <div id="twitchBadge" class="conn"><span class="led"></span><span>Twitch</span></div>
      <div id="kickBadge" class="conn"><span class="led"></span><span>Kick</span></div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="container">

    <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© -->
    <div class="login-inline">
      <div class="lbl">Ø§Ù„Ù…Ù†ØµÙ‘Ø©</div>
      <select id="platformSelect">
        <option value="twitch">Twitch</option>
        <option value="kick">Kick</option>
      </select>

      <div class="lbl">Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©</div>
      <input id="channelInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø© Ø¨Ø¯ÙˆÙ† #">

      <div class="lbl">Ø®ÙŠØ§Ø±Ø§Øª</div>
      <div style="display:flex;gap:8px;align-items:center">
        <label class="chip"><input type="checkbox" id="remember" style="margin-inline-end:6px"> ØªØ°ÙƒØ±Ù†ÙŠ</label>
        <button class="btn" id="fillSaved">Ù…Ù„Ø¡ Ø§Ù„Ù…Ø­ÙÙˆØ¸</button>
      </div>

      <div class="lbl">Ø§ØªØµØ§Ù„</div>
      <button class="btn success" id="connectBtn">âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>

      <div class="status" id="chatStatus">ğŸ’¡ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØµÙ‘Ø© ÙˆØ£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø© Ø«Ù… Ø§Ø¶ØºØ· ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ÙŠÙ…ÙƒÙ†Ùƒ ØªÙƒØ±Ø§Ø±Ù‡Ø§ Ù„Ù„Ù…Ù†ØµÙ‘Ø© Ø§Ù„Ø£Ø®Ø±Ù‰.</div>
    </div>

    <!-- Ø¨Ø§Ù†Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ (ØªØ­Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©) -->
    <div id="turnBanner" class="turn-banner">
      <div class="left">
        <span class="turn-badge">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù†</span>
        <span id="turnName" class="turn-name">â€”</span>
      </div>
      <div class="right">
        <span class="turn-hint">Ø§Ø®ØªØ± Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„Ø§Ø³Ù… Ø§Ù„ÙˆÙ‡Ù…ÙŠ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚</span>
      </div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† -->
    <div class="panel">
      <div class="panel-title">
        <div class="title-left">
          <span>Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†</span>
          <span class="count-chip" id="playersCount">0 Ù„Ø§Ø¹Ø¨</span>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn success" id="btnStart">â–¶ï¸ Ø§Ø¨Ø¯Ø£</button>
          <button class="btn accent" id="btnReset">ğŸ” Ø¥Ø¹Ø§Ø¯Ø©</button>
          <button class="btn" id="btnSkip">â­ï¸ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¯ÙˆØ±</button>
        </div>
      </div>
      <div id="playersGrid" class="grid"></div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ© -->
    <div class="panel">
      <div class="panel-title">
        <div class="title-left">
          <span>Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©</span>
          <span class="count-chip" id="cardsCount">0 Ø¨Ø·Ø§Ù‚Ø©</span>
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn warn" id="btnShuffleCards">ğŸ”€ Ø®Ù„Ø·</button>
          <button class="btn" id="btnLockAll">ğŸ”’ Ù‚ÙÙ„</button>
          <button class="btn" id="btnUnlockAll">ğŸ”“ ÙØªØ­</button>
        </div>
      </div>
      <div id="cardsGrid" class="grid"></div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© -->
    <div class="status-bar">
      <div style="display:flex;flex-wrap:wrap;gap:8px">
        <span class="chip">Ø§Ù†Ø¶Ù…Ø§Ù… Ù…Ù† Ø§Ù„Ø´Ø§Øª: <b>!Ø¯Ø®ÙˆÙ„</b></span>
        <span class="chip">Ø§Ù„ØªØ­Ù‚Ù‚: Ø§Ø®ØªÙØ± <b>Ù„Ø§Ø¹Ø¨Ù‹Ø§</b> Ø«Ù… Ø§Ø®ØªÙØ± <b>Ø¨Ø·Ø§Ù‚Ø©</b> Ù…Ù† Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø±</span>
      </div>
      <div class="legend">
        <div class="lg"><span class="dot-sm d-green"></span><span>ØµØ­ÙŠØ­Ø©/Ù…Ù‚ØµÙ‰</span></div>
        <div class="lg"><span class="dot-sm d-yellow"></span><span>Ù…Ù‚ÙÙ„Ø©</span></div>
        <div class="lg"><span class="dot-sm d-red"></span><span>Ø®Ø·Ø£</span></div>
      </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø± -->
    <div id="gm" class="gm" style="grid-column:1/-1">
      <div class="gm-panel">
        <h3>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø±</h3>

        <div class="row">
          <input id="playerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯)" />
          <button class="btn success" id="addPlayerBtn">Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨</button>
          <span class="hint">Ø£Ùˆ ÙŠÙ†Ø¶Ù…ÙˆÙ† Ù…Ù† Ø§Ù„Ø´Ø§Øª Ø¨Ù€ <b>!Ø¯Ø®ÙˆÙ„</b></span>
        </div>
        <div class="row">
          <input id="fakeWord" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙˆÙ‡Ù…ÙŠ (Ù…Ø«Ø§Ù„: Ø³ÙŠØ§Ø±Ø©)" />
          <select id="fakeOwner"></select>
          <button class="btn success" id="addFakeBtn">Ø¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø©</button>
          <button class="btn" id="clearUnowned">ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø³Ù…Ø§Ø¡</button>
        </div>

        <div class="row" style="width:100%;display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <h4 style="margin:6px 0;color:#e5e9ff;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h4>
            <table class="table">
              <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
              <tbody id="playersTable"></tbody>
            </table>
          </div>
          <div>
            <h4 style="margin:6px 0;color:#e5e9ff;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</h4>
            <table class="table">
              <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø§Ù„Ùƒ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
              <tbody id="cardsTable"></tbody>
            </table>
          </div>
        </div>

        <div class="row">
          <textarea id="log" placeholder="Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«" style="width:100%;min-height:120px" readonly></textarea>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Ø²Ø± ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø± -->
<button id="gmToggle" class="gm-toggle">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø±</button>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
<div id="helpOverlay" class="help-overlay" role="dialog" aria-modal="true">
  <div class="help-card">
    <h3>ğŸ“˜ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</h3>
    <div class="help-steps">
      <div class="help-step"><div class="num">1</div><div>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† Ø²Ø± <b>â–¶ï¸ Ø§Ø¨Ø¯Ø£</b>.</div></div>
      <div class="help-step"><div class="num">2</div><div>Ø§Ø®ØªÙØ± Ø¨Ø·Ø§Ù‚Ø© <b>Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø°ÙƒÙˆØ±</b> Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†.</div></div>
      <div class="help-step"><div class="num">3</div><div>Ø§Ø®ØªÙØ± Ø¨Ø·Ø§Ù‚Ø© <b>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙˆÙ‡Ù…ÙŠ</b> Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù‡.</div></div>
      <div class="help-step"><div class="num">4</div><div>Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ <b>â­ï¸ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¯ÙˆØ±</b>.</div></div>
    </div>
    <div class="help-close">
      <button id="helpClose" class="btn">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
  </div>
</div>

<!-- Ù„Ø§ØµÙ‚ Ø¢Ø®Ø± Ø­Ø¯Ø« -->
<div id="lastEvent" class="last-event" style="display:none">
  <div class="hd">
    <span>ğŸ“° Ø¢Ø®Ø± Ø­Ø¯Ø«</span>
    <button id="lastEventHide" class="btn" style="padding:4px 8px;font-size:12px">Ø¥Ø®ÙØ§Ø¡</button>
  </div>
  <div class="body" id="lastEventBody">â€”</div>
</div>

<script>
/* ===== Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ù†ØµØ§Øª ===== */
let TWITCH_CHANNEL = "", KICK_CHANNEL = "";
let twitchClient = null, kickSocket = null;
let twitchConnected=false, kickConnected=false;
const LS_KEY_TWITCH='fn_twitch', LS_KEY_KICK='fn_kick';

/* ===== Ø¹Ù†Ø§ØµØ± DOM ===== */
const els = {
  turnLabel: document.getElementById('turnLabel'),

  cardsGrid: document.getElementById('cardsGrid'),
  playersGrid: document.getElementById('playersGrid'),

  playersCount: document.getElementById('playersCount'),
  cardsCount: document.getElementById('cardsCount'),

  btnStart: document.getElementById('btnStart'),
  btnReset: document.getElementById('btnReset'),
  btnShuffleCards: document.getElementById('btnShuffleCards'),
  btnLockAll: document.getElementById('btnLockAll'),
  btnUnlockAll: document.getElementById('btnUnlockAll'),
  btnSkip: document.getElementById('btnSkip'),

  platformSelect: document.getElementById('platformSelect'),
  channelInput: document.getElementById('channelInput'),
  remember: document.getElementById('remember'),
  connectBtn: document.getElementById('connectBtn'),
  fillSaved: document.getElementById('fillSaved'),
  chatStatus: document.getElementById('chatStatus'),

  gm: document.getElementById('gm'),
  gmToggle: document.getElementById('gmToggle'),
  playerName: document.getElementById('playerName'),
  addPlayerBtn: document.getElementById('addPlayerBtn'),
  playersTable: document.getElementById('playersTable'),
  fakeWord: document.getElementById('fakeWord'),
  fakeOwner: document.getElementById('fakeOwner'),
  addFakeBtn: document.getElementById('addFakeBtn'),
  clearUnowned: document.getElementById('clearUnowned'),
  cardsTable: document.getElementById('cardsTable'),
  log: document.getElementById('log'),

  twitchBadge: document.getElementById('twitchBadge'),
  kickBadge: document.getElementById('kickBadge'),

  helpBtn: document.getElementById('helpBtn'),
  helpOverlay: document.getElementById('helpOverlay'),
  helpClose: document.getElementById('helpClose'),

  lastEvent: document.getElementById('lastEvent'),
  lastEventBody: document.getElementById('lastEventBody'),
  lastEventHide: document.getElementById('lastEventHide'),

  // Ø¨Ø§Ù†Ø± Ø§Ù„Ø¯ÙˆØ±
  turnBanner: document.getElementById('turnBanner'),
  turnName: document.getElementById('turnName'),
};

/* ===== Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ===== */
const state = {
  players: [],   // {id,name,eliminated:false}
  cards: [],     // {id,text,ownerId,revealed:false,locked:false}
  turnIndex: -1,
  started: false,
  selectedMentionedId: null,
  selectedCardId: null
};

/* ===== Ù…Ø³Ø§Ø¹Ø¯Ø§Øª ===== */
const uid = ()=> Math.random().toString(36).slice(2,10);
const normalize = s => (s||"").toString().trim().toLowerCase();
function byId(arr,id){ return arr.find(x=>x.id===id); }
function currentPlayer(){ if(state.turnIndex<0||state.turnIndex>=state.players.length) return null; return state.players[state.turnIndex]; }
function alivePlayers(){ return state.players.filter(p=>!p.eliminated); }
function log(t){ els.log.value = `[${new Date().toLocaleTimeString()}] ${t}\n` + els.log.value; setLastEvent(t); }

/* ===== Ø¹Ø¯Ø§Ø¯Ø§Øª ===== */
function updateCounts(){
  els.playersCount.textContent = `${state.players.length} Ù„Ø§Ø¹Ø¨`;
  els.cardsCount.textContent   = `${state.cards.length} Ø¨Ø·Ø§Ù‚Ø©`;
}

/* ===== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙÙŠ GM ===== */
function updateSelects(){
  const setOpts=(el,items,withNone=false)=>{
    el.innerHTML=''; if(withNone){const o=document.createElement('option');o.value='';o.textContent='â€”';el.append(o);}
    items.forEach(it=>{const o=document.createElement('option');o.value=it.value;o.textContent=it.label;el.append(o);});
  };
  setOpts(els.fakeOwner, state.players.map(p=>({value:p.id,label:p.name})), true);
}

/* ===== Ø¨Ø§Ù†Ø± Ø§Ù„Ø¯ÙˆØ± (Ù†Ø³Ø®Ø© Ù…Ù† Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨) ===== */
function renderTurnBanner(){
  const p = currentPlayer();
  if (p && !p.eliminated){
    els.turnName.textContent = p.name;
    els.turnLabel.textContent = p.name;
    els.turnBanner.style.display = 'flex';
  } else {
    els.turnName.textContent = 'â€”';
    els.turnLabel.textContent = '-';
    els.turnBanner.style.display = 'none';
  }
}

/* ===== Ø±Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ===== */
function renderPlayers(){
  els.playersGrid.innerHTML='';
  if (state.players.length===0){
    const wrap=document.createElement('div'); wrap.className='empty';
    for(let i=0;i<3;i++){ const g=document.createElement('div'); g.className='ghost'; g.textContent='Ù„Ø§Ø¹Ø¨ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶Ù‡ Ù‡Ù†Ø§ â€¢ Ø£Ø¶ÙÙ Ù„Ø§Ø¹Ø¨Ù‹Ø§ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… !Ø¯Ø®ÙˆÙ„'; wrap.append(g); }
    els.playersGrid.append(wrap);
  } else {
    state.players.forEach((p)=>{
      const el=document.createElement('div'); el.className='card'; el.dataset.id=p.id;
      if (state.selectedMentionedId===p.id) el.classList.add('selected');
      if (p.eliminated) { el.style.opacity=.48; el.style.filter='grayscale(.35)'; }

      el.onclick=()=>{
        if (p.eliminated) return;
        state.selectedMentionedId=p.id;
        document.querySelectorAll('#playersGrid .card').forEach(x=>x.classList.remove('selected'));
        el.classList.add('selected');
        tryResolveIfReady();
      };

      const badge=document.createElement('span'); badge.className='badge';
      const isTurn = currentPlayer() && currentPlayer().id===p.id && !p.eliminated;
      badge.textContent = p.eliminated ? 'Ù…Ù‚ØµÙ‰' : (isTurn ? 'Ø§Ù„Ø¯ÙˆØ±' : 'Ø¬Ø§Ù‡Ø²');

      const t=document.createElement('div'); t.className='text'; t.textContent=p.name;
      el.append(badge,t);
      els.playersGrid.append(el);
    });
  }

  // Ø¬Ø¯ÙˆÙ„ GM
  els.playersTable.innerHTML='';
  state.players.forEach((p,idx)=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=p.name;
    const td2=document.createElement('td'); td2.textContent=p.eliminated?'Ù…Ù‚ØµÙ‰':'Ù†Ø´Ø·';
    const td3=document.createElement('td');
    const elim=document.createElement('button'); elim.className='btn accent'; elim.textContent=p.eliminated?'Ø¥Ø±Ø¬Ø§Ø¹':'Ø¥Ù‚ØµØ§Ø¡';
    elim.onclick=()=>{ p.eliminated=!p.eliminated; if (state.turnIndex===idx && p.eliminated) nextTurnAuto(); renderPlayers(); renderTurnBanner(); };
    const del=document.createElement('button'); del.className='btn'; del.textContent='Ø­Ø°Ù';
    del.onclick=()=>{ state.cards.forEach(c=>{ if(c.ownerId===p.id) c.ownerId=null; }); state.players=state.players.filter(x=>x.id!==p.id); if(state.turnIndex>=state.players.length) state.turnIndex=state.players.length-1; renderPlayers(); renderCards(); renderTurnBanner(); };
    td3.append(elim,document.createTextNode(' '),del);
    tr.append(td1,td2,td3); els.playersTable.append(tr);
  });

  updateCounts();
  renderTurnBanner();
}

/* ===== Ø±Ø³Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ===== */
function renderCards(){
  els.cardsGrid.innerHTML='';
  if (state.cards.length===0){
    const wrap=document.createElement('div'); wrap.className='empty';
    for(let i=0;i<4;i++){ const g=document.createElement('div'); g.className='ghost'; g.textContent='Ø¨Ø·Ø§Ù‚Ø© Ø§Ø³Ù… ÙˆÙ‡Ù…ÙŠ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ â€¢ Ø£Ø¶ÙÙ Ø¨Ø·Ø§Ù‚Ø© Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø±'; wrap.append(g); }
    els.cardsGrid.append(wrap);
  } else {
    state.cards.forEach(c=>{
      const el=document.createElement('div'); el.className='card'; el.dataset.id=c.id;
      if (c.revealed) el.classList.add('revealed');
      if (state.selectedCardId===c.id) el.classList.add('selected');

      el.onclick=()=>{
        if (!state.started){ log('Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹.'); return; }
        if (c.locked){ log('Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ù‚ÙÙ„Ø©.'); return; }
        if (c.revealed){ log('Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ØµØ§Ø±Øª ØµØ­ÙŠØ­Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§.'); return; }
        state.selectedCardId=c.id;
        document.querySelectorAll('#cardsGrid .card').forEach(x=>x.classList.remove('selected','wrong'));
        el.classList.add('selected');
        tryResolveIfReady();
      };

      const badge=document.createElement('span'); badge.className='badge';
      badge.textContent = c.revealed ? 'ØµØ­ÙŠØ­Ø©' : (c.locked ? 'Ù…Ù‚ÙÙ„Ø©' : 'Ø¬Ø§Ù‡Ø²Ø©');

      const t=document.createElement('div'); t.className='text'; t.textContent = c.text;

      el.append(badge,t);
      els.cardsGrid.append(el);
    });
  }

  // Ø¬Ø¯ÙˆÙ„ GM
  els.cardsTable.innerHTML='';
  state.cards.forEach(c=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=c.text;
    const td2=document.createElement('td'); td2.textContent=(byId(state.players,c.ownerId)?.name)||'â€”';
    const td3=document.createElement('td'); td3.textContent=(c.revealed?'ØµØ­ÙŠØ­Ø©':'â€”')+(c.locked?' / Ù…Ù‚ÙÙ„Ø©':'');
    const td4=document.createElement('td');
    const lock=document.createElement('button'); lock.className='btn'; lock.textContent=c.locked?'ÙØªØ­':'Ù‚ÙÙ„'; lock.onclick=()=>{ c.locked=!c.locked; renderCards(); };
    const del=document.createElement('button'); del.className='btn accent'; del.textContent='Ø­Ø°Ù'; del.onclick=()=>{ state.cards=state.cards.filter(x=>x.id!==c.id); renderCards(); };
    td4.append(lock,document.createTextNode(' '),del);
    tr.append(td1,td2,td3,td4); els.cardsTable.append(tr);
  });

  updateCounts();
}

/* ===== Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¯ÙˆØ± + ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¯ÙˆØ± ===== */
function startGame(){
  if (alivePlayers().length===0){ log('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ†.'); return; }
  if (state.cards.length===0){ log('Ø£Ø¶Ù Ø¨Ø·Ø§Ù‚Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.'); return; }
  state.started = true;
  state.turnIndex = state.players.findIndex(p=>!p.eliminated);
  if (state.turnIndex<0) state.turnIndex = 0;
  log('Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©.');
  renderPlayers(); renderCards(); renderTurnBanner();
}
function nextTurnAuto(){
  if (!state.started) return;
  const n = state.players.length; if (!n) return;
  let i = state.turnIndex;
  for (let step=0; step<n; step++){
    i = (i+1) % n;
    if (!state.players[i].eliminated){ state.turnIndex = i; break; }
  }

  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
  state.selectedMentionedId = null;
  state.selectedCardId = null;
  document.querySelectorAll('.card').forEach(x=>x.classList.remove('selected','wrong','flash-red'));

  // Ø§Ù„ÙÙˆØ² Ø¥Ø°Ø§ Ø¨Ù‚ÙŠ Ù„Ø§Ø¹Ø¨ ÙˆØ§Ø­Ø¯
  if (alivePlayers().length<=1){
    const champ = alivePlayers()[0];
    log(champ?`ğŸ‰ Ø§Ù„ÙØ§Ø¦Ø²: ${champ.name}`:'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ§Ø¦Ø².');
  }
  renderPlayers();
  renderTurnBanner();
}
function resetGame(){
  state.started=false; state.turnIndex=-1;
  state.players.forEach(p=>p.eliminated=false);
  state.cards.forEach(c=>{c.revealed=false;c.locked=false;});
  state.selectedMentionedId=null; state.selectedCardId=null;
  log('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©.');
  renderPlayers(); renderCards(); renderTurnBanner();
}
els.btnSkip.onclick = ()=>{
  if (!state.started){ log('Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹.'); return; }
  const cur = currentPlayer()?.name || '-';
  log(`â­ï¸ ØªÙ… ØªØ¬Ø§ÙˆØ² Ø¯ÙˆØ± ${cur}.`);
  nextTurnAuto();
};

/* ===== Ù…Ø¤Ø«Ø± Ø§Ù„Ù†Ø¬Ø§Ø­ ===== */
function confettiBurst(x=window.innerWidth/2, y=120){
  const cnv = document.createElement('canvas');
  cnv.width=window.innerWidth; cnv.height=200; cnv.style.position='fixed';
  cnv.style.left='0'; cnv.style.top='0'; cnv.style.pointerEvents='none'; cnv.style.zIndex='70';
  document.body.appendChild(cnv);
  const ctx = cnv.getContext('2d');
  const parts = Array.from({length:60},()=>({
    x, y, vx:(Math.random()*4-2), vy:(Math.random()*-3-1), g:0.08+Math.random()*0.05, s:2+Math.random()*3, life:50+Math.random()*30
  }));
  let id;
  function step(){
    ctx.clearRect(0,0,cnv.width,cnv.height);
    parts.forEach(p=>{
      p.x+=p.vx; p.y+=p.vy; p.vy+=p.g; p.life--;
      ctx.globalAlpha = Math.max(0, Math.min(1, p.life/80));
      ctx.fillRect(p.x, p.y, p.s, p.s);
    });
    if(parts.every(p=>p.life<=0)){ cancelAnimationFrame(id); document.body.removeChild(cnv); return; }
    id=requestAnimationFrame(step);
  }
  step();
}

/* ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ===== */
function tryResolveIfReady(){
  const turnP = currentPlayer();
  if (!turnP || turnP.eliminated) return;

  const mentionedId = state.selectedMentionedId;
  const cardId = state.selectedCardId;
  if (!mentionedId || !cardId) return;

  const mentioned = byId(state.players, mentionedId);
  const card = byId(state.cards, cardId);
  if (!mentioned || !card || card.locked) return;

  const correct = !!card.ownerId && card.ownerId === mentioned.id;
  const cardEl = document.querySelector(`#cardsGrid .card[data-id="${card.id}"]`);

  if (correct){
    card.revealed = true;
    if (!mentioned.eliminated){
      mentioned.eliminated = true;
      log(`âœ… ØµØ­ÙŠØ­! "${card.text}" ØªØ®Øµ ${mentioned.name}. ØªÙ… Ø¥Ù‚ØµØ§Ø¤Ù‡.`);
    } else {
      log(`âœ… ØµØ­ÙŠØ­! "${card.text}" ØªØ®Øµ ${mentioned.name} (ÙƒØ§Ù† Ù…Ù‚ØµÙ‰).`);
    }
    const rect = cardEl?.getBoundingClientRect?.();
    confettiBurst(rect ? rect.left + rect.width/2 : undefined, rect ? rect.top + 10 : undefined);
  } else {
    if (cardEl){
      cardEl.classList.add('wrong','flash-red');
      setTimeout(()=>cardEl.classList.remove('wrong','flash-red'), 400);
    }
    log(`âŒ Ø®Ø·Ø£! "${card.text}" Ù„Ø§ ØªØ®Øµ ${mentioned.name}.`);
  }

  renderPlayers(); renderCards();
  nextTurnAuto();
}

/* ===== Ø£Ø²Ø±Ø§Ø± Ø¹Ø§Ù…Ø© ===== */
els.btnStart.onclick = startGame;
els.btnReset.onclick = resetGame;
els.btnShuffleCards.onclick = ()=>{
  for(let i=state.cards.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [state.cards[i],state.cards[j]]=[state.cards[j],state.cards[i]]; }
  renderCards();
};
els.btnLockAll.onclick   = ()=>{ state.cards.forEach(c=>c.locked=true); renderCards(); };
els.btnUnlockAll.onclick = ()=>{ state.cards.forEach(c=>c.locked=false); renderCards(); };

/* ===== Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø± ===== */
els.addPlayerBtn.onclick=()=>{
  const name=els.playerName.value.trim(); if(!name) return;
  if(!state.players.some(p=>normalize(p.name)===normalize(name))){
    state.players.push({id:uid(),name,eliminated:false});
    els.playerName.value=''; renderPlayers(); renderTurnBanner();
  } else { log('Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§.'); }
};
els.addFakeBtn.onclick=()=>{
  const text=els.fakeWord.value.trim(); const ownerId=els.fakeOwner.value||null; if(!text) return;
  state.cards.push({id:uid(),text,ownerId,revealed:false,locked:false});
  els.fakeWord.value=''; renderCards(); updateSelects();
};
els.clearUnowned.onclick=()=>{ state.cards = state.cards.filter(c=>!!c.ownerId); renderCards(); updateSelects(); };

function setGmVisibility(show){ els.gm.classList.toggle('open', !!show); }
els.gmToggle.onclick = ()=> setGmVisibility(!els.gm.classList.contains('open'));
setGmVisibility(location.hash==='#gm');
window.addEventListener('keydown',e=>{ if(e.altKey && (e.key.toLowerCase()==='g')) setGmVisibility(!els.gm.classList.contains('open')); });

/* ===== Ø§Ù„Ø´Ø§Øª: Ø§Ù†Ø¶Ù…Ø§Ù… ÙÙ‚Ø· ===== */
function handleChatJoin(user){
  if (!user) return;
  if (state.players.some(p=>normalize(p.name)===normalize(user))) return;
  state.players.push({id:uid(),name:user,eliminated:false});
  renderPlayers(); renderTurnBanner(); log(`Ø§Ù†Ø¶Ù… ${user} Ø¥Ù„Ù‰ Ø§Ù„Ù„Ø¹Ø¨Ø©.`);
}

/* Twitch */
function connectTwitch(channel){
  try{
    updateConnBadge(els.twitchBadge, 'wait');
    twitchClient = new tmi.Client({ channels:[channel], connection:{secure:true,reconnect:true} });
    twitchClient.connect()
      .then(()=>{ 
        TWITCH_CHANNEL=channel; twitchConnected=true; 
        els.chatStatus.textContent=`âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Twitch: #${channel}`; 
        log(`âœ… Twitch Ù…ØªØµÙ„: #${channel}`); 
        updateConnBadge(els.twitchBadge, 'ok');
        if (els.remember.checked) localStorage.setItem(LS_KEY_TWITCH, channel); 
      })
      .catch(e=>{ els.chatStatus.textContent=`âŒ ÙØ´Ù„ Ø§ØªØµØ§Ù„ Twitch`; log('âŒ ÙØ´Ù„ Ø§ØªØµØ§Ù„ Twitch: '+e); updateConnBadge(els.twitchBadge, 'err'); });
    twitchClient.on('message',(ch,tags,message,self)=>{
      if(self) return;
      const user = tags['display-name'] || tags.username || 'Ù…Ø´Ø§Ø±Ùƒ';
      const text = (message||'').trim();
      if (text==='!Ø¯Ø®ÙˆÙ„'){ handleChatJoin(user); return; }
      // Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…Ù† Ø§Ù„Ø´Ø§Øª Ù…Ø¹Ø·Ù„Ø©
    });
  }catch(e){ els.chatStatus.textContent=`âŒ Ø®Ø·Ø£ ÙÙŠ Twitch`; log('Ø®Ø·Ø£ Twitch: '+e.message); updateConnBadge(els.twitchBadge, 'err'); }
}

/* Kick */
async function connectKick(channel){
  try{
    updateConnBadge(els.kickBadge, 'wait');
    const res = await fetch(`https://kick.com/api/v2/channels/${channel}`);
    const data = await res.json();
    const roomId = data?.chatroom?.id;
    if (!roomId){ els.chatStatus.textContent='âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ ØºØ±ÙØ© ÙƒÙŠÙƒ'; updateConnBadge(els.kickBadge, 'err'); return; }

    const ws = new WebSocket("wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=8.4.0-rc2&flash=false");
    kickSocket = ws;
    ws.onopen = ()=>{
      ws.send(JSON.stringify({event:"pusher:subscribe",data:{auth:"",channel:`chatrooms.${roomId}.v2`}}));
      setInterval(()=>{ if(ws.readyState===WebSocket.OPEN){ ws.send(JSON.stringify({event:"pusher:ping",data:{}})); } },12000);
      KICK_CHANNEL=channel; kickConnected=true; els.chatStatus.textContent=`âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Kick: ${channel}`; log(`âœ… Kick Ù…ØªØµÙ„: ${channel}`);
      updateConnBadge(els.kickBadge, 'ok');
      if (els.remember.checked) localStorage.setItem(LS_KEY_KICK, channel);
    };
    ws.onmessage = (event)=>{
      const pkt = JSON.parse(event.data);
      if (pkt.event === "App\\Events\\ChatMessageEvent"){
        const d = JSON.parse(pkt.data);
        const user = d?.sender?.username || 'Ù…Ø´Ø§Ø±Ùƒ';
        const text = (d?.content || '').trim();
        if (text==='!Ø¯Ø®ÙˆÙ„'){ handleChatJoin(user); return; }
        // Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…Ù† Ø§Ù„Ø´Ø§Øª Ù…Ø¹Ø·Ù„Ø©
      }
    };
    ws.onerror = ()=>{ els.chatStatus.textContent='âŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§ØªØµØ§Ù„ Kick'; log('âŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§ØªØµØ§Ù„ Kick'); updateConnBadge(els.kickBadge, 'err'); };
  }catch(e){
    els.chatStatus.textContent='âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Kick';
    log('Kick error: '+e.message);
    updateConnBadge(els.kickBadge, 'err');
  }
}

/* Ø¨Ø§Ø¯Ø¬Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ */
function updateConnBadge(el, state){
  el.classList.remove('ok','wait','err');
  if (state==='ok') el.classList.add('ok');
  else if (state==='wait') el.classList.add('wait');
  else el.classList.add('err');
}

/* Ø²Ø± Ø§Ù„Ø§ØªØµØ§Ù„ */
els.fillSaved.onclick = ()=>{
  els.channelInput.value = (els.platformSelect.value==='twitch')
    ? (localStorage.getItem(LS_KEY_TWITCH)||'')
    : (localStorage.getItem(LS_KEY_KICK)||'');
};
els.connectBtn.onclick = ()=>{
  const platform = els.platformSelect.value;
  const channel  = els.channelInput.value.trim();
  if (!channel){ els.chatStatus.textContent='âš ï¸ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹'; return; }
  if (els.remember.checked){
    if (platform==='twitch') localStorage.setItem(LS_KEY_TWITCH, channel);
    else localStorage.setItem(LS_KEY_KICK, channel);
  }
  if (platform==='twitch'){ connectTwitch(channel); } else { connectKick(channel); }
};

/* Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø© */
function updateAll(){ renderPlayers(); renderCards(); updateSelects(); updateCounts(); renderTurnBanner(); }
updateAll();

/* ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø© */
els.helpBtn.onclick = ()=>{ els.helpOverlay.style.display='flex'; };
els.helpClose.onclick = ()=>{ els.helpOverlay.style.display='none'; };
els.helpOverlay.addEventListener('click',(e)=>{ if(e.target===els.helpOverlay) els.helpOverlay.style.display='none'; });

/* Ù„Ø§ØµÙ‚ Ø¢Ø®Ø± Ø­Ø¯Ø« â€” Ø¥Ø®ÙØ§Ø¡ */
function setLastEvent(text){ els.lastEventBody.textContent = text; els.lastEvent.style.display = 'block'; }
els.lastEventHide.onclick = ()=>{ els.lastEvent.style.display='none'; };

/* Ù„ÙˆØ­Ø© GM (ØªØ¹Ø±ÙŠÙ Ù…ÙƒØ±Ø± Ù„ÙƒÙ† Ø¨Ù†ÙØ³ Ø§Ù„Ø³Ù„ÙˆÙƒ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ) */
function setGmVisibility(show){ els.gm.classList.toggle('open', !!show); }
els.gmToggle.onclick = ()=> setGmVisibility(!els.gm.classList.contains('open'));
setGmVisibility(location.hash==='#gm');
window.addEventListener('keydown',e=>{ if(e.altKey && (e.key.toLowerCase()==='g')) setGmVisibility(!els.gm.classList.contains('open')); });
</script>
</body>
</html>
