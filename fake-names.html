<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ­ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <!-- tmi.js Ù„ØªÙˆÙŠØªØ´ -->
  <script src="tmi.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tmi.js@1.8.5/dist/tmi.min.js"></script>
  <style>
    :root{
      --bg:#0f1115; --panel:#151924; --card:#1b2130; --line:#2a3347;
      --accent:#ff3333; --green:#00d86c; --text:#e8eefc; --muted:#9fb0d0; --ok:#00ffc8; --bad:#ff5b5b; --blue:#0099ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:linear-gradient(135deg,#0e0f13,#121621 40%,#0e1426);
      min-height:100vh;color:var(--text);font-family:'Cairo',system-ui;display:flex;flex-direction:column
    }
    header{
      padding:16px 24px;border-bottom:1px solid var(--line);
      background:rgba(17,20,30,.6);backdrop-filter: blur(6px);
      position:sticky;top:0;z-index:30;display:flex;align-items:center;justify-content:space-between
    }
    header .title{display:flex;align-items:center;gap:10px;font-weight:800}
    header .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 12px var(--accent)}
    header .right{display:flex;gap:10px;color:var(--muted);font-size:14px;align-items:center}
    header .status-pill{padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:rgba(27,33,48,.6)}

    /* Ù…Ø±ÙƒØ² Ø§Ù„ØµÙØ­Ø© */
    .wrap{flex:1;display:flex;align-items:flex-start;justify-content:center;padding:18px}
    .container{width:min(1200px,96vw);margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media (max-width:980px){ .container{grid-template-columns:1fr} }

    /* Ø´Ø±ÙŠØ· ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­ÙŠÙ† */
    .login-inline{grid-column:1/-1;width:100%;margin:0 auto;background:#121826;border:1px solid var(--line);border-radius:12px;padding:10px;display:grid;gap:8px;grid-template-columns:130px 1fr 160px 1fr 160px}
    .login-inline .lbl{display:flex;align-items:center;justify-content:center;border:1px solid #28324a;background:#0f1320;border-radius:10px;font-size:14px}
    .login-inline input,.login-inline select{background:#0f1320;border:1px solid #28324a;color:#e8eefc;padding:8px 10px;border-radius:10px;outline:none;width:100%}
    .login-inline .status{grid-column:1/-1;font-size:14px;color:#a7ffc8}
    @media (max-width:980px){ .login-inline{grid-template-columns:1fr 1fr} .login-inline .lbl{display:none} }

    /* Ø§Ù„Ø£Ù„ÙˆØ§Ø­ Ø§Ù„ÙˆØ³Ø·ÙŠØ© */
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 0 0 1px rgba(0,0,0,.25),0 12px 32px rgba(0,0,0,.25)}
    .panel-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;font-weight:700;color:var(--muted)}
    .title-left{display:flex;align-items:center;gap:10px}
    .count-chip{font-size:12px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#0f1320;color:#cfe0ff}
    .btn{cursor:pointer;user-select:none;border-radius:10px;border:1px solid var(--line);padding:8px 12px;background:linear-gradient(180deg,#1b2130,#121826);color:var(--text);font-weight:700;transition:.15s}
    .btn:hover{transform:translateY(-1px)} .btn.success{background:linear-gradient(180deg,#183a2d,#0d2019);border-color:#214f3e}
    .btn.warn{background:linear-gradient(180deg,#3a3518,#201d0d)} .btn.accent{background:linear-gradient(180deg,#3a1b1b,#1e1111)}

    /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª (Ù„Ù„Ø¬Ù…ÙŠØ¹) */
    .grid{display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:10px}
    @media (max-width:900px){ .grid{grid-template-columns:repeat(2,minmax(140px,1fr))} }
    @media (max-width:620px){ .grid{grid-template-columns:repeat(1,minmax(220px,1fr))} }

    .card{
      user-select:none;cursor:pointer;border-radius:14px;padding:16px 14px;min-height:74px;
      background:linear-gradient(180deg,rgba(31,38,57,.92),rgba(16,20,30,.92));
      border:1px solid var(--line);text-align:center;position:relative
    }
    .card .badge{
      position:absolute;top:8px;inset-inline-start:8px;font-size:12px;padding:2px 8px;border:1px solid var(--line);
      border-radius:999px;color:#c5d2f2;background:rgba(15,18,27,.8)
    }
    .card .text{font-weight:800;font-size:20px;letter-spacing:.3px}
    .card.selected{outline:2px solid var(--blue);box-shadow:0 0 0 3px rgba(0,153,255,.18) inset}
    .card.revealed{background:linear-gradient(180deg,rgba(32,48,38,.95),rgba(12,18,16,.95));border-color:#166b52}
    .card.wrong{animation:shake .32s; box-shadow:0 0 0 2px rgba(255,91,91,.6) inset}
    @keyframes shake{
      10%,90%{transform:translateX(-1px)}
      20%,80%{transform:translateX(2px)}
      30%,50%,70%{transform:translateX(-4px)}
      40%,60%{transform:translateX(4px)}
      100%{transform:translateX(0)}
    }

    .status-bar{grid-column:1/-1;background:rgba(21,25,36,.65);border:1px dashed var(--line);border-radius:14px;padding:10px 14px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
    .chip{font-size:12px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#0f1320}
    .hint{font-size:12px;color:#93a6cc}

    /* Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø± â€” Ù…Ø®ÙÙŠØ© Ø¹Ù† Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† */
    .gm{display:none}
    .gm.open{display:block}
    .gm .gm-panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:8px}
    .gm .row{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
    .gm input,.gm select{background:#0f1320;border:1px solid #2a3347;color:#e8eefc;padding:8px 10px;border-radius:10px;outline:none}
    .table{width:100%;border-collapse:separate;border-spacing:0 6px;font-size:14px}
    .table td,.table th{padding:8px 10px;background:#0f1320;border:1px solid #28324a}
    .table th{color:#9fb0d0;font-weight:700;text-align:inherit}
    .table tr td:first-child,.table tr th:first-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .table tr td:last-child,.table tr th:last-child{border-top-left-radius:10px;border-bottom-left-radius:10px}

    /* Ø²Ø± ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø± Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø± */
    .gm-toggle{
      position:fixed; inset-inline-start:16px; bottom:16px; z-index:60;
      background:linear-gradient(180deg,#1f2536,#141a2a); border:1px solid var(--line);
      border-radius:12px; padding:10px 12px; color:var(--text); font-weight:800; cursor:pointer; opacity:.9
    }
    .gm-toggle:hover{transform:translateY(-1px)}
  </style>
</head>
<body>

<header>
  <div class="title"><span class="dot"></span><span>ğŸ­ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©</span></div>
  <div class="right">
    <span class="status-pill">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù†: <b id="turnLabel">-</b></span>
  </div>
</header>

<div class="wrap">
  <div class="container">

    <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© -->
    <div class="login-inline">
      <div class="lbl">Ø§Ù„Ù…Ù†ØµÙ‘Ø©</div>
      <select id="platformSelect">
        <option value="twitch">Twitch</option>
        <option value="kick">Kick</option>
      </select>

      <div class="lbl">Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©</div>
      <input id="channelInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø© Ø¨Ø¯ÙˆÙ† #">

      <div class="lbl">Ø®ÙŠØ§Ø±Ø§Øª</div>
      <div style="display:flex;gap:8px;align-items:center">
        <label class="chip"><input type="checkbox" id="remember" style="margin-inline-end:6px"> ØªØ°ÙƒØ±Ù†ÙŠ</label>
        <button class="btn" id="fillSaved">Ù…Ù„Ø¡ Ø§Ù„Ù…Ø­ÙÙˆØ¸</button>
      </div>

      <div class="lbl">Ø§ØªØµØ§Ù„</div>
      <button class="btn success" id="connectBtn">âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>

      <div class="status" id="chatStatus">ğŸ’¡ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØµÙ‘Ø© ÙˆØ£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø© Ø«Ù… Ø§Ø¶ØºØ· ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ÙŠÙ…ÙƒÙ†Ùƒ ØªÙƒØ±Ø§Ø±Ù‡Ø§ Ù„Ù„Ù…Ù†ØµÙ‘Ø© Ø§Ù„Ø£Ø®Ø±Ù‰.</div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (ÙˆØ³Ø· Ø§Ù„ØµÙØ­Ø©) -->
    <div class="panel">
      <div class="panel-title">
        <div class="title-left">
          <span>Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†</span>
          <span class="count-chip" id="playersCount">0 Ù„Ø§Ø¹Ø¨</span>
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn success" id="btnStart">â–¶ï¸ Ø§Ø¨Ø¯Ø£</button>
          <button class="btn accent" id="btnReset">ğŸ” Ø¥Ø¹Ø§Ø¯Ø©</button>
        </div>
      </div>
      <div id="playersGrid" class="grid"></div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ© (ÙˆØ³Ø· Ø§Ù„ØµÙØ­Ø©) -->
    <div class="panel">
      <div class="panel-title">
        <div class="title-left">
          <span>Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©</span>
          <span class="count-chip" id="cardsCount">0 Ø¨Ø·Ø§Ù‚Ø©</span>
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn warn" id="btnShuffleCards">ğŸ”€ Ø®Ù„Ø·</button>
          <button class="btn" id="btnLockAll">ğŸ”’ Ù‚ÙÙ„</button>
          <button class="btn" id="btnUnlockAll">ğŸ”“ ÙØªØ­</button>
        </div>
      </div>
      <div id="cardsGrid" class="grid"></div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© -->
    <div class="status-bar">
      <div style="display:flex;flex-wrap:wrap;gap:8px">
        <span class="chip">Ø§Ù†Ø¶Ù…Ø§Ù… Ù…Ù† Ø§Ù„Ø´Ø§Øª: <b>!Ø¯Ø®ÙˆÙ„</b></span>
        <span class="chip">Ø§Ù„ØªØ­Ù‚Ù‚: Ø§Ø¶ØºØ· Ø¨Ø·Ø§Ù‚Ø© <b>Ù„Ø§Ø¹Ø¨</b> (Ø§Ù„Ù…Ø°ÙƒÙˆØ±) Ø«Ù… Ø§Ø¶ØºØ· Ø¨Ø·Ø§Ù‚Ø© <b>Ø§Ø³Ù… ÙˆÙ‡Ù…ÙŠ</b></span>
        <span class="chip">ØµØ­ âŸµ ØªØ®Ø¶Ø± ÙˆØªÙÙˆØ³Ù… "ØµØ­ÙŠØ­Ø©" ÙˆØªÙÙ‚ØµÙ‰ â€” Ø®Ø·Ø£ âŸµ ØªÙ‡ØªØ² Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±</span>
      </div>
      <div class="hint">Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø± Ù…Ø®ÙÙŠØ©. Ø§ÙØªØ­Ù‡Ø§ Ø¨Ø²Ø± Ø§Ù„Ø£Ø³ÙÙ„ Ø£Ùˆ Alt+G Ø£Ùˆ Ø£Ø¶Ù â€#gmâ€ Ù„Ù„Ø±Ø§Ø¨Ø·.</div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø± (Ù…Ø®ÙÙŠØ© â€“ Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø·) -->
    <div id="gm" class="gm" style="grid-column:1/-1">
      <div class="gm-panel">
        <h3 style="margin:0 0 8px">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø±</h3>

        <div class="row">
          <input id="playerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯)" />
          <button class="btn success" id="addPlayerBtn">Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨</button>
          <span class="hint">Ø£Ùˆ ÙŠÙ†Ø¶Ù…ÙˆÙ† Ù…Ù† Ø§Ù„Ø´Ø§Øª Ø¨Ù€ <b>!Ø¯Ø®ÙˆÙ„</b></span>
        </div>
        <div class="row">
          <input id="fakeWord" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙˆÙ‡Ù…ÙŠ (Ù…Ø«Ø§Ù„: Ø³ÙŠØ§Ø±Ø©)" />
          <select id="fakeOwner"></select>
          <button class="btn success" id="addFakeBtn">Ø¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø©</button>
          <button class="btn" id="clearUnowned">Ø­Ø°Ù Ø¨Ø·Ø§Ù‚Ø§Øª Ø¨Ù„Ø§ Ù…Ø§Ù„Ùƒ</button>
        </div>

        <div class="row" style="width:100%;display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <h4 style="margin:6px 0">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h4>
            <table class="table">
              <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
              <tbody id="playersTable"></tbody>
            </table>
          </div>
          <div>
            <h4 style="margin:6px 0">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</h4>
            <table class="table">
              <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø§Ù„Ùƒ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
              <tbody id="cardsTable"></tbody>
            </table>
          </div>
        </div>

        <div class="row">
          <textarea id="log" placeholder="Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«" style="width:100%;min-height:120px" readonly></textarea>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Ø²Ø± ÙˆØ§Ø¶Ø­ Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø± Ù„ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø± -->
<button id="gmToggle" class="gm-toggle">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø±</button>

<script>
/* ==============================
   Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ù†ØµØ§Øª
   ============================== */
let TWITCH_CHANNEL = "";
let KICK_CHANNEL   = "";
let twitchClient = null;
let kickSocket   = null;
let twitchConnected=false, kickConnected=false;

const LS_KEY_TWITCH='fn_twitch', LS_KEY_KICK='fn_kick';

/* ==============================
   Ø¹Ù†Ø§ØµØ± DOM
   ============================== */
const els = {
  turnLabel: document.getElementById('turnLabel'),

  cardsGrid: document.getElementById('cardsGrid'),
  playersGrid: document.getElementById('playersGrid'),

  // Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
  playersCount: document.getElementById('playersCount'),
  cardsCount: document.getElementById('cardsCount'),

  // Ø£Ø²Ø±Ø§Ø± Ø¹Ø§Ù…Ø©
  btnStart: document.getElementById('btnStart'),
  btnReset: document.getElementById('btnReset'),
  btnShuffleCards: document.getElementById('btnShuffleCards'),
  btnLockAll: document.getElementById('btnLockAll'),
  btnUnlockAll: document.getElementById('btnUnlockAll'),

  // Ø´Ø±ÙŠØ· Ø§Ù„Ø¯Ø®ÙˆÙ„
  platformSelect: document.getElementById('platformSelect'),
  channelInput: document.getElementById('channelInput'),
  remember: document.getElementById('remember'),
  connectBtn: document.getElementById('connectBtn'),
  fillSaved: document.getElementById('fillSaved'),
  chatStatus: document.getElementById('chatStatus'),

  // Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø±
  gm: document.getElementById('gm'),
  gmToggle: document.getElementById('gmToggle'),
  playerName: document.getElementById('playerName'),
  addPlayerBtn: document.getElementById('addPlayerBtn'),
  playersTable: document.getElementById('playersTable'),
  fakeWord: document.getElementById('fakeWord'),
  fakeOwner: document.getElementById('fakeOwner'),
  addFakeBtn: document.getElementById('addFakeBtn'),
  clearUnowned: document.getElementById('clearUnowned'),
  cardsTable: document.getElementById('cardsTable'),
  log: document.getElementById('log')
};

/* ==============================
   Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
   ============================== */
const state = {
  players: [],   // {id,name,eliminated:false}
  cards: [],     // {id,text,ownerId,revealed:false,locked:false}
  turnIndex: -1, // ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
  started: false,

  selectedMentionedId: null, // Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø°ÙƒÙˆØ±
  selectedCardId: null       // Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
};

/* ==============================
   Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
   ============================== */
const uid = ()=> Math.random().toString(36).slice(2,10);
const normalize = s => (s||"").toString().trim().toLowerCase();
function byId(arr,id){ return arr.find(x=>x.id===id); }
function currentPlayer(){ if(state.turnIndex<0||state.turnIndex>=state.players.length) return null; return state.players[state.turnIndex]; }
function alivePlayers(){ return state.players.filter(p=>!p.eliminated); }
function log(t){ els.log.value = `[${new Date().toLocaleTimeString()}] ${t}\n` + els.log.value; }
function updateTurnLabel(){ const p=currentPlayer(); els.turnLabel.textContent = (p && !p.eliminated)?p.name:'-'; }

/* ==============================
   Ø¹Ø¯Ø§Ø¯Ø§Øª
   ============================== */
function updateCounts(){
  const nP = state.players.length;
  const nC = state.cards.length;
  els.playersCount.textContent = `${nP} Ù„Ø§Ø¹Ø¨`;
  els.cardsCount.textContent   = `${nC} Ø¨Ø·Ø§Ù‚Ø©`;
}

/* ==============================
   ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙÙŠ GM
   ============================== */
function updateSelects(){
  const setOpts=(el,items,withNone=false)=>{
    el.innerHTML=''; if(withNone){const o=document.createElement('option');o.value='';o.textContent='â€”';el.append(o);}
    items.forEach(it=>{const o=document.createElement('option');o.value=it.value;o.textContent=it.label;el.append(o);});
  };
  setOpts(els.fakeOwner, state.players.map(p=>({value:p.id,label:p.name})), true);
}

/* ==============================
   Ø±Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (ÙˆØ³Ø· Ø§Ù„ØµÙØ­Ø© + Ø¬Ø¯Ø§ÙˆÙ„ GM)
   ============================== */
function renderPlayers(){
  els.playersGrid.innerHTML='';
  state.players.forEach((p,idx)=>{
    const el=document.createElement('div'); el.className='card'; el.dataset.id=p.id;
    if (state.selectedMentionedId===p.id) el.classList.add('selected');
    if (p.eliminated) el.style.opacity=.55, el.style.filter='saturate(.6)';

    el.onclick=()=>{
      if (p.eliminated) return;
      state.selectedMentionedId=p.id;
      document.querySelectorAll('#playersGrid .card').forEach(x=>x.classList.remove('selected'));
      el.classList.add('selected');
      tryResolveIfReady();
    };

    const badge=document.createElement('span'); badge.className='badge'; badge.textContent=p.eliminated?'Ù…Ù‚ØµÙ‰':(idx===state.turnIndex?'Ø§Ù„Ø¯ÙˆØ±':'Ø¬Ø§Ù‡Ø²');
    const t=document.createElement('div'); t.className='text'; t.textContent=p.name;
    el.append(badge,t);
    els.playersGrid.append(el);
  });

  // Ø¬Ø¯Ø§ÙˆÙ„ GM
  els.playersTable.innerHTML='';
  state.players.forEach((p,idx)=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=p.name;
    const td2=document.createElement('td'); td2.textContent=p.eliminated?'Ù…Ù‚ØµÙ‰':'Ù†Ø´Ø·';
    const td3=document.createElement('td');
    const elim=document.createElement('button'); elim.className='btn accent'; elim.textContent=p.eliminated?'Ø¥Ø±Ø¬Ø§Ø¹':'Ø¥Ù‚ØµØ§Ø¡';
    elim.onclick=()=>{ p.eliminated=!p.eliminated; if (state.turnIndex===idx && p.eliminated) nextTurnAuto(); renderPlayers(); updateTurnLabel(); };
    const del=document.createElement('button'); del.className='btn'; del.textContent='Ø­Ø°Ù';
    del.onclick=()=>{ state.cards.forEach(c=>{ if(c.ownerId===p.id) c.ownerId=null; }); state.players=state.players.filter(x=>x.id!==p.id); if(state.turnIndex>=state.players.length) state.turnIndex=state.players.length-1; renderPlayers(); renderCards(); updateTurnLabel(); };
    td3.append(elim,document.createTextNode(' '),del);
    tr.append(td1,td2,td3); els.playersTable.append(tr);
  });

  updateCounts();
  updateSelects();
  updateTurnLabel();
}

/* ==============================
   Ø±Ø³Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª (ÙˆØ³Ø· Ø§Ù„ØµÙØ­Ø© + Ø¬Ø¯Ø§ÙˆÙ„ GM)
   ============================== */
function renderCards(){
  els.cardsGrid.innerHTML='';
  state.cards.forEach(c=>{
    const el=document.createElement('div'); el.className='card'; el.dataset.id=c.id;
    if (c.revealed) el.classList.add('revealed');      // Ø®Ø¶Ø±Ø§Ø¡ Ø¥Ø°Ø§ ØµØ­ÙŠØ­Ø©
    if (state.selectedCardId===c.id) el.classList.add('selected');

    el.onclick=()=>{
      if (!state.started){ log('Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹.'); return; }
      if (c.locked){ log('Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ù‚ÙÙ„Ø©.'); return; }
      // Ù„Ø§ Ù†Ø®ÙÙŠ Ø§Ù„Ù†Øµ â€” Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆØ§Ø¶Ø­Ø© Ø¯ÙˆÙ…Ù‹Ø§
      if (c.revealed){ log('Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ØµØ§Ø±Øª ØµØ­ÙŠØ­Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§.'); return; }
      state.selectedCardId=c.id;
      document.querySelectorAll('#cardsGrid .card').forEach(x=>x.classList.remove('selected','wrong'));
      el.classList.add('selected');
      tryResolveIfReady();
    };

    const badge=document.createElement('span'); badge.className='badge';
    badge.textContent = c.revealed ? 'ØµØ­ÙŠØ­Ø©' : (c.locked ? 'Ù…Ù‚ÙÙ„Ø©' : 'Ø¬Ø§Ù‡Ø²Ø©');

    const t=document.createElement('div'); t.className='text';
    t.textContent = c.text; // ğŸ‘ˆ ÙˆØ§Ø¶Ø­Ø© Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©

    el.append(badge,t);
    els.cardsGrid.append(el);
  });

  // Ø¬Ø¯Ø§ÙˆÙ„ GM
  els.cardsTable.innerHTML='';
  state.cards.forEach(c=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=c.text;
    const td2=document.createElement('td'); td2.textContent=(byId(state.players,c.ownerId)?.name)||'â€”';
    const td3=document.createElement('td'); td3.textContent=(c.revealed?'ØµØ­ÙŠØ­Ø©':'â€”')+(c.locked?' / Ù…Ù‚ÙÙ„Ø©':'');
    const td4=document.createElement('td');
    const lock=document.createElement('button'); lock.className='btn'; lock.textContent=c.locked?'ÙØªØ­':'Ù‚ÙÙ„'; lock.onclick=()=>{ c.locked=!c.locked; renderCards(); };
    const del=document.createElement('button'); del.className='btn accent'; del.textContent='Ø­Ø°Ù'; del.onclick=()=>{ state.cards=state.cards.filter(x=>x.id!==c.id); renderCards(); };
    td4.append(lock,document.createTextNode(' '),del);
    tr.append(td1,td2,td3,td4); els.cardsTable.append(tr);
  });

  updateCounts();
}

/* ==============================
   Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¯ÙˆØ±
   ============================== */
function startGame(){
  if (alivePlayers().length===0){ log('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ†.'); return; }
  if (state.cards.length===0){ log('Ø£Ø¶Ù Ø¨Ø·Ø§Ù‚Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.'); return; }
  state.started = true;
  state.turnIndex = state.players.findIndex(p=>!p.eliminated);
  if (state.turnIndex<0) state.turnIndex = 0;
  log('Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©.');
  renderPlayers(); renderCards(); updateTurnLabel();
}
function nextTurnAuto(){
  if (!state.started) return;
  const n = state.players.length; if (!n) return;
  let i = state.turnIndex;
  for (let step=0; step<n; step++){
    i = (i+1) % n;
    if (!state.players[i].eliminated){ state.turnIndex = i; break; }
  }

  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
  state.selectedMentionedId = null;
  state.selectedCardId = null;
  document.querySelectorAll('.card').forEach(x=>x.classList.remove('selected','wrong'));

  // Ø§Ù„ÙÙˆØ² Ø¥Ø°Ø§ Ø¨Ù‚ÙŠ Ù„Ø§Ø¹Ø¨ ÙˆØ§Ø­Ø¯
  if (alivePlayers().length<=1){
    const champ = alivePlayers()[0];
    log(champ?`ğŸ‰ Ø§Ù„ÙØ§Ø¦Ø²: ${champ.name}`:'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ§Ø¦Ø².');
  }
  renderPlayers();
  updateTurnLabel();
}
function resetGame(){
  state.started=false; state.turnIndex=-1;
  state.players.forEach(p=>p.eliminated=false);
  state.cards.forEach(c=>{c.revealed=false;c.locked=false;});
  state.selectedMentionedId=null; state.selectedCardId=null;
  log('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©.');
  renderPlayers(); renderCards(); updateTurnLabel();
}

/* ==============================
   Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
   ============================== */
function tryResolveIfReady(){
  const turnP = currentPlayer();
  if (!turnP || turnP.eliminated) return;

  const mentionedId = state.selectedMentionedId;
  const cardId = state.selectedCardId;
  if (!mentionedId || !cardId) return;

  const mentioned = byId(state.players, mentionedId);
  const card = byId(state.cards, cardId);
  if (!mentioned || !card || card.locked) return;

  const owner = byId(state.players, card.ownerId);
  const correct = !!owner && owner.id === mentioned.id;

  const cardEl = document.querySelector(`#cardsGrid .card[data-id="${card.id}"]`);

  if (correct){
    card.revealed = true; // ØªØµØ¨Ø­ Ø®Ø¶Ø±Ø§Ø¡ ÙˆØªÙÙˆØ³Ù… "ØµØ­ÙŠØ­Ø©"
    if (!mentioned.eliminated){
      mentioned.eliminated = true;
      log(`âœ… ØµØ­ÙŠØ­! "${card.text}" ØªØ®Øµ ${mentioned.name}. ØªÙ… Ø¥Ù‚ØµØ§Ø¤Ù‡.`);
    } else {
      log(`âœ… ØµØ­ÙŠØ­! "${card.text}" ØªØ®Øµ ${mentioned.name} (ÙƒØ§Ù† Ù…Ù‚ØµÙ‰).`);
    }
  } else {
    // Ø§Ù‡ØªØ²Ø§Ø² ÙˆØ¥Ø¨Ø±Ø§Ø² Ø®Ø·Ø£
    if (cardEl){ cardEl.classList.add('wrong'); setTimeout(()=>cardEl.classList.remove('wrong'), 350); }
    log(`âŒ Ø®Ø·Ø£! "${card.text}" Ù„Ø§ ØªØ®Øµ ${mentioned.name}.`);
  }

  renderPlayers(); renderCards(); // Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
  nextTurnAuto();
}

/* ==============================
   Ø£Ø²Ø±Ø§Ø± Ø¹Ø§Ù…Ø©
   ============================== */
els.btnStart.onclick = startGame;
els.btnReset.onclick = resetGame;
els.btnShuffleCards.onclick = ()=>{
  for(let i=state.cards.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [state.cards[i],state.cards[j]]=[state.cards[j],state.cards[i]]; }
  renderCards();
};
els.btnLockAll.onclick   = ()=>{ state.cards.forEach(c=>c.locked=true); renderCards(); };
els.btnUnlockAll.onclick = ()=>{ state.cards.forEach(c=>c.locked=false); renderCards(); };

/* ==============================
   Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø± (Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø·)
   ============================== */
els.addPlayerBtn.onclick=()=>{
  const name=els.playerName.value.trim(); if(!name) return;
  if(!state.players.some(p=>normalize(p.name)===normalize(name))){
    state.players.push({id:uid(),name,eliminated:false});
    els.playerName.value=''; renderPlayers(); updateTurnLabel();
  } else { log('Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§.'); }
};
els.addFakeBtn.onclick=()=>{
  const text=els.fakeWord.value.trim(); const ownerId=els.fakeOwner.value||null; if(!text) return;
  state.cards.push({id:uid(),text,ownerId,revealed:false,locked:false});
  els.fakeWord.value=''; renderCards(); updateSelects();
};
els.clearUnowned.onclick=()=>{ state.cards = state.cards.filter(c=>!!c.ownerId); renderCards(); updateSelects(); };

function setGmVisibility(show){ els.gm.classList.toggle('open', !!show); }
els.gmToggle.onclick = ()=> setGmVisibility(!els.gm.classList.contains('open'));
setGmVisibility(location.hash==='#gm');
window.addEventListener('keydown',e=>{ if(e.altKey && (e.key.toLowerCase()==='g')) setGmVisibility(!els.gm.classList.contains('open')); });

/* ==============================
   Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø´Ø§Øª
   ============================== */
function handleChatJoin(user){
  if (!user) return;
  if (state.players.some(p=>normalize(p.name)===normalize(user))) return;
  state.players.push({id:uid(),name:user,eliminated:false});
  renderPlayers(); updateTurnLabel(); log(`Ø§Ù†Ø¶Ù… ${user} Ø¥Ù„Ù‰ Ø§Ù„Ù„Ø¹Ø¨Ø©.`);
}
function handleChatAttempt(user, message, platform){
  if (!state.started) return;
  const turnP = currentPlayer(); if (!turnP) return;
  if (normalize(turnP.name)!==normalize(user)) return;
  const parts=(message||'').trim().split(/\s+/).filter(Boolean);
  if (parts.length>=2){
    const mentionedName=parts[0];
    const cardText=parts.slice(1).join(' ');
    const mentioned = state.players.find(p=>normalize(p.name)===normalize(mentionedName));
    const card = state.cards.find(c=>normalize(c.text)===normalize(cardText));
    if (mentioned){ state.selectedMentionedId = mentioned.id; }
    if (card && !card.revealed && !card.locked){ state.selectedCardId = card.id; }
    log(`ğŸ“¨ (${platform}) ${user}: ÙŠÙ‚ØªØ±Ø­ Ø£Ù† ${mentionedName} ØªØ­Øª "${cardText}"`);
    renderPlayers(); renderCards(); tryResolveIfReady();
  }
}

/* Twitch */
function connectTwitch(channel){
  try{
    twitchClient = new tmi.Client({ channels:[channel], connection:{secure:true,reconnect:true} });
    twitchClient.connect()
      .then(()=>{ TWITCH_CHANNEL=channel; twitchConnected=true; els.chatStatus.textContent=`âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Twitch: #${channel}`; log(`âœ… Twitch Ù…ØªØµÙ„: #${channel}`); if (els.remember.checked) localStorage.setItem(LS_KEY_TWITCH, channel); })
      .catch(e=>{ els.chatStatus.textContent=`âŒ ÙØ´Ù„ Ø§ØªØµØ§Ù„ Twitch`; log('âŒ ÙØ´Ù„ Ø§ØªØµØ§Ù„ Twitch: '+e); });
    twitchClient.on('message',(ch,tags,message,self)=>{
      if(self) return;
      const user = tags['display-name'] || tags.username || 'Ù…Ø´Ø§Ø±Ùƒ';
      const text = (message||'').trim();
      if (text==='!Ø¯Ø®ÙˆÙ„'){ handleChatJoin(user); return; }
      handleChatAttempt(user, text, 'twitch');
    });
  }catch(e){ els.chatStatus.textContent=`âŒ Ø®Ø·Ø£ ÙÙŠ Twitch`; log('Ø®Ø·Ø£ Twitch: '+e.message); }
}

/* Kick (API + Pusher) */
async function connectKick(channel){
  try{
    const res = await fetch(`https://kick.com/api/v2/channels/${channel}`);
    const data = await res.json();
    const roomId = data?.chatroom?.id;
    if (!roomId){ els.chatStatus.textContent='âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ ØºØ±ÙØ© ÙƒÙŠÙƒ'; return; }

    const ws = new WebSocket("wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=8.4.0-rc2&flash=false");
    kickSocket = ws;
    ws.onopen = ()=>{
      ws.send(JSON.stringify({event:"pusher:subscribe",data:{auth:"",channel:`chatrooms.${roomId}.v2`}}));
      setInterval(()=>{ if(ws.readyState===WebSocket.OPEN){ ws.send(JSON.stringify({event:"pusher:ping",data:{}})); } },12000);
      KICK_CHANNEL=channel; kickConnected=true; els.chatStatus.textContent=`âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Kick: ${channel}`; log(`âœ… Kick Ù…ØªØµÙ„: ${channel}`);
      if (els.remember.checked) localStorage.setItem(LS_KEY_KICK, channel);
    };
    ws.onmessage = (event)=>{
      const pkt = JSON.parse(event.data);
      if (pkt.event === "App\\Events\\ChatMessageEvent"){
        const d = JSON.parse(pkt.data);
        const user = d?.sender?.username || 'Ù…Ø´Ø§Ø±Ùƒ';
        const text = (d?.content || '').trim();
        if (text==='!Ø¯Ø®ÙˆÙ„'){ handleChatJoin(user); return; }
        handleChatAttempt(user, text, 'kick');
      }
    };
    ws.onerror = ()=>{ els.chatStatus.textContent='âŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§ØªØµØ§Ù„ Kick'; log('âŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§ØªØµØ§Ù„ Kick'); };
  }catch(e){
    els.chatStatus.textContent='âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Kick';
    log('Kick error: '+e.message);
  }
}

/* Ø²Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© */
els.fillSaved.onclick = ()=>{
  els.channelInput.value = (els.platformSelect.value==='twitch')
    ? (localStorage.getItem(LS_KEY_TWITCH)||'')
    : (localStorage.getItem(LS_KEY_KICK)||'');
};
els.connectBtn.onclick = ()=>{
  const platform = els.platformSelect.value;
  const channel  = els.channelInput.value.trim();
  if (!channel){ els.chatStatus.textContent='âš ï¸ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹'; return; }
  if (els.remember.checked){
    if (platform==='twitch') localStorage.setItem(LS_KEY_TWITCH, channel);
    else localStorage.setItem(LS_KEY_KICK, channel);
  }
  if (platform==='twitch'){ connectTwitch(channel); } else { connectKick(channel); }
};

/* ==============================
   Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø©
   ============================== */
function updateAll(){ renderPlayers(); renderCards(); updateSelects(); updateTurnLabel(); updateCounts(); }
updateAll();

// Ø¯Ø¹Ù… #gm Ùˆ Alt+G Ù„ÙØªØ­ Ø§Ù„Ù„ÙˆØ­Ø©
function setGmVisibility(show){ els.gm.classList.toggle('open', !!show); }
setGmVisibility(location.hash==='#gm');
window.addEventListener('keydown',e=>{ if(e.altKey && (e.key.toLowerCase()==='g')) setGmVisibility(!els.gm.classList.contains('open')); });
</script>
</body>
</html>