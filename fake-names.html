<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ­ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ© - Ù†Ø³Ø®Ø© Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ†</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      /* Ø£Ù„ÙˆØ§Ù† 2026 Ø§Ù„Ø¨Ø±ÙŠÙ…ÙŠÙˆÙ… */
      --bg:#15171d;
      --bg-soft:#1b1e26;
      --panel:rgba(26,29,38,0.96);
      --panel-soft:rgba(24,27,36,0.9);
      --card:#20232e;
      --line:#2f3440;
      --line-soft:#3a4050;

      /* Ø£Ù„ÙˆØ§Ù† Ù…ÙŠØ¯Ùˆ Ø§Ù„Ø¨Ø±ÙŠÙ…ÙŠÙˆÙ… */
      --accent:#ff3b3b;      /* Ø£Ø­Ù…Ø± DV ÙØ®Ù… */
      --accent-soft:#ff5555;
      --green:#22c58b;       /* Ø²Ù…Ø±Ø¯ÙŠ */
      --green-soft:#26d39a;
      --blue:#3a8fff;        /* Ø£Ø²Ø±Ù‚ ØªÙ‚Ù†ÙŠ Ù†Ø§Ø¹Ù… */
      --blue-soft:#5aa4ff;
      --yellow:#f1c75c;      /* Ø°Ù‡Ø¨ÙŠ Ù‡Ø§Ø¯ÙŠ */
      --text:#f2f4fb;
      --muted:#a3afc7;
      --muted-soft:#8d98b0;
      --danger:#ff6262;

      --radius-lg:16px;
      --radius-md:12px;
      --radius-sm:10px;
      --shadow-soft:0 14px 40px rgba(0,0,0,0.45);
      --shadow-subtle:0 8px 22px rgba(0,0,0,0.35);
      --border-1:1px solid var(--line);
    }

    *{
      box-sizing:border-box;
      -webkit-tap-highlight-color:transparent;
    }

    body{
      margin:0;
      min-height:100vh;
      color:var(--text);
      font-family:'Cairo',system-ui;
      display:flex;
      flex-direction:column;
      background:
        radial-gradient(circle at top left,#303646 0,#15171d 42%,#101218 82%);
      position:relative;
      overflow-x:hidden;
    }

    /* Ø·Ø¨Ù‚Ø© Ø®ÙÙŠÙØ© ÙÙˆÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ© */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:
        radial-gradient(circle at top right,rgba(255,59,59,0.07),transparent 55%),
        radial-gradient(circle at bottom left,rgba(58,143,255,0.06),transparent 60%);
      pointer-events:none;
      z-index:-1;
    }

    header{
      padding:14px 24px;
      border-bottom:1px solid rgba(53,59,75,0.8);
      background:linear-gradient(180deg,rgba(18,19,25,0.96),rgba(16,18,24,0.96));
      backdrop-filter: blur(14px);
      position:sticky;
      top:0;
      z-index:30;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      box-shadow:0 10px 32px rgba(0,0,0,0.65);
    }

    header .title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.4px;
      font-size:18px;
    }

    header .dot{
      width:11px;
      height:11px;
      border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 0 0 rgba(255,59,59,0.7);
      animation:dotPulse 2.3s ease-out infinite;
    }
    @keyframes dotPulse{
      0%{box-shadow:0 0 0 0 rgba(255,59,59,0.7);}
      70%{box-shadow:0 0 0 9px rgba(255,59,59,0);}
      100%{box-shadow:0 0 0 0 rgba(255,59,59,0);}
    }

    header .right{
      display:flex;
      gap:10px;
      color:var(--muted);
      font-size:14px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    header .status-pill{
      padding:6px 11px;
      border-radius:999px;
      border:1px solid rgba(66,72,89,0.9);
      background:linear-gradient(180deg,#181b24,#141720);
      color:var(--muted-soft);
      display:flex;
      align-items:center;
      gap:6px;
      font-size:13px;
      box-shadow:0 4px 14px rgba(0,0,0,0.5);
    }

    header .status-pill b{
      color:var(--accent-soft);
    }

    /* Ù…Ø±ÙƒØ² Ø§Ù„ØµÙØ­Ø© */
    .wrap{
      flex:1;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:18px 18px 26px;
    }
    .container{
      width:min(1200px,96vw);
      margin:0 auto;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:18px;
    }
    @media (max-width:980px){
      .container{grid-template-columns:1fr;}
    }

    /* Ø¨Ø§Ù†Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ */
    .turn-banner{
      grid-column:1/-1;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background:linear-gradient(120deg,rgba(30,34,45,.98),rgba(26,29,40,.96));
      border-radius:var(--radius-lg);
      padding:12px 14px;
      position:relative;
      overflow:hidden;
      border:1px solid rgba(74,82,103,0.9);
      box-shadow:var(--shadow-subtle);
    }

    .turn-banner::before{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(120deg,rgba(255,59,59,0.12),rgba(58,143,255,0.04));
      mix-blend-mode:soft-light;
      opacity:.7;
      pointer-events:none;
    }

    .turn-banner .left{
      display:flex;
      align-items:center;
      gap:12px;
      position:relative;
      z-index:1;
    }

    .turn-badge{
      font-size:12px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(82,90,116,0.95);
      background:radial-gradient(circle at top,#202633,#171a23);
      color:#d7e1ff;
      letter-spacing:.2px;
    }

    .turn-name{
      font-weight:900;
      font-size:22px;
      letter-spacing:.3px;
      text-shadow:0 0 14px rgba(0,0,0,0.7);
    }

    /* Ù…Ø¤Ù‚Øª Ø§Ù„Ø¯ÙˆØ± */
    .turn-timer {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 6px;
    }

    .timer-circle {
        position: relative;
        width: 36px;
        height: 36px;
    }

    .timer-circle svg {
        width: 36px;
        height: 36px;
        transform: rotate(-90deg);
    }

    .timer-bg {
        fill: none;
        stroke: var(--line-soft);
        stroke-width: 3;
    }

    .timer-progress {
        fill: none;
        stroke: var(--green);
        stroke-width: 3;
        stroke-linecap: round;
        stroke-dasharray: 113;
        stroke-dashoffset: 113;
        transition: stroke-dashoffset 1s linear;
    }

    .timer-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 11px;
        font-weight: 800;
        color: var(--text);
        text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    }

    /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ù…Ø© */
    .btn{
      cursor:pointer;
      user-select:none;
      border-radius:var(--radius-md);
      border:1px solid rgba(74,82,103,0.95);
      padding:8px 12px;
      background:linear-gradient(180deg,#222634,#181b26);
      color:var(--text);
      font-weight:700;
      font-size:13px;
      transition:transform .12s ease,box-shadow .12s ease,background .12s ease,border-color .12s ease,opacity .12s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 8px 20px rgba(0,0,0,0.65);
    }
    .btn:active{
      transform:translateY(0);
      box-shadow:0 4px 10px rgba(0,0,0,0.7);
      opacity:.9;
    }

    .btn.success{
      background:linear-gradient(180deg,#1b3a30,#12241e);
      border-color:rgba(47,133,95,0.95);
      color:#c5f7e5;
    }
    .btn.success:hover{
      box-shadow:0 9px 22px rgba(15,118,84,0.65);
    }

    .btn.warn{
      background:linear-gradient(180deg,#3b331c,#201a11);
      border-color:rgba(149,116,50,0.95);
      color:#ffeab9;
    }

    .btn.accent{
      background:linear-gradient(180deg,#412024,#261114);
      border-color:rgba(200,76,89,0.95);
      color:#ffe0e0;
    }

    /* Ø§Ù„Ø£Ù„ÙˆØ§Ø­ Ø§Ù„ÙˆØ³Ø·ÙŠØ© */
    .panel{
      background:var(--panel-soft);
      border-radius:var(--radius-lg);
      padding:14px 14px 12px;
      box-shadow:var(--shadow-soft);
      position:relative;
      overflow:hidden;
      border:1px solid rgba(67,74,92,0.95);
    }

    .panel::before{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(135deg,rgba(255,255,255,0.009),rgba(255,255,255,0));
      pointer-events:none;
    }

    .panel-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
      font-weight:700;
      color:var(--muted);
      position:relative;
      z-index:1;
    }

    .title-left{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:14px;
    }

    .title-left span:first-child{
      font-weight:800;
      color:#e4e8f7;
    }

    .count-chip{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(83,92,116,0.95);
      background:radial-gradient(circle at top,#222736,#181b24);
      color:#d2ddff;
    }

    /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
    .grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(160px,1fr));
      gap:10px;
      position:relative;
      z-index:1;
    }
    @media (max-width:900px){
      .grid{grid-template-columns:repeat(2,minmax(140px,1fr));}
    }
    @media (max-width:620px){
      .grid{grid-template-columns:repeat(1,minmax(220px,1fr));}
    }

    .card{
      user-select:none;
      cursor:pointer;
      border-radius:14px;
      padding:16px 14px;
      min-height:74px;
      background:radial-gradient(circle at top,#262a38,#191c26);
      border:1px solid rgba(71,79,102,0.95);
      text-align:center;
      position:relative;
      box-shadow:0 10px 24px rgba(0,0,0,0.72);
      transition:transform .12s ease,box-shadow .12s ease,border-color .12s ease,background .12s ease,opacity .12s ease;
    }

    .card:hover{
      transform:translateY(-2px);
      box-shadow:0 14px 30px rgba(0,0,0,0.8);
    }

    .card .badge{
      position:absolute;
      top:8px;
      inset-inline-start:8px;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      color:#d7e2ff;
      background:rgba(17,20,29,0.96);
      border:1px solid rgba(86,95,122,0.95);
      letter-spacing:.1px;
    }

    .card .text{
      font-weight:800;
      font-size:20px;
      letter-spacing:.3px;
      text-shadow:0 0 12px rgba(0,0,0,0.8);
    }

    /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† */
    .card.winner {
        background: radial-gradient(circle at top, #1f3a30, #13231c) !important;
        border: 2px solid var(--green-soft) !important;
        box-shadow: 0 0 20px var(--green-soft) !important;
        animation: winnerGlow 2s infinite alternate;
    }

    @keyframes winnerGlow {
        from { box-shadow: 0 0 10px var(--green-soft); }
        to { box-shadow: 0 0 30px var(--green-soft); }
    }

    .player-correct {
        position: absolute;
        bottom: 8px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 11px;
        color: var(--green-soft);
        background: rgba(34, 197, 139, 0.1);
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid rgba(34, 197, 139, 0.3);
        white-space: nowrap;
    }

    .card.selected{
      outline:2px solid var(--blue-soft);
      box-shadow:0 0 0 1px rgba(90,164,255,0.55),0 14px 32px rgba(26,115,232,0.55);
      border-color:rgba(110,171,255,0.95);
      background:radial-gradient(circle at top,#28344a,#1a2130);
    }

    .card.revealed{
      background:radial-gradient(circle at top,#1f3a30,#13231c);
      border-color:rgba(49,140,101,0.95);
      box-shadow:0 14px 36px rgba(16,120,84,0.7);
    }

    .card.revealed .badge{
      background:rgba(13,40,29,0.98);
      border-color:rgba(79,168,121,0.95);
      color:#c3f3de;
    }

    .card.wrong{
      animation:shake .32s;
      box-shadow:0 0 0 2px rgba(255,98,98,.7) inset,0 0 20px rgba(255,98,98,0.6);
      border-color:rgba(255,122,122,0.95);
      background:radial-gradient(circle at top,#3a2024,#241014);
    }

    @keyframes shake{
      10%,90%{transform:translateX(-1px);}
      20%,80%{transform:translateX(2px);}
      30%,50%,70%{transform:translateX(-4px);}
      40%,60%{transform:translateX(4px);}
      100%{transform:translateX(0);}
    }

    /* ÙÙ„Ø§Ø´ Ø£Ø­Ù…Ø± Ù„Ù„Ø®Ø·Ø£ */
    .flash-red{position:relative;}
    .flash-red::after{
      content:"";
      position:absolute;
      inset:0;
      background:rgba(255,0,0,.16);
      animation:fadeFlash .35s ease-out forwards;
      border-radius:14px;
    }
    @keyframes fadeFlash{
      from{opacity:1;}
      to{opacity:0;}
    }

    .status-bar{
      grid-column:1/-1;
      background:rgba(24,27,36,0.9);
      border-radius:var(--radius-lg);
      padding:10px 14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      border:1px dashed rgba(81,88,110,0.95);
      box-shadow:0 10px 26px rgba(0,0,0,0.65);
      position:relative;
      overflow:hidden;
    }

    .status-bar::before{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(120deg,rgba(255,255,255,0.01),rgba(255,255,255,0));
      pointer-events:none;
    }

    .status-bar > *{
      position:relative;
      z-index:1;
    }

    .chip{
      font-size:12px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(83,92,116,0.96);
      background:radial-gradient(circle at top,#202533,#181b23);
      color:#d3ddff;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .chip b{
      color:var(--accent-soft);
    }

    .hint{
      font-size:12px;
      color:var(--muted-soft);
    }

    /* Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… Ø§Ù„Ø¬ÙˆÙ„Ø© */
    .round-progress {
        grid-column: 1/-1;
        background: linear-gradient(135deg, rgba(30,33,43,.96), rgba(22,25,34,.96));
        border-radius: var(--radius-md);
        padding: 10px 14px;
        display: flex;
        align-items: center;
        gap: 15px;
        margin-top: 10px;
        border: 1px solid rgba(67,74,92,0.95);
        box-shadow: var(--shadow-subtle);
    }

    .progress-bar {
        flex: 1;
        height: 8px;
        background: var(--line);
        border-radius: 4px;
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent), var(--yellow));
        border-radius: 4px;
        width: 0%;
        transition: width 0.5s ease;
        box-shadow: 0 0 10px rgba(255, 59, 59, 0.4);
    }

    .round-label {
        font-size: 12px;
        color: var(--muted-soft);
        white-space: nowrap;
    }

    .round-label span {
        color: var(--text);
        font-weight: 800;
        background: var(--accent);
        padding: 2px 8px;
        border-radius: 999px;
        margin-right: 4px;
    }

    /* Ø£Ø³Ø·ÙˆØ±Ø© Ø£Ù„ÙˆØ§Ù† */
    .legend{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .legend .lg{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(83,92,116,0.9);
      background:radial-gradient(circle at top,#202533,#181b23);
      color:#d3ddff;
    }
    .dot-sm{
      width:10px;
      height:10px;
      border-radius:50%;
      box-shadow:0 0 10px rgba(0,0,0,0.6);
    }
    .d-green{background:var(--green-soft);}
    .d-yellow{background:var(--yellow);}
    .d-blue{background:var(--blue-soft);}
    .d-red{background:var(--danger);}

    /* Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø± â€” Ù…Ø®ÙÙŠØ© Ø¹Ù† Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† */
    .gm{
      display:none;
    }
    .gm.open{
      display:block;
    }

    .gm .gm-panel{
      background:var(--panel-soft);
      border-radius:var(--radius-lg);
      padding:12px 12px 10px;
      margin-top:8px;
      border:1px solid rgba(74,82,103,0.95);
      box-shadow:var(--shadow-soft);
      position:relative;
      overflow:hidden;
    }

    .gm .gm-panel::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at top left,rgba(255,59,59,0.08),transparent 55%);
      opacity:.7;
      pointer-events:none;
    }

    .gm h3{
      margin:0 0 8px;
      font-size:16px;
      color:#f1f4ff;
      position:relative;
      z-index:1;
    }

    .gm .row{
      display:flex;
      gap:8px;
      margin-bottom:8px;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }

    .gm input,
    .gm select,
    .gm textarea{
      background:radial-gradient(circle at top,#191c25,#13151d);
      border:1px solid rgba(73,81,104,0.95);
      color:var(--text);
      padding:8px 10px;
      border-radius:var(--radius-md);
      outline:none;
      font-size:13px;
      box-shadow:0 6px 18px rgba(0,0,0,0.55) inset;
    }

    .gm textarea{
      resize:vertical;
    }

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 6px;
      font-size:13px;
    }

    .table td,
    .table th{
      padding:8px 10px;
      background:#151822;
      border:1px solid rgba(68,75,99,0.95);
    }

    .table th{
      color:var(--muted);
      font-weight:700;
      text-align:inherit;
      background:#181b26;
    }

    .table tr td:first-child,
    .table tr th:first-child{
      border-top-right-radius:10px;
      border-bottom-right-radius:10px;
    }
    .table tr td:last-child,
    .table tr th:last-child{
      border-top-left-radius:10px;
      border-bottom-left-radius:10px;
    }

    .gm .hint{
      color:var(--muted-soft);
    }

    /* Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
    .stats-panel {
        grid-column: 1/-1;
        background: linear-gradient(135deg, rgba(30,33,43,.96), rgba(22,25,34,.96));
        border-radius: var(--radius-lg);
        padding: 12px;
        margin-top: 10px;
        border: 1px solid rgba(67,74,92,0.95);
        box-shadow: var(--shadow-soft);
    }

    .stats-panel h4 {
        margin: 0 0 10px;
        font-size: 14px;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 10px;
    }

    .stat-card {
        background: radial-gradient(circle at top, #222736, #181b24);
        border: 1px solid rgba(83,92,116,0.95);
        border-radius: var(--radius-md);
        padding: 12px;
        text-align: center;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .stat-label {
        font-size: 11px;
        color: var(--muted-soft);
        display: block;
        margin-bottom: 6px;
    }

    .stat-value {
        font-size: 18px;
        font-weight: 800;
        color: var(--text);
        display: block;
    }

    .stat-subtitle {
        font-size: 10px;
        color: var(--muted);
        margin-top: 4px;
    }

    /* Ø²Ø± ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø± */
    .gm-toggle{
      position:fixed;
      inset-inline-start:16px;
      bottom:16px;
      z-index:60;
      background:radial-gradient(circle at top,#262a38,#191c24);
      border-radius:var(--radius-lg);
      padding:9px 13px;
      color:var(--text);
      font-weight:800;
      cursor:pointer;
      opacity:.92;
      border:1px solid rgba(84,92,116,0.95);
      box-shadow:0 14px 32px rgba(0,0,0,0.8);
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .gm-toggle:hover{
      transform:translateY(-2px);
      box-shadow:0 18px 40px rgba(0,0,0,0.9);
    }

    /* Ø²Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª */
    .help-btn{
      cursor:pointer;
      border-radius:var(--radius-md);
      border:1px solid rgba(80,88,112,0.95);
      background:radial-gradient(circle at top,#1c2030,#151823);
      padding:7px 10px;
      font-weight:800;
      font-size:13px;
      color:#dde5ff;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 8px 20px rgba(0,0,0,0.65);
    }

    .help-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 26px rgba(0,0,0,0.8);
    }

    .help-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.72);
      backdrop-filter:blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:80;
    }

    .help-card{
      width:min(760px,92vw);
      background:radial-gradient(circle at top,#252938,#191b25);
      border-radius:var(--radius-lg);
      padding:16px 16px 14px;
      border:1px solid rgba(82,90,116,0.95);
      box-shadow:0 22px 60px rgba(0,0,0,0.95);
      color:var(--text);
    }

    .help-card h3{
      margin:0 0 10px;
      font-size:18px;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .help-steps{
      display:grid;
      gap:10px;
      margin-top:6px;
    }

    .help-step{
      display:flex;
      gap:10px;
      align-items:flex-start;
      border-radius:var(--radius-md);
      padding:10px;
      border:1px solid rgba(82,90,116,0.95);
      background:radial-gradient(circle at top,#212636,#171a23);
    }

    .help-step .num{
      width:28px;
      height:28px;
      border-radius:10px;
      background:radial-gradient(circle at top,#292f42,#1c1f2a);
      border:1px solid rgba(95,104,133,0.95);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:13px;
      color:#e8edff;
      box-shadow:0 6px 16px rgba(0,0,0,0.8);
    }

    .help-step div:last-child{
      font-size:13px;
      color:#d8def5;
    }

    .help-close{
      margin-top:10px;
      display:flex;
      justify-content:flex-end;
    }

    /* Ù„Ø§ØµÙ‚ Ø¢Ø®Ø± Ø­Ø¯Ø« */
    .last-event{
      position:fixed;
      inset-inline-end:16px;
      top:74px;
      z-index:50;
      min-width:220px;
      max-width:40vw;
      background:radial-gradient(circle at top,#252938,#191b25);
      border-radius:var(--radius-lg);
      padding:10px 10px 9px;
      border:1px solid rgba(82,90,116,0.95);
      box-shadow:0 18px 40px rgba(0,0,0,0.9);
      font-size:13px;
      color:#e7ebff;
    }

    .last-event .hd{
      display:flex;
      align-items:center;
      justify-content:space-between;
      color:var(--muted);
      margin-bottom:6px;
      gap:10px;
    }

    .last-event .hd span{
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:700;
      color:#d1d8f5;
    }

    .last-event .body{
      line-height:1.6;
      color:#e9edff;
    }

    /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„ÙØ±Ø§Øº */
    .empty{
      display:grid;
      gap:8px;
    }

    .empty .ghost{
      border-radius:14px;
      min-height:74px;
      background:
        linear-gradient(120deg,rgba(255,255,255,0.02),rgba(255,255,255,0.004)),
        repeating-linear-gradient(135deg,#191b24,#191b24 8px,#151821 8px,#151821 16px);
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted-soft);
      font-size:13px;
      border:1px dashed rgba(90,98,122,0.9);
      opacity:.9;
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª ØµØºÙŠØ±Ø© Ù„Ù„Ø¬ÙˆØ§Ù„ */
    @media (max-width:600px){
      header{
        padding:10px 14px;
      }
      .wrap{
        padding:14px 10px 22px;
      }
      .gm-toggle{
        inset-inline-start:10px;
        bottom:10px;
      }
      .last-event{
        inset-inline-end:10px;
        top:66px;
        max-width:80vw;
      }
      .turn-banner{
        padding-inline:10px;
      }
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù†ØªØµÙ ÙˆÙ†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© */
    .midcard{
      min-width:160px;
      padding:20px;
      border-radius:14px;
      background:radial-gradient(circle at top,#262a38,#191c26);
      border:1px solid rgba(71,79,102,0.95);
      color:#fff;
      font-size:26px;
      font-weight:800;
      text-align:center;
      box-shadow:0 10px 26px rgba(0,0,0,0.7);
      opacity:0;
      transform:scale(.6);
      transition:opacity .35s ease,transform .35s ease;
    }
    .midcard.show{
      opacity:1;
      transform:scale(1);
    }
    #matchResultOverlay{
      font-size:70px;
      font-weight:900;
      text-shadow:0 0 30px rgba(0,0,0,0.8);
    }
    .result-ok{
      color:var(--green-soft);
      text-shadow:0 0 25px rgba(34,197,139,.55);
    }
    .result-bad{
      color:var(--danger);
      text-shadow:0 0 25px rgba(255,98,98,.55);
    }

    /* ===== Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ===== */
    .viewer-modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        backdrop-filter: blur(12px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
    }

    .viewer-card {
        background: radial-gradient(circle at top, #252938, #191b25);
        border-radius: var(--radius-lg);
        padding: 30px;
        width: min(400px, 90vw);
        border: 1px solid rgba(82,90,116,0.95);
        box-shadow: 0 30px 80px rgba(0,0,0,0.95);
        text-align: center;
    }

    .viewer-card h2 {
        margin: 0 0 25px;
        color: var(--text);
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .viewer-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .form-group {
        text-align: right;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--muted-soft);
        font-size: 14px;
        font-weight: 600;
    }

    .form-group input {
        width: 100%;
        padding: 14px 16px;
        border-radius: var(--radius-md);
        border: 1px solid rgba(73,81,104,0.95);
        background: radial-gradient(circle at top,#191c25,#13151d);
        color: var(--text);
        font-size: 15px;
        font-family: 'Cairo';
        box-shadow: 0 6px 18px rgba(0,0,0,0.55) inset;
        outline: none;
        transition: border-color 0.2s ease;
    }

    .form-group input:focus {
        border-color: var(--accent-soft);
        box-shadow: 0 0 0 2px rgba(255, 59, 59, 0.2);
    }

    .viewer-btn {
        background: linear-gradient(180deg, #1b3a30, #12241e);
        border: 1px solid rgba(47,133,95,0.95);
        color: #c5f7e5;
        padding: 16px;
        border-radius: var(--radius-md);
        font-weight: 800;
        font-size: 16px;
        cursor: pointer;
        margin-top: 10px;
        transition: all 0.2s ease;
    }

    .viewer-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(15,118,84,0.65);
    }

    .viewer-btn:active {
        transform: translateY(0);
    }

    .success-message {
        text-align: center;
        padding: 30px 20px;
        color: var(--text);
        font-size: 16px;
    }

    .success-message h3 {
        color: var(--green-soft);
        font-size: 22px;
        margin-bottom: 15px;
    }

    .success-message p {
        color: var(--muted-soft);
        line-height: 1.6;
        margin-bottom: 10px;
    }

    .success-btn {
        background: linear-gradient(180deg, #28344a, #1a2130);
        border: 1px solid rgba(90,164,255,0.95);
        color: #d7e1ff;
        padding: 12px 24px;
        border-radius: var(--radius-md);
        font-weight: 800;
        font-size: 14px;
        cursor: pointer;
        margin-top: 20px;
        transition: all 0.2s ease;
    }

    .success-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(90,164,255,0.4);
    }

    /* Ø²Ø± Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† Ù…Ø¹ ØªØ³Ù„ÙŠØ· Ø§Ù„Ø¶ÙˆØ¡ */
    .viewer-link-btn {
        background: linear-gradient(180deg, #28344a, #1a2130);
        border: 1px solid rgba(90,164,255,0.95);
        color: #d7e1ff;
        animation: highlightPulse 2s infinite;
        position: relative;
    }

    @keyframes highlightPulse {
        0% { box-shadow: 0 0 0 0 rgba(90, 164, 255, 0.7); }
        70% { box-shadow: 0 0 0 15px rgba(90, 164, 255, 0); }
        100% { box-shadow: 0 0 0 0 rgba(90, 164, 255, 0); }
    }

    .viewer-link-btn::after {
        content: "ğŸ”¥";
        position: absolute;
        top: -8px;
        right: -8px;
        font-size: 12px;
        animation: bounce 1s infinite;
    }

    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
    }

    .link-copied {
        background: var(--green) !important;
        color: white !important;
        border-color: var(--green-soft) !important;
    }

    /* ===== Ù†Ø§ÙØ°Ø© Ø´ÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· ===== */
    .share-modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        backdrop-filter: blur(12px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1001;
        padding: 20px;
    }

    .share-card {
        background: radial-gradient(circle at top, #252938, #191b25);
        border-radius: var(--radius-lg);
        padding: 24px;
        width: min(500px, 100%);
        border: 1px solid rgba(82,90,116,0.95);
        box-shadow: 0 30px 80px rgba(0,0,0,0.95);
        text-align: center;
    }

    .share-card h3 {
        margin: 0 0 20px;
        color: var(--text);
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .url-box {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(73,81,104,0.95);
        border-radius: var(--radius-md);
        padding: 12px;
        margin: 20px 0;
        font-family: monospace;
        font-size: 14px;
        word-break: break-all;
        color: var(--text);
        text-align: center;
    }

    .copy-btn {
        background: linear-gradient(180deg, #222634, #181b26);
        border: 1px solid rgba(74,82,103,0.95);
        color: var(--text);
        padding: 12px 24px;
        border-radius: var(--radius-md);
        font-weight: 800;
        font-size: 14px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin: 10px;
        transition: all 0.2s ease;
    }

    .copy-btn:hover {
        background: linear-gradient(180deg, #28344a, #1a2130);
        transform: translateY(-2px);
    }

    .copy-btn.copied {
        background: var(--green);
        color: white;
        border-color: var(--green-soft);
    }

    .share-options {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .share-option {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: var(--radius-md);
        padding: 8px 16px;
        color: var(--text);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
    }

    .share-option:hover {
        background: rgba(255,255,255,0.1);
        transform: translateY(-2px);
    }
    
    /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
    .notification {
        position: fixed;
        top: 100px;
        right: 20px;
        background: var(--green);
        color: white;
        padding: 12px 16px;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-soft);
        z-index: 1000;
        animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }

    /* Ø¹Ø±Ø¶ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† */
    .winners-display {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, var(--green), var(--green-soft));
        padding: 40px 60px;
        border-radius: 20px;
        color: white;
        font-size: 36px;
        font-weight: 900;
        text-align: center;
        z-index: 1000;
        box-shadow: 0 20px 60px rgba(34, 197, 139, 0.5);
        animation: winnerPulse 2s infinite;
    }

    @keyframes winnerPulse {
        0% { transform: translate(-50%, -50%) scale(1); }
        50% { transform: translate(-50%, -50%) scale(1.05); }
        100% { transform: translate(-50%, -50%) scale(1); }
    }
  </style>
</head>
<body>

<header>
  <div class="title">
    <span class="dot"></span>
    <span>ğŸ­ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©</span>
  </div>
  <div class="right">
    <span class="status-pill">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù†: <b id="turnLabel">-</b></span>
    <button id="viewerLinkBtn" class="btn viewer-link-btn">ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†</button>
    <button id="helpBtn" class="help-btn">â” ØªØ¹Ù„ÙŠÙ…Ø§Øª</button>
  </div>
</header>

<div class="wrap">
  <div class="container">

    <!-- Ø¨Ø§Ù†Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ -->
    <div id="turnBanner" class="turn-banner">
      <div class="left">
        <span class="turn-badge">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù†</span>
        <span id="turnName" class="turn-name">â€”</span>
      </div>
      <div class="right">
        <div class="turn-timer">
          <div class="timer-circle">
            <svg>
              <circle cx="18" cy="18" r="18" class="timer-bg"></circle>
              <circle cx="18" cy="18" r="18" class="timer-progress"></circle>
            </svg>
            <span class="timer-text" id="timerText">60</span>
          </div>
          <span class="turn-hint">Ø§Ø®ØªØ± Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„Ø§Ø³Ù… Ø§Ù„ÙˆÙ‡Ù…ÙŠ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚</span>
        </div>
      </div>
    </div>

    <!-- Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… Ø§Ù„Ø¬ÙˆÙ„Ø© -->
    <div class="round-progress">
      <div class="progress-bar">
        <div class="progress-fill" id="roundProgress"></div>
      </div>
      <div class="round-label">Ø§Ù„Ø¬ÙˆÙ„Ø©: <span id="roundNumber">1</span></div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† -->
    <div class="panel">
      <div class="panel-title">
        <div class="title-left">
          <span>Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†</span>
          <span class="count-chip" id="playersCount">0 Ù„Ø§Ø¹Ø¨</span>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn success" id="btnStart">â–¶ï¸ Ø§Ø¨Ø¯Ø£</button>
          <button class="btn accent" id="btnReset">ğŸ” Ø¥Ø¹Ø§Ø¯Ø©</button>
          <button class="btn" id="btnSkip">â­ï¸ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¯ÙˆØ±</button>
        </div>
      </div>
      <div id="playersGrid" class="grid"></div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ© -->
    <div class="panel">
      <div class="panel-title">
        <div class="title-left">
          <span>Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©</span>
          <span class="count-chip" id="cardsCount">0 Ø¨Ø·Ø§Ù‚Ø©</span>
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn warn" id="btnShuffleCards">ğŸ”€ Ø®Ù„Ø·</button>
          <button class="btn" id="btnLockAll">ğŸ”’ Ù‚ÙÙ„</button>
          <button class="btn" id="btnUnlockAll">ğŸ”“ ÙØªØ­</button>
        </div>
      </div>
      <div id="cardsGrid" class="grid"></div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
    <div class="stats-panel">
      <h4>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h4>
      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„ØµØ­Ø©</span>
          <span class="stat-value" id="accuracyRate">0%</span>
          <span class="stat-subtitle">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø®ØªÙŠØ§Ø±Ù‹Ø§</span>
          <span class="stat-value" id="mostChosenName">â€”</span>
          <span class="stat-subtitle" id="mostChosenCount">0 Ù…Ø±Ø©</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Ø§Ù„Ø£ÙƒØ«Ø± Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©</span>
          <span class="stat-value" id="mostCorrectPlayer">â€”</span>
          <span class="stat-subtitle" id="mostCorrectCount">0 ØµØ­ÙŠØ­Ø©</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</span>
          <span class="stat-value" id="remainingCards">0</span>
          <span class="stat-subtitle">Ù…Ù† Ø£ØµÙ„ <span id="totalCards">0</span></span>
        </div>
      </div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© -->
    <div class="status-bar">
      <div style="display:flex;flex-wrap:wrap;gap:8px">
        <span class="chip">Ø§Ù†Ø¶Ù…Ø§Ù… Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·: <b>ğŸ”— Ø§Ø¶ØºØ· Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†</b></span>
        <span class="chip">Ø§Ù„ØªØ­Ù‚Ù‚: Ø§Ø®ØªÙØ± <b>Ù„Ø§Ø¹Ø¨Ù‹Ø§</b> Ø«Ù… Ø§Ø®ØªÙØ± <b>Ø¨Ø·Ø§Ù‚Ø©</b> Ù…Ù† Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø±</span>
      </div>
      <div class="legend">
        <div class="lg"><span class="dot-sm d-green"></span><span>ØµØ­ÙŠØ­Ø©/Ù…Ù‚ØµÙ‰</span></div>
        <div class="lg"><span class="dot-sm d-yellow"></span><span>Ù…Ù‚ÙÙ„Ø©</span></div>
        <div class="lg"><span class="dot-sm d-red"></span><span>Ø®Ø·Ø£</span></div>
        <div class="lg"><span class="dot-sm d-green" style="animation: winnerGlow 2s infinite"></span><span>ÙØ§Ø¦Ø²</span></div>
      </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø± -->
    <div id="gm" class="gm" style="grid-column:1/-1">
      <div class="gm-panel">
        <h3>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø±</h3>

        <div class="row">
          <input id="playerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯)" />
          <button class="btn success" id="addPlayerBtn">Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨</button>
          <span class="hint">Ø£Ùˆ ÙŠÙ†Ø¶Ù…ÙˆÙ† Ø¹Ø¨Ø± <b>ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†</b></span>
        </div>
        <div class="row">
          <input id="fakeWord" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙˆÙ‡Ù…ÙŠ (Ù…Ø«Ø§Ù„: Ø³ÙŠØ§Ø±Ø©)" />
          <select id="fakeOwner"></select>
          <button class="btn success" id="addFakeBtn">Ø¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø©</button>
          <button class="btn" id="clearUnowned">ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø³Ù…Ø§Ø¡</button>
        </div>

        <div class="row" style="width:100%;display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <h4 style="margin:6px 0;color:#e5e9ff;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h4>
            <table class="table">
              <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>ØµØ­ÙŠØ­Ø©</th><th>Ø®Ø·Ø£</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
              <tbody id="playersTable"></tbody>
            </table>
          </div>
          <div>
            <h4 style="margin:6px 0;color:#e5e9ff;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</h4>
            <table class="table">
              <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø§Ù„Ùƒ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
              <tbody id="cardsTable"></tbody>
            </table>
          </div>
        </div>

        <div class="row">
          <textarea id="log" placeholder="Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«" style="width:100%;min-height:120px" readonly></textarea>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Ø²Ø± ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø± -->
<button id="gmToggle" class="gm-toggle">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø±</button>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† -->
<div id="viewerModal" class="viewer-modal" style="display:none;">
  <div class="viewer-card">
    <h2>ğŸ® Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
    
    <div id="viewerForm" class="viewer-form">
      <div class="form-group">
        <label>ğŸ‘¤ Ø§Ø³Ù…Ùƒ ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©</label>
        <input type="text" id="viewerPlatformName" placeholder="Ù…Ø«Ø§Ù„: AhmadGamer" required>
      </div>
      
      <div class="form-group">
        <label>ğŸ­ Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ø§Ù„ÙˆÙ‡Ù…ÙŠ</label>
        <input type="text" id="viewerFakeName" placeholder="Ù…Ø«Ø§Ù„: Ø³ÙˆØ¨Ø±Ù…Ø§Ù†" required>
      </div>
      
      <button class="viewer-btn" id="submitViewer">ğŸš€ Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù†</button>
    </div>
    
    <div id="successMessage" class="success-message" style="display:none;">
      <h3>âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!</h3>
      <p>Ù„Ù‚Ø¯ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¥Ù„Ù‰ Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø±.</p>
      <p>Ø³ØªØ¸Ù‡Ø± ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù‚Ø±ÙŠØ¨Ø§Ù‹.</p>
      <button class="success-btn" onclick="window.close()">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©</button>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø±Ø§Ø¨Ø· -->
<div id="shareModal" class="share-modal" style="display:none;">
  <div class="share-card">
    <h3>ğŸ”— Ø´Ø§Ø±Ùƒ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†</h3>
    <p style="color:var(--muted-soft);margin-bottom:20px;">Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ£Ø±Ø³Ù„Ù‡ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</p>
    
    <div class="url-box" id="shareUrl">https://...</div>
    
    <button class="copy-btn" id="copyShareUrl">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
    
    <div class="share-options">
      <button class="share-option" onclick="shareToTwitter()">ğŸ¦ ØªÙˆÙŠØªØ±</button>
      <button class="share-option" onclick="shareToDiscord()">ğŸ’¬ Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯</button>
      <button class="share-option" onclick="shareToWhatsApp()">ğŸ’š ÙˆØ§ØªØ³Ø§Ø¨</button>
    </div>
    
    <button class="btn" id="closeShare" style="margin-top:20px;">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
<div id="helpOverlay" class="help-overlay" role="dialog" aria-modal="true">
  <div class="help-card">
    <h3>ğŸ“˜ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù„Ø¹Ø¨</h3>
    <div class="help-steps">
      <div class="help-step"><div class="num">1</div><div>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† Ø²Ø± <b>â–¶ï¸ Ø§Ø¨Ø¯Ø£</b>.</div></div>
      <div class="help-step"><div class="num">2</div><div>Ø§Ø®ØªÙØ± Ø¨Ø·Ø§Ù‚Ø© <b>Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø°ÙƒÙˆØ±</b> Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†.</div></div>
      <div class="help-step"><div class="num">3</div><div>Ø§Ø®ØªÙØ± Ø¨Ø·Ø§Ù‚Ø© <b>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙˆÙ‡Ù…ÙŠ</b> Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù‡.</div></div>
      <div class="help-step"><div class="num">4</div><div>Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ <b>â­ï¸ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¯ÙˆØ±</b>.</div></div>
      <div class="help-step"><div class="num">5</div><div>Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙˆÙ† ÙŠÙ†Ø¶Ù…ÙˆÙ† Ø¹Ø¨Ø± <b>ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†</b>.</div></div>
      <div class="help-step"><div class="num">6</div><div>Ø§Ù„Ù„Ø§Ø¹Ø¨Ø§Ù† Ø§Ù„Ø£Ø®ÙŠØ±Ø§Ù† ÙŠÙÙˆØ²Ø§Ù† ÙˆÙŠØ¸Ù‡Ø± Ø§Ø³Ù…Ø§Ù‡Ù…Ø§ ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ!</div></div>
    </div>
    <div class="help-close">
      <button id="helpClose" class="btn">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
  </div>
</div>

<!-- Ù„Ø§ØµÙ‚ Ø¢Ø®Ø± Ø­Ø¯Ø« -->
<div id="lastEvent" class="last-event" style="display:none">
  <div class="hd">
    <span>ğŸ“° Ø¢Ø®Ø± Ø­Ø¯Ø«</span>
    <button id="lastEventHide" class="btn" style="padding:4px 8px;font-size:12px">Ø¥Ø®ÙØ§Ø¡</button>
  </div>
  <div class="body" id="lastEventBody">â€”</div>
</div>

<!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù†ØªØµÙ + Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© -->
<div id="middleCardsArea" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);display:none;gap:40px;z-index:150;pointer-events:none;">
  <div id="middleLeftCard" class="midcard"></div>
  <div id="middleRightCard" class="midcard"></div>
</div>
<div id="matchResultOverlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:200;pointer-events:none;"></div>

<script>
/* ===== Ø¹Ù†Ø§ØµØ± DOM ===== */
const els = {
  turnLabel: document.getElementById('turnLabel'),
  turnName: document.getElementById('turnName'),
  timerText: document.getElementById('timerText'),
  
  cardsGrid: document.getElementById('cardsGrid'),
  playersGrid: document.getElementById('playersGrid'),

  playersCount: document.getElementById('playersCount'),
  cardsCount: document.getElementById('cardsCount'),

  btnStart: document.getElementById('btnStart'),
  btnReset: document.getElementById('btnReset'),
  btnShuffleCards: document.getElementById('btnShuffleCards'),
  btnLockAll: document.getElementById('btnLockAll'),
  btnUnlockAll: document.getElementById('btnUnlockAll'),
  btnSkip: document.getElementById('btnSkip'),

  gm: document.getElementById('gm'),
  gmToggle: document.getElementById('gmToggle'),
  playerName: document.getElementById('playerName'),
  addPlayerBtn: document.getElementById('addPlayerBtn'),
  playersTable: document.getElementById('playersTable'),
  fakeWord: document.getElementById('fakeWord'),
  fakeOwner: document.getElementById('fakeOwner'),
  addFakeBtn: document.getElementById('addFakeBtn'),
  clearUnowned: document.getElementById('clearUnowned'),
  cardsTable: document.getElementById('cardsTable'),
  log: document.getElementById('log'),

  helpBtn: document.getElementById('helpBtn'),
  helpOverlay: document.getElementById('helpOverlay'),
  helpClose: document.getElementById('helpClose'),

  lastEvent: document.getElementById('lastEvent'),
  lastEventBody: document.getElementById('lastEventBody'),
  lastEventHide: document.getElementById('lastEventHide'),

  turnBanner: document.getElementById('turnBanner'),
  
  roundProgress: document.getElementById('roundProgress'),
  roundNumber: document.getElementById('roundNumber'),
  
  accuracyRate: document.getElementById('accuracyRate'),
  mostChosenName: document.getElementById('mostChosenName'),
  mostChosenCount: document.getElementById('mostChosenCount'),
  mostCorrectPlayer: document.getElementById('mostCorrectPlayer'),
  mostCorrectCount: document.getElementById('mostCorrectCount'),
  remainingCards: document.getElementById('remainingCards'),
  totalCards: document.getElementById('totalCards'),
  
  viewerLinkBtn: document.getElementById('viewerLinkBtn'),
  viewerModal: document.getElementById('viewerModal'),
  viewerPlatformName: document.getElementById('viewerPlatformName'),
  viewerFakeName: document.getElementById('viewerFakeName'),
  submitViewer: document.getElementById('submitViewer'),
  viewerForm: document.getElementById('viewerForm'),
  successMessage: document.getElementById('successMessage'),
  
  shareModal: document.getElementById('shareModal'),
  shareUrl: document.getElementById('shareUrl'),
  copyShareUrl: document.getElementById('copyShareUrl'),
  closeShare: document.getElementById('closeShare')
};

/* ===== Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ===== */
const state = {
  players: [],
  cards: [],
  turnIndex: -1,
  started: false,
  selectedMentionedId: null,
  selectedCardId: null,
  turnTimer: null,
  timeLeft: 60,
  currentRound: 1,
  viewerRequests: [],
  roomId: generateRoomId(),
  gameEnded: false,
  // ØªØªØ¨Ø¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  cardChoices: {}, // ØªØªØ¨Ø¹ Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ø®ØªÙŠØ§Ø± ÙƒÙ„ Ø¨Ø·Ø§Ù‚Ø©
  lastWinners: [] // Ø§Ù„ÙØ§Ø¦Ø²ÙˆÙ† Ø§Ù„Ø£Ø®ÙŠØ±ÙˆÙ†
};

/* ===== ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù ØºØ±ÙØ© ÙØ±ÙŠØ¯ ===== */
function generateRoomId() {
    return 'room_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

/* ===== ØªØ£Ø«ÙŠØ±Ø§Øª ØµÙˆØªÙŠØ© ===== */
const sounds = {
  correct: () => {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);
    
    oscillator.frequency.setValueAtTime(523.25, ctx.currentTime);
    oscillator.frequency.setValueAtTime(659.25, ctx.currentTime + 0.1);
    oscillator.frequency.setValueAtTime(783.99, ctx.currentTime + 0.2);
    
    gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
    
    oscillator.start();
    oscillator.stop(ctx.currentTime + 0.5);
  },
  
  wrong: () => {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);
    
    oscillator.frequency.setValueAtTime(200, ctx.currentTime);
    oscillator.frequency.setValueAtTime(150, ctx.currentTime + 0.1);
    
    gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
    
    oscillator.start();
    oscillator.stop(ctx.currentTime + 0.3);
  },
  
  turn: () => {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);
    
    oscillator.frequency.setValueAtTime(440, ctx.currentTime);
    
    gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
    
    oscillator.start();
    oscillator.stop(ctx.currentTime + 0.2);
  },
  
  win: () => {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);
    
    oscillator.frequency.setValueAtTime(523.25, ctx.currentTime);
    oscillator.frequency.setValueAtTime(659.25, ctx.currentTime + 0.1);
    oscillator.frequency.setValueAtTime(783.99, ctx.currentTime + 0.2);
    oscillator.frequency.setValueAtTime(1046.50, ctx.currentTime + 0.3);
    
    gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.8);
    
    oscillator.start();
    oscillator.stop(ctx.currentTime + 0.8);
  }
};

/* ===== Ù…Ø³Ø§Ø¹Ø¯Ø§Øª ===== */
const uid = ()=> Math.random().toString(36).slice(2,10);
const normalize = s => (s||"").toString().trim().toLowerCase();
function byId(arr,id){ return arr.find(x=>x.id===id); }
function currentPlayer(){ if(state.turnIndex<0||state.turnIndex>=state.players.length) return null; return state.players[state.turnIndex]; }
function alivePlayers(){ return state.players.filter(p=>!p.eliminated); }
function log(t){ els.log.value = `[${new Date().toLocaleTimeString()}] ${t}\n` + els.log.value; setLastEvent(t); updateStats(); }

/* ===== Ù†Ø¸Ø§Ù… Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ù†ÙˆØ§ÙØ° ===== */
function sendViewerRequestToMain(platformName, fakeName) {
    const requestId = 'viewer_request_' + Date.now();
    const requestData = {
        id: requestId,
        platformName: platformName,
        fakeName: fakeName,
        timestamp: Date.now(),
        roomId: getRoomIdFromURL() || state.roomId
    };
    
    localStorage.setItem('fn_viewer_request', JSON.stringify(requestData));
    
    if (window.opener) {
        try {
            window.opener.postMessage({
                type: 'VIEWER_REQUEST',
                data: requestData
            }, '*');
        } catch (e) {
            console.log('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');
        }
    }
    
    return requestId;
}

function getRoomIdFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get('room');
}

function addViewerInMainPage(platformName, fakeName) {
    const playerId = uid();
    state.players.push({
        id: playerId,
        name: platformName,
        eliminated: false,
        correctGuesses: 0,
        wrongGuesses: 0,
        isWinner: false
    });
    
    state.cards.push({
        id: uid(),
        text: fakeName,
        ownerId: playerId,
        revealed: false,
        locked: false
    });
    
    renderPlayers();
    renderCards();
    updateSelects();
    
    log(`âœ… ${platformName} Ø§Ù†Ø¶Ù… Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø§Ø³Ù… "${fakeName}"`);
    showNotification(`${platformName} Ø§Ù†Ø¶Ù… Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø§Ø³Ù… ${fakeName}`);
    sounds.correct();
    
    return true;
}

function processViewerRequests() {
    const requestStr = localStorage.getItem('fn_viewer_request');
    if (requestStr) {
        try {
            const request = JSON.parse(requestStr);
            const requestAge = Date.now() - request.timestamp;
            if (requestAge < 10000) {
                addViewerInMainPage(request.platformName, request.fakeName);
                localStorage.removeItem('fn_viewer_request');
            } else {
                localStorage.removeItem('fn_viewer_request');
            }
        } catch (e) {
            localStorage.removeItem('fn_viewer_request');
        }
    }
}

window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'VIEWER_REQUEST') {
        const request = event.data.data;
        addViewerInMainPage(request.platformName, request.fakeName);
    }
});

/* ===== Ø¯Ø§Ù„Ø© Ø¥Ø´Ø¹Ø§Ø± ===== */
function showNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

/* ===== Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ===== */
function generateViewerLink() {
    const baseUrl = window.location.origin + window.location.pathname;
    const roomId = state.roomId;
    return baseUrl + `?viewer=1&room=${roomId}`;
}

/* ===== Ù…Ø¤Ù‚Øª Ø§Ù„Ø¯ÙˆØ± ===== */
function startTurnTimer() {
    clearInterval(state.turnTimer);
    state.timeLeft = 60;
    updateTimerDisplay();
    
    state.turnTimer = setInterval(() => {
        state.timeLeft--;
        updateTimerDisplay();
        
        if (state.timeLeft <= 0) {
            clearInterval(state.turnTimer);
            const player = currentPlayer();
            if (player && !player.eliminated) {
                log(`â° Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª ${player.name}`);
                sounds.wrong();
            }
            nextTurnAuto();
        }
    }, 1000);
}

function updateTimerDisplay() {
    els.timerText.textContent = state.timeLeft;
    const progress = document.querySelector('.timer-progress');
    if (progress) {
        const circumference = 2 * Math.PI * 18;
        const offset = circumference - (state.timeLeft / 60) * circumference;
        progress.style.strokeDasharray = `${circumference} ${circumference}`;
        progress.style.strokeDashoffset = offset;
        
        if (state.timeLeft <= 10) {
            progress.style.stroke = 'var(--danger)';
        } else if (state.timeLeft <= 30) {
            progress.style.stroke = 'var(--yellow)';
        } else {
            progress.style.stroke = 'var(--green)';
        }
    }
}

/* ===== Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ===== */
function updateStats() {
    // 1. Ù…Ø¹Ø¯Ù„ Ø§Ù„ØµØ­Ø©
    let totalGuesses = 0;
    let correctGuesses = 0;
    
    state.players.forEach(p => {
        totalGuesses += p.correctGuesses + p.wrongGuesses;
        correctGuesses += p.correctGuesses;
    });
    
    const accuracy = totalGuesses > 0 ? Math.round((correctGuesses / totalGuesses) * 100) : 0;
    els.accuracyRate.textContent = `${accuracy}%`;
    
    // 2. Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙˆÙ‡Ù…ÙŠ Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø®ØªÙŠØ§Ø±Ù‹Ø§
    let mostChosen = { name: 'â€”', count: 0 };
    Object.keys(state.cardChoices).forEach(cardId => {
        const card = byId(state.cards, cardId);
        if (card && state.cardChoices[cardId] > mostChosen.count) {
            mostChosen = { 
                name: card.text, 
                count: state.cardChoices[cardId] 
            };
        }
    });
    
    els.mostChosenName.textContent = mostChosen.name;
    els.mostChosenCount.textContent = `${mostChosen.count} Ù…Ø±Ø©`;
    
    // 3. Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙƒØ«Ø± Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©
    let mostCorrect = { player: null, count: 0 };
    state.players.forEach(p => {
        if (p.correctGuesses > mostCorrect.count) {
            mostCorrect = { 
                player: p.name, 
                count: p.correctGuesses 
            };
        }
    });
    
    els.mostCorrectPlayer.textContent = mostCorrect.player || 'â€”';
    els.mostCorrectCount.textContent = `${mostCorrect.count} ØµØ­ÙŠØ­Ø©`;
    
    // 4. Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
    const unrevealed = state.cards.filter(c => !c.revealed).length;
    els.remainingCards.textContent = `${unrevealed}`;
    els.totalCards.textContent = `${state.cards.length}`;
    
    updateProgressBar();
}

function updateProgressBar() {
    const progress = els.roundProgress;
    if (!progress) return;
    
    const revealed = state.cards.filter(c => c.revealed).length;
    const total = state.cards.length;
    const percentage = total > 0 ? Math.round((revealed / total) * 100) : 0;
    
    progress.style.width = `${percentage}%`;
    els.roundNumber.textContent = state.currentRound;
}

/* ===== Ø¹Ø¯Ø§Ø¯Ø§Øª ===== */
function updateCounts(){
  els.playersCount.textContent = `${state.players.length} Ù„Ø§Ø¹Ø¨`;
  els.cardsCount.textContent   = `${state.cards.length} Ø¨Ø·Ø§Ù‚Ø©`;
}

/* ===== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙÙŠ GM ===== */
function updateSelects(){
  const setOpts=(el,items,withNone=false)=>{
    el.innerHTML=''; if(withNone){const o=document.createElement('option');o.value='';o.textContent='â€”';el.append(o);}
    items.forEach(it=>{const o=document.createElement('option');o.value=it.value;o.textContent=it.label;el.append(o);});
  };
  setOpts(els.fakeOwner, state.players.map(p=>({value:p.id,label:p.name})), true);
}

/* ===== Ø¨Ø§Ù†Ø± Ø§Ù„Ø¯ÙˆØ± ===== */
function renderTurnBanner(){
  const p = currentPlayer();
  if (p && !p.eliminated && !state.gameEnded){
    els.turnName.textContent = p.name;
    els.turnLabel.textContent = p.name;
    els.turnBanner.style.display = 'flex';
    if (state.started) {
        startTurnTimer();
    }
  } else {
    els.turnName.textContent = 'â€”';
    els.turnLabel.textContent = '-';
    els.turnBanner.style.display = 'none';
    clearInterval(state.turnTimer);
  }
}

/* ===== Ø±Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ===== */
function renderPlayers(){
  els.playersGrid.innerHTML='';
  if (state.players.length===0){
    const wrap=document.createElement('div'); wrap.className='empty';
    for(let i=0;i<3;i++){ const g=document.createElement('div'); g.className='ghost'; g.textContent='Ù„Ø§Ø¹Ø¨ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶Ù‡ Ù‡Ù†Ø§ â€¢ Ø£Ø¶ÙÙ Ù„Ø§Ø¹Ø¨Ù‹Ø§ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… !Ø¯Ø®ÙˆÙ„'; wrap.append(g); }
    els.playersGrid.append(wrap);
  } else {
    state.players.forEach((p)=>{
      const el=document.createElement('div'); el.className='card'; el.dataset.id=p.id;
      if (p.isWinner) el.classList.add('winner');
      if (state.selectedMentionedId===p.id) el.classList.add('selected');
      if (p.eliminated) { el.style.opacity=.48; el.style.filter='grayscale(.35)'; }

      el.onclick=()=>{
        if (p.eliminated || state.gameEnded) return;
        state.selectedMentionedId=p.id;
        document.querySelectorAll('#playersGrid .card').forEach(x=>x.classList.remove('selected'));
        el.classList.add('selected');
        tryResolveIfReady();
      };

      const badge=document.createElement('span'); badge.className='badge';
      if (p.isWinner) {
          badge.textContent = 'ğŸ† ÙØ§Ø¦Ø²';
      } else {
          const isTurn = currentPlayer() && currentPlayer().id===p.id && !p.eliminated;
          badge.textContent = p.eliminated ? 'Ù…Ù‚ØµÙ‰' : (isTurn ? 'Ø§Ù„Ø¯ÙˆØ±' : 'Ø¬Ø§Ù‡Ø²');
      }

      const t=document.createElement('div'); t.className='text'; t.textContent=p.name;
      
      // Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ù†Ù‚Ø§Ø· Ø£Ùˆ Ù†Ø¬ÙˆÙ…)
      if (p.correctGuesses > 0) {
          const correctBadge = document.createElement('span');
          correctBadge.className = 'player-correct';
          correctBadge.textContent = `âœ… ${p.correctGuesses}`;
          el.append(correctBadge);
      }
      
      el.append(badge,t);
      els.playersGrid.append(el);
    });
  }

  // Ø¬Ø¯ÙˆÙ„ GM (Ù…Ø¹Ø¯Ù„)
  els.playersTable.innerHTML='';
  state.players.forEach((p,idx)=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=p.name;
    const td2=document.createElement('td'); td2.textContent=p.correctGuesses;
    const td3=document.createElement('td'); td3.textContent=p.wrongGuesses;
    const td4=document.createElement('td'); 
    td4.textContent = p.isWinner ? 'ğŸ† ÙØ§Ø¦Ø²' : (p.eliminated?'Ù…Ù‚ØµÙ‰':'Ù†Ø´Ø·');
    const td5=document.createElement('td');
    const elim=document.createElement('button'); elim.className='btn accent'; elim.textContent=p.eliminated?'Ø¥Ø±Ø¬Ø§Ø¹':'Ø¥Ù‚ØµØ§Ø¡';
    elim.onclick=()=>{ 
        if (state.gameEnded) return;
        p.eliminated=!p.eliminated; 
        if (state.turnIndex===idx && p.eliminated) nextTurnAuto(); 
        renderPlayers(); 
        renderTurnBanner(); 
        checkWinCondition();
    };
    const del=document.createElement('button'); del.className='btn'; del.textContent='Ø­Ø°Ù';
    del.onclick=()=>{ 
        state.cards.forEach(c=>{ if(c.ownerId===p.id) c.ownerId=null; }); 
        state.players=state.players.filter(x=>x.id!==p.id); 
        if(state.turnIndex>=state.players.length) state.turnIndex=state.players.length-1; 
        renderPlayers(); 
        renderCards(); 
        renderTurnBanner();
        checkWinCondition();
    };
    td5.append(elim,document.createTextNode(' '),del);
    tr.append(td1,td2,td3,td4,td5); els.playersTable.append(tr);
  });

  updateCounts();
  renderTurnBanner();
  updateStats();
}

/* ===== Ø±Ø³Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ===== */
function renderCards(){
  els.cardsGrid.innerHTML='';
  if (state.cards.length===0){
    const wrap=document.createElement('div'); wrap.className='empty';
    for(let i=0;i<4;i++){ const g=document.createElement('div'); g.className='ghost'; g.textContent='Ø¨Ø·Ø§Ù‚Ø© Ø§Ø³Ù… ÙˆÙ‡Ù…ÙŠ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ â€¢ Ø£Ø¶ÙÙ Ø¨Ø·Ø§Ù‚Ø© Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø±'; wrap.append(g); }
    els.cardsGrid.append(wrap);
  } else {
    state.cards.forEach(c=>{
      const el=document.createElement('div'); el.className='card'; el.dataset.id=c.id;
      if (c.revealed) el.classList.add('revealed');
      if (state.selectedCardId===c.id) el.classList.add('selected');

      el.onclick=()=>{
        if (!state.started){ log('Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹.'); return; }
        if (state.gameEnded){ log('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©.'); return; }
        if (c.locked){ log('Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ù‚ÙÙ„Ø©.'); return; }
        if (c.revealed){ log('Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ØµØ§Ø±Øª ØµØ­ÙŠØ­Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§.'); return; }
        state.selectedCardId=c.id;
        document.querySelectorAll('#cardsGrid .card').forEach(x=>x.classList.remove('selected','wrong'));
        el.classList.add('selected');
        tryResolveIfReady();
      };

      const badge=document.createElement('span'); badge.className='badge';
      badge.textContent = c.revealed ? 'ØµØ­ÙŠØ­Ø©' : (c.locked ? 'Ù…Ù‚ÙÙ„Ø©' : 'Ø¬Ø§Ù‡Ø²Ø©');

      const t=document.createElement('div'); t.className='text'; t.textContent = c.text;

      el.append(badge,t);
      els.cardsGrid.append(el);
    });
  }

  // Ø¬Ø¯ÙˆÙ„ GM
  els.cardsTable.innerHTML='';
  state.cards.forEach(c=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=c.text;
    const td2=document.createElement('td'); td2.textContent=(byId(state.players,c.ownerId)?.name)||'â€”';
    const td3=document.createElement('td'); td3.textContent=(c.revealed?'ØµØ­ÙŠØ­Ø©':'â€”')+(c.locked?' / Ù…Ù‚ÙÙ„Ø©':'');
    const td4=document.createElement('td');
    const lock=document.createElement('button'); lock.className='btn'; lock.textContent=c.locked?'ÙØªØ­':'Ù‚ÙÙ„'; lock.onclick=()=>{ c.locked=!c.locked; renderCards(); };
    const del=document.createElement('button'); del.className='btn accent'; del.textContent='Ø­Ø°Ù'; del.onclick=()=>{ state.cards=state.cards.filter(x=>x.id!==c.id); renderCards(); };
    td4.append(lock,document.createTextNode(' '),del);
    tr.append(td1,td2,td3,td4); els.cardsTable.append(tr);
  });

  updateCounts();
  updateStats();
}

/* ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙÙˆØ² (Ø¢Ø®Ø± Ù„Ø§Ø¹Ø¨ÙŠÙ†) ===== */
function checkWinCondition() {
    if (state.gameEnded) return false;
    
    const alive = alivePlayers();
    
    if (alive.length === 2) {
        // Ø§Ù„ÙØ§Ø¦Ø²ÙˆÙ† Ù‡Ù… Ø¢Ø®Ø± Ù„Ø§Ø¹Ø¨ÙŠÙ†
        endGame(alive);
        return true;
    } else if (alive.length === 1) {
        // Ø­Ø§Ù„Ø© Ø®Ø§ØµØ© - Ù„Ø§Ø¹Ø¨ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ø¨Ù‚ÙŠ
        endGame(alive);
        return true;
    } else if (alive.length === 0) {
        // Ø­Ø§Ù„Ø© Ø®Ø§ØµØ© - Ù„Ø§ Ø£Ø­Ø¯ Ø¨Ù‚ÙŠ
        state.gameEnded = true;
        state.started = false;
        clearInterval(state.turnTimer);
        log('ğŸ² Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©! Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ§Ø¦Ø²ÙŠÙ†.');
        return true;
    }
    
    return false;
}

/* ===== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ¹Ø±Ø¶ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† ===== */
function endGame(winners) {
    state.gameEnded = true;
    state.started = false;
    clearInterval(state.turnTimer);
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ†
    winners.forEach(p => {
        p.isWinner = true;
        p.eliminated = false; // Ù†Ø¬Ø¹Ù„Ù‡ Ù†Ø´Ø· Ù„ÙŠØ¸Ù‡Ø± ÙƒÙØ§Ø¦Ø²
    });
    
    state.lastWinners = winners;
    
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¯Ø«
    const winnerNames = winners.map(w => w.name).join(' Ùˆ ');
    log(`ğŸ† Ø§Ù„ÙØ§Ø¦Ø²ÙˆÙ†: ${winnerNames}! Ù…Ø¨Ø±ÙˆÙƒ Ù„Ù„ÙØ§Ø¦Ø²ÙŠÙ†!`);
    
    // Ø¹Ø±Ø¶ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ†
    showWinners(winners);
    
    // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ÙÙˆØ²
    sounds.win();
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù…Ø¹ ØªÙ…ÙŠÙŠØ² Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ†
    renderPlayers();
}

/* ===== Ø¹Ø±Ø¶ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ ===== */
function showWinners(winners) {
    const winnerNames = winners.map(w => w.name).join(' Ùˆ ');
    
    const winnerDiv = document.createElement('div');
    winnerDiv.className = 'winners-display';
    
    winnerDiv.innerHTML = `
        <div style="font-size: 28px; margin-bottom: 20px;">ğŸ† Ø§Ù„ÙØ§Ø¦Ø²ÙˆÙ† ğŸ†</div>
        <div style="font-size: 42px; text-shadow: 0 4px 12px rgba(0,0,0,0.3);">${winnerNames}</div>
        <div style="font-size: 18px; margin-top: 20px; opacity: 0.9;">Ø¢Ø®Ø± Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙŠØªØ¨Ù‚ÙŠØ§Ù† ÙŠÙÙˆØ²Ø§Ù†!</div>
    `;
    
    document.body.appendChild(winnerDiv);
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†ÙŠ
    setTimeout(() => {
        if (winnerDiv.parentNode) {
            document.body.removeChild(winnerDiv);
        }
    }, 10000);
}

/* ===== Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¯ÙˆØ± + ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¯ÙˆØ± ===== */
function startGame(){
    if (state.gameEnded) {
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        resetGame();
        return;
    }
    
    if (alivePlayers().length===0){ log('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ†.'); return; }
    if (state.cards.length===0){ log('Ø£Ø¶Ù Ø¨Ø·Ø§Ù‚Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.'); return; }
    state.started = true;
    state.gameEnded = false;
    state.turnIndex = state.players.findIndex(p=>!p.eliminated);
    if (state.turnIndex<0) state.turnIndex = 0;
    log('Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©.');
    sounds.turn();
    renderPlayers(); renderCards(); renderTurnBanner();
}

function nextTurnAuto(){
  if (!state.started || state.gameEnded) return;
  const n = state.players.length; if (!n) return;
  let i = state.turnIndex;
  for (let step=0; step<n; step++){
    i = (i+1) % n;
    if (!state.players[i].eliminated){ state.turnIndex = i; break; }
  }

  state.selectedMentionedId = null;
  state.selectedCardId = null;
  document.querySelectorAll('.card').forEach(x=>x.classList.remove('selected','wrong','flash-red'));

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ÙÙˆØ² Ø¨Ø¹Ø¯ ÙƒÙ„ Ø¯ÙˆØ±
  if (!checkWinCondition()) {
      renderPlayers();
      renderTurnBanner();
      sounds.turn();
  }
}

function resetGame(){
  state.gameEnded = false;
  state.started=false; 
  state.turnIndex=-1;
  state.lastWinners = [];
  state.cardChoices = {};
  
  state.players.forEach(p=>{
    p.eliminated=false;
    p.correctGuesses=0;
    p.wrongGuesses=0;
    p.isWinner=false;
  });
  
  state.cards.forEach(c=>{
    c.revealed=false;
    c.locked=false;
  });
  
  state.selectedMentionedId=null; 
  state.selectedCardId=null;
  state.timeLeft=60;
  state.currentRound=1;
  clearInterval(state.turnTimer);
  
  log('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©.');
  renderPlayers(); renderCards(); renderTurnBanner(); updateStats();
}

els.btnSkip.onclick = ()=>{
  if (!state.started || state.gameEnded){ log('Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹.'); return; }
  const cur = currentPlayer()?.name || '-';
  log(`â­ï¸ ØªÙ… ØªØ¬Ø§ÙˆØ² Ø¯ÙˆØ± ${cur}.`);
  sounds.wrong();
  nextTurnAuto();
};

/* ===== Ù…Ø¤Ø«Ø± Ø§Ù„Ù†Ø¬Ø§Ø­ ===== */
function confettiBurst(x=window.innerWidth/2, y=120){
  const cnv = document.createElement('canvas');
  cnv.width=window.innerWidth; cnv.height=200; cnv.style.position='fixed';
  cnv.style.left='0'; cnv.style.top='0'; cnv.style.pointerEvents='none'; cnv.style.zIndex='70';
  document.body.appendChild(cnv);
  const ctx = cnv.getContext('2d');
  const parts = Array.from({length:60},()=>({
    x, y, vx:(Math.random()*4-2), vy:(Math.random()*-3-1), g:0.08+Math.random()*0.05, s:2+Math.random()*3, life:50+Math.random()*30
  }));
  let id;
  function step(){
    ctx.clearRect(0,0,cnv.width,cnv.height);
    parts.forEach(p=>{
      p.x+=p.vx; p.y+=p.vy; p.vy+=p.g; p.life--;
      ctx.globalAlpha = Math.max(0, Math.min(1, p.life/80));
      ctx.fillRect(p.x, p.y, p.s, p.s);
    });
    if(parts.every(p=>p.life<=0)){ cancelAnimationFrame(id); document.body.removeChild(cnv); return; }
    id=requestAnimationFrame(step);
  }
  step();
}

/* ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ===== */
function tryResolveIfReady(){
  if (state.gameEnded) return;
  
  const turnP = currentPlayer();
  if (!turnP || turnP.eliminated) return;

  const mentionedId = state.selectedMentionedId;
  const cardId = state.selectedCardId;
  if (!mentionedId || !cardId) return;

  const mentioned = byId(state.players, mentionedId);
  const card = byId(state.cards, cardId);
  if (!mentioned || !card || card.locked) return;

  // ØªØªØ¨Ø¹ Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
  if (!state.cardChoices[cardId]) {
    state.cardChoices[cardId] = 0;
  }
  state.cardChoices[cardId]++;

  const correct = !!card.ownerId && card.ownerId === mentioned.id;
  const cardEl = document.querySelector(`#cardsGrid .card[data-id="${card.id}"]`);

  if (correct){
    card.revealed = true;
    mentioned.correctGuesses++;
    
    if (!mentioned.eliminated){
      mentioned.eliminated = true;
      log(`âœ… ØµØ­ÙŠØ­! "${card.text}" ØªØ®Øµ ${mentioned.name}. ØªÙ… Ø¥Ù‚ØµØ§Ø¤Ù‡.`);
    } else {
      log(`âœ… ØµØ­ÙŠØ­! "${card.text}" ØªØ®Øµ ${mentioned.name} (ÙƒØ§Ù† Ù…Ù‚ØµÙ‰).`);
    }
    
    sounds.correct();
    const rect = cardEl?.getBoundingClientRect?.();
    confettiBurst(rect ? rect.left + rect.width/2 : undefined, rect ? rect.top + 10 : undefined);
    
    showMiddleCards(mentioned.name, card.text, true);
    
  } else {
    mentioned.wrongGuesses++;
    
    if (cardEl){
      cardEl.classList.add('wrong','flash-red');
      setTimeout(()=>cardEl.classList.remove('wrong','flash-red'), 400);
    }
    log(`âŒ Ø®Ø·Ø£! "${card.text}" Ù„Ø§ ØªØ®Øµ ${mentioned.name}.`);
    sounds.wrong();
    
    showMiddleCards(mentioned.name, card.text, false);
  }

  renderPlayers(); 
  renderCards();
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ÙÙˆØ²
  if (!checkWinCondition()) {
      setTimeout(() => nextTurnAuto(), 1500);
  }
}

/* ===== ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù„Ù„Ù…Ù†ØªØµÙ ===== */
function showMiddleCards(playerName, cardName, isCorrect) {
    const middleArea = document.getElementById('middleCardsArea');
    const leftBox = document.getElementById('middleLeftCard');
    const rightBox = document.getElementById('middleRightCard');
    const resultBox = document.getElementById('matchResultOverlay');
    
    if (!middleArea || !leftBox || !rightBox || !resultBox) return;
    
    leftBox.textContent = playerName;
    rightBox.textContent = cardName;
    
    middleArea.style.display = 'flex';
    resultBox.style.display = 'flex';
    
    void leftBox.offsetWidth;
    void rightBox.offsetWidth;
    
    leftBox.classList.add('show');
    rightBox.classList.add('show');
    
    if (isCorrect) {
        resultBox.textContent = 'âœ” ØµØ­ÙŠØ­!';
        resultBox.className = 'result-ok';
    } else {
        resultBox.textContent = 'âœ– Ø®Ø·Ø£';
        resultBox.className = 'result-bad';
    }
    
    setTimeout(() => {
        middleArea.style.display = 'none';
        resultBox.style.display = 'none';
        leftBox.classList.remove('show');
        rightBox.classList.remove('show');
    }, 2000);
}

/* ===== Ø£Ø²Ø±Ø§Ø± Ø¹Ø§Ù…Ø© ===== */
els.btnStart.onclick = startGame;
els.btnReset.onclick = resetGame;
els.btnShuffleCards.onclick = ()=>{
  for(let i=state.cards.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [state.cards[i],state.cards[j]]=[state.cards[j],state.cards[i]]; }
  renderCards();
};
els.btnLockAll.onclick   = ()=>{ state.cards.forEach(c=>c.locked=true); renderCards(); };
els.btnUnlockAll.onclick = ()=>{ state.cards.forEach(c=>c.locked=false); renderCards(); };

/* ===== Ù„ÙˆØ­Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø± ===== */
els.addPlayerBtn.onclick=()=>{
  const name=els.playerName.value.trim(); if(!name) return;
  if(!state.players.some(p=>normalize(p.name)===normalize(name))){
    state.players.push({
        id:uid(),
        name,
        eliminated:false,
        correctGuesses:0,
        wrongGuesses:0,
        isWinner:false
    });
    els.playerName.value=''; renderPlayers(); renderTurnBanner();
    log(`ğŸ‘¤ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨: ${name}`);
  } else { log('Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§.'); }
};
els.addFakeBtn.onclick=()=>{
  const text=els.fakeWord.value.trim(); const ownerId=els.fakeOwner.value||null; if(!text) return;
  state.cards.push({id:uid(),text,ownerId,revealed:false,locked:false});
  els.fakeWord.value=''; renderCards(); updateSelects();
  log(`ğŸƒ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø©: ${text}`);
};
els.clearUnowned.onclick=()=>{ state.cards = state.cards.filter(c=>!!c.ownerId); renderCards(); updateSelects(); log('ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ù…Ù„ÙˆÙƒØ©'); };

function setGmVisibility(show){ els.gm.classList.toggle('open', !!show); }
els.gmToggle.onclick = ()=> setGmVisibility(!els.gm.classList.contains('open'));
setGmVisibility(location.hash==='#gm');
window.addEventListener('keydown',e=>{ if(e.altKey && (e.key.toLowerCase()==='g')) setGmVisibility(!els.gm.classList.contains('open')); });

/* ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† ===== */
function showViewerModal() {
    els.viewerModal.style.display = 'flex';
    els.viewerForm.style.display = 'block';
    els.successMessage.style.display = 'none';
    els.viewerPlatformName.value = '';
    els.viewerFakeName.value = '';
}

function openShareModal() {
    els.shareUrl.textContent = generateViewerLink();
    els.shareModal.style.display = 'flex';
}

function closeShareModal() {
    els.shareModal.style.display = 'none';
}

els.copyShareUrl.onclick = function() {
    navigator.clipboard.writeText(els.shareUrl.textContent)
        .then(() => {
            this.textContent = 'âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®!';
            this.classList.add('copied');
            setTimeout(() => {
                this.textContent = 'ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·';
                this.classList.remove('copied');
            }, 2000);
        });
};

function sendViewerRequest(platformName, fakeName) {
    sendViewerRequestToMain(platformName, fakeName);
    els.viewerForm.style.display = 'none';
    els.successMessage.style.display = 'block';
    setTimeout(() => {
        if (window.opener) {
            window.close();
        }
    }, 3000);
    return true;
}

els.submitViewer.onclick = function() {
    const platformName = els.viewerPlatformName.value.trim();
    const fakeName = els.viewerFakeName.value.trim();
    
    if (!platformName || !fakeName) {
        alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
        return;
    }
    
    sendViewerRequest(platformName, fakeName);
};

els.viewerLinkBtn.onclick = openShareModal;
els.closeShare.onclick = closeShareModal;

function shareToTwitter() {
    const text = `ğŸ­ Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©! ${els.shareUrl.textContent}`;
    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`, '_blank');
}

function shareToDiscord() {
    const text = `ğŸ­ Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©!\n${els.shareUrl.textContent}`;
    window.open(`https://discord.com/channels/@me?text=${encodeURIComponent(text)}`, '_blank');
}

function shareToWhatsApp() {
    const text = `ğŸ­ Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©!\n${els.shareUrl.textContent}`;
    window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`, '_blank');
}

/* ===== Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø© ===== */
function updateAll(){ 
    renderPlayers(); 
    renderCards(); 
    updateSelects(); 
    updateCounts(); 
    renderTurnBanner(); 
    updateStats(); 
}
updateAll();

// Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ø°Ù‡ ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯
if (new URLSearchParams(window.location.search).get('viewer') === '1') {
    showViewerModal();
} else {
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŒ Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    setInterval(processViewerRequests, 2000);
}

/* ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø© */
els.helpBtn.onclick = ()=>{ els.helpOverlay.style.display='flex'; };
els.helpClose.onclick = ()=>{ els.helpOverlay.style.display='none'; };
els.helpOverlay.addEventListener('click',(e)=>{ if(e.target===els.helpOverlay) els.helpOverlay.style.display='none'; });

/* Ù„Ø§ØµÙ‚ Ø¢Ø®Ø± Ø­Ø¯Ø« â€” Ø¥Ø®ÙØ§Ø¡ */
function setLastEvent(text){ els.lastEventBody.textContent = text; els.lastEvent.style.display = 'block'; }
els.lastEventHide.onclick = ()=>{ els.lastEvent.style.display='none'; };

/* ===== Ù†Ø¸Ø§Ù… Ø¨Ø·Ø§Ù‚ØªÙŠÙ† Ù„Ù„Ù…Ù†ØªØµÙ (ÙŠÙ…ÙŠÙ†/ÙŠØ³Ø§Ø±) ===== */
let rightSelectedId = null;
let leftSelectedId = null;

document.addEventListener('click', function(e){
  const target = e.target;
  if (!(target instanceof Element)) return;
  const playerCard = target.closest('#playersGrid .card');
  const fakeCard   = target.closest('#cardsGrid .card');

  if (playerCard){
    rightSelectedId = playerCard.dataset.id || null;
    maybeAnimateMiddle();
  }
  if (fakeCard){
    leftSelectedId = fakeCard.dataset.id || null;
    maybeAnimateMiddle();
  }
}, true);

function maybeAnimateMiddle(){
  if (!rightSelectedId || !leftSelectedId) return;
  if (!state.started || state.gameEnded) return;

  const turnP = currentPlayer();
  if (!turnP || turnP.eliminated) return;

  const mentioned = byId(state.players, rightSelectedId);
  const card      = byId(state.cards, leftSelectedId);
  if (!mentioned || !card) return;
  if (card.locked || card.revealed) return;

  const middleArea = document.getElementById('middleCardsArea');
  const leftBox    = document.getElementById('middleLeftCard');
  const rightBox   = document.getElementById('middleRightCard');
  if (!middleArea || !leftBox || !rightBox) return;

  leftBox.textContent  = mentioned.name;
  rightBox.textContent = card.text;

  middleArea.style.display = 'flex';
  void leftBox.offsetWidth;
  leftBox.classList.add('show');
  rightBox.classList.add('show');

  const correct = !!card.ownerId && card.ownerId === mentioned.id;
  setTimeout(()=>{ showPairResult(correct); }, 450);

  setTimeout(()=>{
    middleArea.style.display = 'none';
    leftBox.classList.remove('show');
    rightBox.classList.remove('show');
    rightSelectedId = null;
    leftSelectedId  = null;
  }, 1200);
}

function showPairResult(correct){
  const box = document.getElementById('matchResultOverlay');
  if (!box) return;
  box.style.display = 'flex';
  box.classList.remove('result-ok','result-bad');

  if (correct){
    box.classList.add('result-ok');
    box.textContent = 'âœ” ØµØ­ÙŠØ­';
  } else {
    box.classList.add('result-bad');
    box.textContent = 'âœ– Ø®Ø·Ø£';
  }

  setTimeout(()=>{ box.style.display='none'; }, 900);
}

// ØªÙ†Ø¸ÙŠÙ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
setInterval(() => {
    const now = Date.now();
    state.viewerRequests = state.viewerRequests.filter(r => now - r.timestamp < 300000);
}, 60000);
</script>
</body>
</html>
