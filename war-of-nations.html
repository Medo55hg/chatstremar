<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>🌍 حرب الدول</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">
<script src="tmi.min.js"></script>
<style>
:root{
  --bg1:#1a1a3d; --bg2:#004466; --text:#fff; --panel:#222; --line:#444;
  --accent:#ff3333; --ok:#00e6a8; --warn:#ffcc00; --muted:#ccc; --card:#222;
  --badge:#0b3d3d; --badge-b:#0ff; --bad:#ff6666;
}
[data-theme="light"]{
  --bg1:#f2f6ff; --bg2:#dfe9ff; --text:#111; --panel:#fff; --line:#e5e7eb;
  --accent:#ff3333; --ok:#00a37a; --warn:#b08500; --muted:#444; --card:#fff;
  --badge:#e8f7f7; --badge-b:#027e7e; --bad:#b00020;
}
body {
  background: linear-gradient(-45deg, var(--bg1), var(--bg2), var(--bg1), var(--bg2));
  background-size: 400% 400%;
  animation: gradientBG 20s ease infinite;
  color: var(--text);
  font-family: 'Cairo', sans-serif;
  text-align: center;
  padding: 20px;
}
@keyframes gradientBG { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

h1{ font-size:36px; color:var(--accent); margin:0 0 10px; }
.small-note{ font-size:14px; color:var(--muted); }
.badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:var(--badge); border:1px solid var(--badge-b); color:var(--badge-b); font-size:12px; margin-inline:6px; }

.container { display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start; }
.panel{
  width:48%; min-height:300px; border:2px solid #fff3; background: #0003;
  backdrop-filter: blur(4px);
  border-radius:12px; padding:12px; overflow:hidden; position:relative;
}
@media(max-width: 1000px){ .panel{ width:100%; } }

button{
  padding:10px 16px; border:none; border-radius:8px; cursor:pointer;
  background:var(--accent); color:#fff; font-family:'Cairo',sans-serif;
}
button.alt{ background:#6c757d; }
button.ghost{ background:#39424e; }
button.green{ background:#198754; }
button.cyan{ background:#0dcaf0; color:#001218; }
button.warn{ background:#b08500; }
button:disabled{ opacity:0.6; cursor:not-allowed; }

select,input{ padding:10px; border-radius:8px; border:1px solid var(--line); background:#0004; color:var(--text); }
.controls-row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center; }

.overlay {
  position:fixed; inset:0;
  background:rgba(0,0,0,0.7);
  display:none; align-items:center; justify-content:center;
  font-size:24px; z-index:999; padding: 20px; text-align:center;
}

#noticeBar{
  position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
  background: #000c; color:#fff; padding:10px 16px; border-radius:999px;
  border:1px solid #fff4; z-index:1000; opacity:0; pointer-events:none;
  transition: opacity .25s ease;
}

/* لوحة اللاعبين */
#wheel canvas{ display:block; margin:10px auto 0; }
#turnTimerText { margin-top:6px; }
#turnProgressWrap{ width:80%; height:10px; background:#ffffff22; border-radius:999px; margin:6px auto 0; overflow:hidden; }
#turnProgress{ height:100%; width:0%; background:linear-gradient(90deg, #0ff, #09f); transition: width .2s linear; }

/* الدول Grid */
#countryList{
  display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; padding:8px;
}
.country{
  background:var(--card); border:1px solid #ffffff1a; border-radius:10px; padding:8px;
  text-align:center; opacity:0; transform: translateY(8px) scale(.98);
  transition: all .25s ease; cursor:pointer; user-select:none;
  box-shadow: 0 4px 12px rgba(0,0,0,.15);
}
.country.show{ opacity:1; transform: translateY(0) scale(1); }
.country img{ width:80px; display:block; margin:2px auto 6px; border-radius:6px; }

/* المقصّيين */
.eliminated-section { margin-top: 16px; padding: 12px; background: rgba(255,0,0,0.12);
  border-radius: 10px; border: 1px solid #ff000055; }
.eliminated-title { color: #ff6b6b; font-size: 22px; margin:0 0 6px; }
.eliminated-content { color: #ff9999; font-size: 16px; display:flex; flex-wrap:wrap; justify-content:center; gap:8px; }
.eliminated-item { background: rgba(255,0,0,0.25); padding:6px 10px; border-radius: 8px; }

/* إعادة اللاعبين */
.revive-section{ margin-top: 12px; padding: 12px; background: rgba(0,255,0,0.12);
  border-radius: 10px; border: 1px solid #00ff0055; }
.revive-title{ color:#00ff99; font-size:22px; margin:0 0 8px; }
.revive-select{ padding:8px; font-size:16px; border-radius:8px; border:none; }
.revive-button{ background:#28a745; }

/* لوحة نتائج + تاريخ أحداث */
.sidebar{ width:100%; border-top:1px dashed #ffffff33; margin-top:10px; padding-top:10px; }
.score-table{ width:100%; border-collapse: collapse; font-size:14px; }
.score-table th, .score-table td{ padding:6px 8px; border-bottom:1px solid #ffffff1a; text-align:center; }
.score-table th{ color:#0ff; }
.bad-icon{ color: var(--bad); }
.ok-icon{ color: var(--ok); }

/* مؤقت الجولة */
#roundTimerBox{ margin-top:10px; padding:8px; background:#0004; border:1px solid #ffffff22; border-radius:10px; display:inline-block; }
#themeToggle{ position: fixed; bottom: 14px; left: 14px; padding:8px 12px; font-size:14px; background:#222; border:1px solid #fff2; }
</style>
</head>
<body>
<div id="noticeBar"></div>

<h1>🌍 لعبة حرب الدول</h1>
<p>اختر المنصة وأرسل <span class="badge">!دخول</span> في الشات للانضمام <span class="badge">يُقفل بعد البدء</span></p>

<div class="container">
  <!-- لوحة اللاعبين -->
  <div class="panel" id="wheel">
    <h3>👥 قائمة اللاعبين</h3>
    <p class="small-note">سيكون اختيار الأسماء عشوائيًا</p>
    <canvas id="playerWheel" width="420" height="420"></canvas>
    <div class="controls-row" style="margin-top:6px;">
      <div title="مدة دوران العجلة: تؤثر على مدة الأنيميشن فقط">
        <select id="spinTimeSelect">
          <option value="10">10 ثواني</option>
          <option value="20">20 ثانية</option>
          <option value="30">30 ثانية</option>
          <option value="40">40 ثانية</option>
          <option value="50">50 ثانية</option>
          <option value="60" selected>60 ثانية</option>
        </select>
        <div class="small-note">⏱️ مدة دوران العجلة</div>
      </div>

      <div title="عدّاد الدور: الوقت المسموح للاعب المختار قبل التجاوز">
        <select id="turnSecondsSelect">
          <option value="20">20ث</option>
          <option value="30" selected>30ث</option>
          <option value="45">45ث</option>
          <option value="60">60ث</option>
        </select>
        <div class="small-note">⌚ عدّاد الدور</div>
      </div>

      <button onclick="spinWheelAnimated()">🎯 دوران العجلة</button>
      <button class="ghost" onclick="skipTurn()">⏭️ تجاوز الدور</button>
      <button class="alt" onclick="resetGame()">↺ إعادة تعيين</button>
    </div>
    <div id="turnTimerText" class="small-note">⏳ عدّاد الدور: غير نشط</div>
    <div id="turnProgressWrap"><div id="turnProgress"></div></div>

    <div class="sidebar">
      <h4 style="margin:10px 0 6px;">📊 لوحة النتائج</h4>
      <table class="score-table" id="scoreTable">
        <thead><tr><th>اللاعب</th><th>الدول</th><th>الحصانة</th></tr></thead>
        <tbody></tbody>
      </table>

      <h4 style="margin:10px 0 6px;">🕑 آخر الأحداث</h4>
      <div id="eventLog" class="small-note" style="text-align:right; max-height:140px; overflow:auto;"></div>

      <div style="margin-top:10px;">
        <button class="warn" onclick="endRound()">🏁 إنهاء الجولة وإعلان الفائز</button>
      </div>
    </div>
  </div>

  <!-- الدول -->
  <div class="panel">
    <div class="controls-row" style="justify-content:space-between;">
      <h3 style="margin:0;">🌐 الدول</h3>
      <div>
        <button onclick="manualShuffle()">🔁 خلط الدول</button>
        <button class="ghost" onclick="clearSavedState()">🗑️ حذف الحفظ</button>
      </div>
    </div>
    <p class="small-note">تقدر تنقر على بطاقة دولة للهجوم إذا كان دورك</p>
    <div id="countryList"></div>

    <!-- مقصّيين -->
    <div class="eliminated-section" id="eliminatedSection">
      <h3 class="eliminated-title">🚫 الدول المقصاة واللاعبين المطرودين</h3>
      <div class="eliminated-content" id="eliminatedContent">
        <div class="eliminated-item">لا يوجد محذوفين بعد</div>
      </div>
    </div>

    <!-- إعادة اللاعبين + مؤقت الجولة -->
    <div class="revive-section" id="reviveSection">
      <h3 class="revive-title">♻️ إعادة لاعب</h3>
      <select id="reviveSelect" class="revive-select">
        <option value="">اختر لاعباً لإعادته</option>
      </select>
      <button onclick="revivePlayer()" class="revive-button">إعادة اللاعب</button>
      <p class="small-note">أوامر الشات: <b>!اعاده @اسم</b> — الخروج: <b>!خروج</b></p>

      <div id="roundTimerBox" title="مؤقت الجولة: حدّ أقصى لمدّة المباراة كلها">
        ⌛ مؤقت الجولة:
        <select id="roundSelect" onchange="resetRoundTimerSelect()">
          <option value="0">بدون</option>
          <option value="600">10 دقائق</option>
          <option value="900">15 دقيقة</option>
          <option value="1800" selected>30 دقيقة</option>
        </select>
        <span id="roundTimeText">— غير نشط</span>
        <button class="cyan" onclick="startRoundTimer()">بدء</button>
        <button class="alt" onclick="stopRoundTimer()">إيقاف</button>
        <div class="small-note">📝 عند انتهاء المؤقت: نعلن الفائز حسب الباقين/أكثر دول</div>
      </div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay"></div>

<!-- اتصال بالشات -->
<div style="margin-top:16px;">
  <select id="platformSelect">
    <option value="twitch">Twitch</option>
    <option value="kick">Kick</option>
  </select>
  <input type="text" id="channelInput" placeholder="🎮 اكتب اسم القناة">
  <button class="green" onclick="connectChat()">✅ تسجيل الدخول</button>
  <div id="chatStatus" class="small-note" style="margin-top:6px; color:#0f0;"></div>
</div>

<div class="controls-row" style="margin-top:12px; gap:6px;">
  <button onclick="startGame()">بدء اللعبة</button>
  <button class="green" onclick="saveState()">💾 حفظ</button>
  <button class="cyan" onclick="loadState()">📥 استرجاع</button>
  <button id="themeToggle" onclick="toggleTheme()">🌓 تبديل الثيم</button>
</div>

<h3 id="currentTurnDisplay" style="margin-top:10px; color:#0ff;">✨ الدور الآن: لم يبدأ بعد</h3>

<script>
/* =========================
   الحالة والمتغيرات العامة
   ========================= */
let players = [], playerColors = {}, currentTurnPlayer = "";
const countriesPool = [
  "السعودية","الإمارات","قطر","مصر","الأردن","لبنان","العراق","الكويت","عمان","البحرين",
  "تونس","الجزائر","المغرب","ليبيا","السودان","اليمن","سوريا","فلسطين","تركيا","إيران",
  "ألمانيا","فرنسا","إيطاليا","إسبانيا","أمريكا","كندا","روسيا","الصين","اليابان","الهند"
];
let assignedCountries = {}, remainingCountries = [], immunityCountries = [], reviveCountries = [], usedSpecialCountries = [];
let playerImmunity = {}, eliminatedPlayers = [], lastReviver = "";
let isGameStarted = false;
const overlay = document.getElementById("overlay");
let eliminatedData = [];
let turnTimerId = null, turnSeconds = 30, joinLocked = false;
let roundTimerId = null, roundLeft = 0;
let eventLog = [];

/* =========================
   إشعارات علوية + Overlay
   ========================= */
const notice = document.getElementById('noticeBar');
function toast(msg, ms=3000){
  overlay.textContent = msg;
  overlay.style.display = "flex";
  clearTimeout(overlay._t);
  overlay._t = setTimeout(()=> overlay.style.display = "none", ms);
}
function notify(msg, ms=1800){
  notice.textContent = msg;
  notice.style.opacity = 1;
  clearTimeout(notice._t);
  notice._t = setTimeout(()=> notice.style.opacity = 0, ms);
}

/* =========================
   أدوات مساعدة
   ========================= */
function getColorForPlayer(player) {
  if (playerColors[player]) return playerColors[player];
  const hash = [...player].reduce((a, c) => a + c.charCodeAt(0), 0);
  const col = `hsl(${hash % 360}, 70%, 60%)`;
  playerColors[player] = col;
  return col;
}
function addPlayer(name, color = null) {
  if (joinLocked) return;
  if (!name) return;
  if (!players.includes(name)) {
    players.push(name);
    getColorForPlayer(name);
    renderPlayers(); updateScoreboard();
  }
}
function removePlayer(name){
  const idx = players.indexOf(name);
  if (idx !== -1){
    players.splice(idx,1);
    delete playerColors[name];
    for (const c of Object.keys(assignedCountries)){
      if (assignedCountries[c] === name){
        delete assignedCountries[c];
        remainingCountries = remainingCountries.filter(x=>x!==c);
      }
    }
    eliminatedPlayers = eliminatedPlayers.filter(x=>x!==name);
    eliminatedData = eliminatedData.filter(item=> item.player !== name);
    renderPlayers(); renderCountries(); updateEliminatedDisplay(); updateScoreboard();
  }
}
function logEvent(text){
  const ts = new Date().toLocaleTimeString();
  eventLog.unshift(`• [${ts}] ${text}`);
  eventLog = eventLog.slice(0, 20);
  document.getElementById('eventLog').innerHTML = eventLog.map(e=>`<div>${e}</div>`).join('');
}

/* =========================
   رسم عجلة اللاعبين
   ========================= */
function renderPlayers(rotation = 0) {
  const canvas = document.getElementById("playerWheel");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  const r = canvas.width / 2;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (players.length === 0) return;
  const slice = 2 * Math.PI / players.length;
  players.forEach((p, i) => {
    const angle = slice * i + rotation;
    ctx.beginPath(); ctx.moveTo(r, r);
    ctx.arc(r, r, r, angle, angle + slice);
    ctx.fillStyle = getColorForPlayer(p); ctx.fill(); ctx.strokeStyle="#000"; ctx.lineWidth=1; ctx.stroke();
    ctx.save(); ctx.translate(r, r); ctx.rotate(angle + slice / 2);
    ctx.textAlign = "right";
    ctx.fillStyle = "#000";
    ctx.font = "bold 14px Cairo";
    let displayName = p + (playerImmunity[p] ? " (محصن)" : "");
    ctx.fillText(displayName, r - 10, 5); ctx.restore();
  });
  // السهم الثابت عند زاوية 0 راديان (يمين المركز)
  ctx.beginPath();
  ctx.moveTo(canvas.width - 20, r);
  ctx.lineTo(canvas.width, r - 20);
  ctx.lineTo(canvas.width, r + 20);
  ctx.closePath();
  ctx.fillStyle = "#ff0";
  ctx.fill();
}

/* =========================
   المقصّيين + الإعادة
   ========================= */
function updateEliminatedDisplay() {
  const eliminatedContent = document.getElementById("eliminatedContent");
  const reviveSelect = document.getElementById("reviveSelect");
  eliminatedContent.innerHTML = "";
  reviveSelect.innerHTML = '<option value="">اختر لاعباً لإعادته</option>';
  if (eliminatedData.length === 0) {
      eliminatedContent.innerHTML = '<div class="eliminated-item">لا يوجد محذوفين بعد</div>';
      return;
  }
  eliminatedData.forEach(item => {
      const itemElement = document.createElement("div");
      itemElement.className = "eliminated-item";
      itemElement.textContent = `(${item.country}) ${item.player}`;
      eliminatedContent.appendChild(itemElement);
      const option = document.createElement("option");
      option.value = item.player;
      option.textContent = item.player;
      reviveSelect.appendChild(option);
  });
}
function revivePlayer() {
  const reviveSelect = document.getElementById("reviveSelect");
  const playerToRevive = reviveSelect.value;
  if (!playerToRevive) return;
  reviveByName(playerToRevive);
}
function reviveByName(playerToRevive){
  if (!eliminatedPlayers.includes(playerToRevive)) return;
  players.push(playerToRevive);
  getColorForPlayer(playerToRevive);
  eliminatedPlayers = eliminatedPlayers.filter(x => x !== playerToRevive);
  eliminatedData = eliminatedData.filter(item => item.player !== playerToRevive);
  const availableCountries = countriesPool.filter(c => 
      !remainingCountries.includes(c) && 
      !usedSpecialCountries.includes(c)
  );
  if (availableCountries.length > 0) {
      const newCountry = availableCountries[Math.floor(Math.random() * availableCountries.length)];
      assignedCountries[newCountry] = playerToRevive;
      remainingCountries.push(newCountry);
      usedSpecialCountries.push(newCountry);
      shufflePlayersAndCountries();
      renderCountries();
      renderPlayers();
      updateEliminatedDisplay();
      updateScoreboard();
      notify(`♻️ تمت إعادة ${playerToRevive} بدولة جديدة`);
      logEvent(`إعادة ${playerToRevive}`);
  }
}

/* =========================
   خلط اللاعبين والدول
   ========================= */
function shufflePlayersAndCountries() {
  for (let i = players.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [players[i], players[j]] = [players[j], players[i]];
  }
  const shuffledCountries = [...remainingCountries].sort(() => Math.random() - 0.5);
  const newAssignedCountries = {};
  shuffledCountries.forEach((country, i) => {
      if (assignedCountries[country] !== undefined) {
          const player = players[i % players.length] || null;
          newAssignedCountries[country] = player;
      } else {
          newAssignedCountries[country] = null;
      }
  });
  assignedCountries = newAssignedCountries;
}
function manualShuffle(){
  shufflePlayersAndCountries();
  renderCountries();
  renderPlayers();
  updateScoreboard();
  notify("🔁 تم خلط الدول واللاعبين عشوائيًا");
}

/* =========================
   دوران العجلة — دقّة وساعة حقيقية
   ========================= */
function spinWheelAnimated() {
  if (players.length === 0) return;

  stopTurnTimer(); // نوقف عدّاد الدور لو شغّال

  const spinSec = Math.max(1, parseInt(document.getElementById("spinTimeSelect").value) || 10);
  const durationMs = spinSec * 1000; // ← مدة حقيقية بالمللي ثانية
  const slice = 2 * Math.PI / players.length;

  const fullSpins = 5 * 2 * Math.PI;     // دورات كاملة لجمالية الحركة
  const randomAngle = Math.random() * 2 * Math.PI; // زاوية عشوائية لنتيجة مختلفة كل مرة
  const targetRotation = fullSpins + randomAngle;

  let rotation = 0;
  const start = performance.now();

  function animate(now) {
    const elapsed = now - start;
    let t = Math.min(1, elapsed / durationMs);      // 0 → 1 بحسب الوقت الحقيقي
    // منحنى تسهيل (ease-in-out, smoothstep)
    const eased = t * t * (3 - 2 * t);
    rotation = targetRotation * eased;
    renderPlayers(rotation);

    if (t < 1) {
      requestAnimationFrame(animate);
    } else {
      // حساب الفائز بدقة: السهم عند زاوية 0 راديان (يمين)
      const final = rotation % (2 * Math.PI);
      // الزاوية المقابلة تحت السهم هي عكس دوران العجلة:
      const angleUnderPointer = ( (2 * Math.PI) - final ) % (2 * Math.PI);
      // حوّلها إلى فهرس القطاع:
      const index = Math.floor(angleUnderPointer / slice) % players.length;

      currentTurnPlayer = players[index];
      toast(`🎯 اللاعب المختار: ${currentTurnPlayer}`, 1200);
      document.getElementById("currentTurnDisplay").innerText = `✨ الدور الآن: ${currentTurnPlayer}`;

      // ابدأ عدّاد الدور الحقيقي بعد الاختيار
      turnSeconds = parseInt(document.getElementById("turnSecondsSelect").value) || 30;
      startTurnTimer();
      logEvent(`اختيار الدور: ${currentTurnPlayer}`);
    }
  }
  requestAnimationFrame(animate);
}

/* =========================
   عدّاد الدور (اللاعب المختار)
   ========================= */
function startTurnTimer(){
  const txt = document.getElementById("turnTimerText");
  const bar = document.getElementById("turnProgress");
  let secs = turnSeconds;
  txt.textContent = `⏳ عدّاد الدور: ${secs}ث`;
  stopTurnTimer();
  bar.style.width = "100%";
  const total = secs;
  turnTimerId = setInterval(()=>{
    secs--;
    txt.textContent = `⏳ عدّاد الدور: ${secs}ث`;
    bar.style.width = Math.max(0, (secs/total)*100) + "%";
    if (secs <= 0){
      stopTurnTimer();
      txt.textContent = `⏳ عدّاد الدور: انتهى`;
      notify(`⏭️ انتهى وقت ${currentTurnPlayer} — تم تجاوز الدور`);
      logEvent(`تجاوز الدور عن ${currentTurnPlayer}`);
      currentTurnPlayer = "";
      document.getElementById("currentTurnDisplay").innerText = `✨ الدور الآن: لم يتم الاختيار`;
    }
  }, 1000);
}
function stopTurnTimer(){
  if (turnTimerId){ clearInterval(turnTimerId); turnTimerId = null; }
  const bar = document.getElementById("turnProgress");
  if (bar) bar.style.width = "0%";
}
function skipTurn(){
  if (!currentTurnPlayer) return;
  notify(`⏭️ تجاوزنا دور ${currentTurnPlayer}`);
  logEvent(`تجاوز ${currentTurnPlayer}`);
  currentTurnPlayer = "";
  document.getElementById("currentTurnDisplay").innerText = `✨ الدور الآن: لم يتم الاختيار`;
  stopTurnTimer();
}

/* =========================
   بدء اللعبة
   ========================= */
function startGame() {
  if (players.length < 2) return alert("يجب إضافة لاعبين أولاً!");
  isGameStarted = true;
  joinLocked = true;
  usedSpecialCountries = [];
  eliminatedData = [];
  playerImmunity = {};
  eliminatedPlayers = [];
  lastReviver = "";
  assignedCountries = {};
  remainingCountries = [];
  immunityCountries = [];
  reviveCountries = [];

  const totalNeeded = Math.min(countriesPool.length, players.length + 4);
  const availableCountries = [...countriesPool];
  const selectedCountries = [];
  for (let i = 0; i < totalNeeded; i++) {
    if (availableCountries.length === 0) break;
    const randomIndex = Math.floor(Math.random() * availableCountries.length);
    selectedCountries.push(availableCountries[randomIndex]);
    availableCountries.splice(randomIndex, 1);
  }
  const specialCountries = [];
  while (specialCountries.length < Math.min(4, selectedCountries.length)) {
    const randomIndex = Math.floor(Math.random() * selectedCountries.length);
    specialCountries.push(selectedCountries[randomIndex]);
    selectedCountries.splice(randomIndex, 1);
  }
  immunityCountries = specialCountries.slice(0, 2);
  reviveCountries = specialCountries.slice(2);
  usedSpecialCountries.push(...specialCountries);

  const playableCountries = [...selectedCountries];
  const shuffledPlayers = [...players];
  for (let i = shuffledPlayers.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffledPlayers[i], shuffledPlayers[j]] = [shuffledPlayers[j], shuffledPlayers[i]];
  }
  playableCountries.forEach((country, i) => {
    const player = shuffledPlayers[i % shuffledPlayers.length];
    assignedCountries[country] = player;
    remainingCountries.push(country);
  });

  remainingCountries.push(...specialCountries);
  specialCountries.forEach(country => { assignedCountries[country] = null; });

  renderCountries();
  renderPlayers();
  updateEliminatedDisplay();
  updateScoreboard();
  toast("🎮 بدأت اللعبة! تم توزيع الدول عشوائياً", 1300);
  saveState();
}

/* =========================
   عرض الدول + النقر للهجوم
   ========================= */
function renderCountries() {
  const box = document.getElementById("countryList");
  box.innerHTML = "";
  const list = [...remainingCountries];
  list.forEach((c, i) => {
    const div = document.createElement("div");
    div.className = "country";
    div.innerHTML = `<img src="https://flagcdn.com/w80/${getCountryCode(c)}.png" alt=""><div>${c}</div>`;
    div.onclick = () => { if (isGameStarted && currentTurnPlayer) attackCountry(c); };
    setTimeout(() => { box.appendChild(div); setTimeout(() => div.classList.add("show"), 10); }, i * 40);
  });
}

/* =========================
   منطق الهجوم
   ========================= */
function attackCountry(c) {
  if (!isGameStarted || !currentTurnPlayer) return;
  if (!remainingCountries.includes(c)) return;

  const attacker = currentTurnPlayer;
  const victim = assignedCountries[c];

  toast(`🔴 ${attacker} هاجم ${c}`, 900);
  stopTurnTimer();
  currentTurnPlayer = ""; // تجميد الدور أثناء الإجراء

  setTimeout(() => {
    if (victim && playerImmunity[victim] && attacker !== victim) {
      playerImmunity[victim] = false;
      notify(`🛡️ تم كسر حصانة ${victim}`);
      logEvent(`كسر حصانة ${victim}`);
      shufflePlayersAndCountries();
      renderCountries(); renderPlayers(); updateScoreboard();
    }
    else if (immunityCountries.includes(c)) {
      playerImmunity[attacker] = true;
      immunityCountries = immunityCountries.filter(x => x !== c);
      usedSpecialCountries.push(c);
      remainingCountries = remainingCountries.filter(x => x !== c);
      delete assignedCountries[c];
      notify(`✅ ${attacker} حصل على حصانة`);
      logEvent(`حصانة إلى ${attacker}`);
      renderCountries(); renderPlayers(); updateScoreboard();
    }
    else if (reviveCountries.includes(c)) {
      reviveCountries = reviveCountries.filter(x => x !== c);
      usedSpecialCountries.push(c);
      remainingCountries = remainingCountries.filter(x => x !== c);
      delete assignedCountries[c];
      lastReviver = attacker;
      notify(`♻️ ${attacker} يقدر يعيد لاعب: !اعاده @الاسم`);
      logEvent(`صلاحية إعادة حصل عليها ${attacker}`);
      renderCountries();
    }
    else if (victim && attacker === victim) {
      remainingCountries = remainingCountries.filter(x => x !== c);
      delete assignedCountries[c];
      const index = players.indexOf(victim);
      if (index !== -1) players.splice(index, 1);
      delete playerColors[victim];
      eliminatedPlayers.push(victim);
      eliminatedData.push({ country: c, player: victim });
      notify(`❌ ${victim} أقصى نفسه`);
      logEvent(`${victim} أقصى نفسه من ${c}`);
      renderPlayers(); renderCountries(); updateEliminatedDisplay(); updateScoreboard();
    }
    else if (victim && attacker !== victim) {
      remainingCountries = remainingCountries.filter(x => x !== c);
      delete assignedCountries[c];
      const index = players.indexOf(victim);
      if (index !== -1) players.splice(index, 1);
      delete playerColors[victim];
      eliminatedPlayers.push(victim);
      eliminatedData.push({ country: c, player: victim });
      notify(`❌ تم إقصاء ${victim} من ${c}`);
      logEvent(`${attacker} أقصى ${victim} من ${c}`);
      renderPlayers(); renderCountries(); updateEliminatedDisplay(); updateScoreboard();
    }

    saveState();
    document.getElementById("currentTurnDisplay").innerText = `✨ الدور الآن: لم يتم الاختيار`;
  }, 900);
}

/* =========================
   أعلام
   ========================= */
function getCountryCode(n) {
  const codes = { "السعودية":"sa","الإمارات":"ae","قطر":"qa","مصر":"eg","الأردن":"jo","لبنان":"lb","العراق":"iq","الكويت":"kw","عمان":"om","البحرين":"bh","تونس":"tn","الجزائر":"dz","المغرب":"ma","ليبيا":"ly","السودان":"sd","اليمن":"ye","سوريا":"sy","فلسطين":"ps","تركيا":"tr","إيران":"ir","ألمانيا":"de","فرنسا":"fr","إيطاليا":"it","إسبانيا":"es","أمريكا":"us","كندا":"ca","روسيا":"ru","الصين":"cn","اليابان":"jp","الهند":"in" };
  return codes[n] || "un";
}

/* =========================
   اتصال بالشات
   ========================= */
function connectChat() {
  const plat = document.getElementById("platformSelect").value;
  const channel = document.getElementById("channelInput").value.trim();
  if (!channel) { toast("⚠️ اكتب اسم القناة أولاً"); return; }

  if (plat === "twitch") {
    const client = new tmi.Client({ channels: [channel] });
    client.connect();
    client.on("message", (ch, tags, msg, self) => {
      if (self) return;
      const user = tags["display-name"] || tags["username"] || "";
      const color = tags["color"] || null;
      const content = (msg||"").trim();

      if (!isGameStarted && content === "!دخول") addPlayer(user, color);
      if (content === "!خروج") removePlayer(user);

      if (isGameStarted && currentTurnPlayer && user === currentTurnPlayer && countriesPool.includes(content)) {
        if (remainingCountries.includes(content)) attackCountry(content);
      }

      if ((content.startsWith("!اعاده") || content.startsWith("!إعاده")) && user === lastReviver) {
        const mentioned = content.split("@")[1]?.trim();
        if (mentioned) reviveByName(mentioned);
      }
    });
    document.getElementById("chatStatus").innerText = "✅ تم الاتصال بـTwitch!";
  }

  else if (plat === "kick") {
    fetch(`https://kick.com/api/v2/channels/${channel}`)
      .then(res => res.json())
      .then(data => {
        const roomId = data.chatroom.id;
        const socket = new WebSocket("wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=8.4.0-rc2");
        socket.onopen = () => {
          socket.send(JSON.stringify({ event: "pusher:subscribe", data: { auth: "", channel: `chatrooms.${roomId}.v2` } }));
          setInterval(() => {
            if (socket.readyState === WebSocket.OPEN)
              socket.send(JSON.stringify({ event: "pusher:ping", data: {} }));
          }, 12000);
        };
        socket.onmessage = (e) => {
          const msg = JSON.parse(e.data);
          if (msg.event === "App\\Events\\ChatMessageEvent") {
            const d = JSON.parse(msg.data);
            const user = d.sender.username;
            const content = (d.content || "").trim();

            if (!isGameStarted && content === "!دخول") addPlayer(user);
            if (content === "!خروج") removePlayer(user);

            if (isGameStarted && currentTurnPlayer && user === currentTurnPlayer && countriesPool.includes(content)) {
              if (remainingCountries.includes(content)) attackCountry(content);
            }

            if ((content.startsWith("!اعاده") || content.startsWith("!إعاده")) && user === lastReviver) {
              const mentioned = content.split("@")[1]?.trim();
              if (mentioned) reviveByName(mentioned);
            }
          }
        };
        document.getElementById("chatStatus").innerText = "✅ تم الاتصال بـKick!";
      })
      .catch(err => {
        console.error("Kick connection error:", err);
        document.getElementById("chatStatus").innerText = "❌ فشل الاتصال بـKick!";
      });
  }
}

/* =========================
   لوحة النتائج
   ========================= */
function updateScoreboard(){
  const counts = {};
  for (const c of Object.keys(assignedCountries)){
    const p = assignedCountries[c];
    if (p) counts[p] = (counts[p]||0) + 1;
  }
  const tbody = document.querySelector('#scoreTable tbody');
  tbody.innerHTML = players.map(p=>{
    const n = counts[p]||0;
    const hasImmunity = !!playerImmunity[p];
    return `<tr>
      <td>${p}</td>
      <td>${n}</td>
      <td>${hasImmunity ? '<span class="ok-icon">🛡️</span>' : '-'}</td>
    </tr>`;
  }).join('');
}

/* =========================
   مؤقت الجولة
   ========================= */
function resetRoundTimerSelect(){
  const sel = document.getElementById('roundSelect');
  roundLeft = parseInt(sel.value)||0;
  document.getElementById('roundTimeText').textContent = roundLeft ? `— ${formatM(roundLeft)}` : '— غير نشط';
}
function startRoundTimer(){
  stopRoundTimer();
  roundLeft = parseInt(document.getElementById('roundSelect').value)||0;
  if (!roundLeft){ notify("⏳ لا يوجد مؤقت محدد"); return; }
  document.getElementById('roundTimeText').textContent = `— ${formatM(roundLeft)}`;
  roundTimerId = setInterval(()=>{
    roundLeft--;
    document.getElementById('roundTimeText').textContent = `— ${formatM(roundLeft)}`;
    if (roundLeft<=0){
      stopRoundTimer();
      notify("🏁 انتهى زمن الجولة — سنعلن الفائزين حسب البقاء/أكثر دول");
      endRound(true);
    }
  },1000);
}
function stopRoundTimer(){
  if (roundTimerId){ clearInterval(roundTimerId); roundTimerId=null; }
}
function formatM(sec){
  const m = Math.floor(sec/60), s = sec%60;
  return `${m}:${String(s).padStart(2,'0')}`;
}

/* =========================
   إنهاء الجولة وإعلان الفائز
   ========================= */
function endRound(auto=false){
  const counts = {};
  for (const c of Object.keys(assignedCountries)){
    const p = assignedCountries[c];
    if (p) counts[p] = (counts[p]||0) + 1;
  }
  let best = [], max = -1;
  players.forEach(p=>{
    const n = counts[p]||0;
    if (n>max){ max=n; best=[p]; }
    else if (n===max){ best.push(p); }
  });
  let msg = "";
  if (players.length===1){
    msg = `🏆 الفائز: ${players[0]} — آخر لاعب باقٍ`;
  }else if (best.length===1){
    msg = `🏆 الفائز: ${best[0]} — بأكبر عدد دول (${max})`;
  }else{
    msg = `🤝 تعادل بين: ${best.join('، ')} — (${max})`;
  }
  toast(msg, 3500);
  logEvent(msg);
}

/* =========================
   الحفظ
   ========================= */
function saveState(){
  const state = {
    players, playerColors, currentTurnPlayer,
    assignedCountries, remainingCountries,
    immunityCountries, reviveCountries, usedSpecialCountries,
    playerImmunity, eliminatedPlayers, lastReviver,
    isGameStarted, eliminatedData, joinLocked, eventLog
  };
  localStorage.setItem("war_states_v3", JSON.stringify(state));
  notify("💾 تم الحفظ", 900);
}
function loadState(){
  const raw = localStorage.getItem("war_states_v3");
  if (!raw) { toast("ℹ️ لا يوجد حفظ سابق"); return; }
  try{
    const s = JSON.parse(raw);
    players = s.players || [];
    playerColors = s.playerColors || {};
    currentTurnPlayer = s.currentTurnPlayer || "";
    assignedCountries = s.assignedCountries || {};
    remainingCountries = s.remainingCountries || [];
    immunityCountries = s.immunityCountries || [];
    reviveCountries = s.reviveCountries || [];
    usedSpecialCountries = s.usedSpecialCountries || [];
    playerImmunity = s.playerImmunity || {};
    eliminatedPlayers = s.eliminatedPlayers || [];
    lastReviver = s.lastReviver || "";
    isGameStarted = !!s.isGameStarted;
    eliminatedData = s.eliminatedData || [];
    joinLocked = !!s.joinLocked;
    eventLog = s.eventLog || [];

    renderCountries(); renderPlayers(); updateEliminatedDisplay(); updateScoreboard();
    document.getElementById("eventLog").innerHTML = eventLog.map(e=>`<div>${e}</div>`).join('');
    document.getElementById("currentTurnDisplay").innerText = `✨ الدور الآن: ${currentTurnPlayer || "غير محدد"}`;
    notify("📥 تم استرجاع الحالة");
  }catch(e){
    console.error(e);
    toast("⚠️ حصل خطأ أثناء الاسترجاع");
  }
}
function clearSavedState(){
  localStorage.removeItem("war_states_v3");
  notify("🗑️ تم حذف الحفظ", 900);
}

/* =========================
   ثيم
   ========================= */
function toggleTheme(){
  const isLight = document.documentElement.getAttribute('data-theme') === 'light';
  document.documentElement.setAttribute('data-theme', isLight ? 'dark' : 'light');
  notify(isLight ? "🌙 ثيم غامق" : "☀️ ثيم فاتح");
}

/* =========================
   تهيئة
   ========================= */
function resetGame(){
  if (turnTimerId) clearInterval(turnTimerId);
  if (roundTimerId) clearInterval(roundTimerId);
  players = []; playerColors = {}; currentTurnPlayer = "";
  assignedCountries = {}; remainingCountries = [];
  immunityCountries = []; reviveCountries = []; usedSpecialCountries = [];
  playerImmunity = {}; eliminatedPlayers = []; lastReviver = "";
  isGameStarted = false; eliminatedData = []; joinLocked = false; eventLog = [];
  renderPlayers(); renderCountries(); updateEliminatedDisplay(); updateScoreboard();
  document.getElementById("eventLog").innerHTML = "";
  document.getElementById("currentTurnDisplay").innerText = `✨ الدور الآن: لم يبدأ بعد`;
  notify("↺ تم إعادة تعيين اللعبة");
}
function init(){
  document.documentElement.setAttribute('data-theme', 'dark');
  resetRoundTimerSelect();
}
init();
</script>
</body>
</html>
