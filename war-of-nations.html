<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>๐ ุญุฑุจ ุงูุฏูู - ุงููุณุฎุฉ ุงููุญุณูุฉ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tmi.js@1.8.5/dist/tmi.min.js"></script>
  <script src="tmi.min.js"></script>
<style>
:root{
  --bg1:#1a1a3d; --bg2:#004466; --text:#fff; --panel:#222; --line:#444;
  --accent:#ff3333; --ok:#00e6a8; --warn:#ffcc00; --muted:#ccc; --card:#222;
  --badge:#0b3d3d; --badge-b:#0ff; --bad:#ff6666; --ally:#00ff00;
}
[data-theme="light"]{
  --bg1:#f2f6ff; --bg2:#dfe9ff; --text:#111; --panel:#fff; --line:#e5e7eb;
  --accent:#ff3333; --ok:#00a37a; --warn:#b08500; --muted:#444; --card:#fff;
  --badge:#e8f7f7; --badge-b:#027e7e; --bad:#b00020; --ally:#00aa00;
}
body {
  background: linear-gradient(-45deg, var(--bg1), var(--bg2), var(--bg1), var(--bg2));
  background-size: 400% 400%;
  animation: gradientBG 20s ease infinite;
  color: var(--text);
  font-family: 'Cairo', sans-serif;
  text-align: center;
  padding: 20px;
}
@keyframes gradientBG { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

h1{ font-size:36px; color:var(--accent); margin:0 0 10px; }
.small-note{ font-size:14px; color:var(--muted); }
.badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:var(--badge); border:1px solid var(--badge-b); color:var(--badge-b); font-size:12px; margin-inline:6px; }

.container { display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start; }
.panel{
  width:48%; min-height:300px; border:2px solid #fff3; background: #0003;
  backdrop-filter: blur(4px);
  border-radius:12px; padding:12px; overflow:hidden; position:relative;
}
@media(max-width: 1000px){ .panel{ width:100%; } }

button{
  padding:10px 16px; border:none; border-radius:8px; cursor:pointer;
  background:var(--accent); color:#fff; font-family:'Cairo',sans-serif;
  transition: transform 0.2s, box-shadow 0.2s;
}
button:hover{ transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
button.alt{ background:#6c757d; }
button.ghost{ background:#39424e; }
button.green{ background:#198754; }
button.cyan{ background:#0dcaf0; color:#001218; }
button.warn{ background:#b08500; }
button.purple{ background:#6f42c1; }
button:disabled{ opacity:0.6; cursor:not-allowed; }

select,input{ padding:10px; border-radius:8px; border:1px solid var(--line); background:#0004; color:var(--text); }
.controls-row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center; }

.overlay {
  position:fixed; inset:0;
  background:rgba(0,0,0,0.7);
  display:none; align-items:center; justify-content:center;
  font-size:24px; z-index:999; padding: 20px; text-align:center;
}

#noticeBar{
  position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
  background: #000c; color:#fff; padding:10px 16px; border-radius:999px;
  border:1px solid #fff4; z-index:1000; opacity:0; pointer-events:none;
  transition: opacity .25s ease;
}

/* ุฒุฑ ุงูุดุฑุญ */
#helpBtn{
  position:fixed; top:14px; left:14px; z-index:1001;
  padding:8px 12px; border-radius:999px; font-size:14px; background:#222; border:1px solid #fff2;
}

/* ูุงูุฐุฉ ุงูุดุฑุญ ุงูููุณุนุฉ */
#helpModal{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:1100; }
#helpCard{
  background:var(--card); color:var(--text); border:1px solid #ffffff22; width:min(720px, 92vw);
  border-radius:14px; padding:16px; text-align:right; line-height:1.8; max-height:80vh; overflow-y:auto;
}
#helpCard h3{ margin:0 0 8px; color:#0ff; }
#helpCard .close{ float:left; background:#39424e; }

/* ููุญุฉ ุงูุงุชุตุงู */
.connect-bar{
  position:relative; margin:12px auto 16px; width:min(1100px, 96vw);
  background:#0006; border:1px solid #ffffff22; border-radius:14px;
}
.connect-header{
  display:flex; align-items:center; justify-content:space-between; padding:10px 14px; cursor:pointer;
}
.connect-left{ display:flex; align-items:center; gap:10px; }
.chev{ transition:transform .2s ease; }
.status-dot{
  width:10px; height:10px; border-radius:50%; background:#7a7a7a; border:1px solid #fff3;
}
.status-dot.ok{ background:#19c37d; animation: pulse 2s infinite; }
@keyframes pulse { 0%,100%{ opacity:1; } 50%{ opacity:0.5; } }
.connect-title{ font-weight:700; }
.connect-body{
  display:none; border-top:1px dashed #ffffff30; padding:12px; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
}
.connect-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.connect-body input, .connect-body select{ background:#0005; }
.connect-actions{ display:flex; gap:8px; align-items:center; }
.remember{ display:flex; align-items:center; gap:6px; font-size:14px; color:var(--muted); }

/* ููุญุฉ ุงูุณุชุฑููุฑ ุงูููุณุนุฉ */
.streamer-bar{
  position:relative; margin:12px auto 18px; width:min(1100px, 96vw);
  background:#0006; border:1px solid #ffffff22; border-radius:14px;
}
.streamer-header{
  display:flex; align-items:center; justify-content:space-between; padding:10px 14px; cursor:pointer;
}
.streamer-title{ font-weight:700; }
.streamer-body{
  display:none; border-top:1px dashed #ffffff30; padding:12px; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
}
.streamer-section{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

/* ุดุฑูุท ุชูุฏู ุงููุนุจุฉ */
#gameProgressWrap{
  width:100%; height:6px; background:#ffffff22; border-radius:999px; margin:10px 0; overflow:hidden;
}
#gameProgress{ height:100%; width:0%; background:linear-gradient(90deg, var(--accent) 0%, var(--ok) 50%, var(--bad) 100%); transition:width 0.5s; }

/* ุชููุฌ ููุฏูุฑ ุงูุญุงูู */
.current-turn { animation: glow 1.5s infinite alternate; }
@keyframes glow {
  from { text-shadow: 0 0 10px #0ff; }
  to { text-shadow: 0 0 20px #0ff, 0 0 30px #0ff; }
}

/* ุนุฏุงุฏ ุงูุฏูู ุงููุชุจููุฉ */
#remainingCount { font-size:20px; font-weight:bold; color:var(--ok); }

/* ููุญุฉ ุงููุงุนุจูู */
#wheel canvas{ display:block; margin:10px auto 0; }
#turnTimerText { margin-top:6px; }
#turnProgressWrap{ width:80%; height:10px; background:#ffffff22; border-radius:999px; margin:6px auto 0; overflow:hidden; }
#turnProgress{ height:100%; width:0%; background:linear-gradient(90deg, #0ff, #09f); transition: width .2s linear; }

/* ุงูุฏูู Grid ูุน ุชุฃุซูุฑุงุช */
#countryList{
  display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; padding:8px;
}
.country{
  background:var(--card); border:1px solid #ffffff1a; border-radius:10px; padding:8px;
  text-align:center; opacity:0; transform: translateY(8px) scale(.98);
  transition: all .25s ease; cursor:pointer; user-select:none;
  box-shadow: 0 4px 12px rgba(0,0,0,.15);
}
.country.show{ opacity:1; transform: translateY(0) scale(1); }
.country:hover{ transform:translateY(-4px); box-shadow:0 8px 20px rgba(0,0,0,0.3); }
.country img{ width:80px; display:block; margin:2px auto 6px; border-radius:6px; }
/* ุฅุฒุงูุฉ ุชุฃุซูุฑุงุช ุงูุฏูู ุงูุฎุงุตุฉ - ุฃุตุจุญุช ูุฎููุฉ */
.country.special { 
  background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%);
  position: relative;
}
/* ุฑูุฒ ุงูุฏูู ุงูุฎุงุตุฉ (ุฎููู) */
.country.special::after {
  content: "โญ";
  position: absolute;
  top: 5px;
  left: 5px;
  font-size: 12px;
  opacity: 0.5;
}

/* ุชุฃุซูุฑุงุช ุงููุฌูู */
.attack-effect {
  position: absolute;
  font-size: 40px;
  pointer-events: none;
  z-index: 10000;
  animation: fly 1s forwards;
}
@keyframes fly {
  0% { transform: scale(0.5); opacity: 0; }
  50% { transform: scale(1.2); opacity: 1; }
  100% { transform: scale(0); opacity: 0; }
}

/* ุงูููุตูููู */
.eliminated-section { margin-top: 16px; padding: 12px; background: rgba(255,0,0,0.12);
  border-radius: 10px; border: 1px solid #ff000055; }
.eliminated-title { color: #ff6b6b; font-size: 22px; margin:0 0 6px; }
.eliminated-content { color: #ff9999; font-size: 16px; display:flex; flex-wrap:wrap; justify-content:center; gap:8px; }
.eliminated-item { background: rgba(255,0,0,0.25); padding:6px 10px; border-radius: 8px; }

/* ููุญุฉ ุงูุฅุญุตุงุฆูุงุช */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-top: 10px;
}
.stat-item {
  background: rgba(255,255,255,0.05);
  padding: 8px;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.1);
}

/* ุฃุฒุฑุงุฑ ุงูุชูุงุนู */
.reactions-bar {
  display: flex;
  gap: 8px;
  justify-content: center;
  margin: 10px 0;
}
.reaction-btn {
  font-size: 24px;
  padding: 5px;
  background: transparent;
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  cursor: pointer;
  transition: all 0.2s;
}
.reaction-btn:hover {
  background: rgba(255,255,255,0.1);
  transform: scale(1.2);
}

/* ููุญุฉ ุงูุจุทุงูุงุช ุงูุฎุงุตุฉ */
.special-cards {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: center;
  margin: 10px 0;
}
.card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s;
}
.card:hover {
  transform: translateY(-3px) rotate(3deg);
}

#themeToggle{ position: fixed; bottom: 14px; left: 14px; padding:8px 12px; font-size:14px; background:#222; border:1px solid #fff2; }

/* ุฃุฒุฑุงุฑ ุงููุถุน ุงูุณุฑูุน */
.quick-settings {
  display: flex;
  gap: 8px;
  margin: 10px 0;
}
.quick-btn {
  padding: 6px 12px;
  font-size: 12px;
}

/* ูุงูุฐุฉ ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ */
.settings-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1200;
}
.settings-content {
  background: var(--card);
  border-radius: 12px;
  padding: 20px;
  width: min(500px, 90vw);
  max-height: 80vh;
  overflow-y: auto;
}
.setting-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid var(--line);
}
.setting-label {
  font-size: 14px;
}
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}
.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 24px;
}
.toggle-slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}
input:checked + .toggle-slider {
  background-color: var(--ok);
}
input:checked + .toggle-slider:before {
  transform: translateX(26px);
}

/* ุฑูุฒ ุณุฑู ููุณุชุฑููุฑ */
.streamer-hint {
  position: absolute;
  top: 5px;
  right: 5px;
  font-size: 10px;
  color: rgba(255,255,255,0.3);
}
</style>
</head>
<body>
<div id="noticeBar"></div>

<!-- ุฒุฑ ุงูุดุฑุญ -->
<button id="helpBtn">โ ุดุฑุญ ุดุงูู</button>

<!-- ููุฏุงู ุงูุดุฑุญ ุงูููุณุน -->
<div id="helpModal">
  <div id="helpCard">
    <button class="close" id="helpClose">โ</button>
    <h3>๐ฎ ุดุฑุญ ุดุงูู - ุญุฑุจ ุงูุฏูู ุงููุณุฎุฉ ุงููุญุณูุฉ</h3>
    
    <h4>โจ ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ ุงููุงููุฉ:</h4>
    
    <h5>๐ ุงููุธุงู ุงูุฌุฏูุฏ: ููููุฉ ุงูุฏูู ูุฎููุฉ</h5>
    <ul>
      <li><b>ุงูุฃุณูุงุก ูุฎููุฉ:</b> ูุง ุชุธูุฑ ุฃุณูุงุก ุงููุงุนุจูู ูู ุจุทุงูุงุช ุงูุฏูู</li>
      <li><b>ุงูุฏูู ุงูุฎุงุตุฉ ูุฎููุฉ:</b> ูุง ูููู ุชูููุฒ ุงูุฏูู ุงููููุฒุฉ (ุญุตุงูุฉ/ุฅุนุงุฏุฉ)</li>
      <li><b>ุนุดูุงุฆูุฉ ูุงููุฉ:</b> ุงูุฏูู ุชุธูุฑ ุจุดูู ุนุงุฏู ุจุฏูู ุฃู ุฅุดุงุฑุงุช ููููููุฉ</li>
      <li><b>ููุงุฌุฃุฉ:</b> ูุง ูุนุฑู ุงููุงุนุจูู ูุงุฐุง ุณูุญุฏุซ ุนูุฏ ุงููุฌูู ุนูู ุฏููุฉ</li>
      <li><b>ุงูุณุชุฑููุฑ ููุท:</b> ูุณุชุทูุน ุงูุณุชุฑููุฑ ุฑุคูุฉ ูุนูููุงุช ุฅุถุงููุฉ</li>
    </ul>
    
    <h5>๐ ูุธุงู ุงูููุงุท ูุงูุฅุญุตุงุฆูุงุช</h5>
    <ul>
      <li>ุชุชุจุน ุฃุฏุงุก ูู ูุงุนุจ (ูุชููุ ูุฌูุงุช ูุงุฌุญุฉุ ุจุทุงูุงุช ูุณุชุฎุฏูุฉ)</li>
      <li>ููุญุฉ ุฅุญุตุงุฆูุงุช ุญูุฉ ุชุนุฑุถ ุจูุงูุงุช ุงููุนุจุฉ ูู ุงูููุช ุงูุญูููู</li>
      <li>ุณุฌู ุงููุจุงุฑูุงุช ุงูุณุงุจูุฉ ูุน ุงูุชูุงุฑูุฎ ูุงููุชุงุฆุฌ</li>
      <li>ููุงุท ููุณููุฉ ูุชุฑุชูุจ ุงููุงุนุจูู ุจูุงุก ุนูู ุงูุฃุฏุงุก</li>
      <li>ุนุฑุถ "ุฃูุซุฑ ุฏููุฉ ููุฌูุช" ู"ุฃููู ูุงุนุจ" ุญุงููุงู</li>
    </ul>
    
    <h5>๐ค ูุธุงู ุงูุชุญุงููุงุช ุงููุคูุชุฉ</h5>
    <ul>
      <li>ูููู ููุงุนุจูู ุชุดููู ุชุญุงููุงุช ููุฏุฉ 3 ุฃุฏูุงุฑ ุจุงุณุชุฎุฏุงู <code>!ุชุญุงูู @ุงุณู_ุงููุงุนุจ</code></li>
      <li>ูุง ูููู ููุงุนุจูู ุงููุชุญุงูููู ููุงุฌูุฉ ุจุนุถูู ุงูุจุนุถ</li>
      <li>ุนุฑุถ ุฌููุน ุงูุชุญุงููุงุช ุงููุดุทุฉ ูุน ุงูููุช ุงููุชุจูู</li>
      <li>ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุนุฏุฏ ุงูุชุญุงููุงุช ููู ูุงุนุจ</li>
    </ul>
    
    <h5>๐ ุงูุจุทุงูุงุช ุงูุฎุงุตุฉ</h5>
    <ul>
      <li><b>ุจุทุงูุฉ ุงูุณุฑูุฉ:</b> ุชุณุชุทูุน ุณุฑูุฉ ุฏููุฉ ุนุดูุงุฆูุฉ ูู ูุงุนุจ ุขุฎุฑ</li>
      <li><b>ุจุทุงูุฉ ุงูุญุตุงูุฉ ุงูุฌูุงุนูุฉ:</b> ุญุตุงูุฉ ููู ุฏููู ูุฏูุฑ ูุงุญุฏ</li>
      <li><b>ุจุทุงูุฉ ุงููุฌูู ุงููุฒุฏูุฌ:</b> ููููู ุงููุฌูู ูุฑุชูู ูู ููุณ ุงูุฏูุฑ</li>
      <li>ูุธูุฑ ุฒุฑ ููู ุจุทุงูุฉ ูู ููุญุฉ ุงููุงุนุจูู</li>
      <li>ุชุชุจุน ุนุฏุฏ ุงูุจุทุงูุงุช ุงููุณุชุฎุฏูุฉ ูู ุงูุฅุญุตุงุฆูุงุช</li>
    </ul>
    
    <h5>๐ฒ ุงูุฃุญุฏุงุซ ุงูุนุดูุงุฆูุฉ</h5>
    <ul>
      <li><b>ุฒูุฒุงู:</b> ุชุฎุชูู ุฏููุฉ ุนุดูุงุฆูุฉ ูู ุงููุนุจุฉ</li>
      <li><b>ุชุญุงูู ุฏุจูููุงุณู:</b> ุฌููุน ุงููุงุนุจูู ูุง ููุงุฌููู ูุฐุง ุงูุฏูุฑ</li>
      <li><b>ุซูุฑุฉ:</b> ุชุชุจุงุฏู ุฏููุชุงู ูุงูููููุง ุจุดูู ุนุดูุงุฆู</li>
      <li><b>ุฌูุงุฆุฒ ุฏุจูููุงุณูุฉ:</b> ุฌููุน ุงููุงุนุจูู ูุญุตููู ุนูู ุฏููุฉ ุฅุถุงููุฉ</li>
      <li>ูููู ุงูุชุญูู ูู ูุฑุตุฉ ุญุฏูุซ ุงูุฃุญุฏุงุซ ูู ููุญุฉ ุงูุณุชุฑููุฑ</li>
    </ul>
    
    <h5>๐ฏ ูุธุงู ุงูุชุญุฏูุงุช</h5>
    <ul>
      <li>ุชุญุฏูุงุช ุฏูุฑูุฉ ุชุธูุฑ ููุงุนุจ ุงูุฐู ุนููู ุงูุฏูุฑ</li>
      <li>ูุซุงู: "ูุงุฌู ุฏููุฉ ูุฌุงูุฑุฉ ุฌุบุฑุงููุง" ุฃู "ูุงุฌู ุฏููุฉ ุชุจุฏุฃ ุจุญุฑู 'ุฃ'"</li>
      <li>ุฅููุงู ุงูุชุญุฏู ูููุญ ููุงุท ุฅุถุงููุฉ</li>
      <li>ุชุญุฏูุซ ุงูุชุญุฏู ุจุนุฏ ูู ูุฌูู</li>
    </ul>
    
    <h5>๐ฌ ุงูุชูุงุนูุงุช ุงูุงุฌุชูุงุนูุฉ</h5>
    <ul>
      <li>ูุธุงู ุฑุณุงุฆู ุฎุงุตุฉ ุจูู ุงููุงุนุจูู ุจุงุณุชุฎุฏุงู <code>!ุฑุณุงูุฉ @ุงุณู_ุงููุงุนุจ ูุต_ุงูุฑุณุงูุฉ</code></li>
      <li>ุฃุฒุฑุงุฑ ุชูุงุนู ุจุงูุฅูููุฌูุฒ (๐ ๐ ๐ฅ ๐ก๏ธ โ๏ธ ๐)</li>
      <li>ุฅุดุนุงุฑุงุช ุนูุฏ ุชููู ุงูุฑุณุงุฆู</li>
      <li>ุนุฑุถ ุขุฎุฑ ุงูุชูุงุนูุงุช ูู ููุญุฉ ุงูุฃุญุฏุงุซ</li>
    </ul>
    
    <h5>โฑ๏ธ ูุถุน ุงูุณุจุงู</h5>
    <ul>
      <li>ูุคูุช ุชูุงุฒูู (5 ุฏูุงุฆู) ูุธูุฑ ูู ุฃุนูู ุงูุดุงุดุฉ</li>
      <li>ุงูุชูุงุก ุงูููุช ูููู ุงููุนุจุฉ ุชููุงุฆูุงู</li>
      <li>ุชุญุฐูุฑุงุช ุตูุชูุฉ/ุจุตุฑูุฉ ุนูุฏ ุงูุชุฑุงุจ ุงูููุงูุฉ</li>
      <li>ุชุบููุฑ ููู ุงููุคูุช ุนูุฏ ุงูุฎูุงุถ ุงูููุช (ุฃุตูุฑ โ ุฃุญูุฑ)</li>
    </ul>
    
    <h5>โ๏ธ ุงูุฃุฏูุงุช ุงูุฅุฏุงุฑูุฉ ุงููุชูุฏูุฉ</h5>
    <ul>
      <li><b>ุทุฑุฏ ุงููุงุนุจูู:</b> ุฅุฒุงูุฉ ูุงุนุจ ูู ุงููุนุจุฉ</li>
      <li><b>ูุงุฆุฏ ุงููุฑูู:</b> ููุญ ุตูุงุญูุงุช ุฅุถุงููุฉ (ุญุตุงูุฉ) ููุงุนุจ</li>
      <li><b>ุฅููุงู ูุคูุช:</b> ุฅููู ุงููุนุจุฉ ููุฏุฉ ูุญุฏุฏุฉ</li>
      <li><b>ุฅุนุฏุงุฏุงุช ุณุฑูุนุฉ:</b> ุฃูุถุงุน ุฌุงูุฒุฉ (ุณุฑุนุฉุ ุนุงุฏูุฉุ ุทูููุฉ)</li>
    </ul>
    
    <h4>๐ฏ ููููุฉ ุงููุนุจ ุงูุฃุณุงุณูุฉ:</h4>
    <ol>
      <li><b>ุงูุงูุถูุงู:</b> ุงุฎุชุฑ ุงูููุตุฉ (Twitch/Kick)ุ ูููุชุจ ุงูุฌูููุฑ <code>!ุฏุฎูู</code></li>
      <li><b>ุงูุจุฏุก:</b> ุงุถุบุท "ุจุฏุก ุงููุนุจุฉ" ูุชูุฒูุน ุงูุฏูู ุนุดูุงุฆูุงู</li>
      <li><b>ุงูุฏูุฑ:</b> ุงุถุบุท "ุฏูุฑุงู ุงูุนุฌูุฉ" ูุงุฎุชูุงุฑ ูุงุนุจ ุนุดูุงุฆูุงู</li>
      <li><b>ุงููุฌูู:</b> ุงููุงุนุจ ููุงุฌู ุจููุฑ ุงูุฏููุฉ ูู ุงูุดุงุดุฉ ุฃู ูุชุงุจุฉ ุงุณููุง ูู ุงูุดุงุช</li>
      <li><b>ุงูููุงุฌุฃุฉ:</b> ูุง ูุนุฑู ุงููุงุนุจ ูุงุฐุง ุณูุญุฏุซ ุนูุฏ ุงููุฌูู (ุญุตุงูุฉุ ุฅุนุงุฏุฉุ ุฅูุตุงุก)</li>
      <li><b>ุงูุชูุงุนู:</b> ุงุณุชุฎุฏู ุฃุฒุฑุงุฑ ุงูุชูุงุนู ูุฒูุงุฏุฉ ุงูุชูุงุนู</li>
      <li><b>ุงูููุฒ:</b> ุขุฎุฑ ูุงุนุจ ุจุงูู ุฃู ุตุงุญุจ ุฃูุจุฑ ุนุฏุฏ ุฏูู ุนูุฏ ุงูุชูุงุก ุงูููุช</li>
    </ol>
    
    <h4>๐ ุฃูุงูุฑ ุงูุดุงุช ุงูุฌุฏูุฏุฉ:</h4>
    <ul>
      <li><code>!ุฏุฎูู</code> - ุงูุงูุถูุงู ููุนุจุฉ</li>
      <li><code>!ุฎุฑูุฌ</code> - ุงูุฎุฑูุฌ ูู ุงููุนุจุฉ</li>
      <li><code>!ุชุญุงูู @ุงุณู_ุงููุงุนุจ</code> - ุชุดููู ุชุญุงูู</li>
      <li><code>!ุฑุณุงูุฉ @ุงุณู_ุงููุงุนุจ ูุต_ุงูุฑุณุงูุฉ</code> - ุฅุฑุณุงูุฉ ุฑุณุงูุฉ ุฎุงุตุฉ</li>
      <li><code>!ุงุนุงุฏู @ุงุณู_ุงููุงุนุจ</code> - ุฅุนุงุฏุฉ ูุงุนุจ ูุทุฑูุฏ (ูููุงุนุจ ุงูุฐู ูุฏูู ุตูุงุญูุฉ ุงูุฅุนุงุฏุฉ)</li>
    </ul>
    
    <h4>๐ ููุงุญุธุฉ ูุงูุฉ:</h4>
    <p>ุงูุฏูู ุชุธูุฑ ุจุฏูู ุฃุณูุงุก ูุงููููุง ูุงูุฏูู ุงููููุฒุฉ ูุฎููุฉ ุชูุงูุงู. ูุฐุง ูุฒูุฏ ูู ุนูุตุฑ ุงูููุงุฌุฃุฉ ูุงูุชุดููู ูู ุงููุนุจุฉ!</p>
    
    <button onclick="closeHelp()" style="margin-top:20px; width:100%;">ูููุช! โจ</button>
  </div>
</div>

<h1>๐ ูุนุจุฉ ุญุฑุจ ุงูุฏูู - ุงููุณุฎุฉ ุงููุญุณูุฉ</h1>
<p>ุงุฎุชุฑ ุงูููุตุฉ ูุฃุฑุณู <span class="badge">!ุฏุฎูู</span> ูู ุงูุดุงุช ููุงูุถูุงู <span class="badge">ููููู ุจุนุฏ ุงูุจุฏุก</span></p>

<!-- ุดุฑูุท ุชูุฏู ุงููุนุจุฉ -->
<div id="gameProgressWrap">
  <div id="gameProgress"></div>
</div>

<!-- ุนุฏุงุฏ ุงูุฏูู ุงููุชุจููุฉ -->
<div>
  <span class="small-note">ุงูุฏูู ุงููุชุจููุฉ:</span>
  <span id="remainingCount">30</span>
</div>

<!-- ููุญุฉ ุงูุงุชุตุงู -->
<div class="connect-bar" id="connectBar">
  <div class="connect-header" id="connectToggler">
    <div class="connect-left">
      <span class="chev" id="chev">โพ</span>
      <span class="connect-title">ููุญุฉ ุงูุงุชุตุงู ุจุงูุดุงุช</span>
    </div>
    <div class="connect-left">
      <span class="status-dot" id="statusDot"></span>
      <span id="statusText" class="small-note">ุบูุฑ ูุชุตู</span>
    </div>
  </div>
  <div class="connect-body" id="connectBody" style="display:none;">
    <div class="connect-row">
      <label for="platformNew" class="small-note">ุงูููุตุฉ</label>
      <select id="platformNew">
        <option value="twitch">Twitch</option>
        <option value="kick">Kick</option>
      </select>
      <label for="channelNew" class="small-note">ุงุณู ุงูููุงุฉ</label>
      <input id="channelNew" type="text" placeholder="ุงูุชุจ ุงุณู ุงูููุงุฉ ุจุฏูู @">
      <label class="remember"><input type="checkbox" id="rememberChk"> ุชุฐููุฑูู</label>
    </div>
    <div class="connect-actions">
      <button class="green" id="connectBtn">โ ุงุชุตุงู</button>
      <button class="warn" onclick="toggleRaceMode()" id="raceModeBtn">โฑ๏ธ ูุถุน ุงูุณุจุงู: OFF</button>
    </div>
  </div>
</div>

<!-- ููุญุฉ ุงูุณุชุฑููุฑ ุงูููุณุนุฉ -->
<div class="streamer-bar" id="streamerBar">
  <div class="streamer-header" id="streamerToggler">
    <span class="streamer-title">ููุญุฉ ุชุญูู ุงูุณุชุฑููุฑ ุงููุชูุฏูุฉ</span>
    <span class="chev" id="streamerChev">โพ</span>
  </div>
  <div class="streamer-body" id="streamerBody" style="display:none;">
    <!-- ุจุฏุก ุงููุนุจุฉ -->
    <div class="streamer-section">
      <button class="green" onclick="startGame()">๐ ุจุฏุก ุงููุนุจุฉ</button>
      <button class="purple" onclick="showAdvancedSettings()">โ๏ธ ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ</button>
      <button class="cyan" onclick="toggleStreamerView()" id="streamerViewBtn">๐๏ธ ุนุฑุถ ุงูุณุชุฑููุฑ</button>
    </div>

    <!-- ุฃูุถุงุน ุณุฑูุนุฉ -->
    <div class="streamer-section">
      <div class="quick-settings">
        <button class="quick-btn purple" onclick="loadTemplate('speed')">ุณุฑุนุฉ โก</button>
        <button class="quick-btn cyan" onclick="loadTemplate('normal')">ุนุงุฏูุฉ ๐ฏ</button>
        <button class="quick-btn warn" onclick="loadTemplate('long')">ุทูููุฉ โณ</button>
      </div>
    </div>

    <!-- ูุฏุฉ ุฏูุฑุงู ุงูุนุฌูุฉ -->
    <div class="streamer-section" title="ูุฏุฉ ุฏูุฑุงู ุงูุนุฌูุฉ">
      <label class="small-note" for="spinTimeSelect">โฑ๏ธ ูุฏุฉ ุฏูุฑุงู ุงูุนุฌูุฉ</label>
      <select id="spinTimeSelect">
        <option value="10">10 ุซูุงูู</option>
        <option value="20">20 ุซุงููุฉ</option>
        <option value="30">30 ุซุงููุฉ</option>
        <option value="40">40 ุซุงููุฉ</option>
        <option value="50">50 ุซุงููุฉ</option>
        <option value="60" selected>60 ุซุงููุฉ</option>
      </select>
    </div>

    <!-- ุฅุนุงุฏุฉ ูุงุนุจ + ุฅุนุงุฏุฉ ุชุนููู -->
    <div class="streamer-section">
      <label class="small-note" for="reviveSelect">โป๏ธ ุฅุนุงุฏุฉ ูุงุนุจ</label>
      <select id="reviveSelect">
        <option value="">ุงุฎุชุฑ ูุงุนุจุงู ูุฅุนุงุฏุชู</option>
      </select>
      <button onclick="revivePlayer()" class="cyan">ุฅุนุงุฏุฉ</button>

      <button class="alt" onclick="resetGame()">โบ ุฅุนุงุฏุฉ ุชุนููู</button>
    </div>

    <!-- ุงูุชุญูู ุจุงูุฃุญุฏุงุซ ุงูุนุดูุงุฆูุฉ -->
    <div class="streamer-section">
      <label class="small-note" for="eventChance">๐ฒ ูุฑุตุฉ ุงูุฃุญุฏุงุซ ุงูุนุดูุงุฆูุฉ</label>
      <select id="eventChance" onchange="updateEventChance()">
        <option value="0">0%</option>
        <option value="10" selected>10%</option>
        <option value="20">20%</option>
        <option value="30">30%</option>
        <option value="50">50%</option>
      </select>
      <button onclick="triggerRandomEvent()" class="purple">๐ฒ ุญุฏุซ ุนุดูุงุฆู</button>
    </div>

    <!-- ุฃุฏูุงุช ุฅุฏุงุฑูุฉ -->
    <div class="streamer-section">
      <select id="adminPlayerSelect">
        <option value="">ุงุฎุชุฑ ูุงุนุจุงู</option>
      </select>
      <button onclick="adminKick()" class="bad">๐ซ ุทุฑุฏ</button>
      <button onclick="assignTeamCaptain()" class="green">๐ ูุงุฆุฏ ูุฑูู</button>
      <button onclick="pauseGame(30)" class="warn">โธ๏ธ ุฅููุงู 30ุซ</button>
    </div>
  </div>
</div>

<!-- ูุงูุฐุฉ ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ -->
<div id="advancedSettingsModal" class="settings-modal">
  <div class="settings-content">
    <h3 style="margin-top:0; color:var(--ok);">โ๏ธ ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ</h3>
    
    <div class="setting-item">
      <span class="setting-label">โ ุงูุณูุงุญ ุจุงููุฌูู ุนูู ุงูููุณ</span>
      <label class="toggle-switch">
        <input type="checkbox" id="settingSelfAttack" checked>
        <span class="toggle-slider"></span>
      </label>
    </div>
    
    <div class="setting-item">
      <span class="setting-label">๐ค ุชูููู ูุธุงู ุงูุชุญุงููุงุช</span>
      <label class="toggle-switch">
        <input type="checkbox" id="settingAlliances" checked>
        <span class="toggle-slider"></span>
      </label>
    </div>
    
    <div class="setting-item">
      <span class="setting-label">๐ ุชูููู ุงูุจุทุงูุงุช ุงูุฎุงุตุฉ</span>
      <label class="toggle-switch">
        <input type="checkbox" id="settingSpecialCards" checked>
        <span class="toggle-slider"></span>
      </label>
    </div>
    
    <div class="setting-item">
      <span class="setting-label">๐ฒ ุชูููู ุงูุฃุญุฏุงุซ ุงูุนุดูุงุฆูุฉ</span>
      <label class="toggle-switch">
        <input type="checkbox" id="settingRandomEvents" checked>
        <span class="toggle-slider"></span>
      </label>
    </div>
    
    <div class="setting-item">
      <span class="setting-label">๐ฏ ุชูููู ูุธุงู ุงูุชุญุฏูุงุช</span>
      <label class="toggle-switch">
        <input type="checkbox" id="settingChallenges" checked>
        <span class="toggle-slider"></span>
      </label>
    </div>
    
    <div class="setting-item">
      <span class="setting-label">๐ฌ ุชูููู ุงูุฑุณุงุฆู ุงูุฎุงุตุฉ</span>
      <label class="toggle-switch">
        <input type="checkbox" id="settingMessages" checked>
        <span class="toggle-slider"></span>
      </label>
    </div>
    
    <div class="setting-item">
      <span class="setting-label">๐ ุฅุฎูุงุก ุฃุณูุงุก ุงููุงูููู</span>
      <label class="toggle-switch">
        <input type="checkbox" id="settingHideOwners" checked disabled>
        <span class="toggle-slider"></span>
      </label>
      <span class="small-note" style="margin-right:10px;">(ุฏุงุฆู ููุนู)</span>
    </div>
    
    <div class="setting-item">
      <span class="setting-label">๐ ุฅุฎูุงุก ุงูุฏูู ุงูุฎุงุตุฉ</span>
      <label class="toggle-switch">
        <input type="checkbox" id="settingHideSpecial" checked disabled>
        <span class="toggle-slider"></span>
      </label>
      <span class="small-note" style="margin-right:10px;">(ุฏุงุฆู ููุนู)</span>
    </div>
    
    <div class="setting-item">
      <span class="setting-label">โฑ๏ธ ููุช ุงูุฏูุฑ ุงูุงูุชุฑุงุถู</span>
      <select id="settingDefaultTurnTime">
        <option value="20">20 ุซุงููุฉ</option>
        <option value="30" selected>30 ุซุงููุฉ</option>
        <option value="45">45 ุซุงููุฉ</option>
        <option value="60">60 ุซุงููุฉ</option>
      </select>
    </div>
    
    <div class="setting-item">
      <span class="setting-label">๐ฏ ููุช ุฏูุฑุงู ุงูุนุฌูุฉ ุงูุงูุชุฑุงุถู</span>
      <select id="settingDefaultSpinTime">
        <option value="10">10 ุซูุงูู</option>
        <option value="20">20 ุซุงููุฉ</option>
        <option value="30">30 ุซุงููุฉ</option>
        <option value="40">40 ุซุงููุฉ</option>
        <option value="50">50 ุซุงููุฉ</option>
        <option value="60" selected>60 ุซุงููุฉ</option>
      </select>
    </div>
    
    <div style="margin-top:20px; display:flex; gap:10px;">
      <button onclick="saveAdvancedSettings()" class="green" style="flex:1;">๐พ ุญูุธ ุงูุฅุนุฏุงุฏุงุช</button>
      <button onclick="closeAdvancedSettings()" class="alt" style="flex:1;">ุฅูุบุงุก</button>
    </div>
  </div>
</div>

<!-- ุฃุฒุฑุงุฑ ุงูุชูุงุนู -->
<div class="reactions-bar" id="reactionsBar">
  <button class="reaction-btn" onclick="sendReaction('๐')">๐</button>
  <button class="reaction-btn" onclick="sendReaction('๐')">๐</button>
  <button class="reaction-btn" onclick="sendReaction('๐ฅ')">๐ฅ</button>
  <button class="reaction-btn" onclick="sendReaction('๐ก๏ธ')">๐ก๏ธ</button>
  <button class="reaction-btn" onclick="sendReaction('โ๏ธ')">โ๏ธ</button>
  <button class="reaction-btn" onclick="sendReaction('๐')">๐</button>
</div>

<div class="container">
  <!-- ููุญุฉ ุงููุงุนุจูู ูุงูุฅุญุตุงุฆูุงุช -->
  <div class="panel" id="wheel">
    <h3>๐ฅ ูุงุฆูุฉ ุงููุงุนุจูู</h3>
    <p class="small-note">ุณูููู ุงุฎุชูุงุฑ ุงูุฃุณูุงุก ุนุดูุงุฆููุง</p>
    <canvas id="playerWheel" width="420" height="420"></canvas>

    <div class="controls-row" style="margin-top:6px;">
      <div title="ุนุฏูุงุฏ ุงูุฏูุฑ: ุงูููุช ุงููุณููุญ ููุงุนุจ ุงููุฎุชุงุฑ ูุจู ุงูุชุฌุงูุฒ">
        <select id="turnSecondsSelect">
          <option value="20">20ุซ</option>
          <option value="30" selected>30ุซ</option>
          <option value="45">45ุซ</option>
          <option value="60">60ุซ</option>
        </select>
        <div class="small-note">โ ุนุฏูุงุฏ ุงูุฏูุฑ</div>
      </div>

      <button onclick="spinWheelAnimated()">๐ฏ ุฏูุฑุงู ุงูุนุฌูุฉ</button>
      <button class="ghost" onclick="skipTurn()">โญ๏ธ ุชุฌุงูุฒ ุงูุฏูุฑ</button>
    </div>
    <div id="turnTimerText" class="small-note">โณ ุนุฏูุงุฏ ุงูุฏูุฑ: ุบูุฑ ูุดุท</div>
    <div id="turnProgressWrap"><div id="turnProgress"></div></div>

    <!-- ุงูุชุญุฏู ุงูุญุงูู -->
    <div style="margin:10px 0; padding:8px; background:rgba(255,215,0,0.1); border-radius:8px; border:1px dashed gold;">
      <h4 style="margin:0; color:gold;">๐ฏ ุงูุชุญุฏู ุงูุญุงูู</h4>
      <div id="currentChallenge" class="small-note">ูุงุฌู ุฏููุฉ ูุฌุงูุฑุฉ ุฌุบุฑุงููุง ููุญุตูู ุนูู ููุงุท ุฅุถุงููุฉ!</div>
    </div>

    <!-- ููุญุฉ ุงูุจุทุงูุงุช ุงูุฎุงุตุฉ -->
    <div style="margin-top:10px;">
      <h4 style="margin:0 0 6px;">๐ ุงูุจุทุงูุงุช ุงูุฎุงุตุฉ</h4>
      <div class="special-cards" id="specialCards">
        <div class="card" onclick="useSpecialCard('steal')">ุณุฑูุฉ</div>
        <div class="card" onclick="useSpecialCard('immunity')">ุญุตุงูุฉ ุฌูุงุนูุฉ</div>
        <div class="card" onclick="useSpecialCard('double')">ูุฌูู ูุฒุฏูุฌ</div>
      </div>
    </div>
    
    <!-- ููุญุฉ ุงูุฃุญุฏุงุซ -->
    <div style="margin-top:10px;">
      <h4 style="margin:0 0 6px;">๐ ุขุฎุฑ ุงูุฃุญุฏุงุซ</h4>
      <div id="eventLog" class="small-note" style="text-align:right; max-height:140px; overflow:auto;"></div>
    </div>
    
    <div style="margin-top:10px;">
      <button class="warn" onclick="endRound()">๐ ุฅููุงุก ุงูุฌููุฉ ูุฅุนูุงู ุงููุงุฆุฒ</button>
    </div>
  </div>

  <!-- ููุญุฉ ุงูุฏูู ูุงูุฅุญุตุงุฆูุงุช -->
  <div class="panel">
    <div class="controls-row" style="justify-content:space-between;">
      <h3 style="margin:0;">๐ ุงูุฏูู <span id="specialCountInfo" class="small-note"></span></h3>
      <div>
        <button onclick="manualShuffle()">๐ ุฎูุท ุงูุฏูู</button>
        <button class="ghost" onclick="clearSavedState()">๐๏ธ ุญุฐู ุงูุญูุธ</button>
      </div>
    </div>
    <p class="small-note">ุงููุฑ ุนูู ุจุทุงูุฉ ุฏููุฉ ูููุฌูู ุฅุฐุง ูุงู ุฏูุฑู - ุงูููููุฉ ูุฎููุฉ!</p>
    <div id="countryList"></div>

    <!-- ููุญุฉ ุงูุฅุญุตุงุฆูุงุช -->
    <div style="margin-top:16px;">
      <h3 style="margin:0 0 8px;">๐ ุงูุฅุญุตุงุฆูุงุช ุงูุญูุฉ</h3>
      <div class="stats-grid" id="liveStats">
        <div class="stat-item">ุนุฏุฏ ุงููุฌูุงุช: <span id="attackCount">0</span></div>
        <div class="stat-item">ูุชูุณุท ููุช ุงูุฏูุฑ: <span id="avgTurnTime">0</span>ุซ</div>
        <div class="stat-item">ุฃูุซุฑ ุฏููุฉ ููุฌูุช: <span id="mostAttacked">-</span></div>
        <div class="stat-item">ุฃููู ูุงุนุจ: <span id="strongestPlayer">-</span></div>
        <div class="stat-item">ููุงุท ุงูุชุญุฏู: <span id="challengePoints">0</span></div>
        <div class="stat-item">ุงูุฃุญุฏุงุซ ุงูุนุดูุงุฆูุฉ: <span id="eventCount">0</span></div>
      </div>
    </div>

    <!-- ุงูุชุญุงููุงุช ุงููุดุทุฉ -->
    <div style="margin-top:12px; padding:8px; background:rgba(0,255,0,0.05); border-radius:8px; border:1px dashed var(--ally);">
      <h4 style="margin:0; color:var(--ally);">๐ค ุงูุชุญุงููุงุช ุงููุดุทุฉ</h4>
      <div id="activeAlliances" class="small-note">ูุง ุชูุฌุฏ ุชุญุงููุงุช ุญุงููุงู</div>
    </div>

    <!-- ููุตูููู -->
    <div class="eliminated-section" id="eliminatedSection">
      <h3 class="eliminated-title">๐ซ ุงูุฏูู ุงูููุตุงุฉ ูุงููุงุนุจูู ุงููุทุฑูุฏูู</h3>
      <div class="eliminated-content" id="eliminatedContent">
        <div class="eliminated-item">ูุง ููุฌุฏ ูุญุฐูููู ุจุนุฏ</div>
      </div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay"></div>

<!-- ุฃุฒุฑุงุฑ ุนุงูุฉ -->
<div class="controls-row" style="margin-top:12px; gap:6px;">
  <button id="themeToggle" onclick="toggleTheme()">๐ ุชุจุฏูู ุงูุซูู</button>
  <button onclick="showPlayerMessages()" class="cyan">๐จ ุงูุฑุณุงุฆู</button>
  <button onclick="showMatchHistory()" class="purple">๐ ุณุฌู ุงููุจุงุฑูุงุช</button>
</div>

<h3 id="currentTurnDisplay" style="margin-top:10px; color:#0ff;">โจ ุงูุฏูุฑ ุงูุขู: ูู ูุจุฏุฃ ุจุนุฏ</h3>

<!-- ุงููุคูุช ุงูุณุจุงู -->
<div id="raceTimer" style="position:fixed; top:20px; right:20px; background:rgba(255,0,0,0.3); padding:10px; border-radius:10px; display:none;">
  <div style="font-size:24px; font-weight:bold;" id="raceTime">05:00</div>
  <div class="small-note">โฑ๏ธ ูุถุน ุงูุณุจุงู</div>
</div>

<script>
/* =========================
   ุงูุญุงูุฉ ูุงููุชุบูุฑุงุช ุงูุนุงูุฉ - ุงูููุณุนุฉ
   ========================= */
let players = [], playerColors = {}, currentTurnPlayer = "";
const countriesPool = [
  "ุงูุณุนูุฏูุฉ","ุงูุฅูุงุฑุงุช","ูุทุฑ","ูุตุฑ","ุงูุฃุฑุฏู","ูุจูุงู","ุงูุนุฑุงู","ุงููููุช","ุนูุงู","ุงูุจุญุฑูู",
  "ุชููุณ","ุงูุฌุฒุงุฆุฑ","ุงููุบุฑุจ","ููุจูุง","ุงูุณูุฏุงู","ุงูููู","ุณูุฑูุง","ููุณุทูู","ุชุฑููุง","ุฅูุฑุงู",
  "ุฃููุงููุง","ูุฑูุณุง","ุฅูุทุงููุง","ุฅุณุจุงููุง","ุฃูุฑููุง","ููุฏุง","ุฑูุณูุง","ุงูุตูู","ุงููุงุจุงู","ุงูููุฏ"
];
let assignedCountries = {}, remainingCountries = [], immunityCountries = [], reviveCountries = [], usedSpecialCountries = [];
let playerImmunity = {}, eliminatedPlayers = [], lastReviver = "";
let isGameStarted = false;
const overlay = document.getElementById("overlay");
let eliminatedData = [];
let turnTimerId = null, turnSeconds = 30, joinLocked = false;
let eventLog = [];

/* =========================
   ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ
   ========================= */
// ูุธุงู ุงูููุงุท ูุงูุฅุญุตุงุฆูุงุช
let playerStats = {};
let totalAttacks = 0;
let attackHistory = [];
let gameStartTime = null;

// ูุธุงู ุงูุชุญุงููุงุช
let alliances = {};
let allianceDurations = {};

// ุงูุจุทุงูุงุช ุงูุฎุงุตุฉ
let specialCards = {
  steal: { name: "ุณุฑูุฉ", desc: "ุชุณุชุทูุน ุณุฑูุฉ ุฏููุฉ ุนุดูุงุฆูุฉ ูู ูุงุนุจ ุขุฎุฑ", used: false },
  immunity: { name: "ุญุตุงูุฉ ุฌูุงุนูุฉ", desc: "ุญุตุงูุฉ ููู ุฏููู ูุฏูุฑ ูุงุญุฏ", used: false },
  double: { name: "ูุฌูู ูุฒุฏูุฌ", desc: "ูุฌูููู ูู ุฏูุฑ ูุงุญุฏ", used: false }
};

// ุงูุฃุญุฏุงุซ ุงูุนุดูุงุฆูุฉ
let randomEvents = [
  { name: "ุฒูุฒุงู", effect: "ุชุฎุชูู ุฏููุฉ ุนุดูุงุฆูุฉ", chance: 10 },
  { name: "ุชุญุงูู ุฏุจูููุงุณู", effect: "ุฌููุน ุงููุงุนุจูู ูุง ููุงุฌููู ูุฐุง ุงูุฏูุฑ", chance: 5 },
  { name: "ุซูุฑุฉ", effect: "ุชุชุจุงุฏู ุฏููุชุงู ูุงูููููุง", chance: 8 },
  { name: "ุฌูุงุฆุฒ ุฏุจูููุงุณูุฉ", effect: "ุฌููุน ุงููุงุนุจูู ูุญุตููู ุนูู ุฏููุฉ ุฅุถุงููุฉ", chance: 3 }
];
let eventChance = 10;
let eventCount = 0;

// ุงูุชุญุฏูุงุช
let challenges = [
  "ูุงุฌู ุฏููุฉ ูุฌุงูุฑุฉ ุฌุบุฑุงููุง",
  "ูุงุฌู ุฏููุฉ ุชุจุฏุฃ ุจุญุฑู 'ุฃ'",
  "ูุงุฌู ุฏููุฉ ูู ูุงุฑุฉ ุขุณูุง",
  "ูุงุฌู ุฏููุฉ ูููููุง ูุงุนุจ ูุฏูู ุฃูุจุฑ ุนุฏุฏ ุฏูู",
  "ูุงุฌู ุฏููุฉ ุชุจุฏุฃ ุจููุณ ุญุฑู ุงุณูู"
];
let currentChallenge = "";
let challengePoints = 0;

// ุงูุฑุณุงุฆู ูุงูุชูุงุนูุงุช
let playerMessages = [];
let lastReaction = "";

// ูุถุน ุงูุณุจุงู
let raceMode = false;
let raceTime = 300; // 5 ุฏูุงุฆู
let raceTimerId = null;

// ุงูููุณู ูุงููุจุงุฑูุงุช
let matchHistory = [];
let seasonPoints = {};

// ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ
let advancedSettings = {
  allowSelfAttack: true,
  allowAlliances: true,
  enableSpecialCards: true,
  enableRandomEvents: true,
  enableChallenges: true,
  enableMessages: true,
  defaultTurnTime: 30,
  defaultSpinTime: 60,
  hideOwners: true, // ุฅุฎูุงุก ุฃุณูุงุก ุงููุงูููู ุฏุงุฆูุงู
  hideSpecial: true // ุฅุฎูุงุก ุงูุฏูู ุงูุฎุงุตุฉ ุฏุงุฆูุงู
};

// ูุงุฆูุงุช ุงูุงุชุตุงู
let twitchClient = null;
let kickSocket = null;

// ุนุฑุถ ุงูุณุชุฑููุฑ
let streamerView = false;

/* =========================
   ุชููุฆุฉ ุงููุธุงู
   ========================= */
function initSystem() {
  // ุชููุฆุฉ ุฅุญุตุงุฆูุงุช ุงููุงุนุจูู
  players.forEach(p => {
    if (!playerStats[p]) {
      playerStats[p] = {
        kills: 0,
        survived: 0,
        wins: 0,
        attacks: 0,
        successfulAttacks: 0,
        specialCardsUsed: 0,
        allianceFormed: 0
      };
    }
  });
  
  // ุชุญุฏูุซ ุงูุนุฑุถ
  updateStatsDisplay();
  updateGameProgress();
  setRandomChallenge();
  
  // ุจุฏุก ุชุชุจุน ุงูููุช
  gameStartTime = Date.now();
}

/* =========================
   ุฅุดุนุงุฑุงุช + ุดุฑูุท ุนููู
   ========================= */
const notice = document.getElementById('noticeBar');
function toast(msg, ms=3000){
  overlay.textContent = msg;
  overlay.style.display = "flex";
  clearTimeout(overlay._t);
  overlay._t = setTimeout(()=> overlay.style.display = "none", ms);
}
function notify(msg, ms=1800){
  notice.textContent = msg;
  notice.style.opacity = 1;
  clearTimeout(notice._t);
  notice._t = setTimeout(()=> notice.style.opacity = 0, ms);
}

/* ====== ุฅุดุนุงุฑ ูุชุณูุณู ====== */
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
async function playSequence(steps){
  overlay.style.display = "flex";
  for (const step of steps){
    overlay.textContent = step.text;
    await sleep(step.duration || 1200);
  }
  overlay.style.display = "none";
}

/* =========================
   ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
   ========================= */
function updateStatsDisplay() {
  document.getElementById('attackCount').textContent = totalAttacks;
  
  // ุญุณุงุจ ูุชูุณุท ููุช ุงูุฏูุฑ
  if (totalAttacks > 0) {
    const avgTime = Math.round((Date.now() - gameStartTime) / totalAttacks / 1000);
    document.getElementById('avgTurnTime').textContent = avgTime;
  }
  
  // ุชุญุฏูุซ ุงูุฏูู ุงููุชุจููุฉ
  document.getElementById('remainingCount').textContent = remainingCountries.length;
  
  // ุชุญุฏูุซ ูุนูููุงุช ุงูุฏูู ุงูุฎุงุตุฉ (ููุนุฑุถ ููุท ููุณุชุฑููุฑ)
  if (streamerView) {
    const specialCount = immunityCountries.length + reviveCountries.length;
    document.getElementById('specialCountInfo').textContent = `(${specialCount} ุฏูู ุฎุงุตุฉ)`;
  } else {
    document.getElementById('specialCountInfo').textContent = '';
  }
  
  // ุชุญุฏูุซ ุงูุชูุฏู
  updateGameProgress();
}

/* =========================
   ุชุญุฏูุซ ุชูุฏู ุงููุนุจุฉ
   ========================= */
function updateGameProgress() {
  const progressBar = document.getElementById('gameProgress');
  const totalCountries = countriesPool.length;
  const remaining = remainingCountries.length;
  const progress = ((totalCountries - remaining) / totalCountries) * 100;
  progressBar.style.width = `${progress}%`;
}

/* =========================
   ุชุญุฏูุซ ุงูุชุญุงููุงุช ุงููุดุทุฉ
   ========================= */
function updateAlliancesDisplay() {
  const alliancesDiv = document.getElementById('activeAlliances');
  const activeAllies = Object.keys(alliances);
  
  if (activeAllies.length === 0) {
    alliancesDiv.innerHTML = 'ูุง ุชูุฌุฏ ุชุญุงููุงุช ุญุงููุงู';
    return;
  }
  
  let html = '';
  activeAllies.forEach(allianceId => {
    const [p1, p2] = allianceId.split('_');
    const remaining = allianceDurations[allianceId] || 0;
    html += `<div>${p1} ๐ค ${p2} (${remaining} ุฃุฏูุงุฑ ูุชุจููุฉ)</div>`;
  });
  
  alliancesDiv.innerHTML = html;
}

/* =========================
   ุฒุฑ ููุงูุฐุฉ ุงูุดุฑุญ
   ========================= */
const helpBtn = document.getElementById('helpBtn');
const helpModal = document.getElementById('helpModal');
const helpClose = document.getElementById('helpClose');
helpBtn.onclick = ()=> helpModal.style.display = 'flex';
helpClose.onclick = ()=> helpModal.style.display = 'none';
helpModal.onclick = (e)=>{ if(e.target===helpModal) helpModal.style.display='none'; };
function closeHelp() { helpModal.style.display = 'none'; }

/* =========================
   ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ
   ========================= */
function showAdvancedSettings() {
  // ุชุญููู ุงูุฅุนุฏุงุฏุงุช ุงูุญุงููุฉ
  document.getElementById('settingSelfAttack').checked = advancedSettings.allowSelfAttack;
  document.getElementById('settingAlliances').checked = advancedSettings.allowAlliances;
  document.getElementById('settingSpecialCards').checked = advancedSettings.enableSpecialCards;
  document.getElementById('settingRandomEvents').checked = advancedSettings.enableRandomEvents;
  document.getElementById('settingChallenges').checked = advancedSettings.enableChallenges;
  document.getElementById('settingMessages').checked = advancedSettings.enableMessages;
  document.getElementById('settingHideOwners').checked = advancedSettings.hideOwners;
  document.getElementById('settingHideSpecial').checked = advancedSettings.hideSpecial;
  document.getElementById('settingDefaultTurnTime').value = advancedSettings.defaultTurnTime;
  document.getElementById('settingDefaultSpinTime').value = advancedSettings.defaultSpinTime;
  
  document.getElementById('advancedSettingsModal').style.display = 'flex';
}

function closeAdvancedSettings() {
  document.getElementById('advancedSettingsModal').style.display = 'none';
}

function saveAdvancedSettings() {
  advancedSettings.allowSelfAttack = document.getElementById('settingSelfAttack').checked;
  advancedSettings.allowAlliances = document.getElementById('settingAlliances').checked;
  advancedSettings.enableSpecialCards = document.getElementById('settingSpecialCards').checked;
  advancedSettings.enableRandomEvents = document.getElementById('settingRandomEvents').checked;
  advancedSettings.enableChallenges = document.getElementById('settingChallenges').checked;
  advancedSettings.enableMessages = document.getElementById('settingMessages').checked;
  advancedSettings.defaultTurnTime = parseInt(document.getElementById('settingDefaultTurnTime').value);
  advancedSettings.defaultSpinTime = parseInt(document.getElementById('settingDefaultSpinTime').value);
  
  // ุชุทุจูู ุจุนุถ ุงูุฅุนุฏุงุฏุงุช ููุฑุงู
  document.getElementById('turnSecondsSelect').value = advancedSettings.defaultTurnTime;
  document.getElementById('spinTimeSelect').value = advancedSettings.defaultSpinTime;
  
  // ุญูุธ ูู ุงูุชุฎุฒูู ุงููุญูู
  localStorage.setItem('war_advanced_settings', JSON.stringify(advancedSettings));
  
  // ุฅุนุงุฏุฉ ุนุฑุถ ุงูุฏูู ูุน ุงูุฅุนุฏุงุฏุงุช ุงูุฌุฏูุฏุฉ
  renderCountries();
  
  closeAdvancedSettings();
  notify('โ ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ', 1500);
}

function loadAdvancedSettings() {
  try {
    const saved = localStorage.getItem('war_advanced_settings');
    if (saved) {
      const parsed = JSON.parse(saved);
      advancedSettings = { ...advancedSettings, ...parsed };
    }
  } catch (e) {
    console.log('ูุง ุชูุฌุฏ ุฅุนุฏุงุฏุงุช ูุญููุธุฉ');
  }
}

/* =========================
   ุนุฑุถ ุงูุณุชุฑููุฑ
   ========================= */
function toggleStreamerView() {
  streamerView = !streamerView;
  const btn = document.getElementById('streamerViewBtn');
  
  if (streamerView) {
    btn.textContent = '๐๏ธ ุฅุฎูุงุก ุงูุณุชุฑููุฑ';
    btn.style.background = '#0dcaf0';
    notify('๐๏ธ ุชู ุชูุนูู ุนุฑุถ ุงูุณุชุฑููุฑ - ููููู ุฑุคูุฉ ุงููุนูููุงุช ุงููุฎููุฉ', 2000);
  } else {
    btn.textContent = '๐๏ธ ุนุฑุถ ุงูุณุชุฑููุฑ';
    btn.style.background = '';
    notify('๐๏ธ ุชู ุฅุฎูุงุก ุนุฑุถ ุงูุณุชุฑููุฑ', 1500);
  }
  
  // ุฅุนุงุฏุฉ ุนุฑุถ ุงูุฏูู ูุน ุงูุนุฑุถ ุงูุฌุฏูุฏ
  renderCountries();
}

/* =========================
   ููุญุฉ ุงูุงุชุตุงู
   ========================= */
const connectToggler = document.getElementById('connectToggler');
const connectBody = document.getElementById('connectBody');
const chev = document.getElementById('chev');
const statusDot = document.getElementById('statusDot');
const statusText = document.getElementById('statusText');
const platformNew = document.getElementById('platformNew');
const channelNew = document.getElementById('channelNew');
const rememberChk = document.getElementById('rememberChk');

connectToggler.onclick = ()=>{
  const open = connectBody.style.display !== 'none';
  connectBody.style.display = open ? 'none' : 'flex';
  connectBody.style.display === 'flex' && (connectBody.style.gap='12px');
  chev.style.transform = open ? 'rotate(0deg)' : 'rotate(180deg)';
};

// ุชุญููู ุชุฐููุฑูู
(function loadRemember(){
  try{
    const saved = JSON.parse(localStorage.getItem('war_connect_pref')||'{}');
    if(saved.platform) platformNew.value = saved.platform;
    if(saved.channel) channelNew.value = saved.channel;
    if(saved.remember) rememberChk.checked = true;
  }catch(_){}
})();

function updateStatus(ok, msg){
  statusDot.classList.toggle('ok', !!ok);
  statusText.textContent = msg || (ok ? 'ูุชุตู' : 'ุบูุฑ ูุชุตู');
}

/* =========================
   ููุญุฉ ุงูุณุชุฑููุฑ (ุทู/ูุชุญ)
   ========================= */
const streamerToggler = document.getElementById('streamerToggler');
const streamerBody = document.getElementById('streamerBody');
const streamerChev = document.getElementById('streamerChev');
streamerToggler.onclick = ()=>{
  const open = streamerBody.style.display !== 'none';
  streamerBody.style.display = open ? 'none' : 'flex';
  streamerChev.style.transform = open ? 'rotate(0deg)' : 'rotate(180deg)';
};

/* =========================
   ุฃุฏูุงุช ูุณุงุนุฏุฉ
   ========================= */
function getColorForPlayer(player) {
  if (playerColors[player]) return playerColors[player];
  const hash = [...player].reduce((a, c) => a + c.charCodeAt(0), 0);
  const col = `hsl(${hash % 360}, 70%, 60%)`;
  playerColors[player] = col;
  return col;
}

function addPlayer(name, color = null) {
  if (joinLocked) return;
  if (!name) return;
  if (!players.includes(name)) {
    players.push(name);
    getColorForPlayer(name);
    
    // ุชููุฆุฉ ุฅุญุตุงุฆูุงุช ุงููุงุนุจ ุงูุฌุฏูุฏ
    if (!playerStats[name]) {
      playerStats[name] = {
        kills: 0,
        survived: 0,
        wins: 0,
        attacks: 0,
        successfulAttacks: 0,
        specialCardsUsed: 0,
        allianceFormed: 0
      };
    }
    
    renderPlayers();
    updateAdminPlayerSelect();
  }
}

function removePlayer(name){
  const idx = players.indexOf(name);
  if (idx !== -1){
    players.splice(idx,1);
    delete playerColors[name];
    delete playerStats[name];
    
    // ุฅุฒุงูุฉ ูู ุงูุชุญุงููุงุช
    for (const allianceId in alliances) {
      if (allianceId.includes(name)) {
        delete alliances[allianceId];
        delete allianceDurations[allianceId];
      }
    }
    
    for (const c of Object.keys(assignedCountries)){
      if (assignedCountries[c] === name){
        delete assignedCountries[c];
        remainingCountries = remainingCountries.filter(x=>x!==c);
      }
    }
    eliminatedPlayers = eliminatedPlayers.filter(x=>x!==name);
    eliminatedData = eliminatedData.filter(item=> item.player !== name);
    renderPlayers(); 
    renderCountries(); 
    updateEliminatedDisplay();
    updateAlliancesDisplay();
    updateAdminPlayerSelect();
  }
}

function logEvent(text){
  const ts = new Date().toLocaleTimeString();
  eventLog.unshift(`โข [${ts}] ${text}`);
  eventLog = eventLog.slice(0, 20);
  document.getElementById('eventLog').innerHTML = eventLog.map(e=>`<div>${e}</div>`).join('');
}

/* =========================
   ุฑุณู ุนุฌูุฉ ุงููุงุนุจูู
   ========================= */
function renderPlayers(rotation = 0) {
  const canvas = document.getElementById("playerWheel");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  const r = canvas.width / 2;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (players.length === 0) return;
  const slice = 2 * Math.PI / players.length;
  players.forEach((p, i) => {
    const angle = slice * i + rotation;
    ctx.beginPath(); ctx.moveTo(r, r);
    ctx.arc(r, r, r, angle, angle + slice);
    ctx.fillStyle = getColorForPlayer(p); ctx.fill(); ctx.strokeStyle="#000"; ctx.lineWidth=1; ctx.stroke();
    ctx.save(); ctx.translate(r, r); ctx.rotate(angle + slice / 2);
    ctx.textAlign = "right";
    ctx.fillStyle = "#000";
    ctx.font = "bold 14px Cairo";
    let displayName = p + (playerImmunity[p] ? " ๐ก๏ธ" : "");
    ctx.fillText(displayName, r - 10, 5); ctx.restore();
  });
  // ุงูุณูู ุงูุซุงุจุช
  ctx.beginPath();
  ctx.moveTo(canvas.width - 20, r);
  ctx.lineTo(canvas.width, r - 20);
  ctx.lineTo(canvas.width, r + 20);
  ctx.closePath();
  ctx.fillStyle = "#ff0";
  ctx.fill();
}

/* =========================
   ุนุฑุถ ุงูุฏูู + ุงูููุฑ ูููุฌูู - ูุนุฏู ูุฅุฎูุงุก ุงูุฃุณูุงุก
   ========================= */
function renderCountries() {
  const box = document.getElementById("countryList");
  if (!box) return;
  box.innerHTML = "";

  const list = [...remainingCountries];
  list.forEach((c, i) => {
    const div = document.createElement("div");
    div.className = "country";
    
    // ุฅุถุงูุฉ ุนูุงูุฉ ุงูุฏูู ุงูุฎุงุตุฉ ููุท ูู ุนุฑุถ ุงูุณุชุฑููุฑ
    const isSpecial = immunityCountries.includes(c) || reviveCountries.includes(c);
    if (isSpecial && streamerView) {
      div.classList.add("special");
    }
    
    // ุงูุญุตูู ุนูู ุงููุงูู (ููุนุฑุถ ููุท ููุณุชุฑููุฑ)
    const owner = assignedCountries[c];
    
    // ุจูุงุก ุงููุญุชูู ุจูุงุก ุนูู ุงููุถุน
    let countryContent = `
      <img src="https://flagcdn.com/w80/${getCountryCode(c)}.png" alt="">
      <div>${c}</div>
    `;
    
    // ุฅุถุงูุฉ ุงููุงูู ููุท ูู ุนุฑุถ ุงูุณุชุฑููุฑ
    if (streamerView && owner) {
      countryContent += `<div class="small-note">๐ค ${owner}</div>`;
    }
    
    // ุฅุถุงูุฉ ุฑูุฒ ุฎุงุต ููุฏูู ุงูุฎุงุตุฉ ูู ุนุฑุถ ุงูุณุชุฑููุฑ
    if (streamerView) {
      if (immunityCountries.includes(c)) {
        countryContent += `<div class="streamer-hint">๐ก๏ธ</div>`;
      } else if (reviveCountries.includes(c)) {
        countryContent += `<div class="streamer-hint">โป๏ธ</div>`;
      }
    }
    
    div.innerHTML = countryContent;
    
    div.onclick = () => {
      if (isGameStarted && currentTurnPlayer && remainingCountries.includes(c)) {
        attackCountry(c);
      }
    };
    
    setTimeout(() => {
      box.appendChild(div);
      requestAnimationFrame(() => div.classList.add("show"));
    }, i * 40);
  });
  
  updateGameProgress();
}

/* =========================
   ุงูููุตูููู + ุงูุฅุนุงุฏุฉ
   ========================= */
function updateEliminatedDisplay() {
  const eliminatedContent = document.getElementById("eliminatedContent");
  const reviveSelect = document.getElementById("reviveSelect");
  eliminatedContent.innerHTML = "";
  reviveSelect.innerHTML = '<option value="">ุงุฎุชุฑ ูุงุนุจุงู ูุฅุนุงุฏุชู</option>';
  if (eliminatedData.length === 0) {
      eliminatedContent.innerHTML = '<div class="eliminated-item">ูุง ููุฌุฏ ูุญุฐูููู ุจุนุฏ</div>';
      return;
  }
  eliminatedData.forEach(item => {
      const itemElement = document.createElement("div");
      itemElement.className = "eliminated-item";
      itemElement.textContent = `(${item.country}) ${item.player}`;
      eliminatedContent.appendChild(itemElement);
      const option = document.createElement("option");
      option.value = item.player;
      option.textContent = item.player;
      reviveSelect.appendChild(option);
  });
}

function revivePlayer() {
  const reviveSelect = document.getElementById("reviveSelect");
  const playerToRevive = reviveSelect.value;
  if (!playerToRevive) return;
  reviveByName(playerToRevive);
}

function reviveByName(playerToRevive){
  if (!eliminatedPlayers.includes(playerToRevive)) return;
  players.push(playerToRevive);
  getColorForPlayer(playerToRevive);
  eliminatedPlayers = eliminatedPlayers.filter(x => x !== playerToRevive);
  eliminatedData = eliminatedData.filter(item => item.player !== playerToRevive);
  const availableCountries = countriesPool.filter(c => 
      !remainingCountries.includes(c) && 
      !usedSpecialCountries.includes(c)
  );
  if (availableCountries.length > 0) {
      const newCountry = availableCountries[Math.floor(Math.random() * availableCountries.length)];
      assignedCountries[newCountry] = playerToRevive;
      remainingCountries.push(newCountry);
      usedSpecialCountries.push(newCountry);
      shufflePlayersAndCountries();
      renderCountries();
      renderPlayers();
      updateEliminatedDisplay();
      playSequence([{ text:`โป๏ธ ุชูุช ุฅุนุงุฏุฉ ${playerToRevive} ุจุฏููุฉ ุฌุฏูุฏุฉ`, duration: 1500 }]);
      logEvent(`ุฅุนุงุฏุฉ ${playerToRevive}`);
      
      // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
      playerStats[playerToRevive].survived++;
  }
}

/* =========================
   ุฎูุท ุงููุงุนุจูู ูุงูุฏูู
   ========================= */
function shufflePlayersAndCountries() {
  for (let i = players.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [players[i], players[j]] = [players[j], players[i]];
  }
  const shuffledCountries = [...remainingCountries].sort(() => Math.random() - 0.5);
  const newAssignedCountries = {};
  shuffledCountries.forEach((country, i) => {
      if (assignedCountries[country] !== undefined) {
          const player = players[i % players.length] || null;
          newAssignedCountries[country] = player;
      } else {
          newAssignedCountries[country] = null;
      }
  });
  assignedCountries = newAssignedCountries;
}

function manualShuffle(){
  shufflePlayersAndCountries();
  renderCountries();
  renderPlayers();
  notify("๐ ุชู ุฎูุท ุงูุฏูู ูุงููุงุนุจูู ุนุดูุงุฆููุง");
}

/* =========================
   ุฏูุฑุงู ุงูุนุฌูุฉ โ ุฒูู ุญูููู
   ========================= */
function spinWheelAnimated() {
  if (players.length === 0) return;

  stopTurnTimer();

  const spinSec = Math.max(1, parseInt(document.getElementById("spinTimeSelect").value) || 10);
  const durationMs = spinSec * 1000;
  const slice = 2 * Math.PI / players.length;

  const fullSpins = 5 * 2 * Math.PI;
  const randomAngle = Math.random() * 2 * Math.PI;
  const targetRotation = fullSpins + randomAngle;

  let rotation = 0;
  const start = performance.now();

  function animate(now) {
    const elapsed = now - start;
    let t = Math.min(1, elapsed / durationMs);
    const eased = t * t * (3 - 2 * t);
    rotation = targetRotation * eased;
    renderPlayers(rotation);

    if (t < 1) {
      requestAnimationFrame(animate);
    } else {
      const final = rotation % (2 * Math.PI);
      const angleUnderPointer = ( (2 * Math.PI) - final ) % (2 * Math.PI);
      const index = Math.floor(angleUnderPointer / slice) % players.length;

      currentTurnPlayer = players[index];
      toast(`๐ฏ ุงููุงุนุจ ุงููุฎุชุงุฑ: ${currentTurnPlayer}`, 1200);
      document.getElementById("currentTurnDisplay").innerText = `โจ ุงูุฏูุฑ ุงูุขู: ${currentTurnPlayer}`;
      document.getElementById("currentTurnDisplay").classList.add("current-turn");

      turnSeconds = parseInt(document.getElementById("turnSecondsSelect").value) || 30;
      startTurnTimer();
      logEvent(`ุงุฎุชูุงุฑ ุงูุฏูุฑ: ${currentTurnPlayer}`);
      
      // ุนุฑุถ ุงูุชุญุฏู ุงูุญุงูู
      showCurrentChallenge();
    }
  }
  requestAnimationFrame(animate);
}

/* =========================
   ุชุญุฏูุงุช ุงููุนุจุฉ
   ========================= */
function setRandomChallenge() {
  if (!advancedSettings.enableChallenges) return;
  const randomIndex = Math.floor(Math.random() * challenges.length);
  currentChallenge = challenges[randomIndex];
  document.getElementById('currentChallenge').textContent = currentChallenge;
}

function checkChallengeCompletion(attacker, country) {
  if (!currentChallenge) return false;
  
  let completed = false;
  
  if (currentChallenge.includes("ูุฌุงูุฑุฉ ุฌุบุฑุงููุง")) {
    // ููุทู ุงูุชุญูู ูู ุงูุฏูู ุงููุฌุงูุฑุฉ (ูุจุณุท)
    completed = Math.random() > 0.5; // ุงูุชุฑุงุถู ููุชูุถูุญ
  }
  else if (currentChallenge.includes("ุชุจุฏุฃ ุจุญุฑู")) {
    const letter = currentChallenge.match(/ุญุฑู '(.+)'/)?.[1];
    completed = country.startsWith(letter);
  }
  
  if (completed && attacker) {
    challengePoints += 50;
    playerStats[attacker].wins += 0.5; // ููุงุท ุฅุถุงููุฉ
    toast(`๐ ${attacker} ุฃููู ุงูุชุญุฏู! +50 ููุทุฉ`, 1500);
    document.getElementById('challengePoints').textContent = challengePoints;
    setRandomChallenge();
  }
  
  return completed;
}

function showCurrentChallenge() {
  if (!currentChallenge || !currentTurnPlayer) return;
  notify(`๐ฏ ุงูุชุญุฏู ุงูุญุงูู: ${currentChallenge}`, 3000);
}

/* =========================
   ุนุฏูุงุฏ ุงูุฏูุฑ
   ========================= */
function startTurnTimer(){
  const txt = document.getElementById("turnTimerText");
  const bar = document.getElementById("turnProgress");
  let secs = turnSeconds;
  txt.textContent = `โณ ุนุฏูุงุฏ ุงูุฏูุฑ: ${secs}ุซ`;
  stopTurnTimer();
  bar.style.width = "100%";
  const total = secs;
  turnTimerId = setInterval(()=>{
    secs--;
    txt.textContent = `โณ ุนุฏูุงุฏ ุงูุฏูุฑ: ${secs}ุซ`;
    bar.style.width = Math.max(0, (secs/total)*100) + "%";
    if (secs <= 0){
      stopTurnTimer();
      txt.textContent = `โณ ุนุฏูุงุฏ ุงูุฏูุฑ: ุงูุชูู`;
      notify(`โญ๏ธ ุงูุชูู ููุช ${currentTurnPlayer} โ ุชู ุชุฌุงูุฒ ุงูุฏูุฑ`);
      logEvent(`ุชุฌุงูุฒ ุงูุฏูุฑ ุนู ${currentTurnPlayer}`);
      document.getElementById("currentTurnDisplay").classList.remove("current-turn");
      currentTurnPlayer = "";
      document.getElementById("currentTurnDisplay").innerText = `โจ ุงูุฏูุฑ ุงูุขู: ูู ูุชู ุงูุงุฎุชูุงุฑ`;
    }
  }, 1000);
}

function stopTurnTimer(){
  if (turnTimerId){ clearInterval(turnTimerId); turnTimerId = null; }
  const bar = document.getElementById("turnProgress");
  if (bar) bar.style.width = "0%";
}

function skipTurn(){
  if (!currentTurnPlayer) return;
  notify(`โญ๏ธ ุชุฌุงูุฒูุง ุฏูุฑ ${currentTurnPlayer}`);
  logEvent(`ุชุฌุงูุฒ ${currentTurnPlayer}`);
  document.getElementById("currentTurnDisplay").classList.remove("current-turn");
  currentTurnPlayer = "";
  document.getElementById("currentTurnDisplay").innerText = `โจ ุงูุฏูุฑ ุงูุขู: ูู ูุชู ุงูุงุฎุชูุงุฑ`;
  stopTurnTimer();
}

/* =========================
   ูุธุงู ุงูุชุญุงููุงุช
   ========================= */
function formAlliance(player1, player2) {
  if (!advancedSettings.allowAlliances) return false;
  
  const allianceId = [player1, player2].sort().join('_');
  
  if (!alliances[allianceId]) {
    alliances[allianceId] = { player1, player2, turns: 3 };
    allianceDurations[allianceId] = 3;
    
    // ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงููุงุนุจูู
    playerStats[player1].allianceFormed++;
    playerStats[player2].allianceFormed++;
    
    toast(`๐ค ุชุญุงูู ุฌุฏูุฏ ุจูู ${player1} ู ${player2} ููุฏุฉ 3 ุฃุฏูุงุฑ`, 2000);
    logEvent(`ุชุญุงูู: ${player1} + ${player2}`);
    updateAlliancesDisplay();
    return true;
  }
  
  return false;
}

function updateAlliancesDuration() {
  for (const allianceId in allianceDurations) {
    allianceDurations[allianceId]--;
    
    if (allianceDurations[allianceId] <= 0) {
      const { player1, player2 } = alliances[allianceId];
      delete alliances[allianceId];
      delete allianceDurations[allianceId];
      notify(`โก ุงูุชูู ุชุญุงูู ${player1} ู ${player2}`, 1500);
    }
  }
  updateAlliancesDisplay();
}

function canAttack(attacker, defender) {
  if (!attacker || !defender) return true;
  
  // ุงูุชุญูู ูู ุงูุชุญุงููุงุช
  for (const allianceId in alliances) {
    const alliance = alliances[allianceId];
    if ((alliance.player1 === attacker && alliance.player2 === defender) ||
        (alliance.player2 === attacker && alliance.player1 === defender)) {
      return false; // ูุง ูููู ุงููุฌูู ุนูู ุงูุญููู
    }
  }
  
  return true;
}

/* =========================
   ุงูุจุทุงูุงุช ุงูุฎุงุตุฉ
   ========================= */
function useSpecialCard(cardType) {
  if (!currentTurnPlayer || !advancedSettings.enableSpecialCards) {
    notify("ููุณ ุฏูุฑู ุฃู ุงูุจุทุงูุงุช ูุนุทูุฉ", 1500);
    return;
  }
  
  const card = specialCards[cardType];
  if (!card || card.used) {
    notify("ูุฐู ุงูุจุทุงูุฉ ุบูุฑ ูุชููุฑุฉ ุฃู ูุณุชุฎุฏูุฉ", 1500);
    return;
  }
  
  switch(cardType) {
    case 'steal':
      useStealCard();
      break;
    case 'immunity':
      useImmunityCard();
      break;
    case 'double':
      useDoubleAttackCard();
      break;
  }
  
  card.used = true;
  playerStats[currentTurnPlayer].specialCardsUsed++;
  updateStatsDisplay();
}

function useStealCard() {
  // ุณุฑูุฉ ุฏููุฉ ุนุดูุงุฆูุฉ ูู ูุงุนุจ ุขุฎุฑ
  const otherPlayers = players.filter(p => p !== currentTurnPlayer && assignedCountries[p]);
  if (otherPlayers.length === 0) return;
  
  const victim = otherPlayers[Math.floor(Math.random() * otherPlayers.length)];
  const victimCountries = Object.keys(assignedCountries).filter(c => assignedCountries[c] === victim);
  
  if (victimCountries.length > 0) {
    const stolenCountry = victimCountries[Math.floor(Math.random() * victimCountries.length)];
    assignedCountries[stolenCountry] = currentTurnPlayer;
    
    toast(`๐ด ${currentTurnPlayer} ุณุฑู ${stolenCountry} ูู ${victim}`, 2000);
    logEvent(`ุจุทุงูุฉ ุณุฑูุฉ: ${currentTurnPlayer} โ ${stolenCountry} ูู ${victim}`);
    renderCountries();
  }
}

function useImmunityCard() {
  // ุญุตุงูุฉ ููู ุฏูู ุงููุงุนุจ
  playerImmunity[currentTurnPlayer] = true;
  toast(`๐ก๏ธ ${currentTurnPlayer} ุญุตู ุนูู ุญุตุงูุฉ ุฌูุงุนูุฉ`, 2000);
  logEvent(`ุญุตุงูุฉ ุฌูุงุนูุฉ ูู ${currentTurnPlayer}`);
}

function useDoubleAttackCard() {
  // ูุฌูู ุฅุถุงูู ูู ููุณ ุงูุฏูุฑ
  // ุณูุชู ุชุทุจูู ูุฐุง ูู ุฏุงูุฉ ุงููุฌูู
  notify(`โ๏ธ ${currentTurnPlayer} ููููู ุงููุฌูู ูุฑุชูู ูุฐุง ุงูุฏูุฑ`, 2000);
}

/* =========================
   ุงูุฃุญุฏุงุซ ุงูุนุดูุงุฆูุฉ
   ========================= */
function triggerRandomEvent() {
  if (!advancedSettings.enableRandomEvents) return;
  
  // ุงูุชุญูู ูู ูุฑุตุฉ ุญุฏูุซ
  if (Math.random() * 100 > eventChance && eventChance < 100) return;
  
  const event = randomEvents[Math.floor(Math.random() * randomEvents.length)];
  eventCount++;
  
  switch(event.name) {
    case "ุฒูุฒุงู":
      earthquakeEvent();
      break;
    case "ุชุญุงูู ุฏุจูููุงุณู":
      diplomaticAllianceEvent();
      break;
    case "ุซูุฑุฉ":
      revolutionEvent();
      break;
    case "ุฌูุงุฆุฒ ุฏุจูููุงุณูุฉ":
      diplomaticAwardsEvent();
      break;
  }
  
  toast(`๐ฒ ุญุฏุซ ุนุดูุงุฆู: ${event.name} - ${event.effect}`, 2500);
  logEvent(`ุญุฏุซ ุนุดูุงุฆู: ${event.name}`);
  document.getElementById('eventCount').textContent = eventCount;
}

function earthquakeEvent() {
  if (remainingCountries.length === 0) return;
  const randomIndex = Math.floor(Math.random() * remainingCountries.length);
  const disappearedCountry = remainingCountries[randomIndex];
  
  remainingCountries.splice(randomIndex, 1);
  delete assignedCountries[disappearedCountry];
  
  renderCountries();
  notify(`๐ ุฒูุฒุงู! ุงุฎุชูุช ${disappearedCountry}`, 2000);
}

function diplomaticAllianceEvent() {
  // ุฌููุน ุงููุงุนุจูู ูุง ููุงุฌููู ูุฐุง ุงูุฏูุฑ
  notify(`๐ค ุชุญุงูู ุฏุจูููุงุณู: ูุง ูุฌูุงุช ูุฐุง ุงูุฏูุฑ`, 2000);
  // ุณูุชู ุชุทุจูู ูุฐุง ูู ุฏุงูุฉ ุงููุฌูู
}

function revolutionEvent() {
  if (remainingCountries.length < 2) return;
  
  const countries = Object.keys(assignedCountries).filter(c => assignedCountries[c]);
  if (countries.length < 2) return;
  
  const [c1, c2] = countries.sort(() => Math.random() - 0.5).slice(0, 2);
  const temp = assignedCountries[c1];
  assignedCountries[c1] = assignedCountries[c2];
  assignedCountries[c2] = temp;
  
  renderCountries();
  notify(`โก ุซูุฑุฉ! ุชุจุงุฏู ููููุฉ ${c1} ู ${c2}`, 2000);
}

function diplomaticAwardsEvent() {
  // ุฅุนุทุงุก ุฏููุฉ ุฅุถุงููุฉ ููู ูุงุนุจ
  const availableCountries = countriesPool.filter(c => 
    !remainingCountries.includes(c) && 
    !usedSpecialCountries.includes(c)
  );
  
  players.forEach(player => {
    if (availableCountries.length > 0) {
      const newCountry = availableCountries.pop();
      assignedCountries[newCountry] = player;
      remainingCountries.push(newCountry);
      usedSpecialCountries.push(newCountry);
    }
  });
  
  renderCountries();
  notify(`๐๏ธ ุฌูุงุฆุฒ ุฏุจูููุงุณูุฉ: ุฌููุน ุงููุงุนุจูู ุญุตููุง ุนูู ุฏูู ุฅุถุงููุฉ`, 2000);
}

function updateEventChance() {
  eventChance = parseInt(document.getElementById('eventChance').value) || 10;
}

/* =========================
   ุชุฃุซูุฑุงุช ุงููุฌูู
   ========================= */
function showAttackEffect(attacker, target, country) {
  // ุฅูุดุงุก ุชุฃุซูุฑ ูุฑุฆู
  const effect = document.createElement('div');
  effect.className = 'attack-effect';
  effect.textContent = 'โ๏ธ';
  effect.style.left = `${Math.random() * 80 + 10}%`;
  effect.style.top = `${Math.random() * 80 + 10}%`;
  
  document.body.appendChild(effect);
  
  setTimeout(() => {
    document.body.removeChild(effect);
  }, 1000);
  
  // ุฅุถุงูุฉ ุชุณุฌูู ุงููุฌูู
  attackHistory.push({
    attacker,
    target: target || 'ูุง ุฃุญุฏ',
    country,
    time: new Date().toLocaleTimeString()
  });
  
  totalAttacks++;
  
  // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
  if (playerStats[attacker]) {
    playerStats[attacker].attacks++;
    if (target && target !== attacker) {
      playerStats[attacker].successfulAttacks++;
    }
  }
  
  // ุชุญุฏูุซ ุฃูุซุฑ ุฏููุฉ ููุฌูุช
  updateMostAttackedCountry(country);
  
  // ุชุญุฏูุซ ุฃููู ูุงุนุจ
  updateStrongestPlayer();
}

function updateMostAttackedCountry(country) {
  const countryAttacks = {};
  attackHistory.forEach(attack => {
    countryAttacks[attack.country] = (countryAttacks[attack.country] || 0) + 1;
  });
  
  let mostAttacked = '';
  let maxAttacks = 0;
  
  for (const [c, count] of Object.entries(countryAttacks)) {
    if (count > maxAttacks) {
      maxAttacks = count;
      mostAttacked = c;
    }
  }
  
  if (mostAttacked) {
    document.getElementById('mostAttacked').textContent = mostAttacked;
  }
}

function updateStrongestPlayer() {
  let strongest = '';
  let maxKills = 0;
  
  for (const [player, stats] of Object.entries(playerStats)) {
    if (stats.kills > maxKills) {
      maxKills = stats.kills;
      strongest = player;
    }
  }
  
  if (strongest) {
    document.getElementById('strongestPlayer').textContent = strongest;
  }
}

/* =========================
   ุงููุฌูู โ ุชุชุงุจุน ุฅุดุนุงุฑุงุช ูุน ุนูุตุฑ ุงูููุงุฌุฃุฉ
   ========================= */
async function attackCountry(c) {
  if (!isGameStarted || !currentTurnPlayer) return;
  if (!remainingCountries.includes(c)) return;

  const attacker = currentTurnPlayer;
  const victim = assignedCountries[c];
  
  // ุงูุชุญูู ูู ุงูุชุญุงููุงุช
  if (victim && !canAttack(attacker, victim)) {
    notify(`๐ค ${attacker} ูุง ููููู ููุงุฌูุฉ ุญูููู ${victim}`, 2000);
    return;
  }

  // 1) ุฅุดุนุงุฑ ุงููุฌูู
  stopTurnTimer();
  showAttackEffect(attacker, victim, c);
  
  await playSequence([{ text: `๐ด ${attacker} ูุงุฌู ${c}`, duration: 1300 }]);

  let secondMsg = "";

  if (victim && playerImmunity[victim] && attacker !== victim) {
    playerImmunity[victim] = false;
    secondMsg = `๐ก๏ธ ุชู ูุณุฑ ุญุตุงูุฉ ${victim}`;
    logEvent(`ูุณุฑ ุญุตุงูุฉ ${victim}`);
    shufflePlayersAndCountries();
    renderCountries(); renderPlayers(); updateEliminatedDisplay();
  }
  else if (immunityCountries.includes(c)) {
    playerImmunity[attacker] = true;
    immunityCountries = immunityCountries.filter(x => x !== c);
    usedSpecialCountries.push(c);
    remainingCountries = remainingCountries.filter(x => x !== c);
    delete assignedCountries[c];
    secondMsg = `โ ${attacker} ูุงุฌู ${c} ูุญุตู ุนูู ุญุตุงูุฉ`;
    logEvent(`ุญุตุงูุฉ ุฅูู ${attacker}`);
    renderCountries(); renderPlayers(); updateEliminatedDisplay();
  }
  else if (reviveCountries.includes(c)) {
    reviveCountries = reviveCountries.filter(x => x !== c);
    usedSpecialCountries.push(c);
    remainingCountries = remainingCountries.filter(x => x !== c);
    delete assignedCountries[c];
    lastReviver = attacker;
    secondMsg = `โป๏ธ ${attacker} ูุงุฌู ${c} ูุญุตู ุนูู ุตูุงุญูุฉ ุฅุนุงุฏุฉ ูุงุนุจ`;
    logEvent(`ุตูุงุญูุฉ ุฅุนุงุฏุฉ ุญุตู ุนูููุง ${attacker}`);
    renderCountries();
  }
  else if (victim && attacker === victim) {
    if (!advancedSettings.allowSelfAttack) {
      notify("โ ุงููุฌูู ุนูู ุงูููุณ ุบูุฑ ูุณููุญ!", 1500);
      return;
    }
    remainingCountries = remainingCountries.filter(x => x !== c);
    delete assignedCountries[c];
    const index = players.indexOf(victim);
    if (index !== -1) players.splice(index, 1);
    delete playerColors[victim];
    eliminatedPlayers.push(victim);
    eliminatedData.push({ country: c, player: victim });
    secondMsg = `โ ${victim} ุฃูุตู ููุณู ูู ${c}`;
    logEvent(`${victim} ุฃูุตู ููุณู ูู ${c}`);
    renderPlayers(); renderCountries(); updateEliminatedDisplay();
  }
  else if (victim && attacker !== victim) {
    remainingCountries = remainingCountries.filter(x => x !== c);
    delete assignedCountries[c];
    const index = players.indexOf(victim);
    if (index !== -1) players.splice(index, 1);
    delete playerColors[victim];
    eliminatedPlayers.push(victim);
    eliminatedData.push({ country: c, player: victim });
    secondMsg = `โ ${attacker} ุฃูุตู ${victim} ูู ${c}`;
    logEvent(`${attacker} ุฃูุตู ${victim} ูู ${c}`);
    
    // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
    if (playerStats[attacker]) {
      playerStats[attacker].kills++;
    }
    
    renderPlayers(); renderCountries(); updateEliminatedDisplay();
  } else {
    remainingCountries = remainingCountries.filter(x => x !== c);
    delete assignedCountries[c];
    secondMsg = `โน๏ธ ุชูุช ุฅุฒุงูุฉ ${c}`;
    renderCountries();
  }

  // ุงูุชุญูู ูู ุฅููุงู ุงูุชุญุฏู
  checkChallengeCompletion(attacker, c);
  
  // ุชุญุฏูุซ ูุฏุฉ ุงูุชุญุงููุงุช
  updateAlliancesDuration();
  
  // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
  updateStatsDisplay();

  if (secondMsg){
    await playSequence([{ text: secondMsg, duration: 1500 }]);
  }
  
  document.getElementById("currentTurnDisplay").classList.remove("current-turn");
  document.getElementById("currentTurnDisplay").innerText = `โจ ุงูุฏูุฑ ุงูุขู: ูู ูุชู ุงูุงุฎุชูุงุฑ`;
  
  // ุญุฏุซ ุนุดูุงุฆู ุจุนุฏ ุงููุฌูู
  if (advancedSettings.enableRandomEvents) {
    setTimeout(() => triggerRandomEvent(), 500);
  }
}

/* =========================
   ุฃุนูุงู
   ========================= */
function getCountryCode(n) {
  const codes = { "ุงูุณุนูุฏูุฉ":"sa","ุงูุฅูุงุฑุงุช":"ae","ูุทุฑ":"qa","ูุตุฑ":"eg","ุงูุฃุฑุฏู":"jo","ูุจูุงู":"lb","ุงูุนุฑุงู":"iq","ุงููููุช":"kw","ุนูุงู":"om","ุงูุจุญุฑูู":"bh","ุชููุณ":"tn","ุงูุฌุฒุงุฆุฑ":"dz","ุงููุบุฑุจ":"ma","ููุจูุง":"ly","ุงูุณูุฏุงู":"sd","ุงูููู":"ye","ุณูุฑูุง":"sy","ููุณุทูู":"ps","ุชุฑููุง":"tr","ุฅูุฑุงู":"ir","ุฃููุงููุง":"de","ูุฑูุณุง":"fr","ุฅูุทุงููุง":"it","ุฅุณุจุงููุง":"es","ุฃูุฑููุง":"us","ููุฏุง":"ca","ุฑูุณูุง":"ru","ุงูุตูู":"cn","ุงููุงุจุงู":"jp","ุงูููุฏ":"in" };
  return codes[n] || "un";
}

/* =========================
   ุงุชุตุงู ุจุงูุดุงุช - ุชู ุงูุชุตุญูุญ
   ========================= */
let isConnected = false;

function connectChat() {
  const plat = platformNew.value;
  const channel = channelNew.value.trim().toLowerCase();
  
  if (!channel) { 
    toast("โ๏ธ ุงูุชุจ ุงุณู ุงูููุงุฉ ุฃููุงู"); 
    return; 
  }
  
  if (isConnected) {
    disconnectChat();
  }

  try {
    if (rememberChk.checked) {
      localStorage.setItem('war_connect_pref', JSON.stringify({
        platform: plat, 
        channel, 
        remember: true
      }));
    } else {
      localStorage.removeItem('war_connect_pref');
    }
  } catch(_) {}

  updateStatus(false, 'ุฌุงุฑู ุงูุงุชุตุงู...');

  if (plat === "twitch") {
    connectTwitch(channel);
  } else if (plat === "kick") {
    connectKick(channel);
  }
}

function connectTwitch(channel) {
  try {
    // ูุตู ุงูุนููู ุงููุฏูู ุฅุฐุง ูุงู ููุฌูุฏุงู
    if (twitchClient) {
      twitchClient.disconnect();
    }
    
    // ุฅูุดุงุก ุนููู ุฌุฏูุฏ
    twitchClient = new tmi.Client({
      options: { debug: false },
      connection: { reconnect: true, secure: true },
      channels: [channel]
    });
    
    // ูุนุงูุฌุฉ ุงูุฃุญุฏุงุซ
    twitchClient.on('connected', (address, port) => {
      console.log(`Connected to Twitch: ${address}:${port}`);
      updateStatus(true, `ูุชุตู ุจู ${channel}`);
      notify(`โ ุชู ุงูุงุชุตุงู ุจููุงุฉ ${channel} ุนูู Twitch!`);
      isConnected = true;
      document.getElementById('connectBtn').textContent = 'โ ูุทุน ุงูุงุชุตุงู';
    });
    
    twitchClient.on('message', (channel, tags, message, self) => {
      if (self) return;
      
      const user = tags['display-name'] || tags['username'] || '';
      const content = message.trim();
      
      handleChatMessage(user, content);
    });
    
    twitchClient.on('disconnected', (reason) => {
      console.log(`Disconnected from Twitch: ${reason}`);
      updateStatus(false, 'ุงููุทุน ุงูุงุชุตุงู');
      isConnected = false;
      document.getElementById('connectBtn').textContent = 'โ ุงุชุตุงู';
    });
    
    // ุจุฏุก ุงูุงุชุตุงู
    twitchClient.connect().catch(err => {
      console.error('Twitch connection error:', err);
      updateStatus(false, 'ูุดู ุงูุงุชุตุงู');
      notify('โ ูุดู ุงูุงุชุตุงู ุจูTwitch! ุชุฃูุฏ ูู ุงุณู ุงูููุงุฉ');
    });
    
  } catch (error) {
    console.error('Error connecting to Twitch:', error);
    updateStatus(false, 'ุฎุทุฃ ูู ุงูุงุชุตุงู');
    notify('โ ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจูTwitch');
  }
}

function connectKick(channel) {
  // Kick API connection (simplified version)
  updateStatus(true, `ูุชุตู ุจู ${channel}`);
  notify(`โ ุชู ุงูุงุชุตุงู ุจููุงุฉ ${channel} ุนูู Kick!`);
  isConnected = true;
  document.getElementById('connectBtn').textContent = 'โ ูุทุน ุงูุงุชุตุงู';
  
  // Note: Kick requires actual backend server for full integration
  // This is a simplified version for demonstration
  toast("โ๏ธ ููุงุญุธุฉ: ุงุชุตุงู Kick ูุนูู ุจุดูู ูุญุฏูุฏุ ูุญุชุงุฌ ูุฎุงุฏู ุฎููู ููุชูุงูู ุงููุงูู", 3000);
}

function disconnectChat() {
  if (twitchClient) {
    twitchClient.disconnect();
    twitchClient = null;
  }
  
  if (kickSocket) {
    kickSocket.close();
    kickSocket = null;
  }
  
  updateStatus(false, 'ุบูุฑ ูุชุตู');
  notify('๐ ุชู ูุทุน ุงูุงุชุตุงู');
  isConnected = false;
  document.getElementById('connectBtn').textContent = 'โ ุงุชุตุงู';
}

function handleChatMessage(user, content) {
  // ุฅุถุงูุฉ ูุงุนุจ
  if (!isGameStarted && content === "!ุฏุฎูู") {
    addPlayer(user);
  }
  
  // ุฎุฑูุฌ ูุงุนุจ
  if (content === "!ุฎุฑูุฌ") {
    removePlayer(user);
  }
  
  // ุชุญุงูู
  if (content.startsWith("!ุชุญุงูู") && advancedSettings.allowAlliances) {
    const mentioned = content.split("@")[1]?.trim();
    if (mentioned && players.includes(mentioned) && user !== mentioned && players.includes(user)) {
      formAlliance(user, mentioned);
    }
  }
  
  // ุฑุณุงุฆู ุฎุงุตุฉ
  if (content.startsWith("!ุฑุณุงูุฉ") && advancedSettings.enableMessages) {
    const parts = content.split(" ");
    if (parts.length >= 3) {
      const to = parts[1].replace("@", "").trim();
      const message = parts.slice(2).join(" ");
      if (to && message) {
        sendMessage(user, to, message);
      }
    }
  }
  
  // ูุฌูู (ุฅุฐุง ูุงู ุฏูุฑ ุงููุงุนุจ)
  if (isGameStarted && currentTurnPlayer && user === currentTurnPlayer) {
    const countryName = content.trim();
    if (countriesPool.includes(countryName) && remainingCountries.includes(countryName)) {
      attackCountry(countryName);
    }
  }
  
  // ุฅุนุงุฏุฉ ูุงุนุจ
  if ((content.startsWith("!ุงุนุงุฏู") || content.startsWith("!ุฅุนุงุฏู")) && user === lastReviver) {
    const mentioned = content.split("@")[1]?.trim();
    if (mentioned) {
      reviveByName(mentioned);
    }
  }
}

/* =========================
   ุงูุฑุณุงุฆู ูุงูุชูุงุนูุงุช
   ========================= */
function sendMessage(from, to, message) {
  if (!advancedSettings.enableMessages) return;
  
  playerMessages.push({
    from,
    to,
    message,
    time: new Date().toLocaleTimeString()
  });
  
  // ุนุฑุถ ุฅุดุนุงุฑ ููุงุนุจ ุงููุนูู ุฅุฐุง ูุงู ูุชุตูุงู
  if (currentTurnPlayer === to) {
    notify(`๐จ ุฑุณุงูุฉ ูู ${from}: ${message}`, 3000);
  }
  
  logEvent(`ุฑุณุงูุฉ: ${from} โ ${to}`);
}

function showPlayerMessages() {
  if (playerMessages.length === 0) {
    toast("๐ญ ูุง ุชูุฌุฏ ุฑุณุงุฆู", 1500);
    return;
  }
  
  let messagesText = "๐จ ุงูุฑุณุงุฆู:\n";
  playerMessages.slice(-5).forEach(msg => {
    messagesText += `[${msg.time}] ${msg.from} โ ${msg.to}: ${msg.message}\n`;
  });
  
  toast(messagesText, 4000);
}

function sendReaction(reaction) {
  if (!currentTurnPlayer) {
    notify("ููุณ ููุงู ุฏูุฑ ูุดุท ููุชูุงุนู", 1500);
    return;
  }
  
  lastReaction = reaction;
  notify(`๐ญ ${currentTurnPlayer}: ${reaction}`, 2000);
  
  // ุฅุฑุณุงู ุฑุฏ ุงููุนู ููุดุงุช ุฅุฐุง ูุงู ูุชุตูุงู
  logEvent(`ุชูุงุนู: ${currentTurnPlayer} ${reaction}`);
}

/* =========================
   ุจุฏุก ุงููุนุจุฉ โ ูุณุฎุฉ ููููุงุฉ ูุน ุฅุฎูุงุก ุงููุนูููุงุช
   ========================= */
function startGame() {
  try {
    if (players.length < 2) {
      notify("โ๏ธ ูุงุฒู ูุงุนุจูู ุงุซููู ุนูู ุงูุฃูู (ุงูุชุจูุง !ุฏุฎูู)", 2500);
      return;
    }

    isGameStarted = true;
    joinLocked = true;
    usedSpecialCountries = [];
    eliminatedData = [];
    playerImmunity = {};
    eliminatedPlayers = [];
    lastReviver = "";
    assignedCountries = {};
    remainingCountries = [];
    immunityCountries = [];
    reviveCountries = [];
    
    // ุฅุนุงุฏุฉ ุชุนููู ุงูุจุทุงูุงุช
    for (const card in specialCards) {
      specialCards[card].used = false;
    }

    const totalNeeded = Math.min(countriesPool.length, players.length + 4);
    const availableCountries = [...countriesPool];
    if (totalNeeded <= 0) {
      notify("โ๏ธ ูุง ูู ุฏูู ูุงููุฉ ููุชูุฒูุน", 2500);
      return;
    }

    const selectedCountries = [];
    for (let i = 0; i < totalNeeded; i++) {
      if (availableCountries.length === 0) break;
      const randomIndex = Math.floor(Math.random() * availableCountries.length);
      selectedCountries.push(availableCountries[randomIndex]);
      availableCountries.splice(randomIndex, 1);
    }

    const specialCountries = [];
    while (specialCountries.length < Math.min(4, selectedCountries.length)) {
      const randomIndex = Math.floor(Math.random() * selectedCountries.length);
      specialCountries.push(selectedCountries[randomIndex]);
      selectedCountries.splice(randomIndex, 1);
    }
    immunityCountries = specialCountries.slice(0, 2);
    reviveCountries  = specialCountries.slice(2);
    usedSpecialCountries.push(...specialCountries);

    const playableCountries = [...selectedCountries];
    const shuffledPlayers = [...players];
    for (let i = shuffledPlayers.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffledPlayers[i], shuffledPlayers[j]] = [shuffledPlayers[j], shuffledPlayers[i]];
    }
    playableCountries.forEach((country, i) => {
      const player = shuffledPlayers[i % shuffledPlayers.length];
      assignedCountries[country] = player;
      remainingCountries.push(country);
    });

    remainingCountries.push(...specialCountries);
    specialCountries.forEach(country => { assignedCountries[country] = null; });

    renderCountries();
    renderPlayers();
    updateEliminatedDisplay();
    
    // ุชููุฆุฉ ุงููุธุงู
    initSystem();

    const msg = `๐ฎ ุจุฏุฃุช ุงููุนุจุฉ!
๐ฅ ูุงุนุจูู: ${players.length}
๐บ๏ธ ุฏูู ูุนุจ: ${playableCountries.length}
โญ ุฎุงุตุฉ: ${specialCountries.length} (ุญุตุงูุฉ: ${immunityCountries.length}, ุฅุนุงุฏุฉ: ${reviveCountries.length})
๐ ุงูููููุฉ ูุฎููุฉ ูุงูุฏูู ุงูุฎุงุตุฉ ุบูุฑ ูุฑุฆูุฉ!`;
    toast(msg, 2500);
    logEvent("ุจุฏุก ุงููุนุจุฉ ูุชูุฒูุน ุงูุฏูู - ุงูููููุฉ ูุฎููุฉ");
    
    // ุจุฏุก ูุถุน ุงูุณุจุงู ุฅุฐุง ูุงู ููุนูุงู
    if (raceMode) {
      startRaceMode();
    }
  } catch (err) {
    console.error("startGame error:", err);
    toast("โ๏ธ ุตุงุฑ ุฎุทุฃ ุฃุซูุงุก ุจุฏุก ุงููุนุจุฉ โ ุฑุงุฌุน ุงููููุณูู", 2500);
  }
}

/* =========================
   ูุถุน ุงูุณุจุงู
   ========================= */
function toggleRaceMode() {
  raceMode = !raceMode;
  const btn = document.getElementById('raceModeBtn');
  const timer = document.getElementById('raceTimer');
  
  if (raceMode) {
    btn.textContent = 'โฑ๏ธ ูุถุน ุงูุณุจุงู: ON';
    timer.style.display = 'block';
    if (isGameStarted) {
      startRaceMode();
    }
    notify("โฑ๏ธ ูุถุน ุงูุณุจุงู ููุนู", 1500);
  } else {
    btn.textContent = 'โฑ๏ธ ูุถุน ุงูุณุจุงู: OFF';
    timer.style.display = 'none';
    stopRaceMode();
    notify("โฑ๏ธ ูุถุน ุงูุณุจุงู ูุนุทู", 1500);
  }
}

function startRaceMode() {
  const timerDisplay = document.getElementById('raceTime');
  let timeLeft = raceTime;
  
  updateRaceTimerDisplay(timeLeft);
  
  raceTimerId = setInterval(() => {
    timeLeft--;
    updateRaceTimerDisplay(timeLeft);
    
    if (timeLeft <= 0) {
      stopRaceMode();
      endRound(true);
      notify("โฐ ุงูุชูู ููุช ุงูุณุจุงู!", 3000);
    }
    
    // ุชุญุฐูุฑุงุช ุงูููุช
    if (timeLeft === 60) notify("โฐ ุชุจูู ุฏูููุฉ ูุงุญุฏุฉ!", 2000);
    if (timeLeft === 30) notify("โฐ ุชุจูู 30 ุซุงููุฉ!", 2000);
    if (timeLeft === 10) {
      notify("โฐ ุชุจูู 10 ุซูุงูู!", 1000);
    }
  }, 1000);
}

function stopRaceMode() {
  if (raceTimerId) {
    clearInterval(raceTimerId);
    raceTimerId = null;
  }
}

function updateRaceTimerDisplay(seconds) {
  const timerDisplay = document.getElementById('raceTime');
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  timerDisplay.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  
  // ุชุบููุฑ ุงูููู ุนูุฏ ุงูุฎูุงุถ ุงูููุช
  if (seconds <= 30) {
    timerDisplay.style.color = '#ff3333';
    timerDisplay.style.animation = 'glow 0.5s infinite alternate';
  } else if (seconds <= 60) {
    timerDisplay.style.color = '#ffcc00';
  } else {
    timerDisplay.style.color = '#ffffff';
    timerDisplay.style.animation = 'none';
  }
}

/* =========================
   ุงูููุงูุจ ุงูุณุฑูุนุฉ
   ========================= */
function loadTemplate(templateName) {
  const templates = {
    speed: { players: 4, countries: 8, turnTime: 20, spinTime: 10 },
    normal: { players: 8, countries: 16, turnTime: 30, spinTime: 30 },
    long: { players: 12, countries: 24, turnTime: 45, spinTime: 60 }
  };
  
  const tpl = templates[templateName];
  if (!tpl) return;
  
  document.getElementById('turnSecondsSelect').value = tpl.turnTime;
  document.getElementById('spinTimeSelect').value = tpl.spinTime;
  
  // ุฅุฐุง ูุงู ููุงู ูุงุนุจูู ุฃูู ูู ุงููุทููุจ
  if (players.length < tpl.players) {
    notify(`๐ฅ ูุญุชุงุฌ ${tpl.players - players.length} ูุงุนุจูู ุฅุถุงูููู`, 2000);
  }
  
  notify(`โ ุชู ุชุญููู ูุงูุจ ${templateName}`, 1500);
}

/* =========================
   ุงูุฃุฏูุงุช ุงูุฅุฏุงุฑูุฉ
   ========================= */
function updateAdminPlayerSelect() {
  const select = document.getElementById('adminPlayerSelect');
  select.innerHTML = '<option value="">ุงุฎุชุฑ ูุงุนุจุงู</option>';
  
  players.forEach(player => {
    const option = document.createElement('option');
    option.value = player;
    option.textContent = player;
    select.appendChild(option);
  });
}

function adminKick() {
  const select = document.getElementById('adminPlayerSelect');
  const player = select.value;
  if (!player) return;
  
  if (confirm(`ูู ุชุฑูุฏ ุทุฑุฏ ${player}ุ`)) {
    removePlayer(player);
    toast(`๐ซ ุชู ุทุฑุฏ ${player}`, 2000);
    logEvent(`ุทุฑุฏ ุฅุฏุงุฑู: ${player}`);
  }
}

function assignTeamCaptain() {
  const select = document.getElementById('adminPlayerSelect');
  const player = select.value;
  if (!player) return;
  
  // ููุญ ุตูุงุญูุงุช ุฅุถุงููุฉ (ูููู ุชูุณูุนูุง)
  playerImmunity[player] = true;
  notify(`๐ ${player} ุฃุตุจุญ ูุงุฆุฏ ุงููุฑูู ูุญุตู ุนูู ุญุตุงูุฉ`, 2000);
  logEvent(`ูุงุฆุฏ ูุฑูู: ${player}`);
}

function pauseGame(seconds) {
  if (!isGameStarted) return;
  
  isGameStarted = false;
  const oldTurnPlayer = currentTurnPlayer;
  currentTurnPlayer = "";
  stopTurnTimer();
  
  notify(`โธ๏ธ ุงููุนุจุฉ ูุชูููุฉ ููุฏุฉ ${seconds} ุซุงููุฉ`, seconds * 1000);
  
  setTimeout(() => {
    isGameStarted = true;
    currentTurnPlayer = oldTurnPlayer;
    if (currentTurnPlayer) {
      startTurnTimer();
      notify("โถ๏ธ ุงุณุชุฆูุงู ุงููุนุจุฉ", 1500);
    }
  }, seconds * 1000);
}

/* =========================
   ุณุฌู ุงููุจุงุฑูุงุช
   ========================= */
function showMatchHistory() {
  if (matchHistory.length === 0) {
    toast("๐ ูุง ุชูุฌุฏ ูุจุงุฑูุงุช ุณุงุจูุฉ", 1500);
    return;
  }
  
  let historyText = "๐ ุขุฎุฑ ุงููุจุงุฑูุงุช:\n";
  matchHistory.slice(-3).forEach((match, i) => {
    historyText += `${i + 1}. ${match.winner} ูุงุฒ (${match.date})\n`;
  });
  
  toast(historyText, 4000);
}

function saveMatchToHistory(winner) {
  matchHistory.push({
    winner,
    playersCount: players.length,
    date: new Date().toLocaleDateString(),
    duration: Math.round((Date.now() - gameStartTime) / 1000 / 60) + " ุฏูููุฉ"
  });
  
  // ุงูุงุญุชูุงุธ ุจู 10 ูุจุงุฑูุงุช ููุท
  if (matchHistory.length > 10) {
    matchHistory.shift();
  }
}

/* =========================
   ุฅููุงุก ุงูุฌููุฉ ูุฅุนูุงู ุงููุงุฆุฒ
   ========================= */
function endRound(auto=false){
  const counts = {};
  for (const c of Object.keys(assignedCountries)){
    const p = assignedCountries[c];
    if (p) counts[p] = (counts[p]||0) + 1;
  }
  let best = [], max = -1;
  players.forEach(p=>{
    const n = counts[p]||0;
    if (n>max){ max=n; best=[p]; }
    else if (n===max){ best.push(p); }
  });
  let msg = "";
  if (players.length===1){
    msg = `๐ ุงููุงุฆุฒ: ${players[0]} โ ุขุฎุฑ ูุงุนุจ ุจุงูู`;
    if (playerStats[players[0]]) playerStats[players[0]].wins++;
    saveMatchToHistory(players[0]);
  }else if (best.length===1){
    msg = `๐ ุงููุงุฆุฒ: ${best[0]} โ ุจุฃูุจุฑ ุนุฏุฏ ุฏูู (${max})`;
    if (playerStats[best[0]]) playerStats[best[0]].wins++;
    saveMatchToHistory(best[0]);
  }else{
    msg = `๐ค ุชุนุงุฏู ุจูู: ${best.join('ุ ')} โ (${max})`;
    best.forEach(p => {
      if (playerStats[p]) playerStats[p].wins += 0.5;
    });
    saveMatchToHistory(best.join(' ู '));
  }
  
  // ุฅุถุงูุฉ ููุงุท ุงูููุณู
  const seasonWinner = best.length === 1 ? best[0] : best.join('_');
  seasonPoints[seasonWinner] = (seasonPoints[seasonWinner] || 0) + 100;
  
  toast(msg, 3500);
  logEvent(msg);
  
  // ุฅููุงู ูุถุน ุงูุณุจุงู
  if (raceMode) {
    stopRaceMode();
  }
}

/* =========================
   ุซูู + ุชููุฆุฉ
   ========================= */
function toggleTheme(){
  const isLight = document.documentElement.getAttribute('data-theme') === 'light';
  document.documentElement.setAttribute('data-theme', isLight ? 'dark' : 'light');
  notify(isLight ? "๐ ุซูู ุบุงูู" : "โ๏ธ ุซูู ูุงุชุญ");
}

function clearSavedState(){
  localStorage.removeItem("war_states_v3");
  localStorage.removeItem("war_match_history");
  localStorage.removeItem("war_season_points");
  localStorage.removeItem("war_advanced_settings");
  notify("๐๏ธ ุชู ุญุฐู ุฌููุน ุงูุญูุธ", 900);
}

function resetGame(){
  if (turnTimerId) clearInterval(turnTimerId);
  if (raceTimerId) {
    clearInterval(raceTimerId);
    raceTimerId = null;
  }
  players = []; playerColors = {}; currentTurnPlayer = "";
  assignedCountries = {}; remainingCountries = [];
  immunityCountries = []; reviveCountries = []; usedSpecialCountries = [];
  playerImmunity = {}; eliminatedPlayers = []; lastReviver = "";
  isGameStarted = false; eliminatedData = []; joinLocked = false; eventLog = [];
  playerStats = {}; totalAttacks = 0; attackHistory = [];
  alliances = {}; allianceDurations = {};
  eventCount = 0; challengePoints = 0; currentChallenge = "";
  playerMessages = []; lastReaction = "";
  raceMode = false; document.getElementById('raceModeBtn').textContent = 'โฑ๏ธ ูุถุน ุงูุณุจุงู: OFF';
  streamerView = false; document.getElementById('streamerViewBtn').textContent = '๐๏ธ ุนุฑุถ ุงูุณุชุฑููุฑ';
  document.getElementById('raceTimer').style.display = 'none';
  
  // ุฅุนุงุฏุฉ ุชุนููู ุงูุจุทุงูุงุช
  for (const card in specialCards) {
    specialCards[card].used = false;
  }
  
  renderPlayers(); renderCountries(); updateEliminatedDisplay();
  document.getElementById("eventLog").innerHTML = "";
  document.getElementById("currentTurnDisplay").innerText = `โจ ุงูุฏูุฑ ุงูุขู: ูู ูุจุฏุฃ ุจุนุฏ`;
  document.getElementById("currentTurnDisplay").classList.remove("current-turn");
  document.getElementById('remainingCount').textContent = "30";
  document.getElementById('gameProgress').style.width = "0%";
  
  updateStatsDisplay();
  updateAlliancesDisplay();
  updateAdminPlayerSelect();
  
  notify("โบ ุชู ุฅุนุงุฏุฉ ุชุนููู ุงููุนุจุฉ ุจุงููุงูู");
}

function init(){
  document.documentElement.setAttribute('data-theme', 'dark');
  updateAdminPlayerSelect();
  setRandomChallenge();
  loadAdvancedSettings();
  
  // ุชุญููู ุณุฌู ุงููุจุงุฑูุงุช
  try {
    const savedHistory = localStorage.getItem('war_match_history');
    if (savedHistory) matchHistory = JSON.parse(savedHistory);
    
    const savedSeason = localStorage.getItem('war_season_points');
    if (savedSeason) seasonPoints = JSON.parse(savedSeason);
  } catch (_) {}
  
  // ุญูุธ ุฏูุฑู
  setInterval(() => {
    try {
      localStorage.setItem('war_match_history', JSON.stringify(matchHistory));
      localStorage.setItem('war_season_points', JSON.stringify(seasonPoints));
      localStorage.setItem('war_advanced_settings', JSON.stringify(advancedSettings));
    } catch (_) {}
  }, 30000);
  
  // ุฑุจุท ุฒุฑ ุงูุงุชุตุงู
  document.getElementById('connectBtn').onclick = connectChat;
}

// ุฅุถุงูุฉ ุญุฏุซ ูููุณุฎ ุงูุงุญุชูุงุทู ุงูุชููุงุฆู
window.addEventListener('beforeunload', () => {
  try {
    localStorage.setItem('war_match_history', JSON.stringify(matchHistory));
    localStorage.setItem('war_season_points', JSON.stringify(seasonPoints));
    localStorage.setItem('war_advanced_settings', JSON.stringify(advancedSettings));
  } catch (_) {}
});

init();
</script>
</body>
</html>
