<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ğŸŒ Ø­Ø±Ø¨ Ø§Ù„Ø¯ÙˆÙ„</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">
<script src="tmi.min.js"></script>
<style>
:root{
  --bg1:#1a1a3d; --bg2:#004466; --text:#fff; --panel:#222; --line:#444;
  --accent:#ff3333; --ok:#00e6a8; --warn:#ffcc00; --muted:#ccc; --card:#222;
  --badge:#0b3d3d; --badge-b:#0ff; --bad:#ff6666;
}
[data-theme="light"]{
  --bg1:#f2f6ff; --bg2:#dfe9ff; --text:#111; --panel:#fff; --line:#e5e7eb;
  --accent:#ff3333; --ok:#00a37a; --warn:#b08500; --muted:#444; --card:#fff;
  --badge:#e8f7f7; --badge-b:#027e7e; --bad:#b00020;
}
body {
  background: linear-gradient(-45deg, var(--bg1), var(--bg2), var(--bg1), var(--bg2));
  background-size: 400% 400%;
  animation: gradientBG 20s ease infinite;
  color: var(--text);
  font-family: 'Cairo', sans-serif;
  text-align: center;
  padding: 20px;
}
@keyframes gradientBG { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

h1{ font-size:36px; color:var(--accent); margin:0 0 10px; }
.small-note{ font-size:14px; color:var(--muted); }
.badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:var(--badge); border:1px solid var(--badge-b); color:var(--badge-b); font-size:12px; margin-inline:6px; }

.container { display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start; }
.panel{
  width:48%; min-height:300px; border:2px solid #fff3; background: #0003;
  backdrop-filter: blur(4px);
  border-radius:12px; padding:12px; overflow:hidden; position:relative;
}
@media(max-width: 1000px){ .panel{ width:100%; } }

button{
  padding:10px 16px; border:none; border-radius:8px; cursor:pointer;
  background:var(--accent); color:#fff; font-family:'Cairo',sans-serif;
}
button.alt{ background:#6c757d; }
button.ghost{ background:#39424e; }
button.green{ background:#198754; }
button.cyan{ background:#0dcaf0; color:#001218; }
button.warn{ background:#b08500; }
button:disabled{ opacity:0.6; cursor:not-allowed; }

select,input{ padding:10px; border-radius:8px; border:1px solid var(--line); background:#0004; color:var(--text); }
.controls-row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center; }

.overlay {
  position:fixed; inset:0;
  background:rgba(0,0,0,0.7);
  display:none; align-items:center; justify-content:center;
  font-size:24px; z-index:999; padding: 20px; text-align:center;
}

#noticeBar{
  position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
  background: #000c; color:#fff; padding:10px 16px; border-radius:999px;
  border:1px solid #fff4; z-index:1000; opacity:0; pointer-events:none;
  transition: opacity .25s ease;
}

/* Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
#wheel canvas{ display:block; margin:10px auto 0; }
#turnTimerText { margin-top:6px; }
#turnProgressWrap{ width:80%; height:10px; background:#ffffff22; border-radius:999px; margin:6px auto 0; overflow:hidden; }
#turnProgress{ height:100%; width:0%; background:linear-gradient(90deg, #0ff, #09f); transition: width .2s linear; }

/* Ø§Ù„Ø¯ÙˆÙ„ Grid */
#countryList{
  display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; padding:8px;
}
.country{
  background:var(--card); border:1px solid #ffffff1a; border-radius:10px; padding:8px;
  text-align:center; opacity:0; transform: translateY(8px) scale(.98);
  transition: all .25s ease; cursor:pointer; user-select:none;
  box-shadow: 0 4px 12px rgba(0,0,0,.15);
}
.country.show{ opacity:1; transform: translateY(0) scale(1); }
.country img{ width:80px; display:block; margin:2px auto 6px; border-radius:6px; }

/* Ø§Ù„Ù…Ù‚ØµÙ‘ÙŠÙŠÙ† */
.eliminated-section { margin-top: 16px; padding: 12px; background: rgba(255,0,0,0.12);
  border-radius: 10px; border: 1px solid #ff000055; }
.eliminated-title { color: #ff6b6b; font-size: 22px; margin:0 0 6px; }
.eliminated-content { color: #ff9999; font-size: 16px; display:flex; flex-wrap:wrap; justify-content:center; gap:8px; }
.eliminated-item { background: rgba(255,0,0,0.25); padding:6px 10px; border-radius: 8px; }

/* Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
.revive-section{ margin-top: 12px; padding: 12px; background: rgba(0,255,0,0.12);
  border-radius: 10px; border: 1px solid #00ff0055; }
.revive-title{ color:#00ff99; font-size:22px; margin:0 0 8px; }
.revive-select{ padding:8px; font-size:16px; border-radius:8px; border:none; }
.revive-button{ background:#28a745; }

/* Ù„ÙˆØ­Ø© Ù†ØªØ§Ø¦Ø¬ + ØªØ§Ø±ÙŠØ® Ø£Ø­Ø¯Ø§Ø« */
.sidebar{ width:100%; border-top:1px dashed #ffffff33; margin-top:10px; padding-top:10px; }
.score-table{ width:100%; border-collapse: collapse; font-size:14px; }
.score-table th, .score-table td{ padding:6px 8px; border-bottom:1px solid #ffffff1a; text-align:center; }
.score-table th{ color:#0ff; }
.bad-icon{ color: var(--bad); }
.ok-icon{ color: var(--ok); }

/* Ù…Ø¤Ù‚Øª Ø§Ù„Ø¬ÙˆÙ„Ø© */
#roundTimerBox{ margin-top:10px; padding:8px; background:#0004; border:1px solid #ffffff22; border-radius:10px; display:inline-block; }
#themeToggle{ position: fixed; bottom: 14px; left: 14px; padding:8px 12px; font-size:14px; background:#222; border:1px solid #fff2; }
</style>
</head>
<body>
<div id="noticeBar"></div>

<h1>ğŸŒ Ù„Ø¹Ø¨Ø© Ø­Ø±Ø¨ Ø§Ù„Ø¯ÙˆÙ„</h1>
<p>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØµØ© ÙˆØ£Ø±Ø³Ù„ <span class="badge">!Ø¯Ø®ÙˆÙ„</span> ÙÙŠ Ø§Ù„Ø´Ø§Øª Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… <span class="badge">ÙŠÙÙ‚ÙÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø¯Ø¡</span></p>

<div class="container">
  <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† -->
  <div class="panel" id="wheel">
    <h3>ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h3>
    <p class="small-note">Ø³ÙŠÙƒÙˆÙ† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¹Ø´ÙˆØ§Ø¦ÙŠÙ‹Ø§</p>
    <canvas id="playerWheel" width="420" height="420"></canvas>
    <div class="controls-row" style="margin-top:6px;">
      <div title="Ù…Ø¯Ø© Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ø¹Ø¬Ù„Ø©: ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ù…Ø¯Ø© Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† ÙÙ‚Ø·">
        <select id="spinTimeSelect">
          <option value="10">10 Ø«ÙˆØ§Ù†ÙŠ</option>
          <option value="20">20 Ø«Ø§Ù†ÙŠØ©</option>
          <option value="30">30 Ø«Ø§Ù†ÙŠØ©</option>
          <option value="40">40 Ø«Ø§Ù†ÙŠØ©</option>
          <option value="50">50 Ø«Ø§Ù†ÙŠØ©</option>
          <option value="60" selected>60 Ø«Ø§Ù†ÙŠØ©</option>
        </select>
        <div class="small-note">â±ï¸ Ù…Ø¯Ø© Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ø¹Ø¬Ù„Ø©</div>
      </div>

      <div title="Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ±: Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø± Ù‚Ø¨Ù„ Ø§Ù„ØªØ¬Ø§ÙˆØ²">
        <select id="turnSecondsSelect">
          <option value="20">20Ø«</option>
          <option value="30" selected>30Ø«</option>
          <option value="45">45Ø«</option>
          <option value="60">60Ø«</option>
        </select>
        <div class="small-note">âŒš Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ±</div>
      </div>

      <button onclick="spinWheelAnimated()">ğŸ¯ Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ø¹Ø¬Ù„Ø©</button>
      <button class="ghost" onclick="skipTurn()">â­ï¸ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¯ÙˆØ±</button>
      <button class="alt" onclick="resetGame()">â†º Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
    </div>
    <div id="turnTimerText" class="small-note">â³ Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ±: ØºÙŠØ± Ù†Ø´Ø·</div>
    <div id="turnProgressWrap"><div id="turnProgress"></div></div>

    <div class="sidebar">
      <h4 style="margin:10px 0 6px;">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h4>
      <table class="score-table" id="scoreTable">
        <thead><tr><th>Ø§Ù„Ù„Ø§Ø¹Ø¨</th><th>Ø§Ù„Ø¯ÙˆÙ„</th><th>Ø§Ù„Ø­ØµØ§Ù†Ø©</th></tr></thead>
        <tbody></tbody>
      </table>

      <h4 style="margin:10px 0 6px;">ğŸ•‘ Ø¢Ø®Ø± Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h4>
      <div id="eventLog" class="small-note" style="text-align:right; max-height:140px; overflow:auto;"></div>

      <div style="margin-top:10px;">
        <button class="warn" onclick="endRound()">ğŸ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© ÙˆØ¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙØ§Ø¦Ø²</button>
      </div>
    </div>
  </div>

  <!-- Ø§Ù„Ø¯ÙˆÙ„ -->
  <div class="panel">
    <div class="controls-row" style="justify-content:space-between;">
      <h3 style="margin:0;">ğŸŒ Ø§Ù„Ø¯ÙˆÙ„</h3>
      <div>
        <button onclick="manualShuffle()">ğŸ” Ø®Ù„Ø· Ø§Ù„Ø¯ÙˆÙ„</button>
        <button class="ghost" onclick="clearSavedState()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø­ÙØ¸</button>
      </div>
    </div>
    <p class="small-note">ØªÙ‚Ø¯Ø± ØªÙ†Ù‚Ø± Ø¹Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø© Ø¯ÙˆÙ„Ø© Ù„Ù„Ù‡Ø¬ÙˆÙ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¯ÙˆØ±Ùƒ</p>
    <div id="countryList"></div>

    <!-- Ù…Ù‚ØµÙ‘ÙŠÙŠÙ† -->
    <div class="eliminated-section" id="eliminatedSection">
      <h3 class="eliminated-title">ğŸš« Ø§Ù„Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‚ØµØ§Ø© ÙˆØ§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù…Ø·Ø±ÙˆØ¯ÙŠÙ†</h3>
      <div class="eliminated-content" id="eliminatedContent">
        <div class="eliminated-item">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­Ø°ÙˆÙÙŠÙ† Ø¨Ø¹Ø¯</div>
      </div>
    </div>

    <!-- Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† + Ù…Ø¤Ù‚Øª Ø§Ù„Ø¬ÙˆÙ„Ø© -->
    <div class="revive-section" id="reviveSection">
      <h3 class="revive-title">â™»ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ù„Ø§Ø¹Ø¨</h3>
      <select id="reviveSelect" class="revive-select">
        <option value="">Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨Ø§Ù‹ Ù„Ø¥Ø¹Ø§Ø¯ØªÙ‡</option>
      </select>
      <button onclick="revivePlayer()" class="revive-button">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨</button>
      <p class="small-note">Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø§Øª: <b>!Ø§Ø¹Ø§Ø¯Ù‡ @Ø§Ø³Ù…</b> â€” Ø§Ù„Ø®Ø±ÙˆØ¬: <b>!Ø®Ø±ÙˆØ¬</b></p>

      <div id="roundTimerBox" title="Ù…Ø¤Ù‚Øª Ø§Ù„Ø¬ÙˆÙ„Ø©: Ø­Ø¯Ù‘ Ø£Ù‚ØµÙ‰ Ù„Ù…Ø¯Ù‘Ø© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ÙƒÙ„Ù‡Ø§">
        âŒ› Ù…Ø¤Ù‚Øª Ø§Ù„Ø¬ÙˆÙ„Ø©:
        <select id="roundSelect" onchange="resetRoundTimerSelect()">
          <option value="0">Ø¨Ø¯ÙˆÙ†</option>
          <option value="600">10 Ø¯Ù‚Ø§Ø¦Ù‚</option>
          <option value="900">15 Ø¯Ù‚ÙŠÙ‚Ø©</option>
          <option value="1800" selected>30 Ø¯Ù‚ÙŠÙ‚Ø©</option>
        </select>
        <span id="roundTimeText">â€” ØºÙŠØ± Ù†Ø´Ø·</span>
        <button class="cyan" onclick="startRoundTimer()">Ø¨Ø¯Ø¡</button>
        <button class="alt" onclick="stopRoundTimer()">Ø¥ÙŠÙ‚Ø§Ù</button>
        <div class="small-note">ğŸ“ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª: Ù†Ø¹Ù„Ù† Ø§Ù„ÙØ§Ø¦Ø² Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø§Ù‚ÙŠÙ†/Ø£ÙƒØ«Ø± Ø¯ÙˆÙ„</div>
      </div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay"></div>

<!-- Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø§Øª -->
<div style="margin-top:16px;">
  <select id="platformSelect">
    <option value="twitch">Twitch</option>
    <option value="kick">Kick</option>
  </select>
  <input type="text" id="channelInput" placeholder="ğŸ® Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©">
  <button class="green" onclick="connectChat()">âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  <div id="chatStatus" class="small-note" style="margin-top:6px; color:#0f0;"></div>
</div>

<div class="controls-row" style="margin-top:12px; gap:6px;">
  <button onclick="startGame()">Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
  <button class="green" onclick="saveState()">ğŸ’¾ Ø­ÙØ¸</button>
  <button class="cyan" onclick="loadState()">ğŸ“¥ Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
  <button id="themeToggle" onclick="toggleTheme()">ğŸŒ“ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…</button>
</div>

<h3 id="currentTurnDisplay" style="margin-top:10px; color:#0ff;">âœ¨ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù†: Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯</h3>

<script>
/* =========================
   Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
   ========================= */
let players = [], playerColors = {}, currentTurnPlayer = "";
const countriesPool = [
  "Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©","Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª","Ù‚Ø·Ø±","Ù…ØµØ±","Ø§Ù„Ø£Ø±Ø¯Ù†","Ù„Ø¨Ù†Ø§Ù†","Ø§Ù„Ø¹Ø±Ø§Ù‚","Ø§Ù„ÙƒÙˆÙŠØª","Ø¹Ù…Ø§Ù†","Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†",
  "ØªÙˆÙ†Ø³","Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±","Ø§Ù„Ù…ØºØ±Ø¨","Ù„ÙŠØ¨ÙŠØ§","Ø§Ù„Ø³ÙˆØ¯Ø§Ù†","Ø§Ù„ÙŠÙ…Ù†","Ø³ÙˆØ±ÙŠØ§","ÙÙ„Ø³Ø·ÙŠÙ†","ØªØ±ÙƒÙŠØ§","Ø¥ÙŠØ±Ø§Ù†",
  "Ø£Ù„Ù…Ø§Ù†ÙŠØ§","ÙØ±Ù†Ø³Ø§","Ø¥ÙŠØ·Ø§Ù„ÙŠØ§","Ø¥Ø³Ø¨Ø§Ù†ÙŠØ§","Ø£Ù…Ø±ÙŠÙƒØ§","ÙƒÙ†Ø¯Ø§","Ø±ÙˆØ³ÙŠØ§","Ø§Ù„ØµÙŠÙ†","Ø§Ù„ÙŠØ§Ø¨Ø§Ù†","Ø§Ù„Ù‡Ù†Ø¯"
];
let assignedCountries = {}, remainingCountries = [], immunityCountries = [], reviveCountries = [], usedSpecialCountries = [];
let playerImmunity = {}, eliminatedPlayers = [], lastReviver = "";
let isGameStarted = false;
const overlay = document.getElementById("overlay");
let eliminatedData = [];
let turnTimerId = null, turnSeconds = 30, joinLocked = false;
let roundTimerId = null, roundLeft = 0;
let eventLog = [];

/* =========================
   Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù„ÙˆÙŠØ© + Overlay
   ========================= */
const notice = document.getElementById('noticeBar');
function toast(msg, ms=3000){
  overlay.textContent = msg;
  overlay.style.display = "flex";
  clearTimeout(overlay._t);
  overlay._t = setTimeout(()=> overlay.style.display = "none", ms);
}
function notify(msg, ms=1800){
  notice.textContent = msg;
  notice.style.opacity = 1;
  clearTimeout(notice._t);
  notice._t = setTimeout(()=> notice.style.opacity = 0, ms);
}

/* =========================
   Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
   ========================= */
function getColorForPlayer(player) {
  if (playerColors[player]) return playerColors[player];
  const hash = [...player].reduce((a, c) => a + c.charCodeAt(0), 0);
  const col = `hsl(${hash % 360}, 70%, 60%)`;
  playerColors[player] = col;
  return col;
}
function addPlayer(name, color = null) {
  if (joinLocked) return;
  if (!name) return;
  if (!players.includes(name)) {
    players.push(name);
    getColorForPlayer(name);
    renderPlayers(); updateScoreboard();
  }
}
function removePlayer(name){
  const idx = players.indexOf(name);
  if (idx !== -1){
    players.splice(idx,1);
    delete playerColors[name];
    for (const c of Object.keys(assignedCountries)){
      if (assignedCountries[c] === name){
        delete assignedCountries[c];
        remainingCountries = remainingCountries.filter(x=>x!==c);
      }
    }
    eliminatedPlayers = eliminatedPlayers.filter(x=>x!==name);
    eliminatedData = eliminatedData.filter(item=> item.player !== name);
    renderPlayers(); renderCountries(); updateEliminatedDisplay(); updateScoreboard();
  }
}
function logEvent(text){
  const ts = new Date().toLocaleTimeString();
  eventLog.unshift(`â€¢ [${ts}] ${text}`);
  eventLog = eventLog.slice(0, 20);
  document.getElementById('eventLog').innerHTML = eventLog.map(e=>`<div>${e}</div>`).join('');
}

/* =========================
   Ø±Ø³Ù… Ø¹Ø¬Ù„Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
   ========================= */
function renderPlayers(rotation = 0) {
  const canvas = document.getElementById("playerWheel");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  const r = canvas.width / 2;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (players.length === 0) return;
  const slice = 2 * Math.PI / players.length;
  players.forEach((p, i) => {
    const angle = slice * i + rotation;
    ctx.beginPath(); ctx.moveTo(r, r);
    ctx.arc(r, r, r, angle, angle + slice);
    ctx.fillStyle = getColorForPlayer(p); ctx.fill(); ctx.strokeStyle="#000"; ctx.lineWidth=1; ctx.stroke();
    ctx.save(); ctx.translate(r, r); ctx.rotate(angle + slice / 2);
    ctx.textAlign = "right";
    ctx.fillStyle = "#000";
    ctx.font = "bold 14px Cairo";
    let displayName = p + (playerImmunity[p] ? " (Ù…Ø­ØµÙ†)" : "");
    ctx.fillText(displayName, r - 10, 5); ctx.restore();
  });
  // Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ø«Ø§Ø¨Øª Ø¹Ù†Ø¯ Ø²Ø§ÙˆÙŠØ© 0 Ø±Ø§Ø¯ÙŠØ§Ù† (ÙŠÙ…ÙŠÙ† Ø§Ù„Ù…Ø±ÙƒØ²)
  ctx.beginPath();
  ctx.moveTo(canvas.width - 20, r);
  ctx.lineTo(canvas.width, r - 20);
  ctx.lineTo(canvas.width, r + 20);
  ctx.closePath();
  ctx.fillStyle = "#ff0";
  ctx.fill();
}

/* =========================
   Ø§Ù„Ù…Ù‚ØµÙ‘ÙŠÙŠÙ† + Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©
   ========================= */
function updateEliminatedDisplay() {
  const eliminatedContent = document.getElementById("eliminatedContent");
  const reviveSelect = document.getElementById("reviveSelect");
  eliminatedContent.innerHTML = "";
  reviveSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨Ø§Ù‹ Ù„Ø¥Ø¹Ø§Ø¯ØªÙ‡</option>';
  if (eliminatedData.length === 0) {
      eliminatedContent.innerHTML = '<div class="eliminated-item">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­Ø°ÙˆÙÙŠÙ† Ø¨Ø¹Ø¯</div>';
      return;
  }
  eliminatedData.forEach(item => {
      const itemElement = document.createElement("div");
      itemElement.className = "eliminated-item";
      itemElement.textContent = `(${item.country}) ${item.player}`;
      eliminatedContent.appendChild(itemElement);
      const option = document.createElement("option");
      option.value = item.player;
      option.textContent = item.player;
      reviveSelect.appendChild(option);
  });
}
function revivePlayer() {
  const reviveSelect = document.getElementById("reviveSelect");
  const playerToRevive = reviveSelect.value;
  if (!playerToRevive) return;
  reviveByName(playerToRevive);
}
function reviveByName(playerToRevive){
  if (!eliminatedPlayers.includes(playerToRevive)) return;
  players.push(playerToRevive);
  getColorForPlayer(playerToRevive);
  eliminatedPlayers = eliminatedPlayers.filter(x => x !== playerToRevive);
  eliminatedData = eliminatedData.filter(item => item.player !== playerToRevive);
  const availableCountries = countriesPool.filter(c => 
      !remainingCountries.includes(c) && 
      !usedSpecialCountries.includes(c)
  );
  if (availableCountries.length > 0) {
      const newCountry = availableCountries[Math.floor(Math.random() * availableCountries.length)];
      assignedCountries[newCountry] = playerToRevive;
      remainingCountries.push(newCountry);
      usedSpecialCountries.push(newCountry);
      shufflePlayersAndCountries();
      renderCountries();
      renderPlayers();
      updateEliminatedDisplay();
      updateScoreboard();
      notify(`â™»ï¸ ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ${playerToRevive} Ø¨Ø¯ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©`);
      logEvent(`Ø¥Ø¹Ø§Ø¯Ø© ${playerToRevive}`);
  }
}

/* =========================
   Ø®Ù„Ø· Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆØ§Ù„Ø¯ÙˆÙ„
   ========================= */
function shufflePlayersAndCountries() {
  for (let i = players.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [players[i], players[j]] = [players[j], players[i]];
  }
  const shuffledCountries = [...remainingCountries].sort(() => Math.random() - 0.5);
  const newAssignedCountries = {};
  shuffledCountries.forEach((country, i) => {
      if (assignedCountries[country] !== undefined) {
          const player = players[i % players.length] || null;
          newAssignedCountries[country] = player;
      } else {
          newAssignedCountries[country] = null;
      }
  });
  assignedCountries = newAssignedCountries;
}
function manualShuffle(){
  shufflePlayersAndCountries();
  renderCountries();
  renderPlayers();
  updateScoreboard();
  notify("ğŸ” ØªÙ… Ø®Ù„Ø· Ø§Ù„Ø¯ÙˆÙ„ ÙˆØ§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ø´ÙˆØ§Ø¦ÙŠÙ‹Ø§");
}

/* =========================
   Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ø¹Ø¬Ù„Ø© â€” Ø¯Ù‚Ù‘Ø© ÙˆØ³Ø§Ø¹Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©
   ========================= */
function spinWheelAnimated() {
  if (players.length === 0) return;

  stopTurnTimer(); // Ù†ÙˆÙ‚Ù Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ± Ù„Ùˆ Ø´ØºÙ‘Ø§Ù„

  const spinSec = Math.max(1, parseInt(document.getElementById("spinTimeSelect").value) || 10);
  const durationMs = spinSec * 1000; // â† Ù…Ø¯Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©
  const slice = 2 * Math.PI / players.length;

  const fullSpins = 5 * 2 * Math.PI;     // Ø¯ÙˆØ±Ø§Øª ÙƒØ§Ù…Ù„Ø© Ù„Ø¬Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø­Ø±ÙƒØ©
  const randomAngle = Math.random() * 2 * Math.PI; // Ø²Ø§ÙˆÙŠØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø®ØªÙ„ÙØ© ÙƒÙ„ Ù…Ø±Ø©
  const targetRotation = fullSpins + randomAngle;

  let rotation = 0;
  const start = performance.now();

  function animate(now) {
    const elapsed = now - start;
    let t = Math.min(1, elapsed / durationMs);      // 0 â†’ 1 Ø¨Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
    // Ù…Ù†Ø­Ù†Ù‰ ØªØ³Ù‡ÙŠÙ„ (ease-in-out, smoothstep)
    const eased = t * t * (3 - 2 * t);
    rotation = targetRotation * eased;
    renderPlayers(rotation);

    if (t < 1) {
      requestAnimationFrame(animate);
    } else {
      // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ§Ø¦Ø² Ø¨Ø¯Ù‚Ø©: Ø§Ù„Ø³Ù‡Ù… Ø¹Ù†Ø¯ Ø²Ø§ÙˆÙŠØ© 0 Ø±Ø§Ø¯ÙŠØ§Ù† (ÙŠÙ…ÙŠÙ†)
      const final = rotation % (2 * Math.PI);
      // Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© ØªØ­Øª Ø§Ù„Ø³Ù‡Ù… Ù‡ÙŠ Ø¹ÙƒØ³ Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ø¹Ø¬Ù„Ø©:
      const angleUnderPointer = ( (2 * Math.PI) - final ) % (2 * Math.PI);
      // Ø­ÙˆÙ‘Ù„Ù‡Ø§ Ø¥Ù„Ù‰ ÙÙ‡Ø±Ø³ Ø§Ù„Ù‚Ø·Ø§Ø¹:
      const index = Math.floor(angleUnderPointer / slice) % players.length;

      currentTurnPlayer = players[index];
      toast(`ğŸ¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø±: ${currentTurnPlayer}`, 1200);
      document.getElementById("currentTurnDisplay").innerText = `âœ¨ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù†: ${currentTurnPlayer}`;

      // Ø§Ø¨Ø¯Ø£ Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
      turnSeconds = parseInt(document.getElementById("turnSecondsSelect").value) || 30;
      startTurnTimer();
      logEvent(`Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ±: ${currentTurnPlayer}`);
    }
  }
  requestAnimationFrame(animate);
}

/* =========================
   Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ± (Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø±)
   ========================= */
function startTurnTimer(){
  const txt = document.getElementById("turnTimerText");
  const bar = document.getElementById("turnProgress");
  let secs = turnSeconds;
  txt.textContent = `â³ Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ±: ${secs}Ø«`;
  stopTurnTimer();
  bar.style.width = "100%";
  const total = secs;
  turnTimerId = setInterval(()=>{
    secs--;
    txt.textContent = `â³ Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ±: ${secs}Ø«`;
    bar.style.width = Math.max(0, (secs/total)*100) + "%";
    if (secs <= 0){
      stopTurnTimer();
      txt.textContent = `â³ Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ±: Ø§Ù†ØªÙ‡Ù‰`;
      notify(`â­ï¸ Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª ${currentTurnPlayer} â€” ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¯ÙˆØ±`);
      logEvent(`ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¯ÙˆØ± Ø¹Ù† ${currentTurnPlayer}`);
      currentTurnPlayer = "";
      document.getElementById("currentTurnDisplay").innerText = `âœ¨ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù†: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±`;
    }
  }, 1000);
}
function stopTurnTimer(){
  if (turnTimerId){ clearInterval(turnTimerId); turnTimerId = null; }
  const bar = document.getElementById("turnProgress");
  if (bar) bar.style.width = "0%";
}
function skipTurn(){
  if (!currentTurnPlayer) return;
  notify(`â­ï¸ ØªØ¬Ø§ÙˆØ²Ù†Ø§ Ø¯ÙˆØ± ${currentTurnPlayer}`);
  logEvent(`ØªØ¬Ø§ÙˆØ² ${currentTurnPlayer}`);
  currentTurnPlayer = "";
  document.getElementById("currentTurnDisplay").innerText = `âœ¨ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù†: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±`;
  stopTurnTimer();
}

/* =========================
   Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
   ========================= */
function startGame() {
  if (players.length < 2) return alert("ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹!");
  isGameStarted = true;
  joinLocked = true;
  usedSpecialCountries = [];
  eliminatedData = [];
  playerImmunity = {};
  eliminatedPlayers = [];
  lastReviver = "";
  assignedCountries = {};
  remainingCountries = [];
  immunityCountries = [];
  reviveCountries = [];

  const totalNeeded = Math.min(countriesPool.length, players.length + 4);
  const availableCountries = [...countriesPool];
  const selectedCountries = [];
  for (let i = 0; i < totalNeeded; i++) {
    if (availableCountries.length === 0) break;
    const randomIndex = Math.floor(Math.random() * availableCountries.length);
    selectedCountries.push(availableCountries[randomIndex]);
    availableCountries.splice(randomIndex, 1);
  }
  const specialCountries = [];
  while (specialCountries.length < Math.min(4, selectedCountries.length)) {
    const randomIndex = Math.floor(Math.random() * selectedCountries.length);
    specialCountries.push(selectedCountries[randomIndex]);
    selectedCountries.splice(randomIndex, 1);
  }
  immunityCountries = specialCountries.slice(0, 2);
  reviveCountries = specialCountries.slice(2);
  usedSpecialCountries.push(...specialCountries);

  const playableCountries = [...selectedCountries];
  const shuffledPlayers = [...players];
  for (let i = shuffledPlayers.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffledPlayers[i], shuffledPlayers[j]] = [shuffledPlayers[j], shuffledPlayers[i]];
  }
  playableCountries.forEach((country, i) => {
    const player = shuffledPlayers[i % shuffledPlayers.length];
    assignedCountries[country] = player;
    remainingCountries.push(country);
  });

  remainingCountries.push(...specialCountries);
  specialCountries.forEach(country => { assignedCountries[country] = null; });

  renderCountries();
  renderPlayers();
  updateEliminatedDisplay();
  updateScoreboard();
  toast("ğŸ® Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©! ØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯ÙˆÙ„ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹", 1300);
  saveState();
}

/* =========================
   Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙˆÙ„ + Ø§Ù„Ù†Ù‚Ø± Ù„Ù„Ù‡Ø¬ÙˆÙ…
   ========================= */
function renderCountries() {
  const box = document.getElementById("countryList");
  box.innerHTML = "";
  const list = [...remainingCountries];
  list.forEach((c, i) => {
    const div = document.createElement("div");
    div.className = "country";
    div.innerHTML = `<img src="https://flagcdn.com/w80/${getCountryCode(c)}.png" alt=""><div>${c}</div>`;
    div.onclick = () => { if (isGameStarted && currentTurnPlayer) attackCountry(c); };
    setTimeout(() => { box.appendChild(div); setTimeout(() => div.classList.add("show"), 10); }, i * 40);
  });
}

/* =========================
   Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‡Ø¬ÙˆÙ…
   ========================= */
function attackCountry(c) {
  if (!isGameStarted || !currentTurnPlayer) return;
  if (!remainingCountries.includes(c)) return;

  const attacker = currentTurnPlayer;
  const victim = assignedCountries[c];

  toast(`ğŸ”´ ${attacker} Ù‡Ø§Ø¬Ù… ${c}`, 900);
  stopTurnTimer();
  currentTurnPlayer = ""; // ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø¯ÙˆØ± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡

  setTimeout(() => {
    if (victim && playerImmunity[victim] && attacker !== victim) {
      playerImmunity[victim] = false;
      notify(`ğŸ›¡ï¸ ØªÙ… ÙƒØ³Ø± Ø­ØµØ§Ù†Ø© ${victim}`);
      logEvent(`ÙƒØ³Ø± Ø­ØµØ§Ù†Ø© ${victim}`);
      shufflePlayersAndCountries();
      renderCountries(); renderPlayers(); updateScoreboard();
    }
    else if (immunityCountries.includes(c)) {
      playerImmunity[attacker] = true;
      immunityCountries = immunityCountries.filter(x => x !== c);
      usedSpecialCountries.push(c);
      remainingCountries = remainingCountries.filter(x => x !== c);
      delete assignedCountries[c];
      notify(`âœ… ${attacker} Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø­ØµØ§Ù†Ø©`);
      logEvent(`Ø­ØµØ§Ù†Ø© Ø¥Ù„Ù‰ ${attacker}`);
      renderCountries(); renderPlayers(); updateScoreboard();
    }
    else if (reviveCountries.includes(c)) {
      reviveCountries = reviveCountries.filter(x => x !== c);
      usedSpecialCountries.push(c);
      remainingCountries = remainingCountries.filter(x => x !== c);
      delete assignedCountries[c];
      lastReviver = attacker;
      notify(`â™»ï¸ ${attacker} ÙŠÙ‚Ø¯Ø± ÙŠØ¹ÙŠØ¯ Ù„Ø§Ø¹Ø¨: !Ø§Ø¹Ø§Ø¯Ù‡ @Ø§Ù„Ø§Ø³Ù…`);
      logEvent(`ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¹Ø§Ø¯Ø© Ø­ØµÙ„ Ø¹Ù„ÙŠÙ‡Ø§ ${attacker}`);
      renderCountries();
    }
    else if (victim && attacker === victim) {
      remainingCountries = remainingCountries.filter(x => x !== c);
      delete assignedCountries[c];
      const index = players.indexOf(victim);
      if (index !== -1) players.splice(index, 1);
      delete playerColors[victim];
      eliminatedPlayers.push(victim);
      eliminatedData.push({ country: c, player: victim });
      notify(`âŒ ${victim} Ø£Ù‚ØµÙ‰ Ù†ÙØ³Ù‡`);
      logEvent(`${victim} Ø£Ù‚ØµÙ‰ Ù†ÙØ³Ù‡ Ù…Ù† ${c}`);
      renderPlayers(); renderCountries(); updateEliminatedDisplay(); updateScoreboard();
    }
    else if (victim && attacker !== victim) {
      remainingCountries = remainingCountries.filter(x => x !== c);
      delete assignedCountries[c];
      const index = players.indexOf(victim);
      if (index !== -1) players.splice(index, 1);
      delete playerColors[victim];
      eliminatedPlayers.push(victim);
      eliminatedData.push({ country: c, player: victim });
      notify(`âŒ ØªÙ… Ø¥Ù‚ØµØ§Ø¡ ${victim} Ù…Ù† ${c}`);
      logEvent(`${attacker} Ø£Ù‚ØµÙ‰ ${victim} Ù…Ù† ${c}`);
      renderPlayers(); renderCountries(); updateEliminatedDisplay(); updateScoreboard();
    }

    saveState();
    document.getElementById("currentTurnDisplay").innerText = `âœ¨ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù†: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±`;
  }, 900);
}

/* =========================
   Ø£Ø¹Ù„Ø§Ù…
   ========================= */
function getCountryCode(n) {
  const codes = { "Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©":"sa","Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª":"ae","Ù‚Ø·Ø±":"qa","Ù…ØµØ±":"eg","Ø§Ù„Ø£Ø±Ø¯Ù†":"jo","Ù„Ø¨Ù†Ø§Ù†":"lb","Ø§Ù„Ø¹Ø±Ø§Ù‚":"iq","Ø§Ù„ÙƒÙˆÙŠØª":"kw","Ø¹Ù…Ø§Ù†":"om","Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†":"bh","ØªÙˆÙ†Ø³":"tn","Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±":"dz","Ø§Ù„Ù…ØºØ±Ø¨":"ma","Ù„ÙŠØ¨ÙŠØ§":"ly","Ø§Ù„Ø³ÙˆØ¯Ø§Ù†":"sd","Ø§Ù„ÙŠÙ…Ù†":"ye","Ø³ÙˆØ±ÙŠØ§":"sy","ÙÙ„Ø³Ø·ÙŠÙ†":"ps","ØªØ±ÙƒÙŠØ§":"tr","Ø¥ÙŠØ±Ø§Ù†":"ir","Ø£Ù„Ù…Ø§Ù†ÙŠØ§":"de","ÙØ±Ù†Ø³Ø§":"fr","Ø¥ÙŠØ·Ø§Ù„ÙŠØ§":"it","Ø¥Ø³Ø¨Ø§Ù†ÙŠØ§":"es","Ø£Ù…Ø±ÙŠÙƒØ§":"us","ÙƒÙ†Ø¯Ø§":"ca","Ø±ÙˆØ³ÙŠØ§":"ru","Ø§Ù„ØµÙŠÙ†":"cn","Ø§Ù„ÙŠØ§Ø¨Ø§Ù†":"jp","Ø§Ù„Ù‡Ù†Ø¯":"in" };
  return codes[n] || "un";
}

/* =========================
   Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø§Øª
   ========================= */
function connectChat() {
  const plat = document.getElementById("platformSelect").value;
  const channel = document.getElementById("channelInput").value.trim();
  if (!channel) { toast("âš ï¸ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹"); return; }

  if (plat === "twitch") {
    const client = new tmi.Client({ channels: [channel] });
    client.connect();
    client.on("message", (ch, tags, msg, self) => {
      if (self) return;
      const user = tags["display-name"] || tags["username"] || "";
      const color = tags["color"] || null;
      const content = (msg||"").trim();

      if (!isGameStarted && content === "!Ø¯Ø®ÙˆÙ„") addPlayer(user, color);
      if (content === "!Ø®Ø±ÙˆØ¬") removePlayer(user);

      if (isGameStarted && currentTurnPlayer && user === currentTurnPlayer && countriesPool.includes(content)) {
        if (remainingCountries.includes(content)) attackCountry(content);
      }

      if ((content.startsWith("!Ø§Ø¹Ø§Ø¯Ù‡") || content.startsWith("!Ø¥Ø¹Ø§Ø¯Ù‡")) && user === lastReviver) {
        const mentioned = content.split("@")[1]?.trim();
        if (mentioned) reviveByName(mentioned);
      }
    });
    document.getElementById("chatStatus").innerText = "âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€Twitch!";
  }

  else if (plat === "kick") {
    fetch(`https://kick.com/api/v2/channels/${channel}`)
      .then(res => res.json())
      .then(data => {
        const roomId = data.chatroom.id;
        const socket = new WebSocket("wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=8.4.0-rc2");
        socket.onopen = () => {
          socket.send(JSON.stringify({ event: "pusher:subscribe", data: { auth: "", channel: `chatrooms.${roomId}.v2` } }));
          setInterval(() => {
            if (socket.readyState === WebSocket.OPEN)
              socket.send(JSON.stringify({ event: "pusher:ping", data: {} }));
          }, 12000);
        };
        socket.onmessage = (e) => {
          const msg = JSON.parse(e.data);
          if (msg.event === "App\\Events\\ChatMessageEvent") {
            const d = JSON.parse(msg.data);
            const user = d.sender.username;
            const content = (d.content || "").trim();

            if (!isGameStarted && content === "!Ø¯Ø®ÙˆÙ„") addPlayer(user);
            if (content === "!Ø®Ø±ÙˆØ¬") removePlayer(user);

            if (isGameStarted && currentTurnPlayer && user === currentTurnPlayer && countriesPool.includes(content)) {
              if (remainingCountries.includes(content)) attackCountry(content);
            }

            if ((content.startsWith("!Ø§Ø¹Ø§Ø¯Ù‡") || content.startsWith("!Ø¥Ø¹Ø§Ø¯Ù‡")) && user === lastReviver) {
              const mentioned = content.split("@")[1]?.trim();
              if (mentioned) reviveByName(mentioned);
            }
          }
        };
        document.getElementById("chatStatus").innerText = "âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€Kick!";
      })
      .catch(err => {
        console.error("Kick connection error:", err);
        document.getElementById("chatStatus").innerText = "âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€Kick!";
      });
  }
}

/* =========================
   Ù„ÙˆØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
   ========================= */
function updateScoreboard(){
  const counts = {};
  for (const c of Object.keys(assignedCountries)){
    const p = assignedCountries[c];
    if (p) counts[p] = (counts[p]||0) + 1;
  }
  const tbody = document.querySelector('#scoreTable tbody');
  tbody.innerHTML = players.map(p=>{
    const n = counts[p]||0;
    const hasImmunity = !!playerImmunity[p];
    return `<tr>
      <td>${p}</td>
      <td>${n}</td>
      <td>${hasImmunity ? '<span class="ok-icon">ğŸ›¡ï¸</span>' : '-'}</td>
    </tr>`;
  }).join('');
}

/* =========================
   Ù…Ø¤Ù‚Øª Ø§Ù„Ø¬ÙˆÙ„Ø©
   ========================= */
function resetRoundTimerSelect(){
  const sel = document.getElementById('roundSelect');
  roundLeft = parseInt(sel.value)||0;
  document.getElementById('roundTimeText').textContent = roundLeft ? `â€” ${formatM(roundLeft)}` : 'â€” ØºÙŠØ± Ù†Ø´Ø·';
}
function startRoundTimer(){
  stopRoundTimer();
  roundLeft = parseInt(document.getElementById('roundSelect').value)||0;
  if (!roundLeft){ notify("â³ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¤Ù‚Øª Ù…Ø­Ø¯Ø¯"); return; }
  document.getElementById('roundTimeText').textContent = `â€” ${formatM(roundLeft)}`;
  roundTimerId = setInterval(()=>{
    roundLeft--;
    document.getElementById('roundTimeText').textContent = `â€” ${formatM(roundLeft)}`;
    if (roundLeft<=0){
      stopRoundTimer();
      notify("ğŸ Ø§Ù†ØªÙ‡Ù‰ Ø²Ù…Ù† Ø§Ù„Ø¬ÙˆÙ„Ø© â€” Ø³Ù†Ø¹Ù„Ù† Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø¨Ù‚Ø§Ø¡/Ø£ÙƒØ«Ø± Ø¯ÙˆÙ„");
      endRound(true);
    }
  },1000);
}
function stopRoundTimer(){
  if (roundTimerId){ clearInterval(roundTimerId); roundTimerId=null; }
}
function formatM(sec){
  const m = Math.floor(sec/60), s = sec%60;
  return `${m}:${String(s).padStart(2,'0')}`;
}

/* =========================
   Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© ÙˆØ¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙØ§Ø¦Ø²
   ========================= */
function endRound(auto=false){
  const counts = {};
  for (const c of Object.keys(assignedCountries)){
    const p = assignedCountries[c];
    if (p) counts[p] = (counts[p]||0) + 1;
  }
  let best = [], max = -1;
  players.forEach(p=>{
    const n = counts[p]||0;
    if (n>max){ max=n; best=[p]; }
    else if (n===max){ best.push(p); }
  });
  let msg = "";
  if (players.length===1){
    msg = `ğŸ† Ø§Ù„ÙØ§Ø¦Ø²: ${players[0]} â€” Ø¢Ø®Ø± Ù„Ø§Ø¹Ø¨ Ø¨Ø§Ù‚Ù`;
  }else if (best.length===1){
    msg = `ğŸ† Ø§Ù„ÙØ§Ø¦Ø²: ${best[0]} â€” Ø¨Ø£ÙƒØ¨Ø± Ø¹Ø¯Ø¯ Ø¯ÙˆÙ„ (${max})`;
  }else{
    msg = `ğŸ¤ ØªØ¹Ø§Ø¯Ù„ Ø¨ÙŠÙ†: ${best.join('ØŒ ')} â€” (${max})`;
  }
  toast(msg, 3500);
  logEvent(msg);
}

/* =========================
   Ø§Ù„Ø­ÙØ¸
   ========================= */
function saveState(){
  const state = {
    players, playerColors, currentTurnPlayer,
    assignedCountries, remainingCountries,
    immunityCountries, reviveCountries, usedSpecialCountries,
    playerImmunity, eliminatedPlayers, lastReviver,
    isGameStarted, eliminatedData, joinLocked, eventLog
  };
  localStorage.setItem("war_states_v3", JSON.stringify(state));
  notify("ğŸ’¾ ØªÙ… Ø§Ù„Ø­ÙØ¸", 900);
}
function loadState(){
  const raw = localStorage.getItem("war_states_v3");
  if (!raw) { toast("â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­ÙØ¸ Ø³Ø§Ø¨Ù‚"); return; }
  try{
    const s = JSON.parse(raw);
    players = s.players || [];
    playerColors = s.playerColors || {};
    currentTurnPlayer = s.currentTurnPlayer || "";
    assignedCountries = s.assignedCountries || {};
    remainingCountries = s.remainingCountries || [];
    immunityCountries = s.immunityCountries || [];
    reviveCountries = s.reviveCountries || [];
    usedSpecialCountries = s.usedSpecialCountries || [];
    playerImmunity = s.playerImmunity || {};
    eliminatedPlayers = s.eliminatedPlayers || [];
    lastReviver = s.lastReviver || "";
    isGameStarted = !!s.isGameStarted;
    eliminatedData = s.eliminatedData || [];
    joinLocked = !!s.joinLocked;
    eventLog = s.eventLog || [];

    renderCountries(); renderPlayers(); updateEliminatedDisplay(); updateScoreboard();
    document.getElementById("eventLog").innerHTML = eventLog.map(e=>`<div>${e}</div>`).join('');
    document.getElementById("currentTurnDisplay").innerText = `âœ¨ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù†: ${currentTurnPlayer || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}`;
    notify("ğŸ“¥ ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ø§Ù„Ø©");
  }catch(e){
    console.error(e);
    toast("âš ï¸ Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹");
  }
}
function clearSavedState(){
  localStorage.removeItem("war_states_v3");
  notify("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­ÙØ¸", 900);
}

/* =========================
   Ø«ÙŠÙ…
   ========================= */
function toggleTheme(){
  const isLight = document.documentElement.getAttribute('data-theme') === 'light';
  document.documentElement.setAttribute('data-theme', isLight ? 'dark' : 'light');
  notify(isLight ? "ğŸŒ™ Ø«ÙŠÙ… ØºØ§Ù…Ù‚" : "â˜€ï¸ Ø«ÙŠÙ… ÙØ§ØªØ­");
}

/* =========================
   ØªÙ‡ÙŠØ¦Ø©
   ========================= */
function resetGame(){
  if (turnTimerId) clearInterval(turnTimerId);
  if (roundTimerId) clearInterval(roundTimerId);
  players = []; playerColors = {}; currentTurnPlayer = "";
  assignedCountries = {}; remainingCountries = [];
  immunityCountries = []; reviveCountries = []; usedSpecialCountries = [];
  playerImmunity = {}; eliminatedPlayers = []; lastReviver = "";
  isGameStarted = false; eliminatedData = []; joinLocked = false; eventLog = [];
  renderPlayers(); renderCountries(); updateEliminatedDisplay(); updateScoreboard();
  document.getElementById("eventLog").innerHTML = "";
  document.getElementById("currentTurnDisplay").innerText = `âœ¨ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù†: Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯`;
  notify("â†º ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©");
}
function init(){
  document.documentElement.setAttribute('data-theme', 'dark');
  resetRoundTimerSelect();
}
init();
</script>
</body>
</html>
