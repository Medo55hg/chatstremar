<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>🎯 تركيب الكلمات</title>
  <link rel="stylesheet" href="style.css">
  <script src="tmi.min.js"></script>
  <style>
   body { background: #111; color: #fff; font-family: 'Cairo', sans-serif; text-align: center; padding: 20px; }
    h1 { color: #ff3333; margin-top: 10px; }
    .teams-container { display: flex; justify-content: center; align-items: flex-start; margin: 40px auto; width: 100%; gap: 40px; flex-wrap: wrap; }
    .team { width: 250px; padding: 15px; border-radius: 15px; text-align: center; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
    .team-blue { background-color: #0b0f2e; border: 2px solid #0099ff; }
    .team-red { background-color: #2e0b0b; border: 2px solid #ff3333; }
    .players-list { background: #333; padding: 10px; border-radius: 8px; min-height: 50px; font-size: 18px; text-align: right; color: #fff; }
    .player-entry { display: flex; justify-content: space-between; align-items: center; margin: 2px 0; }
    .player-input { width: 90%; padding: 10px; font-size: 16px; margin: 10px 0; border-radius: 8px; border: none; background: #3a3a3a; color: #ccc; text-align: center; }
    .add-btn { background-color: #cc0000; color: white; padding: 8px 16px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-bottom: 10px; }
    .add-btn span { color: #00ccff; font-weight: bold; margin-right: 5px; }
    .game-description { flex: 1; max-width: 500px; background: #222; border: 1px solid #888; border-radius: 10px; padding: 20px; font-size: 18px; line-height: 1.8; }
    .game-description strong { color: #00ff99; }
    .commands-highlight { color: #ff3333; font-weight: bold; margin-top: 10px; display: block; }
    .commands-highlight .blue { color: #0099ff; }
    .commands-highlight .red { color: #ff4444; }
    button { padding: 10px 20px; font-size: 18px; background: #444; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 5px; }
    button:hover { background: #555; }
    .game-box { margin-top: 40px; max-width: 800px; margin-inline: auto; border-radius: 15px; padding: 30px 20px; }
    .team-turn-blue { background: rgba(0, 60, 120, 0.3); border: 2px solid #0099ff; }
    .team-turn-red { background: rgba(120, 0, 0, 0.3); border: 2px solid #ff3333; }
    .letter-used { background-color: #27ae60 !important; border-color: #1e8449 !important; }
    .word-point { color: #f1c40f; font-weight: bold; }
    .score-table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    .score-table th, .score-table td { padding: 10px; border: 1px solid #444; text-align: center; }
    .score-table th { background-color: #333; }
    .score-table tr:nth-child(even) { background-color: #222; }
    .score-table tr:hover { background-color: #2a2a2a; }
  </style>
</head>
<body>
  <h1>🎯 تركيب الكلمات</h1>

  <div class="teams-container">
    <div class="team team-blue">
      <h3>🔵 الفريق الأزرق</h3>
      <input type="text" id="bluePlayerInput" class="player-input" placeholder="اسم اللاعب">
      <button class="add-btn" onclick="addPlayerFromInput('blue')"><span>+</span>إضافة</button>
      <div id="bluePlayers" class="players-list"></div>
    </div>

    <div class="game-description">
      ✅ <strong>شرح اللعبة:</strong><br>
      ستظهر مجموعة من الحروف في منتصف الشاشة.<br>
      على الفريق تركيب أكبر عدد ممكن من الكلمات الصحيحة خلال 5 دقائق.<br>
      كل كلمة = 1 نقطة 🏆<br>
      الفائز هو من يجمع أكثر نقاط!<br>
      <span class="commands-highlight">
        📄 أوامر الشات:<br>
        <span class="blue">🔵 !ازرق</span> للانضمام للفريق الأزرق<br>
        <span class="red">🔴 !احمر</span> للانضمام للفريق الأحمر
      </span>
      
      <table class="score-table">
        <thead>
          <tr>
            <th>الجولة</th>
            <th>الفريق الأزرق</th>
            <th>الفريق الأحمر</th>
          </tr>
        </thead>
        <tbody id="scoreTableBody">
          <!-- سيتم ملؤه بالجافاسكريبت -->
        </tbody>
        <tfoot>
          <tr>
            <th>المجموع</th>
            <th id="blueTotalScore">0</th>
            <th id="redTotalScore">0</th>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="team team-red">
      <h3>🔴 الفريق الأحمر</h3>
      <input type="text" id="redPlayerInput" class="player-input" placeholder="اسم اللاعب">
      <button class="add-btn" onclick="addPlayerFromInput('red')"><span>+</span>إضافة</button>
      <div id="redPlayers" class="players-list"></div>
    </div>
  </div>

  <div id="gameBox" class="game-box">
    <div class="info">
      <div class="category" id="category" style="font-size: 26px; font-weight: bold; margin-bottom: 10px;">الفئة: ...</div>
      <div class="timer" id="timer" style="font-size: 24px; color: #ffcc00; font-weight: bold;">الوقت: 5:00</div>
      <div id="currentTeam" style="font-size: 20px; margin-top: 10px;">الدور: لا أحد</div>
      <div id="pointsInfo" style="font-size: 18px; margin-top: 5px; color: #f1c40f;"></div>
    </div>

    <div class="controls" style="margin: 20px 0;">
      <button onclick="startRound()">🎮 ابدأ الجولة</button>
      <button onclick="resetGame()">🔄 إعادة تعيين</button>
    </div>

    <div class="letters" id="letters" style="display: flex; flex-wrap: wrap; justify-content: center; max-width: 600px; margin: 0 auto; gap: 8px;"></div>
    <div class="words-found" id="wordsFound" style="margin-top: 20px; max-width: 400px; margin-inline: auto; text-align: right;"></div>
  </div>

  <div style="margin-top: 40px;">
    <h2>🛠️ ربط اللعبة بالشات</h2>
    <select id="platformSelect" style="padding:10px;font-size:18px;">
      <option value="twitch">Twitch</option>
      <option value="kick">Kick</option>
    </select>
    <input type="text" id="channelInput" placeholder="🎮 اكتب اسم القناة" style="padding:10px;font-size:18px;">
    <button onclick="connectChat()" style="padding:10px;font-size:18px;background:#28a745;color:#fff;border:none;border-radius:6px;cursor:pointer;">
      ✅ تسجيل الدخول
    </button>
    <div id="chatStatus" style="margin-top:10px;font-size:16px;color:#0f0;"></div>
  </div>

<script>
// حالة اللعبة
let bluePlayers = [];
let redPlayers = [];
let currentTeam = '';
let currentTeamIndex = 0;
let roundTimer;
let secondsLeft = 300;
let foundWords = [];
let roundWords = [];
let roundLetters = [];
let availableLetters = [];
let chatClient = null;
let kickSocket = null;
let totalPoints = 0;
let roundScores = []; // لتخزين نتائج الجولات

// فئات الكلمات
const allCategories = {
  "حيوانات": [
    "أسد", "نمر", "فهد", "ذئب", "دب", 
    "زرافة", "فيل", "غوريلا", "شمبانزي", "كنغر",
    "كوالا", "باندا", "ثعلب", "راكون", "حصان",
    "بقرة", "خروف", "ماعز", "جمل", "غزال",
    "نسر", "صقر", "بومة", "ببغاء", "نعامة",
    "بطريق", "نقار الخشب", "طاووس", "دجاجة", "بطة",
    "إوزة", "حمامة", "بلبل", "عصفور", "غراب",
    "تمساح", "سلحفاة", "سحلية", "حرباء", "أفعى",
    "ثعبان", "تنين كومودو", "ضب", "سقنقور", "تواتارا",
    "ضفدع", "علجوم", "سمندل", "ضفدع الشجر", "نيوت",
    "قرش", "دلفين", "حوت", "تونة", "سلمون",
    "نجم البحر", "قنديل البحر", "فرس البحر", "شفنين", "سمكة البيرانا",
    "نحلة", "فراشة", "نملة", "جرادة", "عنكبوت",
    "عقرب", "دبور", "ذبابة", "بعوضة", "خنفساء",
    "سرعوف", "صرصور", "بق الفراش", "دودة القز", "يرقة",
    "أخطبوط", "حبار", "سرطان البحر", "جراد البحر", "قنفذ البحر",
    "خيار البحر", "محار", "حلزون البحر", "إسفنج بحري", "مرجان",
    "خفاش", "قندس", "قنفذ", "خلد", "فأر",
    "جرذ", "سنجاب", "أرنب", "هامستر", "ظبي",
    "وحيد القرن", "فرس النهر", "جاموس", "بانغولين", "آكل النمل"
],
  
  "فواكه وخضروات":  [
        "تفاح", "موز", "برتقال", "فراولة", "عنب", "مانجو", "أناناس", "بطيخ", "شمام", "خوخ",
        "مشمش", "كمثرى", "جوافة", "تين", "رمان", "كيوي", "ليمون", "جريب فروت", "توت أسود", "توت أزرق",
        "توت بري", "كرز", "تمر", "بابايا", "جاك فروت", "دراق", "نكتارين", "ماراكويا", "ليتشي", "لونجان",
        "كرامبولا", "سابوتا", "تين شوكي", "مانغوستين", "بوميلو", "يوسفي", "سفرجل", "زعرور", "عناب", "أكي",
        "تاماريلو", "فاكهة التنين", "كاكا", "سيريمويا", "فيجوا", "سابوت الأسود", "كارامبولا", "فاكهة القشطة", "كوبواسو", "فاكهة الليتشي"
        , "خيار", "جزر", "بصل", "ثوم", "بطاطس", "بطاطا حلوة", "فلفل حلو", "فلفل حار", "باذنجان",
        "كوسا", "قرع", "شمندر", "ملفوف", "بروكلي", "قرنبيط", "سبانخ", "خس", "كرفس", "جرجير",
        "بقدونس", "كزبرة", "نعناع", "زنجبيل", "كركم", "فاصوليا خضراء", "بازلاء", "ذرة", "فطر", "زيتون",
        "هليون", "شمر", "بامية", "راديشيو", "كراث", "سلق", "جذور اللوتس", "فجل", "لفت", "كرنب",
        "كرنب بروكسيل", "شمام مر", "خرشوف", "بطاطا أرجوانية", "جذر الشمندر", "كاسافا", "يام", "روكا", "كيل", "ميكروغرين"
    ],
  
  " مدن عربية": [
    "الرياض", "جدة", "مكة المكرمة", "المدينة المنورة", "الدمام", "الخبر", "الطائف", "تبوك", "أبها", "نجران",
    "القاهرة", "الإسكندرية", "الجيزة", "شرم الشيخ", "الأقصر", "أسوان", "بورسعيد", "السويس", "المنصورة", "طنطا",
    "بغداد", "البصرة", "الموصل", "أربيل", "النجف", "كربلاء", "السليمانية", "الناصرية", "العمارة", "الديوانية",
    "الرباط", "الدار البيضاء", "مراكش", "فاس", "طنجة", "أكادير", "مكناس", "وجدة", "تطوان", "العيون",
    "الجزائر", "وهران", "قسنطينة", "عنابة", "باتنة", "بسكرة", "تلمسان", "سطيف", "الجلفة", "سكيكدة",
    "أبوظبي", "دبي", "الشارقة", "عجمان", "رأس الخيمة", "الفجيرة", "العين", "دبا الحصن", "خورفكان", "أم القيوين",
    "الكويت", "الأحمدي", "حولي", "الفروانية", "الجهراء", "مبارك الكبير", "العدان", "الرقة", "الجليعة", "الصليبية",
    "الدوحة", "الريان", "أم صلال", "الخور", "الوكرة", "دخان", "الشمال", "الزبارة", "مسيعيد", "الرويس",
    "مسقط", "صلالة", "نزوى", "صحار", "صور", "عبري", "الرستاق", "البريمي", "السيب", "خصب",
    "عمان", "الزرقاء", "إربد", "العقبة", "مادبا", "السلط", "الكرك", "معان", "الطفيلة", "جرش"
],
  
  " عواصم": [
    "أبو ظبي", "أكرا", "أمستردام", "أنقرة", "أوسلو",
    "أوتاوا", "أثينا", "أستانا", "أشغباد", "بغداد",
    "باكو", "بانكوك", "برلين", "برن", "براغ",
    "برازيليا", "بروكسل", "بوخارست", "بودابست", "بوينس آيرس",
    "بيجين", "بيلغراد", "بورتو نوفو", "براتيسلافا", "بلغراد",
    "بنما سيتي", "بكين", "تالين", "تيرانا", "طوكيو",
    "تونس", "تايبي", "طهران", "تيجوانا", "جاكارتا",
    "جنيف", "جوبا", "جيبوتي", "داكار", "دمشق",
    "دبي", "دوشنبه", "ديلي", "دكار", "دبلن",
    "دهوك", "روما", "رييكا", "ريغا", "رياض",
    "زغرب", "ساراييفو", "ستوكهولم", "سول", "سيول",
    "سنغافورة", "سوفيا", "سانتياغو", "سان سلفادور", "سانتا في",
    "سانت بطرسبرغ", "ساو باولو", "صوفيا", "طشقند", "عمان",
    "غابورون", "غيتغا", "فادوز", "فاليتا", "فيلنيوس",
    "فيينا", "قابس", "قطر", "كابول", "كوالالمبور",
    "كوبنهاغن", "كيجالي", "كييف", "كينشاسا", "لشبونة",
    "لندن", "لوساكا", "ليما", "ليوبليانا", "لواندا",
    "لوكسمبورغ", "مابوتو", "مدريد", "مقديشو", "منروفيا",
    "منامة", "موسكو", "مكسيكو سيتي", "نيروبي", "نيامي",
    "نيودلهي", "نيويورك", "هافانا", "هلسنكي", "هونولولو",
    "وارسو", "واشنطن", "ويلينغتون", "ياوندي", "يريفان"
],

  "ماركات ملابس": [
    "نايكي", "أديداس", "بوما", "جوتشي", "شانيل",
    "لويس فويتون", "برادا", "فيرساتشي", "بالينسياغا", "كالفن كلاين",
    "رالف لورين", "لاكوست", "بربري", "تومي هيلفيغر", "ديور",
    "مايكل كورز", "كينزو", "ألكسندر ماكوين", "أوف وايت", "فيلا",
    "أندر آرمر", "لولليمن", "ريبوك", "سوبريم", "ستوسي",
    "ليفايز", "ديزل", "أرماني", "هوجو بوس", "زارا",
    "إتش آند إم", "يونيكلو", "غاب", "أولد نافي", "بانانا ريبابليك",
    "هولستر", "فوريفر 21", "أمبرو", "بول أند بير", "أميريكان إيجل",
    "هولاند", "سوبر دراي", "كارهارت", "ذا نورث فيس", "باتاغونيا",
    "ستون آيلاند", "فيكتوريا سيكريت", "واربي باركر", "ألين أندرو", "بروكس براذرز"
],
  
 " اسماء اولاد": [
    "محمد", "أحمد", "علي", "عمر", "خالد",
    "محمود", "يوسف", "إبراهيم", "مصطفى", "حسن",
    "حسين", "أيمن", "أمير", "باسل", "جمال",
    "رامي", "سامي", "طارق", "وسام", "ياسين",
    "أنس", "بدر", "تامر", "ثائر", "جلال",
    "خليل", "راشد", "سعيد", "شادي", "صلاح",
    "عبد الله", "عثمان", "فارس", "كريم", "لؤي",
    "مازن", "نبيل", "هاشم", "وائل", "يحيى",
    "زياد", "سالم", "شريف", "عدنان", "فهد",
    "ماجد", "ناصر", "هاني", "وليد", "يونس",
    "أسامة", "بكر", "توفيق", "حازم", "خضر",
    "رائد", "سلمان", "شاكر", "عبد الرحمن", "فادي",
    "مروان", "نور", "هادي", "وجدي", "ياسمين",
    "أكرم", "بشير", "تمام", "حسام", "خلف",
    "رامز", "سعد", "شهاب", "عبد العزيز", "فاروق",
    "مشعل", "نبيل", "هيثم", "وسيم", "يافا",
    "أدهم", "بلال", "صالح", "حمد", "خالد",
    "رافع", "سفيان", "شوقي", "عبد الكريم", "فوزي",
    "معاذ", "نادر", "هلال", "واصف", "ياسر"
],

 " اسماء بنات": [
    "فاطمة", "خديجة", "عائشة", "مريم", "سارة", "آمنة", "زينب", "هاجر", "نور", "ليلى",
    "تالا", "يارا", "لونا", "جنى", "ميار", "راما", "لين", "ميس", "ريناد", "دانا",
    "ريحانة", "ياسمين", "زهرة", "غادة", "ورد", "نرجس", "سندس", "كادي", "سلسبيل", "أزهار",
    "أمل", "إيمان", "تقوى", "هدى", "صفاء", "وفاء", "رحمة", "إحسان", "نهى", "سجى",
    "عبير", "أثير", "بتول", "جمانة", "حور", "ديمة", "رغد", "سيلين", "شهد", "ضحى",
    "فرح", "لوجين", "ملاك", "نورين", "هند", "آية", "بشرى", "حلا", "راما", "سلمى",
    "شيماء", "عروب", "غنى", "لمى", "مها", "نادية", "هبة", "آلاء", "بلقيس", "حياة",
    "رين", "سارة", "شذى", "علياء", "فجر", "لارا", "مروة", "نزهة", "هناء", "إيناس",
    "بيسان", "حبيبة", "رانية", "سما", "شروق", "عنود", "فوزية", "لمياء", "منى", "نورا",
    "هيا", "إيلاف", "باهرة", "حنين", "رينيه", "سحر", "شمس", "غزل", "لينا", "ميار"
],

  "سيارات": [
    "تويوتا", "نيسان", "هوندا", "مازدا", "سوبارو",
    "ميتسوبيشي", "سوزوكي", "ليكسوس", "أكورا", "إنفينيتي",
    "مرسيدس بنز", "بي إم دبليو", "أودي", "فولكس فاجن", "بورش",
    "أوبل", "مايباخ", "سمارت", "مان", "فورد",
    "شيفروليه", "جيب", "دودج", "كرايسلر", "تيسلا",
    "كاديلاك", "بويك", "لينكولن", "رام", "هيونداي",
    "كيا", "جنيسيس", "سانج يونج", "دايو", "فيراري",
    "لامبورغيني", "مازيراتي", "ألفا روميو", "فيات", "لانشيا",
    "باجاني", "داتسون", "إيفو", "رينو", "بيجو",
    "سيتروين", "بوغاتي", "دي إس", "رولز رويس", "بنتلي",
    "أستون مارتن", "جاغوار", "لاند روفر", "ميني", "ماكلارين",
    "لوتس", "مورجان", "فوكسهول", "فولفو", "كوبينج",
    "ساب", "سكودا", "سبايكر", "هولدن", "تاتا موتورز",
    "ماهيندرا", "جيلي", "بي واي دي", "جاك", "شيري",
    "هافال", "سايك", "جريت وول", "دونج فينج", "ليفان",
    "زوتي", "لادا", "غاز", "فاز", "أورال",
    "كاماز", "بروتون", "برلييت", "كابنيك", "فوتون",
    "تشانجان", "فيات كرايسلر", "ميتسوكا", "تاترا", "زينورو",
    "سيكويا", "فينيكس", "يونيك", "فارمونت", "زيسيس",
    "فيسكر", "لوسيد موتورز", "ريفين", "بولستار", "أسبارك",
    "ماها", "فاو", "جاكوار لاند روفر", "دينالي"
]
};

// بدء الجولة
function startRound() {
  // تحديد الفريق الحالي
  currentTeam = currentTeamIndex % 2 === 0 ? 'blue' : 'red';
  currentTeamIndex++;
  
  // تحديث واجهة المستخدم
  document.getElementById('currentTeam').textContent = currentTeam === 'blue' ? '🔵 الفريق الأزرق' : '🔴 الفريق الأحمر';
  document.getElementById('gameBox').className = currentTeam === 'blue' ? 'game-box team-turn-blue' : 'game-box team-turn-red';
  
  // إعادة تعيين حالة الجولة
  foundWords = [];
  totalPoints = 0;
  document.getElementById('wordsFound').innerHTML = '';
  document.getElementById('pointsInfo').textContent = '';
  secondsLeft = 300;
  updateTimer();
  clearInterval(roundTimer);
  
  // توليد الحروف والكلمات
  generateRoundWords();
  showLetters();
  
  // بدء المؤقت
  roundTimer = setInterval(() => {
    secondsLeft--;
    updateTimer();
    if (secondsLeft <= 0) {
      endRound();
    }
  }, 1000);
}

// توليد كلمات الجولة
function generateRoundWords() {
  const categories = Object.keys(allCategories);
  const randomCategory = categories[Math.floor(Math.random() * categories.length)];
  const wordList = [...allCategories[randomCategory]];
  shuffleArray(wordList);
  
  // اختيار 7 كلمات عشوائية من الفئة
  roundWords = wordList.slice(0, 7);
  document.getElementById('category').textContent = `الفئة: ${randomCategory}`;
  
  // توليد الحروف من الكلمات المختارة (مع التكرار)
  roundLetters = [];
  roundWords.forEach(word => {
    roundLetters.push(...word.split(''));
  });
  availableLetters = [...roundLetters];
  shuffleArray(roundLetters);
}

// عرض الحروف
function showLetters() {
  const container = document.getElementById('letters');
  container.innerHTML = '';
  
  roundLetters.forEach((ch, index) => {
    const div = document.createElement('div');
    div.className = 'letter';
    div.id = `letter-${index}`;
    div.textContent = ch;
    div.style = `
      width: 60px; height: 60px; 
      margin: 0; font-size: 24px; 
      font-weight: bold; border-radius: 12px; 
      background-color: #1a1a1a; 
      display: flex; align-items: center; 
      justify-content: center; 
      border: 2px solid #333; 
      color: #fff;
    `;
    container.appendChild(div);
  });
}

// تحديث المؤقت
function updateTimer() {
  const min = Math.floor(secondsLeft / 60);
  const sec = secondsLeft % 60;
  document.getElementById('timer').textContent = `الوقت: ${min}:${sec.toString().padStart(2, '0')}`;
}


// نهاية الجولة
function endRound() {
  clearInterval(roundTimer);
  
  // حساب النقاط النهائية
  const wordPoints = foundWords.length;
  totalPoints = wordPoints;
  
  document.getElementById('pointsInfo').textContent = `النقاط: ${wordPoints}`;
  document.getElementById('gameBox').className = 'game-box';
  document.getElementById('currentTeam').textContent = 'الدور: لا أحد';
  
  // إخفاء الحروف غير المستخدمة
  const letters = document.querySelectorAll('.letter');
  letters.forEach(letter => {
    if (!letter.classList.contains('letter-used')) {
      letter.style.visibility = 'hidden';
    }
  });
  
  // عرض الكلمات التي كان يجب تخمينها
  showMissedWords();
  
  // تحديث جدول النقاط
  updateScoreTable(wordPoints);
}

// عرض الكلمات التي لم يتم تخمينها
function showMissedWords() {
  const missedWords = roundWords.filter(word => !foundWords.includes(word));
  
  if (missedWords.length > 0) {
    const missedWordsContainer = document.createElement('div');
    missedWordsContainer.style.marginTop = '20px';
    missedWordsContainer.style.padding = '15px';
    missedWordsContainer.style.backgroundColor = '#2d2d2d';
    missedWordsContainer.style.borderRadius = '10px';
    missedWordsContainer.style.border = '1px solid #444';
    
    const title = document.createElement('div');
    title.textContent = 'الكلمات التي لم يتم العثور عليها:';
    title.style.fontWeight = 'bold';
    title.style.marginBottom = '10px';
    title.style.color = '#ff6666';
    
    const wordsList = document.createElement('div');
    wordsList.style.textAlign = 'right';
    wordsList.style.lineHeight = '1.8';
    
    missedWords.forEach(word => {
      const wordElement = document.createElement('div');
      wordElement.textContent = `• ${word}`;
      wordsList.appendChild(wordElement);
    });
    
    missedWordsContainer.appendChild(title);
    missedWordsContainer.appendChild(wordsList);
    
    // إضافة العنصر بعد قائمة الكلمات التي تم العثور عليها
    const wordsFoundContainer = document.getElementById('wordsFound');
    wordsFoundContainer.appendChild(missedWordsContainer);
  }
  
  const tableBody = document.getElementById('scoreTableBody');
  tableBody.innerHTML = '';
  
  roundScores.forEach(score => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${score.round}</td>
      <td>${score.blue}</td>
      <td>${score.red}</td>
    `;
    tableBody.appendChild(row);
  });
  
  // حساب المجموع الكلي
  const blueTotal = roundScores.reduce((sum, score) => sum + score.blue, 0);
  const redTotal = roundScores.reduce((sum, score) => sum + score.red, 0);
  
  document.getElementById('blueTotalScore').textContent = blueTotal;
  document.getElementById('redTotalScore').textContent = redTotal;
}

// معالجة رسائل الشات
function onChatMessage(username, message) {
  if (!currentTeam || foundWords.length >= roundWords.length) return;
  
  // التحقق من أن اللاعب مسجل في الفريق الحالي
  const currentTeamPlayers = currentTeam === 'blue' ? bluePlayers : redPlayers;
  if (!currentTeamPlayers.includes(username)) return;
  
  const clean = message.trim();
  
  // التحقق من صحة الكلمة
  if (roundWords.includes(clean) && !foundWords.includes(clean)) {
    if (canFormWord(clean)) {
      foundWords.push(clean);
      markLetters(clean);
      
      // حساب النقاط
      const wordPoints = 1;
      totalPoints = wordPoints;
      
      document.getElementById('wordsFound').innerHTML += `
        <div style='
          background: #1f1f1f;
          padding: 8px 12px;
          border-radius: 8px;
          margin-bottom: 6px;
          border: 1px solid #333;
        '>
          ✅ ${clean} - ${username} 
          <span class="word-point">(${wordPoints} نقطة)</span>
        </div>
      `;
      
      // التحقق إذا تم العثور على جميع الكلمات
      if (foundWords.length === roundWords.length) {
        endRound();
      }
    }
  }
}

// التحقق إذا كان يمكن تكوين الكلمة من الحروف المتاحة
function canFormWord(word) {
  const tempAvailableLetters = [...availableLetters];
  const wordLetters = word.split('');
  
  for (const letter of wordLetters) {
    const index = tempAvailableLetters.indexOf(letter);
    if (index === -1) return false;
    tempAvailableLetters.splice(index, 1);
  }
  
  return true;
}

// تمييز الحروف المستخدمة
function markLetters(word) {
  const wordLetters = word.split('');
  const lettersToMark = [...wordLetters];
  
  // تحديث الحروف المتاحة
  for (const letter of wordLetters) {
    const index = availableLetters.indexOf(letter);
    if (index !== -1) {
      availableLetters.splice(index, 1);
    }
  }
  
  // تمييز الحروف في الواجهة
  const letters = document.querySelectorAll('.letter');
  letters.forEach(letter => {
    if (lettersToMark.includes(letter.textContent) && !letter.classList.contains('letter-used')) {
      letter.classList.add('letter-used');
      lettersToMark.splice(lettersToMark.indexOf(letter.textContent), 1);
    }
  });
}

// إضافة لاعب من واجهة المستخدم
function addPlayerFromInput(team) {
  const inputId = team === 'blue' ? 'bluePlayerInput' : 'redPlayerInput';
  const username = document.getElementById(inputId).value.trim();
  
  if (username) {
    addPlayerFromChat(team, username);
    document.getElementById(inputId).value = '';
  }
}

// إضافة لاعب من الشات
function addPlayerFromChat(team, username) {
  const listId = team === 'blue' ? 'bluePlayers' : 'redPlayers';
  const players = team === 'blue' ? bluePlayers : redPlayers;
  const otherTeamPlayers = team === 'blue' ? redPlayers : bluePlayers;

  // التحقق من عدم وجود اللاعب في أي فريق
  if (username && !players.includes(username) && !otherTeamPlayers.includes(username)) {
    players.push(username);
    updatePlayersList(team);
  }
}

// تحديث قائمة اللاعبين
function updatePlayersList(team) {
  const listId = team === 'blue' ? 'bluePlayers' : 'redPlayers';
  const players = team === 'blue' ? bluePlayers : redPlayers;
  const container = document.getElementById(listId);
  
  container.innerHTML = '';
  players.forEach(player => {
    const entry = document.createElement('div');
    entry.className = 'player-entry';
    entry.innerHTML = `<span>• ${player}</span>`;
    container.appendChild(entry);
  });
}

// خلط المصفوفة
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

// إعادة تعيين اللعبة
function resetGame() {
  clearInterval(roundTimer);
  bluePlayers = [];
  redPlayers = [];
  currentTeam = '';
  currentTeamIndex = 0;
  foundWords = [];
  roundWords = [];
  roundLetters = [];
  availableLetters = [];
  totalPoints = 0;
  roundScores = [];
  
  document.getElementById('bluePlayers').innerHTML = '';
  document.getElementById('redPlayers').innerHTML = '';
  document.getElementById('letters').innerHTML = '';
  document.getElementById('wordsFound').innerHTML = '';
  document.getElementById('currentTeam').textContent = 'الدور: لا أحد';
  document.getElementById('timer').textContent = 'الوقت: 5:00';
  document.getElementById('category').textContent = 'الفئة: ...';
  document.getElementById('pointsInfo').textContent = '';
  document.getElementById('gameBox').className = 'game-box';
  document.getElementById('scoreTableBody').innerHTML = '';
  document.getElementById('blueTotalScore').textContent = '0';
  document.getElementById('redTotalScore').textContent = '0';
}

// الاتصال بالشات
function connectChat() {
  const platform = document.getElementById("platformSelect").value;
  const channel = document.getElementById("channelInput").value.trim();

  // إغلاق الاتصالات السابقة
  if (chatClient) chatClient.disconnect();
  if (kickSocket) kickSocket.close();

  if (platform === "twitch") {
    chatClient = new tmi.Client({ 
      channels: [channel],
      connection: {
        reconnect: true,
        secure: true
      }
    });

    chatClient.connect()
      .then(() => {
        document.getElementById("chatStatus").textContent = "✅ تم الاتصال بـ Twitch!";
      })
      .catch(err => {
        console.error("Twitch error:", err);
        document.getElementById("chatStatus").textContent = "❌ فشل الاتصال بـ Twitch!";
      });

    chatClient.on("message", (channel, tags, message, self) => {
      if (self) return;
      const username = tags["display-name"] || tags.username;
      const content = message.trim();

      if (content === "!ازرق") {
        addPlayerFromChat("blue", username);
      } else if (content === "!احمر") {
        addPlayerFromChat("red", username);
      } else {
        onChatMessage(username, content);
      }
    });
  }

  if (platform === "kick") {
    (async () => {
      try {
        const res = await fetch(`https://kick.com/api/v2/channels/${channel}`);
        const data = await res.json();
        const roomId = data.chatroom.id;

        kickSocket = new WebSocket("wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=8.4.0-rc2");

        kickSocket.onopen = () => {
          kickSocket.send(JSON.stringify({
            event: "pusher:subscribe",
            data: {
              auth: "",
              channel: `chatrooms.${roomId}.v2`
            }
          }));
          
          const pingInterval = setInterval(() => {
            if (kickSocket.readyState === WebSocket.OPEN) {
              kickSocket.send(JSON.stringify({ event: "pusher:ping", data: {} }));
            } else {
              clearInterval(pingInterval);
            }
          }, 12000);
        };

        kickSocket.onmessage = (event) => {
          const msg = JSON.parse(event.data);
          if (msg.event === "App\\Events\\ChatMessageEvent") {
            const d = JSON.parse(msg.data);
            const username = d.sender.username;
            const content = d.content.trim();

            if (content === "!ازرق") {
              addPlayerFromChat("blue", username);
            } else if (content === "!احمر") {
              addPlayerFromChat("red", username);
            } else {
              onChatMessage(username, content);
            }
          }
        };

        kickSocket.onclose = () => {
          document.getElementById("chatStatus").textContent = "❌ تم قطع الاتصال بـ Kick!";
        };

        document.getElementById("chatStatus").textContent = "✅ تم الاتصال بـ Kick!";
      } catch (error) {
        console.error("Kick error:", error);
        document.getElementById("chatStatus").textContent = "❌ فشل الاتصال بـ Kick!";
      }
    })();
  }
}
</script>
</body>
</html>


