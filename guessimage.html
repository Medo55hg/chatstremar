<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>๐ผ๏ธ ูุนุจุฉ ุงูุดู ุงูุตูุฑุฉ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <!-- tmi.js ูุชููุชุด -->
  <script src="tmi.min.js"></script>
  <style>
    :root{
      --red:#ff3333; --blue:#00a8ff;
      --panel:#1b2130; --line:#2a3347; --muted:#9fb0d0; --ok:#00d86c;

      /* โ ุฃููุงู ุฎูููุฉ Style2026 */
      --g1:#121629;
      --g2:#0e1322;
    }
    /* (ุงุฎุชูุงุฑู) ูุถุน ูุงุชุญ */
    [data-theme="light"]{
      --g1:#f2f6ff;
      --g2:#dfe9ff;
    }

    *{box-sizing:border-box}
    body{
      margin:0; color:#fff; font-family:'Cairo',sans-serif; padding:18px;

      /* โ ุฎูููุฉ ูุชุญุฑููุฉ + ุชููุฌ ูุทุฑู ุฎููู */
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(255,255,255,.05), transparent 60%),
        radial-gradient(1200px 600px at 90% 90%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(-45deg, var(--g1), var(--g2), var(--g1), var(--g2));
      background-size: 400% 400%;
      animation: gradientBG 22s ease infinite;
    }
    @keyframes gradientBG{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    h1{ color:var(--red); margin:6px 0 14px; letter-spacing:.2px; text-align:center }

    /* ุฒุฑ ุงูุดุฑุญ ุฃุนูู ูุณุงุฑ */
    .help-btn{
      position:fixed; top:18px; left:18px; z-index:10000;
      background:linear-gradient(180deg,#3a445a,#2b3448);
      border:1px solid rgba(255,255,255,.15);
      color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer;
      box-shadow:0 10px 24px rgba(0,0,0,.35); font-size:14px
    }
    .help-btn:active{ transform:translateY(1px) }

    /* ูุงูุฐุฉ ุงูุดุฑุญ */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; z-index:10001;
    }
    .modal{
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      width:min(720px,92vw); max-height:80vh; overflow:auto;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:16px 18px; display:none; z-index:10002;
      box-shadow:0 30px 60px rgba(0,0,0,.45);
    }
    .modal h2{ margin:0 0 8px; color:#fff }
    .modal .x{ position:absolute; top:10px; inset-inline-start:10px; border:1px solid rgba(255,255,255,.15); background:#2b3347; color:#fff; border-radius:8px; padding:6px 10px; cursor:pointer }
    .modal p, .modal li{ line-height:1.7; color:#e8eefc }
    .modal ul{ margin:8px 0 0 0; padding:0 18px }

    /* ุจุทุงูุงุช ุนุงูุฉ */
    .card{ background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); backdrop-filter:blur(8px);
      border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.25) }

    /* ุชุฎุทูุท ุงูุตูุญุฉ ุงูุนุงู: ูุฑู ูููู/ูุณุงุฑ + ุงููุณุฑุญ ุจุงููุณุท */
    .layout{
      display:grid; grid-template-columns: 300px 1fr 300px; gap:14px; align-items:start;
      max-width:1400px; margin:0 auto;
    }

    /* ููุญุงุช ูุงุจูุฉ ููุทู */
    .collapsible{ max-width:1400px; margin:0 auto 12px; overflow:hidden; transition:height .28s ease }
    .collapsible .bar{
      padding:10px 12px; display:flex; align-items:center; gap:10px;
      background:linear-gradient(180deg, rgba(20,24,36,.7), rgba(20,24,36,.55));
      border:1px solid rgba(255,255,255,.12); border-radius:14px;
    }
    .chev{
      width:34px;height:34px;border-radius:10px;border:1px solid rgba(255,255,255,.12);
      display:flex;align-items:center;justify-content:center;background:#232838; cursor:pointer; user-select:none
    }
    .bar-title{ font-weight:700 }
    .bar-status{ margin-inline-start:auto; display:flex; align-items:center; gap:8px }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.gray{background:#777}
    .dot.green{background:#00c07a; box-shadow:0 0 10px #00c07a88}

    .content{ padding:12px; display:none }
    .collapsible.open .content{ display:flex }
    .content.flex{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }

    select,input,button{
      padding:8px 10px; font-size:16px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
      background:#232838; color:#fff; font-family:'Cairo',sans-serif;
    }
    .btn{ background:linear-gradient(180deg, #ff4747, #d73333); border:none; box-shadow:0 6px 18px rgba(255,71,71,.25); cursor:pointer }
    .btn:active{ transform:translateY(1px) }

    /* ุดุฑูุท ุงููุนูููุงุช ููู ุงููุณุฑุญ (ุณุทุฑ ูุงุญุฏ) */
    .top-info{
      max-width:1400px; margin:0 auto 10px; display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap;
    }
    .info-chip{ font-size:16px; background:rgba(0,0,0,.35); padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.06) }

    /* ูุฑูููู ุฌุฏูุฏ (ูุณุงุฑ/ูููู ุงููุณุฑุญ) */
    .team{ padding:12px }
    .team-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px }
    .team-title{ display:flex; align-items:center; gap:10px; font-weight:700 }
    .team-count{ font-size:14px; padding:4px 10px; border-radius:20px; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.08) }
    .players-list{ display:grid; gap:8px; max-height:60vh; overflow:auto; padding-right:4px }
    .player-card{
      display:grid; grid-template-columns:34px 1fr 28px; align-items:center; gap:8px;
      background:rgba(0,0,0,.30); border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:6px 8px
    }
    .slot{ width:34px; height:34px; border-radius:9px; display:flex; align-items:center; justify-content:center; background:#1f2636; border:1px solid rgba(255,255,255,.06); font-weight:700 }
    .player-name{ display:flex; align-items:center; gap:8px; font-size:16px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .badge{ font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.15); background:#233049 }
    .del{ width:24px; height:24px; border-radius:6px; border:1px solid rgba(255,255,255,.12); background:#3a1f26; cursor:pointer }
    .del:hover{ filter:brightness(1.1) }

    /* ุงููุณุฑุญ (ูุฑุจุน ุงููุนุจุฉ) */
    .stage.card{ padding:12px }
    .image-container{ position:relative; width:100%; padding-top:66.66%; margin:12px 0; background:#000; border:1px solid rgba(255,255,255,.08); border-radius:12px; overflow:hidden }
    .image-container::before{ content:""; position:absolute; inset:0; background-image: linear-gradient(#ffffff12 1px, transparent 1px), linear-gradient(90deg, #ffffff12 1px, transparent 1px); background-size:40px 40px; pointer-events:none }
    .image-container img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover }
    .grid{ position:absolute; inset:0; display:grid; grid-template-columns:repeat(12,1fr); grid-template-rows:repeat(6,1fr) }
    .cell{ background:#1c2130; color:#fff; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,.05); cursor:pointer; transition:.3s }
    .cell.revealed{ color:transparent; background:transparent; border-color:transparent; transform:rotateY(180deg) }

    /* ุดุฑูุท ุชูุฏู ุงูููุงุท ุชุญุช ูู ูุฑูู */
    .progress{ background:#101420; border:1px solid rgba(255,255,255,.08); border-radius:14px; overflow:hidden; height:12px; box-shadow:inset 0 0 12px rgba(0,0,0,.35); margin-top:6px }
    .progress > div{ height:100%; width:0% }
    .bluebar{ background:linear-gradient(90deg, rgba(0,168,255,.8), rgba(0,168,255,1)) }
    .redbar{ background:linear-gradient(90deg, rgba(255,71,71,.8), rgba(255,71,71,1)) }

    /* ุงุณุชุฌุงุจุฉ */
    @media (max-width:1060px){
      .layout{ grid-template-columns:1fr; }
      .players-list{ max-height:unset }
    }

    /* ุฅุฎูุงุก ุงุณู ููู ุงูุตูุฑุฉ ูู ุงูุญูู */
    input[type="file"]{ font-size:0; }
    input[type="file"]::file-selector-button{ font-size:16px; }
  </style>
</head>
<body>

<button class="help-btn" id="helpBtn">โ ุดุฑุญ</button>
<div class="modal-backdrop" id="helpBackdrop"></div>
<div class="modal" id="helpModal" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
  <button class="x" id="helpClose">ุฅุบูุงู</button>
  <h2 id="helpTitle">ุดุฑุญ ุชูุตููู โ ูุนุจุฉ ุงูุดู ุงูุตูุฑุฉ</h2>
  <p>ุงููุฏู: ูุชุญ ุงููุฑุจุนุงุช ุจุงูุชุชุงุจุน ุญุชู ูุชุนุฑู ุงููุฑูู ุนูู ุงูุตูุฑุฉ. ุนูุฏ ูู ุฌููุฉุ ูููุญ ุงูููุณุช ุงูููุงุท ูููุฑูู ุงูุฐู ุฃุฌุงุจ.</p>
  <ul>
    <li><b>ุชุฌููุฒ ุงูุงุชุตุงู:</b> ุงุถุบุท ุงูุณูู ูู โููุญุฉ ุงูุงุชุตุงูโุ ุงุฎุชุฑ ุงูููุตุฉ (Twitch/Kick)ุ ุฃุฏุฎู ุงุณู ุงูููุงุฉุ ุซู โุงุชุตุงูโ. ุชุธูุฑ ููุทุฉ ุฎุถุฑุงุก ุนูุฏ ูุฌุงุญ ุงูุงุชุตุงู.</li>
    <li><b>ุงููุฑู ูุงูุฅูุถูุงู:</b> ููุถู ุงููุงุนุจูู ูู ุงูุดุงุช: <code>!ุงุฒุฑู</code> ุฃู <code>!ุงุญูุฑ</code>ุ ูุงููุบุงุฏุฑุฉ <code>!ุฎุฑูุฌ</code>. ูููู ููููุณุช ุญุฐู ุฃู ูุงุนุจ ูู ูุงุฆูุฉ ูุฑููู.</li>
    <li><b>ุจุฏุก ุงูุฌููุฉ:</b> ูู โููุญุฉ ุชุญูู ุงูุณุชุฑููุฑโ ุงุฑูุน ุตูุฑุฉ ุงูุฌููุฉ ุซู ุงุถุบุท โุงุจุฏุฃ ุงููุนุจุฉโ. ุณูุชู ููู ุงูุงูุถูุงู ุญุชู ููุงูุฉ ุงูุฌููุฉ.</li>
    <li><b>ูุชุญ ุงููุฑุจุนุงุช:</b> ุงููุงุนุจ ุงูุญุงูู ูุฎุชุงุฑ ุฎููุฉุ ุชุณุชุทูุน ุฅุนุทุงุก โุชูููุญโ (ูุชุญ ุฎููุฉ ุนุดูุงุฆูุฉ) ุฃู โูุดู ุงูููโ. ุงูุนุฏุงุฏ ูุจุฏุฃ ุนูุฏ ุฃูู ูุชุญ.</li>
    <li><b>ุงูุงุญุชุณุงุจ:</b> ุฎุงูุฉ ุงูููุงุท ุชูููุฃ ุชููุงุฆููุง ุจุนุฏุฏ ุงููุฑุจุนุงุช ุบูุฑ ุงูููุดููุฉ (ูููู ุชุนุฏูููุง ูุฏูููุง). ุงุณุชุฎุฏู โููุฃุฒุฑู/ููุฃุญูุฑโ. ุฎูุงุฑ โุงูุดู ุงูุตูุฑุฉ ุจุนุฏ ุงูุงุญุชุณุงุจโ ููุชุญ ุงูุตูุฑุฉ ูุจุงุดุฑุฉ.</li>
    <li><b>ุงูุชูุงูุจ:</b> ุฒุฑ โุงูุชุงููโ ููุฑุฑ ุงูุฏูุฑ ุจูู ุงูุฃุฒุฑู ูุงูุฃุญูุฑ ุจุงูุชุฑุชูุจ.</li>
    <li><b>ุฅููุงุก ุงูุฌููุฉ:</b> โุฌููุฉ ุฌุฏูุฏุฉโ ุชุนูุฏ ุงูุดุจูุฉ ูุชูุชุญ ุงูุงูุถูุงู. โุฌููุฉ ุฌุฏูุฏุฉ (ูุณุญ ุงูุตูุฑุฉ)โ ุชุตูุฑ ุงูุตูุฑุฉ ุฃูุถูุง.</li>
    <li><b>ุงูุดุฑูุท ุงูุนููู:</b> ููุถุญ ุงููุงุนุจ ุงูุญุงููุ ุงูููุชุ ูุนุฏุฏ ุงููุฑุจุนุงุช ุบูุฑ ุงูููุดููุฉ.</li>
  </ul>
</div>

<h1>๐ผ๏ธ ูุนุจุฉ ุงูุดู ุงูุตูุฑุฉ</h1>

<!-- ููุญุฉ ุงูุงุชุตุงู ุฌุฏูุฏ (ูุฎููุฉ ุงูุชุฑุงุถููุงุ ุชููุชุญ ุจุงูุณูู) -->
<div class="collapsible card" id="connWrap">
  <div class="bar">
    <div class="chev" id="connChev">โธ</div>
    <div class="bar-title">ููุญุฉ ุงูุงุชุตุงู</div>
    <div class="bar-status">
      <span class="dot gray" id="dotTw"></span><span>TW</span>
      <span class="dot gray" id="dotKk" style="margin-inline-start:8px"></span><span>KK</span>
    </div>
  </div>
  <div class="content flex" id="connContent">
    <select id="platformSelect" title="ุงูููุตุฉ">
      <option value="both">Twitch + Kick</option>
      <option value="twitch">Twitch</option>
      <option value="kick">Kick</option>
    </select>
    <input id="twitchChannel" placeholder="ููุงุฉ Twitch (ุจุฏูู #)">
    <input id="kickChannel" placeholder="ููุงุฉ Kick">
    <label style="display:flex;align-items:center;gap:6px">
      <input type="checkbox" id="rememberConn"> ุชุฐููุฑูู
    </label>
    <button class="btn" id="btnConnect">ุงุชุตุงู</button>
    <button class="btn" id="btnDisconnect" style="background:linear-gradient(180deg,#555,#333)">ูุทุน</button>
  </div>
</div>

<!-- ููุญุฉ ุชุญูู ุฌุฏูุฏ (ูุฎููุฉ ุงูุชุฑุงุถููุงุ ุชููุชุญ ุจุงูุณูู) -->
<div class="collapsible card" id="hostWrap">
  <div class="bar">
    <div class="chev" id="hostChev">โธ</div>
    <div class="bar-title">ููุญุฉ ุชุญูู ุงูุณุชุฑููุฑ</div>
  </div>
  <div class="content flex" id="hostContent">
    <span class="section-title">๐๏ธ ุฅุนุฏุงุฏุงุช ุงูุฌููุฉ</span>
    <input type="file" id="imageUpload" accept="image/*" title="ุงุฎุชุฑ ุตูุฑุฉ ุงูุฌููุฉ">
    <input type="number" id="pointsInput" min="1" value="72" style="width:120px" title="ุงูููุงุท (ุงูุชุฑุงุถููุง = ุงููุชุจูู)">
    <label><input type="checkbox" id="autoRevealAfterAward"> ุงูุดู ุงูุตูุฑุฉ ุจุนุฏ ุงูุงุญุชุณุงุจ</label>

    <span class="section-title">โก ุงูุชุญูู ุงูุณุฑูุน</span>
    <button class="btn" id="startButton">๐ฎ ุงุจุฏุฃ ุงููุนุจุฉ</button>
    <button class="btn" id="btnNext">โญ๏ธ ุงูุชุงูู</button>
    <button class="btn" id="btnHint">๐ฉ ุชูููุญ</button>
    <button class="btn" id="btnRevealAll">๐งฉ ูุดู ุงููู</button>
    <button class="btn" id="btnReset">๐ ุฌููุฉ ุฌุฏูุฏุฉ</button>
    <button class="btn" id="btnResetClear">๐งน ุฌููุฉ ุฌุฏูุฏุฉ (ูุณุญ ุงูุตูุฑุฉ)</button>

    <span class="section-title">โ ุงุญุชุณุงุจ ุงูููุงุท</span>
    <button class="btn" id="awardBlue">ููุฃุฒุฑู</button>
    <button class="btn" id="awardRed">ููุฃุญูุฑ</button>
  </div>
</div>

<!-- ุดุฑูุท ุงููุนูููุงุช ุฃุนูู ุงููุณุฑุญ (ุณุทุฑ ูุงุญุฏ) -->
<div class="top-info">
  <div class="info-chip" id="currentPlayer">๐ฎ ุงููุงุนุจ ุงูุญุงูู: โ</div>
  <div class="info-chip" id="timer">โณ 30s</div>
  <div class="info-chip">๐ฆ ุบูุฑ ููุดูู: <span id="remainingCells">72</span></div>
</div>

<!-- ุชุฎุทูุท: ุงูุฃุญูุฑ ูุณุงุฑ โ ุงููุณุฑุญ โ ุงูุฃุฒุฑู ูููู -->
<div class="layout">
  <!-- ุงูุฃุญูุฑ ูุณุงุฑ -->
  <div class="team card" id="teamRed">
    <div class="team-header">
      <div class="team-title"><span class="dot" style="background:var(--red); box-shadow:0 0 12px #ff333355"></span><span>ุงููุฑูู ุงูุฃุญูุฑ</span></div>
      <div class="team-count">ุงููุงุนุจูู: <span id="redCount">0</span></div>
    </div>
    <div class="players-list" id="redPlayers"></div>
    <div class="progress"><div id="redBar" class="redbar"></div></div>
    <div style="margin-top:6px">๐ด ุงูููุงุท: <span id="redScore">0</span> / 150</div>
  </div>

  <!-- ุงููุณุฑุญ (ูุฑุจุน ุงููุนุจุฉ) -->
  <div class="stage card">
    <div class="image-container">
      <img id="gameImage" src="" alt="ุตูุฑุฉ ุงููุนุจุฉ">
      <div class="grid" id="grid"></div>
    </div>
    <div id="guessResult" class="card" style="padding:10px; border:1px solid rgba(255,255,255,.06); min-height:40px"></div>
  </div>

  <!-- ุงูุฃุฒุฑู ูููู -->
  <div class="team card" id="teamBlue">
    <div class="team-header">
      <div class="team-title"><span class="dot" style="background:var(--blue); box-shadow:0 0 12px #00a8ff55"></span><span>ุงููุฑูู ุงูุฃุฒุฑู</span></div>
      <div class="team-count">ุงููุงุนุจูู: <span id="blueCount">0</span></div>
    </div>
    <div class="players-list" id="bluePlayers"></div>
    <div class="progress"><div id="blueBar" class="bluebar"></div></div>
    <div style="margin-top:6px">๐ต ุงูููุงุท: <span id="blueScore">0</span> / 150</div>
  </div>
</div>

<script>
/* ===== ุซูุงุจุช ูุญุงูุฉ ุนุงูุฉ ===== */
const TARGET_SCORE = 150;
const CMD_BLUE = "!ุงุฒุฑู";
const CMD_RED  = "!ุงุญูุฑ";
const CMD_LEAVE= "!ุฎุฑูุฌ";
function $(id){ return document.getElementById(id); }

const bluePlayers = [];
const redPlayers = [];
let turnIndex = 0;
let currentTeam = 'blue';
let answeringTeam = 'blue';
let blueScore = 0;
let redScore = 0;
let timerInterval = null;
let gameLocked = false; // ููู ุงูุงูุถูุงู ุจุนุฏ ุจุฏุก ุงููุนุจุฉ

/* ===== ุงุชุตุงู ุงูุดุงุช ===== */
let twitchClient = null;
let kickWS = null;
let kickPing = null;

function setDots(){
  // TW
  let twOpen = false;
  try{ twOpen = (twitchClient && typeof twitchClient.readyState==='function' && twitchClient.readyState()==='OPEN'); }catch{}
  $('dotTw').className = 'dot ' + (twOpen ? 'green' : 'gray');

  // KK
  let kkOpen = false;
  try{ kkOpen = (kickWS && kickWS.readyState === WebSocket.OPEN); }catch{}
  $('dotKk').className = 'dot ' + (kkOpen ? 'green' : 'gray');
}

function disconnectAll(){
  try{
    if (twitchClient) {
      if (typeof twitchClient.removeAllListeners === 'function') twitchClient.removeAllListeners();
      if (typeof twitchClient.disconnect === 'function') twitchClient.disconnect();
    }
  }catch{}
  twitchClient = null;

  try{ if (kickPing) clearInterval(kickPing); }catch{}
  kickPing = null;

  try{
    if (kickWS && kickWS.readyState === WebSocket.OPEN) kickWS.close();
  }catch{}
  kickWS = null;

  setDots();
  toast('๐ ุชู ูุทุน ุงูุงุชุตุงู');
}

async function connectTwitch(ch){
  if(!ch) return;
  try{ if (twitchClient && typeof twitchClient.disconnect==='function') await twitchClient.disconnect(); }catch{}
  twitchClient = new tmi.Client({ connection:{ secure:true, reconnect:true }, channels:[ch] });
  twitchClient.on('message', function(_channel, tags, msg, self){
    if (self) return;
    handleChat({ platform:'twitch', user: tags['display-name'] || tags.username, text: msg });
  });
  await twitchClient.connect();
}

async function connectKick(channel){
  if(!channel) return;

  // ุฅู ููุฌุฏ connectToKick ุฎุงุฑุฌู
  if (typeof window.connectToKick === 'function') {
    try{ if (kickWS && kickWS.readyState === WebSocket.OPEN) kickWS.close(); }catch{}
    if (kickPing) { try{ clearInterval(kickPing); }catch{} kickPing = null; }
    const disconnectFn = await window.connectToKick(channel, function(payload){
      handleChat({ platform:'kick', user: payload.user, text: payload.text });
      setDots();
    });
    kickWS = { readyState: WebSocket.OPEN, close: function(){ try{ disconnectFn(); }catch{} } };
    return;
  }

  // ุฑุจุท ุฏุงุฎูู
  const res = await fetch('https://kick.com/api/v2/channels/' + encodeURIComponent(channel));
  if(!res.ok){ toast('โ ูุดู ุฌูุจ ููุงุฉ Kick'); return; }
  const data = await res.json();
  const roomId = data && data.chatroom && data.chatroom.id ? data.chatroom.id : null;
  if(!roomId){ toast('โ ูู ููุนุซุฑ ุนูู chatroom id'); return; }

  try{ if (kickPing) clearInterval(kickPing); }catch{} kickPing = null;
  try{ if (kickWS && kickWS.readyState === WebSocket.OPEN) kickWS.close(); }catch{}
  const WS_URL = "wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=8.4.0-rc2&flash=false";
  const channelName = "chatrooms." + roomId + ".v2";
  kickWS = new WebSocket(WS_URL);

  kickWS.onopen = function(){
    kickWS.send(JSON.stringify({ event:"pusher:subscribe", data:{ auth:"", channel:channelName } }));
    kickPing = setInterval(function(){
      if (kickWS && kickWS.readyState === WebSocket.OPEN) {
        kickWS.send(JSON.stringify({ event:"pusher:ping", data:{} }));
      }
    }, 12000);
    setDots();
  };
  kickWS.onmessage = function(ev){
    try{
      const msg = JSON.parse(ev.data);
      if (msg.event === "App\\Events\\ChatMessageEvent") {
        const d = JSON.parse(msg.data || "{}");
        const username = (d && d.sender && (d.sender.username || d.sender.slug)) ? (d.sender.username || d.sender.slug) : "";
        const content  = (d && d.content) ? String(d.content).trim() : "";
        handleChat({ platform:'kick', user: username, text: content });
      }
    }catch{}
  };
  kickWS.onclose = setDots;
  kickWS.onerror = setDots;
}

/* ุฃุฒุฑุงุฑ ููุญุฉ ุงูุงุชุตุงู */
$('btnConnect').addEventListener('click', async function(){
  const mode = $('platformSelect').value;
  const tw = ($('twitchChannel').value||"").trim();
  const kk = ($('kickChannel').value||"").trim();
  if(mode==='twitch' || mode==='both'){ await connectTwitch(tw).catch(()=>toast('โ ูุดู ุชููุชุด')); }
  if(mode==='kick'   || mode==='both'){ await connectKick(kk).catch(()=>toast('โ ูุดู ููู')); }
  if($('rememberConn').checked){
    localStorage.setItem('twitchChannel', tw);
    localStorage.setItem('kickChannel', kk);
    localStorage.setItem('platformSelect', mode);
  }
  setDots();
});
$('btnDisconnect').addEventListener('click', disconnectAll);

/* ===== ุทู/ูุชุญ ุงูููุญุงุช ุจุงูุณูู ===== */
function toggleCollapsible(wrap, chev){
  const el = $(wrap), ch = $(chev);
  if(!el || !ch) return;
  const isOpen = el.classList.contains('open');
  if(isOpen){
    el.classList.remove('open');
    ch.textContent = 'โธ';
  }else{
    el.classList.add('open');
    ch.textContent = 'โพ';
  }
}
$('connChev').addEventListener('click', ()=>toggleCollapsible('connWrap','connChev'));
$('hostChev').addEventListener('click', ()=>toggleCollapsible('hostWrap','hostChev'));

/* ===== ุฃูุงูุฑ ุงูุดุงุช (ูุน ููู ุงูุงูุถูุงู ุจุนุฏ ุงูุจุฏุก) ===== */
function handleChat(payload){
  if(!payload || !payload.text) return;
  let text = String(payload.text||"").trim().toLowerCase();
  const isBlue = (text === CMD_BLUE);
  const isRed  = (text === CMD_RED );
  const isLeave= (text === CMD_LEAVE);
  if(!(isBlue || isRed || isLeave)) return;

  const name = (payload.user||"").toString().trim().replace(/\s+/g,' ').slice(0,24);
  if(!name) return;

  if(isLeave){ removeFromTeams(name); return; }
  if(gameLocked){ return; } // ููููุน ุงูุงูุถูุงู/ุงูุชุบููุฑ ุจุนุฏ ุงูุจุฏุก
  if(isBlue){ moveToTeam('blue', name, payload.platform); return; }
  if(isRed ){ moveToTeam('red',  name, payload.platform); return; }
}

/* ===== ุฅุฏุงุฑุฉ ุงููุฑู + ุญุฐู ูุงุนุจ ===== */
function findIndex(arr, name){
  const lower = name.toLowerCase();
  for(let i=0;i<arr.length;i++){
    if(arr[i].name && arr[i].name.toLowerCase() === lower) return i;
  }
  return -1;
}
function removeFromTeams(name){
  let changed=false, i=findIndex(bluePlayers,name);
  if(i>-1){ bluePlayers.splice(i,1); changed=true; renderTeam('blue'); }
  i=findIndex(redPlayers,name);
  if(i>-1){ redPlayers.splice(i,1); changed=true; renderTeam('red'); }
  if(changed) toast('๐ช ' + name + ' ุชู ุญุฐูู ูู ุงููุฑู');
}
function moveToTeam(team,name,platform){
  const other = (team==='blue') ? 'red' : 'blue';
  let idx=findIndex(other==='blue' ? bluePlayers : redPlayers, name);
  if(idx>-1){
    if(other==='blue') bluePlayers.splice(idx,1);
    else redPlayers.splice(idx,1);
    renderTeam(other);
  }
  const arr = (team==='blue') ? bluePlayers : redPlayers;
  if(findIndex(arr,name)===-1){
    arr.push({name:name, source:platform});
    renderTeam(team);
    toast('โ ' + name + ' ุงูุถู ุฅูู ูุฑูู ' + (team==='blue'?'ุงูุฃุฒุฑู':'ุงูุฃุญูุฑ'));
  }
}
function renderTeam(team){
  const list = (team==='blue') ? $('bluePlayers') : $('redPlayers');
  const arr  = (team==='blue') ? bluePlayers : redPlayers;
  let html = "";
  for(let i=0;i<arr.length;i++){
    const p = arr[i];
    const source = p.source ? (p.source==='twitch'?'Twitch':'Kick') : '';
    html += `
      <div class="player-card">
        <div class="slot">${i+1}</div>
        <div class="player-name">
          <span>${p.name||''}</span>
          ${source?`<span class="badge">${source}</span>`:''}
        </div>
        <button class="del" title="ุญุฐู" onclick="(function(n){ removeFromTeams(n); })('${p.name.replace(/'/g,"\\'")}')">โ</button>
      </div>`;
  }
  list.innerHTML = html;
  (team==='blue'?$('blueCount'):$('redCount')).innerText = String(arr.length);
}

/* ===== ุดุจูุฉ ุงููุฑุจุนุงุช (ุจุฏูู ุชุนุฏูู ุงูููุทู) ===== */
function createGrid(){
  const grid = $('grid');
  grid.innerHTML='';
  for(let i=0;i<72;i++){
    const d=document.createElement('div');
    d.className='cell';
    d.textContent=(i+1);
    d.onclick=function(){
      d.classList.add('revealed');
      d.onclick=null;
      updateRemaining();
      startTimer();
    };
    grid.appendChild(d);
  }
  updateRemaining();
}
function unrevealedCount(){
  const all=document.querySelectorAll('.cell');
  let cnt=0;
  for(let i=0;i<all.length;i++){ if(!all[i].classList.contains('revealed')) cnt++; }
  return cnt;
}
function updateRemaining(){
  const r = unrevealedCount();
  $('remainingCells').innerText = String(r);
  const pi = $('pointsInput');
  if(pi){ let v=r; if(v<1) v=1; pi.value = String(v); }
}
function revealRandomCell(){
  const cells=[].slice.call(document.querySelectorAll('.cell'));
  const closed=cells.filter(c=>!c.classList.contains('revealed'));
  if(!closed.length) return;
  const d = closed[Math.floor(Math.random()*closed.length)];
  d.classList.add('revealed'); d.onclick=null; updateRemaining();
}
function revealAll(){
  const cells=document.querySelectorAll('.cell');
  for(let i=0;i<cells.length;i++){ cells[i].classList.add('revealed'); cells[i].onclick=null; }
  updateRemaining();
}

/* ===== ููุทู ุงููุนุจุฉ ===== */
function startGame(){
  const fileInput = $('imageUpload');
  if(!fileInput || !fileInput.files || !fileInput.files.length){
    alert('โ ุงุฑูุน ุตูุฑุฉ ุฃููุงู'); return;
  }
  const reader=new FileReader();
  reader.onload=function(e){
    $('gameImage').src = e.target.result;
    createGrid();
  };
  reader.readAsDataURL(fileInput.files[0]);

  gameLocked = true; // ููู ุงูุงูุถูุงู/ุงูุชุบููุฑ
  const startBtn=$('startButton'); if(startBtn) startBtn.disabled=true;
  nextTurn();
  toast('๐ซ ุชู ููู ุงูุงูุถูุงู ุฃุซูุงุก ุงูุฌููุฉ');
}
function nextTurn(){
  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  $('timer').innerText='โณ 30s';
  if(bluePlayers.length===0 || redPlayers.length===0){
    alert('โ ูุงุฒู ูุงุนุจูู ูู ูู ูุฑูู'); return;
  }
  let p;
  if(currentTeam==='blue'){
    p = bluePlayers[turnIndex % bluePlayers.length];
    answeringTeam='blue'; currentTeam='red';
  }else{
    p = redPlayers[turnIndex % redPlayers.length];
    answeringTeam='red'; currentTeam='blue'; turnIndex++;
  }
  $('currentPlayer').innerText='๐ฎ ุงููุงุนุจ ุงูุญุงูู: ' + (p && p.name ? p.name : 'โ');
  $('guessResult').innerText='';
}
function startTimer(){
  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  let t=30;
  $('timer').innerText='โณ ' + t + 's';
  timerInterval=setInterval(function(){
    t--; $('timer').innerText='โณ ' + t + 's';
    if(t<=0){
      clearInterval(timerInterval); timerInterval=null;
      $('timer').innerText='โณ ุงูุชูู ุงูููุช!';
    }
  },1000);
}

/* ===== ููุงุท + ุจุฑูุฌุฑูุณ ===== */
function awardPoints(team){
  const auto = $('autoRevealAfterAward').checked;
  const num = $('pointsInput').value;
  const pts = parseInt(num,10);
  if(isNaN(pts) || pts<=0){ alert('โ๏ธ ุฃุฏุฎู ููุงุท ุตุญูุญุฉ'); return; }

  if(team==='blue'){
    blueScore += pts; $('blueScore').innerText = String(blueScore);
    if(blueScore>=TARGET_SCORE) alert('๐ ุงูุฃุฒุฑู ูุงุฒ!');
  }else{
    redScore += pts; $('redScore').innerText = String(redScore);
    if(redScore>=TARGET_SCORE) alert('๐ ุงูุฃุญูุฑ ูุงุฒ!');
  }
  updateBars();
  toast('+' + pts + ' ููุทุฉ ููุฑูู ' + (team==='blue'?'ุงูุฃุฒุฑู':'ุงูุฃุญูุฑ'));
  if(auto) revealAll();
}
function updateBars(){
  let bluePct = (blueScore/TARGET_SCORE)*100; if(bluePct>100) bluePct=100;
  let redPct  = (redScore /TARGET_SCORE)*100; if(redPct>100) redPct=100;
  $('blueBar').style.width = bluePct + '%';
  $('redBar').style.width  = redPct + '%';
}

/* ===== ุฌููุฉ ุฌุฏูุฏุฉ ===== */
function resetRound(clearImage = false){
  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  $('timer').innerText='โณ 30s';
  $('guessResult').innerText='';
  createGrid();
  const left = unrevealedCount();
  $('remainingCells').innerText = String(left);
  const pi = $('pointsInput'); if(pi){ let v=left; if(v<1) v=1; pi.value = String(v); }
  if(clearImage === true){
    const img = $('gameImage'); const up  = $('imageUpload');
    if(img) img.src = ''; if(up)  up.value = '';
  }
  const startBtn = $('startButton'); if(startBtn) startBtn.disabled = false;
  gameLocked = false; // ูุชุญ ุงูุงูุถูุงู ุจูู ุงูุฌููุงุช
  toast(clearImage ? '๐งน ุชู ุชุฌููุฒ ุฌููุฉ ุฌุฏูุฏุฉ ููุณุญ ุงูุตูุฑุฉ' : '๐ ุชู ุชุฌููุฒ ุฌููุฉ ุฌุฏูุฏุฉ');
}

/* ===== Helper ===== */
function toast(text){
  const t=document.createElement('div'); t.textContent=text;
  t.style.position='fixed'; t.style.bottom='24px'; t.style.right='24px';
  t.style.background='rgba(0,0,0,.7)'; t.style.border='1px solid rgba(255,255,255,.15)';
  t.style.padding='10px 14px'; t.style.borderRadius='10px'; t.style.zIndex='9999'; t.style.boxShadow='0 10px 24px rgba(0,0,0,.35)';
  document.body.appendChild(t);
  setTimeout(function(){ t.style.transition='opacity .6s'; t.style.opacity='0'; },1200);
  setTimeout(function(){ try{ t.remove(); }catch{} },1900);
}

/* ===== ุฑูุงุจุท ุงูุฃุฒุฑุงุฑ ===== */
$('startButton').addEventListener('click', startGame);
$('btnNext').addEventListener('click', nextTurn);
$('btnHint').addEventListener('click', revealRandomCell);
$('btnRevealAll').addEventListener('click', revealAll);
$('btnReset').addEventListener('click', ()=>resetRound(false));
$('btnResetClear').addEventListener('click', ()=>resetRound(true));
$('awardBlue').addEventListener('click', ()=>awardPoints('blue'));
$('awardRed').addEventListener('click',  ()=>awardPoints('red'));

/* ===== ุฒุฑ ุงูุดุฑุญ ===== */
function openHelp(open=true){
  $('helpBackdrop').style.display = open?'block':'none';
  $('helpModal').style.display = open?'block':'none';
}
$('helpBtn').addEventListener('click', ()=>openHelp(true));
$('helpClose').addEventListener('click', ()=>openHelp(false));
$('helpBackdrop').addEventListener('click', ()=>openHelp(false));

/* ===== ุจุฏุก ุงูุตูุญุฉ ===== */
window.addEventListener('load', function(){
  createGrid(); updateBars(); setDots();
  // ุงุณุชุฑุฌุงุน ุงุชุตุงู ูุญููุธ
  const tw=localStorage.getItem('twitchChannel'); const kk=localStorage.getItem('kickChannel'); const md=localStorage.getItem('platformSelect');
  if(tw) $('twitchChannel').value=tw;
  if(kk) $('kickChannel').value=kk;
  if(md) $('platformSelect').value=md;
  // ุงุจุฏุฃ ุงูููุญุงุช ูุทููุฉ
  // (ุชููุชุญ ุจุงูุฃุณูู)
});
</script>

<!-- (ุงุฎุชูุงุฑู) ููู ุฎุงุฑุฌู ูููุฑ window.connectToKick(channel, onMessage) -->
<script src="kick_chat.js"></script>
</body>
</html>
