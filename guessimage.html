<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ–¼ï¸ Ù„Ø¹Ø¨Ø© Ø§ÙƒØ´Ù Ø§Ù„ØµÙˆØ±Ø©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet" />
  <!-- tmi.js Ù„ØªÙˆÙŠØªØ´ -->
 <script src="tmi.min.js"></script>
<style>
    :root{ --bg1:#0e0f14; --bg2:#121827; --red:#ff3333; --blue:#00a8ff; }
    *{box-sizing:border-box}
    body{
      background: radial-gradient(1200px 600px at 10% 10%, rgba(255,255,255,.04), transparent 60%),
                  radial-gradient(1200px 600px at 90% 90%, rgba(255,255,255,.04), transparent 60%),
                  linear-gradient(120deg, var(--bg1), var(--bg2));
      color:#fff; font-family:'Amiri',serif; text-align:center; padding:20px;
    }
    h1{ color:var(--red); margin:6px 0 14px; letter-spacing:.5px }
    .teams-container{ display:flex; justify-content:space-between; gap:18px; flex-wrap:wrap; width:95%; margin:18px auto 10px; }
    .card{ background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); backdrop-filter:blur(8px); border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.25) }
    .team{ width:22%; padding:14px; text-align:unset }
    .team-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px }
    .team-title{ display:flex; align-items:center; gap:10px; font-weight:700 }
    .dot{ width:10px; height:10px; border-radius:50% }
    .dot.blue{ background:#00a8ff; box-shadow:0 0 12px #00a8ff55 }
    .dot.red{ background:#ff3333; box-shadow:0 0 12px #ff333355 }
    .team-count{ font-size:14px; padding:4px 10px; border-radius:20px; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.08) }
    .players-list{ display:grid; gap:8px }
    .player-card{ display:grid; grid-template-columns:40px 1fr; align-items:center; gap:10px; background:rgba(0,0,0,.30); border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:8px 10px }
    .slot{ width:34px; height:34px; border-radius:9px; display:flex; align-items:center; justify-content:center; background:#1f2636; border:1px solid rgba(255,255,255,.06); font-weight:700 }
    .player-name{ display:flex; align-items:center; gap:8px; font-size:18px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .badge{ font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.15); background:#233049 }

    .game-description{ width:50%; padding:16px; font-size:18px; line-height:1.6; text-align:center }
    .game-area{ font-size:20px; margin:18px auto; padding:16px; width:95%; max-width:1100px }

    .host-only{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; align-items:center; padding:12px; border:1px dashed rgba(255,255,255,.15); border-radius:14px; background:linear-gradient(180deg, rgba(20,24,36,.7), rgba(20,24,36,.55)) }
    .panel{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; align-items:center; margin:8px 0 }

    input,button{
      padding:10px 12px; font-size:18px; margin:5px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
      background:#232838; color:#fff; font-family:'Amiri',serif;
    }
    button{ background:linear-gradient(180deg, #ff4747, #d73333); border:none; box-shadow:0 6px 18px rgba(255,71,71,.25); cursor:pointer; position:relative; overflow:hidden }
    button:hover{ filter:brightness(1.05) }
    button:active{ transform:translateY(1px) }
    button::after{ content:""; position:absolute; inset:0; background:radial-gradient(circle at var(--x,50%) var(--y,50%), rgba(255,255,255,.25), transparent 40%); opacity:0; transition:opacity .4s ease; }
    button:active::after{ opacity:1; transition:none }

    .image-container{ position:relative; width:100%; padding-top:66.66%; margin:12px 0; background:#000; border:1px solid rgba(255,255,255,.08); border-radius:12px; overflow:hidden }
    .image-container::before{ content:""; position:absolute; inset:0; background-image: linear-gradient(#ffffff12 1px, transparent 1px), linear-gradient(90deg, #ffffff12 1px, transparent 1px); background-size:40px 40px; pointer-events:none }
    .image-container img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover }

    .grid{ position:absolute; inset:0; display:grid; grid-template-columns:repeat(12,1fr); grid-template-rows:repeat(6,1fr) }
    .cell{ background:#1c2130; color:#fff; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,.05); cursor:pointer; transition:.3s }
    .cell.revealed{ color:transparent; background:transparent; border-color:transparent; transform:rotateY(180deg) }

    .info-line{ font-size:16px; background:rgba(0,0,0,.35); padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.06) }
    .errors-list{ margin-top:10px; background:rgba(0,0,0,.35); padding:10px; border-radius:10px; min-height:40px; text-align:right; border:1px solid rgba(255,255,255,.06) }

    .scoreboard{ margin-top:14px; font-size:18px; display:grid; gap:10px }
    .progress{ background:#101420; border:1px solid rgba(255,255,255,.08); border-radius:14px; overflow:hidden; height:18px; box-shadow:inset 0 0 12px rgba(0,0,0,.35) }
    .progress > div{ height:100%; width:0%; background:linear-gradient(90deg, rgba(0,168,255,.8), rgba(0,168,255,1)); transition:width .45s ease }
    .progress.red > div{ background:linear-gradient(90deg, rgba(255,71,71,.8), rgba(255,71,71,1)) }

    @media (max-width:900px){ .team,.game-description{ width:100% } .host-only{ position:sticky; bottom:6px; z-index:20 } input,button{ font-size:16px } }
  </style>
</head>
<body>

<h1>ğŸ–¼ï¸ Ù„Ø¹Ø¨Ø© Ø§ÙƒØ´Ù Ø§Ù„ØµÙˆØ±Ø©</h1>

<div class="teams-container">
  <!-- Ø§Ù„Ø£Ø²Ø±Ù‚ -->
  <div class="team card">
    <div class="team-header">
      <div class="team-title"><span class="dot blue"></span> <span>Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚</span></div>
      <div class="team-count">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†: <span id="blueCount">0</span></div>
    </div>
    <div id="bluePlayers" class="players-list"></div>
  </div>

  <!-- ÙˆØµÙ -->
  <div class="game-description card">
    âœ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù…Ù† Ø§Ù„Ø´Ø§Øª: <code>!Ø§Ø²Ø±Ù‚</code> â€” <code>!Ø§Ø­Ù…Ø±</code> â€” <code>!Ø®Ø±ÙˆØ¬</code><br>
    Ø§Ø±ÙØ¹ ØµÙˆØ±Ø©ØŒ Ø§ÙØªØ­ÙˆØ§ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§ØªØŒ ÙˆØ§Ù„Ù‡ÙˆØ³Øª ÙŠÙˆØ²Ù‘Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø· ÙŠØ¯ÙˆÙŠÙ‹Ø§. Ø£ÙˆÙ„ ÙØ±ÙŠÙ‚ ÙŠØµÙ„ Ø¥Ù„Ù‰ 150 Ù†Ù‚Ø·Ø© ÙŠÙÙˆØ² ğŸ†.
  </div>

  <!-- Ø§Ù„Ø£Ø­Ù…Ø± -->
  <div class="team card">
    <div class="team-header">
      <div class="team-title"><span class="dot red"></span> <span>Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±</span></div>
      <div class="team-count">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†: <span id="redCount">0</span></div>
    </div>
    <div id="redPlayers" class="players-list"></div>
  </div>
</div>

<div class="game-area card">
  <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù‡ÙˆØ³Øª -->
  <div class="host-only">
    <span class="info-line">ğŸ›ï¸ Ø±Ø¨Ø· Ø§Ù„Ø´Ø§Øª â€” Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙˆÙŠØªØµÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</span>
    <input id="twitchChannel" placeholder="Ù‚Ù†Ø§Ø© Twitch (Ø¨Ø¯ÙˆÙ† #)">
    <input id="kickChannel" placeholder="Ù‚Ù†Ø§Ø© Kick">
    <button onclick="disconnectAll()">ğŸ”Œ Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„</button>
    <span class="info-line" id="connState">Ø§Ù„Ø­Ø§Ù„Ø©: ØºÙŠØ± Ù…ØªØµÙ„</span>
  </div>

  <div class="host-only" style="margin-top:8px">
    <span class="info-line">ğŸ–¼ï¸ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù„Ø¹Ø¨Ø©</span>
    <input type="file" id="imageUpload" accept="image/*">
    <button id="startButton" onclick="startGame()">ğŸ® Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
    <button onclick="revealRandomCell()">ğŸŸ© ØªÙ„Ù…ÙŠØ­ (ÙØªØ­ Ø®Ù„ÙŠØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©)</button>
    <button onclick="revealAll()">ğŸ§© ÙƒØ´Ù ÙƒÙ„ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª</button>
    <button onclick="resetRound()">ğŸ”„ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    <button onclick="resetRound(true)">ğŸ§¹ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ù…Ø³Ø­ Ø§Ù„ØµÙˆØ±Ø©)</button>
  </div>

  <div class="panel">
    <div id="currentPlayer" class="info-line">â¬‡ï¸ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
    <div id="timer" class="info-line">â³</div>
    <div class="info-line">ğŸ“¦ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙƒØ´ÙˆÙØ©: <span id="remainingCells">72</span></div>
  </div>

  <div class="image-container">
    <img id="gameImage" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©">
    <div class="grid" id="grid"></div>
  </div>

  <div class="panel">
    <input type="number" id="pointsInput" min="1" value="72" style="width:120px" title="Ø§Ù„Ù†Ù‚Ø§Ø· (Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ = Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ)">
    <button onclick="awardPoints('blue')">âœ… Ø§Ø­ØªØ³Ø§Ø¨ Ù„Ù„Ø£Ø²Ø±Ù‚</button>
    <button onclick="awardPoints('red')">âœ… Ø§Ø­ØªØ³Ø§Ø¨ Ù„Ù„Ø£Ø­Ù…Ø±</button>
    <label><input type="checkbox" id="autoRevealAfterAward"> Ø§ÙƒØ´Ù ÙƒÙ„ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø­ØªØ³Ø§Ø¨</label>
    <button onclick="nextTurn()">â­ï¸ Ø§Ù„ØªØ§Ù„ÙŠ</button>
  </div>

  <div id="guessResult" class="errors-list"></div>

  <div class="scoreboard">
    <div class="info-line">ğŸ”µ Ø§Ù„Ø£Ø²Ø±Ù‚: <span id="blueScore">0</span> Ù†Ù‚Ø·Ø©<div class="progress"><div id="blueBar"></div></div></div>
    <div class="info-line">ğŸ”´ Ø§Ù„Ø£Ø­Ù…Ø±: <span id="redScore">0</span> Ù†Ù‚Ø·Ø©<div class="progress red"><div id="redBar"></div></div></div>
  </div>
</div>

<script>
/* ============= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ============= */
const TARGET_SCORE = 150;
const CMD_BLUE = "!Ø§Ø²Ø±Ù‚";
const CMD_RED  = "!Ø§Ø­Ù…Ø±";
const CMD_LEAVE= "!Ø®Ø±ÙˆØ¬";
function $(id){ return document.getElementById(id); }

/* ============= Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ============= */
const bluePlayers = [];
const redPlayers = [];
let turnIndex = 0;
let currentTeam = 'blue';
let answeringTeam = 'blue';
let blueScore = 0;
let redScore = 0;
let timerInterval = null;

/* ============= Ø±Ø¨Ø· Ø§Ù„Ø´Ø§Øª ============= */
let twitchClient = null;
let kickWS = null;
let kickPing = null;

function setConnState(){
  const parts = [];
  try{
    if (twitchClient && typeof twitchClient.readyState === 'function' && twitchClient.readyState() === 'OPEN') {
      parts.push('Twitch âœ…');
    }
  }catch{}
  try{
    if (kickWS && kickWS.readyState === WebSocket.OPEN) {
      parts.push('Kick âœ…');
    }
  }catch{}
  $('connState').innerText = parts.length ? ('Ø§Ù„Ø­Ø§Ù„Ø©: ' + parts.join(' | ')) : 'Ø§Ù„Ø­Ø§Ù„Ø©: ØºÙŠØ± Ù…ØªØµÙ„';
}

function disconnectAll(){
  try{
    if (twitchClient) {
      if (typeof twitchClient.removeAllListeners === 'function') twitchClient.removeAllListeners();
      if (typeof twitchClient.disconnect === 'function') twitchClient.disconnect();
    }
  }catch{}
  twitchClient = null;

  try{ if (kickPing) clearInterval(kickPing); }catch{}
  kickPing = null;

  try{
    if (kickWS && kickWS.readyState === WebSocket.OPEN) {
      kickWS.close();
    }
  }catch{}
  kickWS = null;

  $('connState').innerText = 'Ø§Ù„Ø­Ø§Ù„Ø©: ØºÙŠØ± Ù…ØªØµÙ„';
  toast('ğŸ”Œ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„');
}

async function connectTwitchAuto(){
  const ch = ($('twitchChannel').value || "").trim();
  if(!ch) return;

  try{
    if (twitchClient && typeof twitchClient.disconnect === 'function') {
      await twitchClient.disconnect();
    }
  }catch{}

  twitchClient = new tmi.Client({ connection:{ secure:true, reconnect:true }, channels:[ch] });

  twitchClient.on('message', function(_channel, tags, msg, self){
    if (self) return;
    handleChat({ platform:'twitch', user: tags['display-name'] || tags.username, text: msg });
  });

  await twitchClient.connect();
  localStorage.setItem('twitchChannel', ch);
  setConnState();
}

async function connectKickAuto(){
  const ch = ($('kickChannel').value || "").trim();
  if(!ch) return;

  // Ø§Ø³ØªØ®Ø¯Ø§Ù… kick_chat.js Ø¥Ù† ÙˆØ¬Ø¯
  if (typeof window.connectToKick === 'function') {
    try{ if (kickWS && kickWS.readyState === WebSocket.OPEN) kickWS.close(); }catch{}
    if (kickPing) { try{ clearInterval(kickPing); }catch{} kickPing = null; }

    const disconnectFn = await window.connectToKick(ch, function(payload){
      handleChat({ platform:'kick', user: payload.user, text: payload.text });
      setConnState();
    });

    // WebSocket ÙˆÙ‡Ù…ÙŠ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø©
    kickWS = { readyState: WebSocket.OPEN, close: function(){ try{ disconnectFn(); }catch{} } };
    localStorage.setItem('kickChannel', ch);
    setConnState();
    return;
  }

  // Ø±Ø¨Ø· Ø¯Ø§Ø®Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø±
  const res = await fetch('https://kick.com/api/v2/channels/' + encodeURIComponent(ch));
  if(!res.ok){ toast('âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ù‚Ù†Ø§Ø© Kick'); return; }
  const data = await res.json();
  const roomId = data && data.chatroom && data.chatroom.id ? data.chatroom.id : null;
  if(!roomId){ toast('âŒ Ù„Ù… ÙŠÙØ¹Ø«Ø± Ø¹Ù„Ù‰ chatroom id'); return; }

  try{ if (kickPing) clearInterval(kickPing); }catch{} kickPing = null;
  try{ if (kickWS && kickWS.readyState === WebSocket.OPEN) kickWS.close(); }catch{}
  const WS_URL = "wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=8.4.0-rc2&flash=false";
  const channelName = "chatrooms." + roomId + ".v2";
  kickWS = new WebSocket(WS_URL);

  kickWS.onopen = function(){
    kickWS.send(JSON.stringify({ event:"pusher:subscribe", data:{ auth:"", channel:channelName } }));
    kickPing = setInterval(function(){
      if (kickWS && kickWS.readyState === WebSocket.OPEN) {
        kickWS.send(JSON.stringify({ event:"pusher:ping", data:{} }));
      }
    }, 12000);
    setConnState();
  };
  kickWS.onmessage = function(ev){
    try{
      const msg = JSON.parse(ev.data);
      if (msg.event === "App\\Events\\ChatMessageEvent") {
        const d = JSON.parse(msg.data || "{}");
        const username = (d && d.sender && (d.sender.username || d.sender.slug)) ? (d.sender.username || d.sender.slug) : "";
        const content  = (d && d.content) ? String(d.content).trim() : "";
        handleChat({ platform:'kick', user: username, text: content });
      }
    }catch{}
  };
  kickWS.onclose = function(){ setConnState(); };
  kickWS.onerror = function(){ setConnState(); };

  localStorage.setItem('kickChannel', ch);
}

/* Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©: Ø§ØªØµØ§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Enter Ø£Ùˆ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø­Ù‚Ù„ */
function onChannelInput(e, which){
  if(e.type === 'keydown' && e.key !== 'Enter') return;
  if(which === 'twitch'){
    connectTwitchAuto().then(function(){ setConnState(); }).catch(function(){ toast('âŒ ÙØ´Ù„ ØªÙˆÙŠØªØ´'); });
  }else{
    connectKickAuto().then(function(){ setConnState(); }).catch(function(){ toast('âŒ ÙØ´Ù„ ÙƒÙŠÙƒ'); });
  }
}
$('twitchChannel').addEventListener('blur', function(e){ onChannelInput(e,'twitch'); });
$('twitchChannel').addEventListener('keydown', function(e){ onChannelInput(e,'twitch'); });
$('kickChannel').addEventListener('blur', function(e){ onChannelInput(e,'kick'); });
$('kickChannel').addEventListener('keydown', function(e){ onChannelInput(e,'kick'); });

/* ============= Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø§Øª ============= */
function handleChat(payload){
  if(!payload || !payload.text) return;

  var text = String(payload.text || "").trim().toLowerCase();
  var isBlue  = (text === CMD_BLUE);
  var isRed   = (text === CMD_RED);
  var isLeave = (text === CMD_LEAVE);
  if(!(isBlue || isRed || isLeave)) return;

  var name = (payload.user || "").toString().trim().replace(/\s+/g,' ').slice(0,24);
  if(!name) return;

  if(isLeave){ removeFromTeams(name); return; }
  if(isBlue){ moveToTeam('blue', name, payload.platform); return; }
  if(isRed){ moveToTeam('red', name, payload.platform); return; }
}

/* ============= Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±Ù‚ ============= */
function findIndex(arr, name){
  var lower = name.toLowerCase();
  for(var i=0;i<arr.length;i++){
    if(arr[i].name && arr[i].name.toLowerCase() === lower) return i;
  }
  return -1;
}
function removeFromTeams(name){
  var changed=false, i=findIndex(bluePlayers,name);
  if(i>-1){ bluePlayers.splice(i,1); changed=true; renderTeam('blue'); }
  i=findIndex(redPlayers,name);
  if(i>-1){ redPlayers.splice(i,1); changed=true; renderTeam('red'); }
  if(changed) toast('ğŸšª ' + name + ' Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„ÙØ±ÙŠÙ‚');
}
function moveToTeam(team,name,platform){
  var other = (team==='blue') ? 'red' : 'blue';
  var idx=findIndex(other==='blue' ? bluePlayers : redPlayers, name);
  if(idx>-1){
    if(other==='blue') bluePlayers.splice(idx,1);
    else redPlayers.splice(idx,1);
    renderTeam(other);
  }
  var arr = (team==='blue') ? bluePlayers : redPlayers;
  if(findIndex(arr,name)===-1){
    arr.push({name:name, source:platform});
    renderTeam(team);
    toast('âœ… ' + name + ' Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ ÙØ±ÙŠÙ‚ ' + (team==='blue'?'Ø§Ù„Ø£Ø²Ø±Ù‚':'Ø§Ù„Ø£Ø­Ù…Ø±'));
  }
}
function renderTeam(team){
  var list = (team==='blue') ? $('bluePlayers') : $('redPlayers');
  var arr  = (team==='blue') ? bluePlayers : redPlayers;
  var html = "";
  for(var i=0;i<arr.length;i++){
    var p = arr[i];
    html += '<div class="player-card">' +
              '<div class="slot">' + (i+1) + '</div>' +
              '<div class="player-name">' +
                '<span>' + (p.name||'') + '</span>' +
                (p.source ? ('<span class="badge">' + (p.source==='twitch'?'Twitch':'Kick') + '</span>') : '') +
              '</div>' +
            '</div>';
  }
  list.innerHTML = html;
  var countEl = (team==='blue') ? $('blueCount') : $('redCount');
  if(countEl) countEl.innerText = String(arr.length);
}

/* ============= Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª ============= */
function createGrid(){
  var grid = $('grid');
  grid.innerHTML='';
  for(var i=0;i<72;i++){
    (function(i){
      var d=document.createElement('div');
      d.className='cell';
      d.textContent=(i+1);
      d.onclick=function(){
        d.classList.add('revealed');
        d.onclick=null;
        updateRemaining();
        startTimer();
      };
      grid.appendChild(d);
    })(i);
  }
  updateRemaining();
}
function unrevealedCount(){
  var all=document.querySelectorAll('.cell');
  var cnt=0;
  for(var i=0;i<all.length;i++){
    if(!all[i].classList.contains('revealed')) cnt++;
  }
  return cnt;
}
function updateRemaining(){
  var r = unrevealedCount();
  $('remainingCells').innerText = String(r);
  var pi = $('pointsInput');
  if(pi){
    var v = r; if(v<1) v=1;
    pi.value = String(v);
  }
}
function revealRandomCell(){
  var cells=[].slice.call(document.querySelectorAll('.cell'));
  var closed=cells.filter(function(c){ return !c.classList.contains('revealed'); });
  if(!closed.length) return;
  var d = closed[Math.floor(Math.random()*closed.length)];
  d.classList.add('revealed');
  d.onclick=null;
  updateRemaining();
}
function revealAll(){
  var cells=document.querySelectorAll('.cell');
  for(var i=0;i<cells.length;i++){
    cells[i].classList.add('revealed');
    cells[i].onclick=null;
  }
  updateRemaining();
}

/* ============= Ø§Ù„Ù„Ø¹Ø¨Ø© ============= */
function startGame(){
  var fileInput = $('imageUpload');
  if(!fileInput || !fileInput.files || !fileInput.files.length){
    alert('âŒ Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }
  var startBtn=$('startButton');
  if(startBtn) startBtn.disabled=true;

  var reader=new FileReader();
  reader.onload=function(e){
    $('gameImage').src = e.target.result;
    createGrid();
  };
  reader.readAsDataURL(fileInput.files[0]);
  nextTurn();
}
function nextTurn(){
  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  $('timer').innerText='â³';
  if(bluePlayers.length===0 || redPlayers.length===0){
    alert('âŒ Ù„Ø§Ø²Ù… Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙŠ ÙƒÙ„ ÙØ±ÙŠÙ‚');
    return;
  }
  var p;
  if(currentTeam==='blue'){
    p = bluePlayers[turnIndex % bluePlayers.length];
    answeringTeam='blue';
    currentTeam='red';
  }else{
    p = redPlayers[turnIndex % redPlayers.length];
    answeringTeam='red';
    currentTeam='blue';
    turnIndex++;
  }
  $('currentPlayer').innerText='ğŸ® Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù†: ' + (p && p.name ? p.name : '');
  $('guessResult').innerText='';
}
function startTimer(){
  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  var t=30;
  $('timer').innerText='â³ ' + t + 's';
  timerInterval=setInterval(function(){
    t--;
    $('timer').innerText='â³ ' + t + 's';
    if(t<=0){
      clearInterval(timerInterval);
      timerInterval=null;
      $('timer').innerText='â³ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!';
    }
  },1000);
}

/* ============= Ù†Ù‚Ø§Ø· + Ø¨Ø±ÙˆØ¬Ø±ÙŠØ³ ============= */
function awardPoints(team){
  var auto = $('autoRevealAfterAward').checked;
  var num = $('pointsInput').value;
  var pts = parseInt(num,10);
  if(isNaN(pts) || pts<=0){ alert('âš ï¸ Ø£Ø¯Ø®Ù„ Ù†Ù‚Ø§Ø· ØµØ­ÙŠØ­Ø©'); return; }

  if(team==='blue'){
    blueScore += pts;
    $('blueScore').innerText = String(blueScore);
    if(blueScore>=TARGET_SCORE) alert('ğŸ† Ø§Ù„Ø£Ø²Ø±Ù‚ ÙØ§Ø²!');
  }else{
    redScore += pts;
    $('redScore').innerText = String(redScore);
    if(redScore>=TARGET_SCORE) alert('ğŸ† Ø§Ù„Ø£Ø­Ù…Ø± ÙØ§Ø²!');
  }
  updateBars();
  toast('+' + pts + ' Ù†Ù‚Ø·Ø© Ù„ÙØ±ÙŠÙ‚ ' + (team==='blue'?'Ø§Ù„Ø£Ø²Ø±Ù‚':'Ø§Ù„Ø£Ø­Ù…Ø±'));
  if(auto) revealAll();
}
function updateBars(){
  var bluePct = (blueScore/TARGET_SCORE)*100; if(bluePct>100) bluePct=100;
  var redPct  = (redScore /TARGET_SCORE)*100; if(redPct>100) redPct=100;
  $('blueBar').style.width = bluePct + '%';
  $('redBar').style.width  = redPct + '%';
}

/* ============= Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ù…Ø¹ Ø®ÙŠØ§Ø± Ù…Ø³Ø­ Ø§Ù„ØµÙˆØ±Ø©) ============= */
function resetRound(clearImage = false){
  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  $('timer').innerText='â³';
  $('guessResult').innerText='';

  createGrid();

  var left = unrevealedCount();
  $('remainingCells').innerText = String(left);
  var pi = $('pointsInput');
  if(pi){
    var v=left; if(v<1) v=1;
    pi.value = String(v);
  }

  if(clearImage === true){
    var img = $('gameImage');
    var up  = $('imageUpload');
    if(img) img.src = '';
    if(up)  up.value = '';
  }

  var startBtn = $('startButton');
  if(startBtn) startBtn.disabled = false;

  toast(clearImage ? 'ğŸ§¹ ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆÙ…Ø³Ø­ Ø§Ù„ØµÙˆØ±Ø©' : 'ğŸ”„ ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©');
}

/* ============= Helper ============= */
function toast(text){
  var t=document.createElement('div'); t.textContent=text;
  t.style.position='fixed'; t.style.bottom='24px'; t.style.right='24px';
  t.style.background='rgba(0,0,0,.7)'; t.style.border='1px solid rgba(255,255,255,.15)';
  t.style.padding='10px 14px'; t.style.borderRadius='10px'; t.style.zIndex='9999'; t.style.boxShadow='0 10px 24px rgba(0,0,0,.35)';
  document.body.appendChild(t);
  setTimeout(function(){ t.style.transition='opacity .6s'; t.style.opacity='0'; },1200);
  setTimeout(function(){ try{ t.remove(); }catch{} },1900);
}

/* ============= Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø© ============= */
window.addEventListener('load', function(){
  createGrid();
  updateBars();

  var tw=localStorage.getItem('twitchChannel');
  if(tw){ $('twitchChannel').value=tw; connectTwitchAuto().then(function(){ setConnState(); }).catch(function(){}); }

  var kk=localStorage.getItem('kickChannel');
  if(kk){ $('kickChannel').value=kk; connectKickAuto().then(function(){ setConnState(); }).catch(function(){}); }

  setConnState();
});

/* ripple Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
document.addEventListener('click', function(e){
  if(e.target && e.target.tagName==='BUTTON'){
    var r=e.target.getBoundingClientRect();
    e.target.style.setProperty('--x',(e.clientX-r.left)+'px');
    e.target.style.setProperty('--y',(e.clientY-r.top)+'px');
  }
});
</script>

<!-- (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø¥Ù† ÙˆÙØ¬Ø¯ Ù…Ù„Ù ÙŠÙˆÙÙ‘Ø± window.connectToKick(channel, onMessage) -->
<script src="kick_chat.js"></script>
</body>
</html>
