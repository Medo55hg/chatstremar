<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>🎯 لعبة الكلمات المبعثرة</title>
  <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
  <!-- تمي.js (احتفظت بنفس المراجع) -->
  <script src="https://cdn.jsdelivr.net/npm/tmi.js@1.8.5/dist/tmi.min.js"></script>
  <script src="tmi.min.js"></script>
  <style>
    :root{
      --red:#ff3333;
      --bg:#111;
      --panel:#222;
      --line:#444;
      --ok:#00ffcc;
      --warn:#ffcc00;
      --blue:#0099ff;
    }
    body{
      background:var(--bg);
      color:#fff;
      font-family:'Amiri',serif;
      text-align:center;
      padding:20px;
    }
    h1{ color:var(--red); margin-top:10px; }

    /* لوحة الإعدادات الجديدة */
    .settings{
      width:90%;max-width:1200px;margin:50px auto 15px;
      background:var(--panel);border:1px solid var(--line);
      border-radius:12px;padding:12px;display:grid;gap:10px;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    }
    .settings .item{
      background:#1a1a1a;border:1px solid #333;border-radius:10px;padding:10px;
      display:flex;flex-direction:column;gap:6px;font-size:18px
    }
    .settings input[type="number"]{padding:8px;border-radius:8px;border:none;font-size:18px}
    .settings label{font-size:16px}
    .settings .switch{display:flex;align-items:center;gap:8px;justify-content:center}

    .game-area{
      font-size:28px;margin:12px auto;background:#222;padding:22px;border-radius:15px;
      width:90%;max-width:1200px;border:2px solid var(--red);
      position:relative;
    }
    input,button{
      padding:12px;font-size:20px;margin:8px auto;border-radius:8px;border:none;font-family:'Amiri',serif
    }
    input.player-input{ width:90%; box-sizing:border-box; }
    button{ background:var(--red); color:#fff; cursor:pointer; }
    .teams-container{
      display:flex;justify-content:space-between;align-items:flex-start;margin:20px auto;width:90%;gap:20px;flex-wrap:wrap
    }
    .team{ width:20%;min-width:240px;padding:15px;border-radius:15px;text-align:center }
    .team-blue{ background:rgba(0,0,255,.1); border:2px solid var(--blue); }
    .team-red{ background:rgba(255,0,0,.1); border:2px solid var(--red); }
    .players-list{ background:#333;padding:10px;border-radius:8px;min-height:50px;font-size:18px;text-align:right }
    .player-entry{ display:flex;justify-content:space-between;align-items:center;margin:2px 0 }
    .player-entry button{ background:#900;font-size:14px;padding:2px 6px;border:none;border-radius:6px;cursor:pointer }

    .game-description{
      width:50%;min-width:280px;background:#222;border:1px solid #555;border-radius:10px;padding:15px;font-size:18px;line-height:1.6
    }
    .current-player{ font-size:26px;margin:16px 0;color:var(--ok) }

    /* تكبير وتمركز الكلمة المبعثرة */
    .scrambled-word{
      font-size:84px; font-weight:700; margin:14px 0;
      letter-spacing:6px; word-spacing:18px; line-height:1.15;
      display:flex; align-items:center; justify-content:center;
      min-height:200px; /* مساحة كافية لتكون بنص المنطقة */
    }

    .timer{ font-size:26px;color:var(--warn);margin:10px 0;font-weight:bold }
    .progress{ height:10px;width:100%;max-width:640px;background:#333;margin:8px auto;border-radius:10px;overflow:hidden;border:1px solid #444 }
    .bar{ height:100%;width:0%;background:linear-gradient(90deg,var(--red),#ff7a7a) }

    .guess-result{ font-size:22px;margin-top:8px;min-height:28px }
    .scoreboard{ margin-top:18px;font-size:22px }

    .answer-box{
      position:fixed;bottom:20px;left:20px;text-align:center;font-size:20px;color:#fff;z-index:100;
      background:#222;border:1px solid #444;border-radius:10px;padding:10px 12px
    }
    .commands-highlight{ color:var(--red);font-weight:bold;margin-top:10px;display:block }
    .hint{ font-size:18px; color:#9fe8d8; margin-top:6px; }

    /* أزرار صغيرة ثانوية */
    .btn-secondary{ background:#444 }
    .btn-green{ background:#28a745 }
    .btn-yellow{ background:#b38f00 }
    .btn-reset{ background:#555; }
  </style>
</head>
<body>

<h1>🎯 لعبة الكلمات المبعثرة</h1>

<!-- لوحة الإعدادات -->
<div class="settings">
  <div class="item">
    ⏱️ <strong>وقت الجولة (ث)</strong>
    <input type="number" id="roundTime" min="10" max="180" step="5" value="30">
  </div>
  <div class="item">
    🏆 <strong>النتيجة المطلوبة</strong>
    <input type="number" id="targetScore" min="5" max="50" step="1" value="15">
  </div>
  <div class="item switch">
    <input type="checkbox" id="autoTimer" checked>
    <label for="autoTimer">بدء المؤقت تلقائيًا</label>
  </div>
  <div class="item switch">
    <input type="checkbox" id="autoNext" checked>
    <label for="autoNext">الانتقال تلقائيًا بعد الإجابة</label>
  </div>
  <div class="item">
    🎛️ <strong>تحكم سريع</strong>
    <button class="btn-secondary" id="pauseResumeBtn" onclick="toggleTimer()">⏸️/▶️ إيقاف/استئناف</button>
    <button class="btn-yellow" onclick="useHint()">💡 تلميح (−5ث)</button>
  </div>
</div>

<div class="teams-container">
  <div class="team team-blue">
    <h3>🔵 الفريق الأزرق</h3>
    <input type="text" id="bluePlayerInput" class="player-input" placeholder="اسم اللاعب">
    <!-- تمت إزالة زر الإضافة -->
    <div id="bluePlayers" class="players-list"></div>
  </div>

  <div class="game-description">
    ✅ <strong>شرح اللعبة:</strong><br>
    ستظهر كلمة مبعثرة في وسط الشاشة.<br>
    على اللاعبين إعادة ترتيبها بشكل صحيح خلال الوقت المحدد.<br>
    يمكن للمنظّم ضبط وقت الجولة والنتيجة المطلوبة من الأعلى.<br>
    أول فريق يصل إلى النتيجة المطلوبة يعتبر الفائز 🏆.<br>
    <span class="commands-highlight">
      📝 أوامر الشات:<br>
      🔵 !ازرق للانضمام للفريق الأزرق — 🔴 !احمر للانضمام للفريق الأحمر
    </span>
    <div class="hint">اختصارات: Space (إيقاف/استئناف المؤقت) – N (التالي) – H (تلميح)</div>
  </div>

  <div class="team team-red">
    <h3>🔴 الفريق الأحمر</h3>
    <input type="text" id="redPlayerInput" class="player-input" placeholder="اسم اللاعب">
    <!-- تمت إزالة زر الإضافة -->
    <div id="redPlayers" class="players-list"></div>
  </div>
</div>

<div class="game-area">
  <button id="startButton" onclick="startGame()">🎮 ابدأ اللعبة</button>
  <div id="currentPlayer" class="current-player">⬇️ اللاعب الحالي سيظهر هنا</div>
  <div id="scrambledWord" class="scrambled-word">🔤 الكلمة هنا</div>
  <div id="timer" class="timer"></div>
  <div class="progress"><div id="bar" class="bar"></div></div>
  <button id="startTimerButton" onclick="startTimer()">⏳ ابدأ المؤقت</button>

  <!-- تمت إزالة حقل الكتابة وزر التأكيد -->
  <div id="guessResult" class="guess-result"></div>
  <br>
  <button class="btn-secondary" onclick="nextTurn()">⏭️ التالي</button>
  <div class="scoreboard">
    🔵 الفريق الأزرق: <span id="blueScore">0</span> نقطة<br>
    🔴 الفريق الأحمر: <span id="redScore">0</span> نقطة<br>
    <button class="btn-reset" onclick="resetScores()">🔄 تصفير النقاط</button>
  </div>
</div>

<div class="answer-box">
  ⚠️ الإجابة: <span id="answerText">❓</span>
  <br>
  <button class="btn-secondary" onclick="toggleAnswer()">👁️ إخفاء/إظهار الإجابة</button>
</div>

<div style="margin-top:20px;">
  <select id="platformSelect" style="padding:10px;font-size:18px;">
    <option value="twitch">Twitch</option>
    <option value="kick">Kick</option>
  </select>
  <input type="text" id="channelInput" placeholder="🎮 اكتب اسم القناة" style="padding:10px;font-size:18px;">
  <button onclick="connectChat()" class="btn-green" style="padding:10px;font-size:18px;border:none;border-radius:6px;cursor:pointer;">
    ✅ تسجيل الدخول
  </button>
  <div id="chatStatus" style="margin-top:10px;font-size:16px;color:#0f0;"></div>
</div>

<script>
/* ========= البيانات والحالة ========= */
const bluePlayers = [];
const redPlayers = [];
let blueTurnOrder = [];
let redTurnOrder = [];

let turnIndex = 0;
let currentAnswer = "";
let blueScore = 0;
let redScore = 0;
let roundSeconds = 30;
let targetScore = 15;
let autoTimer = true;
let autoNext = true;

let timeLeft = 0;
let timerInterval;
let timerRunning = false;
let twitchClient;
let currentPlayerName = "";
let answeringTeam = "";
const usedWords = [];

/* ========= قائمة الكلمات (كما هي) ========= */
const words = [/* نفس قائمتك الطويلة هنا كما أرسلتها */ 
"أمل","حياة","نور","سعادة","شمس","قمر","سماء","نجمة","بحر","نهر",
"جبل","وردة","زهرة","شجرة","غابة","طيور","أسد","نمر","فهد","ذئب",
"دب","حصان","حمار","بقرة","غزال","سمكة","حوت","دلفين","نحلة","فراشة",
"نملة","عصفور","ببغاء","صقر","بومة","ديك","دجاجة","بط","وزة","بطة",
"كلب","قطة","جمل","قرش","تمساح","سلحفاة","ثعبان","عقرب","ضفدع","قرد",
"كنغر","طاووس","نعامة","حمامة","غراب","بلبل","يمامة","دراج","دبور","جرادة",
"صرصور","يراعة","خفاش","أرنب","حرباء","غرير","لاما","موظ","ظبي","ضبع",
"تنين","أسطورة","ساحر","قلعة","عرش","تاج","ملك","ملكة","أمير","أميرة",
"وزير","جيش","سيف","درع","رمح","قوس","سهم","حربة","خوذة","فرس",
"نسر","شعلة","لهب","جمر","ريح","عاصفة","ثلج","برد","صقيع","صحراء",
"واحة","رمل","طين","بركان","زلزال","مطر","ندى","غيم","عشب","أرض",
"تربة","حديقة","مزرعة","بستان","دوحة","مدينة","قرية","بلدة","سوق","مكتبة",
"مدرسة","جامعة","مسجد","كنيسة","معبد","متحف","قصر","مسرح","مستشفى","مطعم",
"مقهى","فندق","مطار","ميناء","محطة","قطار","حافلة","سيارة","دراجة","سفينة",
"طائرة","صاروخ","قارب","غواصة","مروحية","مصباح","شمعة","بطارية","هاتف","حاسوب",
"لوحة","ساعة","كتاب","دفتر","قلم","فرشاة","ممحاة","مسطرة","مقص","مرآة",
"كرسي","طاولة","سرير","خزانة","باب","نافذة","ستارة","سجادة","وسادة","بطانية",
"حقيبة","صندوق","درج","رف","طبق","كوب","ملعقة","سكين","شوكة","قدر",
"مقلاة","غلاية","زجاجة","جرة","وعاء","مصفاة","مغسلة","ثلاجة","فرن","مكيف",
"مدفأة","مروحة","غسالة","مجفف","مكنسة","ممسحة","سلة","علبة","مغلف","مطرقة",
"مسمار","مفتاح","كماشة","منشار","مبرد","مثقاب","حبل","سلسلة","قفل","ميزان",
"ميزاب","خرطوم","برميل","دلو","سطل","اسفنجة","صابون","معجون","مرطب","مرهم",
"دواء","عطر","بخور","منشفة","شرشف","حجاب","قبعة","قميص","بنطال","تنورة",
"فستان","جاكيت","معطف","حذاء","جورب","قفاز","نظارة","حزام","محفظة",
"خاتم","قلادة","حلق","زينة","مظلة","شرفة","سطح","سرداب","قبو",
"دهليز","ردهة","صالة","مطبخ","ممر","بوابة","سور","سياج","رصيف",
"جسر","نفق","ميدان","شارع","زقاق","درب","طريق","مسار","رحلة","سفرة",
"جولة","نزهة","مغامرة","اكتشاف","بحث","لقاء","موعد","اجتماع","محادثة","نقاش",
"اتفاق","عقد","صفقة","تجارة","بيع","شراء","تبادل","هدية","تذكار","تحفة",
"صورة","رسم","تمثال","طابع","ختم","ظرف","وثيقة","بطاقة","جواز",
"ترخيص","فاتورة","إيصال","سجل","مفكرة","مذكرة","تقرير","قصة","رواية",
"مجلة","جريدة","إعلان","دعاية","شعار","علامة","رمز","خريطة","جدول","تصميم",
"خطة","برنامج","طريقة","نمط","شكل","بنية","هيكل","عمارة","زخرفة","نقش",
"تطريز","صباغة","ترميم","صيانة","تصوير","طباعة","نسخ","ترجمة","تحرير","إعداد",
"إنتاج","نشر","إذاعة","تسجيل","عرض","مشاركة","توزيع","تحميل","تشغيل","إيقاف",
"بدء","تحديث","تطوير","إصلاح","تغيير","حذف","إضافة","لصق","حفظ",
"رفع","تنزيل","إرسال","استقبال","ضبط","تهيئة","تفعيل","إلغاء","حماية",
"تشفير","برمجة","اختبار","توثيق","دعم","متابعة","إدارة","قيادة",
"تنظيم","توجيه","مراقبة","تقييم","تحليل","ابتكار","استكشاف","تعليم","تدريب","تدريس",
"شرح","توضيح","إيضاح","تحسين","تعديل","تجربة","محاولة","إنجاز","نجاح","تميز",
"شغف","إلهام","إبداع","خيال","فكر","وعي","إدراك","حكمة","معرفة","خبرة",
"موهبة","مهارة","قدرة","كفاءة","تخصص","اهتمام","فضول","رغبة","عزيمة",
"إرادة","طموح","تفاؤل","إيمان","يقين","ثقة","إخلاص","محبة",
"مودة","رحمة","عطف","حنان","رعاية","تعاون","مساعدة","تضامن","مواساة",
"صداقة","أخوة","قرابة","جار","ضيف","زميل","شريك","رفيق","معارف","ناس",
"شخص","رجل","امرأة","طفل","شاب","فتاة","كهل","شيخ","مسن","عجوز",
"رضيع","مراهق","يتيم","أرمل","أعزب","متزوج","مطلق","حبيب","خطيب","صديق",
"عدو","خصم","منافس","تابع","مستقل","محايد","زعيم","قائد","رئيس",
"وكيل","نائب","سفير","والي","حاكم","قاضي","محامي","شرطي","جندي",
"طيار","بحار","سائق","عامل","حارس","مزارع","صياد","صانع","بائع","تاجر",
"نجار","حداد","خياط","حلاق","مصور","مخرج","ممثل","مغني",
"شاعر","كاتب","مؤلف","ناقد","موسيقي","فنان","أديب","عالم","باحث","مخترع",
"مبتكر","مكتشف","مدير","مسؤول","مدرب","معلم","مرشد","واعظ","إمام",
"داعية","زاهد","حكيم","فقيه","مؤرخ","صحفي","مذيع","مراسل","محرر",
"مترجم","مدقق","ناشر","موزع","مسوق","مطور","مبرمج","مصمم","منتج","منشد",
"مؤذن","حافظ","قارئ","ناسخ","خطاط","زخرف","منقوش","كهربائي",
"سباك","بناء","راعي","مربي","طباخ","جزار","خباز",
"ساعي","مستشار","سلطان","خليفة","أستاذ","محاسب",
"طبيب","صيدلي","ممرض","جراح","معالج","خبير","فني","مهندس","مفكر","ناظر",
"مفتش","مراقب","مشغل","ملاحظ","نادل","خادم","حمال","بواب","ناطور","مشرف",
"ابتسامة","إصرار","إنجاز","إيثار","بساطة","بهجة","تحدي","تفاني","تماسك","ثبات",
"جمال","جود","حب","حلم","خجل","دعم","ذكاء","روح","زهد","سخاء",
"سلام","شجاعة","صبر","ضحك","طمأنينة","عطاء","فرح","فخر","قوة","كرم",
"لطف","مرح","نقاء","هدوء","وفاء","يسر","أمان","إبداع","براءة","تآلف",
"تسامح","تواضع","جاذبية","حكمة","خيال","دفء","رقة","شهامة","صفاء","عزيمة",
"عفوية","غرور","فطرة","قناعة","لباقة","مروءة","نبل","هيبة","وداعة","يأس",
"إتقان","بشاشة","تألق","تعاطف","جد","حزم","خبرة","دقة","رزانة","سعادة",
"شموخ","صدق","طموح","عفة","غموض","فطنة","قدر","كياسة","مثابرة","نشاط",
"همة","ألفة","بشر","تكافل","ثقة","حياة","خوف","ذوق","رحيل","زهو",
"شوق","صمود","عشق","فروسية","قدرة","كلمة","مودة","نقاش","همس","وجد",
"إحسان","بصيرة","تميز","حكمة","دلال","راحة","سحر","شغف","ضياء","عبرة",
"فن","قيمة","لغة","مهارة","نور","هوية","ابتكار","بريق","تحمل","تعلق",
"جلال","حنين","دعابة","رومانسية","سمو","شعر","صخب","عظمة","فلسفة","قبس",
"لمسة","مزاج","نغم","هبة","إرث","بسالة","تأمل","جرأة","حضور","خبر",
"دين","ريادة","سكون","شراكة","صديق","عطش","فكر","قدوة","لقاء","مبدأ",
"نضج","هيام","إشراق","بزوغ","تحقيق","تضحية","جذل","حكاية","دراية","رغبة",
"سرد","شكر","صدى","عز","فهم","قلب","مقصد","نهضة","وجدان","إلهام",
"بزوغ","تناغم","حوار","ذكاء","رواية","سعادة","شعر","صوت","عالم","فنون",
"قصة","مكتب","نهاية","هندسة","ابتكار","بحر","تاريخ","حضارة","دواء","رسم",
"سفر","شمس","صحة","علم","فلك","قمر","موسيقى","نجوم","هواء","ياقوت"
];

/* ========= أدوات مساعدة ========= */
// توحيد نص عربي للمقارنة
function normalizeArabic(s){
  if(!s) return "";
  return s
    .replace(/[\u0640]/g,'')       // إزالة التطويل
    .replace(/[إأآا]/g,'ا')        // توحيد الألف
    .replace(/ى/g,'ي')             // ألف مقصورة -> ياء
    .replace(/ؤ/g,'و').replace(/ئ/g,'ي')
    .replace(/ة/g,'ه')             // ة -> ه (اختياري)
    .replace(/\s+/g,'')            // إزالة المسافات
    .trim();
}
function playTone(ok=true){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type='sine'; o.frequency.value = ok?660:220; g.gain.value=0.05;
    o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{o.stop();ctx.close()}, ok?120:180);
  }catch{}
}
function shuffleWord(word){
  let arr = word.split('');
  let shuffled;
  do{
    shuffled = arr.slice();
    for(let i=shuffled.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [shuffled[i],shuffled[j]]=[shuffled[j],shuffled[i]];
    }
  }while(shuffled.join('')===word);
  return shuffled.join(' ');
}

function updatePlayerList(team){
  const listId = team==='blue' ? "bluePlayers" : "redPlayers";
  const players = team==='blue' ? bluePlayers : redPlayers;
  document.getElementById(listId).innerHTML = players.map((p,i)=>`
    <div class="player-entry">
      <span>• ${p}</span>
      <button onclick="removePlayer('${team}',${i})">🗑️</button>
    </div>
  `).join("");
  saveState();
}

function addPlayer(team){
  const inputId = team==='blue' ? "bluePlayerInput" : "redPlayerInput";
  const name = document.getElementById(inputId).value.trim();
  if(name===""){ alert("❌ الرجاء كتابة اسم اللاعب"); return; }
  if(team==='blue'){
    if(!bluePlayers.includes(name)){ bluePlayers.push(name); blueTurnOrder.push(name); }
  }else{
    if(!redPlayers.includes(name)){ redPlayers.push(name); redTurnOrder.push(name); }
  }
  updatePlayerList(team);
  document.getElementById(inputId).value="";
}

function removePlayer(team,index){
  let removed;
  if(team==='blue'){
    removed = bluePlayers.splice(index,1)[0];
    blueTurnOrder = blueTurnOrder.filter(p=>p!==removed);
  }else{
    removed = redPlayers.splice(index,1)[0];
    redTurnOrder = redTurnOrder.filter(p=>p!==removed);
  }
  updatePlayerList(team);
}

/* ========= تخزين محلي ========= */
function saveState(){
  localStorage.setItem('wm_bluePlayers', JSON.stringify(bluePlayers));
  localStorage.setItem('wm_redPlayers', JSON.stringify(redPlayers));
  localStorage.setItem('wm_scores', JSON.stringify({blueScore,redScore}));
  localStorage.setItem('wm_settings', JSON.stringify({
    roundSeconds, targetScore, autoTimer, autoNext
  }));
}
function loadState(){
  try{
    const bp = JSON.parse(localStorage.getItem('wm_bluePlayers')||'[]');
    const rp = JSON.parse(localStorage.getItem('wm_redPlayers')||'[]');
    bp.forEach(p=>{ if(!bluePlayers.includes(p)) bluePlayers.push(p); });
    rp.forEach(p=>{ if(!redPlayers.includes(p)) redPlayers.push(p); });
    blueTurnOrder=[...bluePlayers]; redTurnOrder=[...redPlayers];
    const sc = JSON.parse(localStorage.getItem('wm_scores')||'{}');
    if(typeof sc.blueScore==='number') blueScore=sc.blueScore;
    if(typeof sc.redScore==='number') redScore=sc.redScore;
    document.getElementById('blueScore').innerText=blueScore;
    document.getElementById('redScore').innerText=redScore;

    const st = JSON.parse(localStorage.getItem('wm_settings')||'{}');
    if(st.roundSeconds) roundSeconds=st.roundSeconds;
    if(st.targetScore) targetScore=st.targetScore;
    if(typeof st.autoTimer==='boolean') autoTimer=st.autoTimer;
    if(typeof st.autoNext==='boolean') autoNext=st.autoNext;

    document.getElementById('roundTime').value=roundSeconds;
    document.getElementById('targetScore').value=targetScore;
    document.getElementById('autoTimer').checked=autoTimer;
    document.getElementById('autoNext').checked=autoNext;

    updatePlayerList('blue'); updatePlayerList('red');
  }catch{}
}

/* ========= إعدادات UI ========= */
document.getElementById('roundTime').addEventListener('change', e=>{
  const v = parseInt(e.target.value||30,10);
  roundSeconds = Math.max(10, Math.min(180, v));
  saveState();
});
document.getElementById('targetScore').addEventListener('change', e=>{
  const v = parseInt(e.target.value||15,10);
  targetScore = Math.max(5, Math.min(50, v));
  saveState();
});
document.getElementById('autoTimer').addEventListener('change', e=>{
  autoTimer = !!e.target.checked; saveState();
});
document.getElementById('autoNext').addEventListener('change', e=>{
  autoNext = !!e.target.checked; saveState();
});

/* ========= المؤقت ========= */
function renderBar(){
  const bar = document.getElementById('bar');
  const pct = Math.max(0, Math.min(100, (timeLeft/roundSeconds)*100));
  bar.style.width = pct + '%';
}
function startTimer(){
  if(timerRunning) return;
  timeLeft = roundSeconds;
  document.getElementById('timer').innerText = `⏳ الوقت المتبقي: ${timeLeft} ثانية`;
  renderBar();
  clearInterval(timerInterval);
  timerRunning = true;
  timerInterval = setInterval(()=>{
    timeLeft--;
    document.getElementById('timer').innerText = `⏳ الوقت المتبقي: ${timeLeft} ثانية`;
    renderBar();
    if(timeLeft<=0){
      clearInterval(timerInterval);
      timerRunning=false;
      document.getElementById('timer').innerText = "⏳ انتهى الوقت!";
    }
  },1000);
}
function stopTimer(){
  clearInterval(timerInterval);
  timerRunning=false;
}
function toggleTimer(){
  if(timerRunning){ stopTimer(); }
  else{
    if(timeLeft>0){ // استئناف
      timerRunning=true;
      timerInterval=setInterval(()=>{
        timeLeft--;
        document.getElementById('timer').innerText = `⏳ الوقت المتبقي: ${timeLeft} ثانية`;
        renderBar();
        if(timeLeft<=0){ stopTimer(); document.getElementById('timer').innerText="⏳ انتهى الوقت!"; }
      },1000);
    }else{ startTimer(); }
  }
}

/* ========= جولات اللعب ========= */
function startGame(){
  document.getElementById("startButton").style.display="none";
  blueTurnOrder=[...bluePlayers];
  redTurnOrder=[...redPlayers];
  turnIndex=0;
  nextTurn();
}
function pickNewWord(){
  let available = words.filter(w=>!usedWords.includes(w));
  if(available.length===0){ usedWords.length=0; available = words.slice(); }
  const w = available[Math.floor(Math.random()*available.length)];
  usedWords.push(w);
  currentAnswer = w;
  document.getElementById("scrambledWord").innerText = shuffleWord(w);
  document.getElementById("answerText").innerText = w;
  document.getElementById("guessResult").innerText="";
}
function nextTurn(){
  stopTimer();
  document.getElementById("timer").innerText = "";
  document.getElementById('bar').style.width='0%';

  if(blueTurnOrder.length===0 || redTurnOrder.length===0){
    alert("❌ يجب وجود لاعبين في كلا الفريقين!");
    return;
  }
  const isBlueTurn = turnIndex % 2 === 0;
  if(isBlueTurn){
    const i = Math.floor(turnIndex/2) % blueTurnOrder.length;
    currentPlayerName = blueTurnOrder[i];
    answeringTeam='blue';
  }else{
    const i = Math.floor(turnIndex/2) % redTurnOrder.length;
    currentPlayerName = redTurnOrder[i];
    answeringTeam='red';
  }
  document.getElementById("currentPlayer").innerText = `🎮 الدور الآن: ${currentPlayerName}`;
  turnIndex++;
  pickNewWord();
  if(autoTimer) startTimer();
}

/* ========= تلميح ========= */
function useHint(){
  if(!timerRunning && timeLeft===0){ return; }
  // خصم 5 ثوانٍ وكشف أول وآخر حرف
  timeLeft = Math.max(0, timeLeft-5);
  renderBar();
  const ans = currentAnswer;
  if(ans && ans.length>=2){
    const first = ans[0], last = ans[ans.length-1];
    document.getElementById('guessResult').innerHTML = `💡 تلميح: يبدأ بـ (<b>${first}</b>) وينتهي بـ (<b>${last}</b>). -5 ثوانٍ`;
    if(timeLeft===0){ stopTimer(); document.getElementById('timer').innerText="⏳ انتهى الوقت!"; }
  }
}

/* ========= التحقق من الإجابة عبر الشات فقط ========= */
function checkAnswer(username, content){
  if(!timerRunning) return;
  // يجب أن يكون اللاعب الحالي فقط
  if(username!==currentPlayerName) return;

  const ok = normalizeArabic(content) === normalizeArabic(currentAnswer);
  if(ok){
    document.getElementById("guessResult").innerHTML = `✅ ${username} أجاب بشكل صحيح!`;
    playTone(true);
    stopTimer();
    if(answeringTeam==='red'){
      redScore++; document.getElementById("redScore").innerText=redScore;
      if(redScore>=targetScore){ alert("🏆 الفريق الأحمر فاز!"); }
    }else{
      blueScore++; document.getElementById("blueScore").innerText=blueScore;
      if(blueScore>=targetScore){ alert("🏆 الفريق الأزرق فاز!"); }
    }
    saveState();
    if(autoNext){ setTimeout(nextTurn, 1000); }
  }else{
    document.getElementById("guessResult").innerText = `❌ إجابة غير صحيحة`;
    playTone(false);
  }
}

/* ========= إظهار/إخفاء الإجابة ========= */
function toggleAnswer(){
  const el = document.getElementById("answerText");
  el.style.visibility = el.style.visibility==="hidden" ? "visible" : "hidden";
}

/* ========= تصفير النقاط فقط ========= */
function resetScores(){
  blueScore = 0; redScore = 0;
  document.getElementById('blueScore').innerText = blueScore;
  document.getElementById('redScore').innerText = redScore;
  saveState();
}

/* ========= زر العودة ========= */
function goHome(){
  if(document.referrer){
    history.back();
  }else{
    // غيّر المسار حسب مشروعك
    try { location.href = 'index.html'; }
    catch { location.href = '/'; }
  }
}

/* ========= اتصال الشات ========= */
function connectChat(){
  const platform = document.getElementById("platformSelect").value;
  const channel = document.getElementById("channelInput").value.trim();
  if(!channel){ alert("اكتب اسم القناة"); return; }

  if(platform==="twitch"){
    twitchClient = new tmi.Client({ channels:[channel] });
    twitchClient.connect();
    twitchClient.on('message',(channel,tags,message,self)=>{
      const username = tags['display-name'];
      const content = (message||"").trim();

      if(content==="!ازرق"){
        if(!bluePlayers.includes(username)){ bluePlayers.push(username); blueTurnOrder.push(username); updatePlayerList("blue"); }
      }else if(content==="!احمر"){
        if(!redPlayers.includes(username)){ redPlayers.push(username); redTurnOrder.push(username); updatePlayerList("red"); }
      }else if(timerRunning && username===currentPlayerName){
        if(normalizeArabic(content) === normalizeArabic(currentAnswer)){
          checkAnswer(username, content); // سيعالج الفوز والتقدم
        }
      }
    });
    document.getElementById("chatStatus").innerText = "✅ تم الاتصال بـ Twitch!";
  }else if(platform==="kick"){
    (async()=>{
      try{
        const res = await fetch(`https://kick.com/api/v2/channels/${channel}`);
        const data = await res.json();
        const roomId = data.chatroom.id;

        const socket = new WebSocket("wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=8.4.0-rc2&flash=false");
        socket.onopen = ()=>{
          socket.send(JSON.stringify({event:"pusher:subscribe",data:{auth:"",channel:`chatrooms.${roomId}.v2`}}));
          setInterval(()=>{ if(socket.readyState===WebSocket.OPEN){ socket.send(JSON.stringify({event:"pusher:ping",data:{}})); } },12000);
        };
        socket.onmessage = (event)=>{
          const msg = JSON.parse(event.data);
          if(msg.event==="App\\Events\\ChatMessageEvent"){
            const d = JSON.parse(msg.data);
            const username = d.sender.username;
            const content = (d.content||"").trim();

            if(content==="!ازرق"){
              if(!bluePlayers.includes(username)){ bluePlayers.push(username); blueTurnOrder.push(username); updatePlayerList("blue"); }
            }else if(content==="!احمر"){
              if(!redPlayers.includes(username)){ redPlayers.push(username); redTurnOrder.push(username); updatePlayerList("red"); }
            }else if(timerRunning && username===currentPlayerName){
              if(normalizeArabic(content) === normalizeArabic(currentAnswer)){
                checkAnswer(username, content);
              }
            }
          }
        };
        document.getElementById("chatStatus").innerText = "✅ تم الاتصال بـ Kick!";
      }catch(e){
        console.error("Kick connection error:", e);
        document.getElementById("chatStatus").innerText = "❌ فشل الاتصال بـ Kick!";
      }
    })();
  }
}

/* ========= أحداث لوحة المفاتيح ========= */
document.addEventListener('keydown', (e)=>{
  if(e.code==="Space"){ e.preventDefault(); toggleTimer(); }
  else if(e.key==="n" || e.key==="N"){ nextTurn(); }
  else if(e.key==="h" || e.key==="H"){ useHint(); }
});

/* ========= بدء الصفحة ========= */
window.addEventListener('DOMContentLoaded', ()=>{
  loadState();
});
</script>
</body>
</html>
