<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>🎯 لعبة الكلمات المبعثرة</title>
  <!-- خط Cairo -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- tmi.js لتويتش -->
  <script src="https://cdn.jsdelivr.net/npm/tmi.js@1.8.5/dist/tmi.min.js"></script>
  <script src="tmi.min.js"></script>
  <style>
    :root{
      --red:#ff3333; --bg:#111; --panel:#222; --line:#444; --ok:#00ffcc; --warn:#ffcc00; --blue:#0099ff;
      --primary:#ff3333; --accent:#9146ff; --bg-900:#0e0f1a; --bg-deep:#0a0b14;

      /* خلفية ستايل2026 */
      --bg1:#1a1a3d;         /* داكن 1 */
      --bg2:#004466;         /* داكن 2 */
      --text:#fff;           /* لون النص الافتراضي */
    }

    /* وضع الفاتح لستايل2026 */
    [data-theme="light"]{
      --bg1:#f2f6ff;         /* فاتح 1 */
      --bg2:#dfe9ff;         /* فاتح 2 */
      --text:#111;           /* لون النص في الفاتح */
    }

    html, body{ height:100%; }
    body{
      margin:0;color:var(--text);font-family:'Cairo',sans-serif;text-align:center;padding:20px;

      /* ✅ خلفية ستايل2026 (بدلاً من الخلفيات القديمة) */
      background: linear-gradient(-45deg, var(--bg1), var(--bg2), var(--bg1), var(--bg2));
      background-size: 400% 400%;
      animation: gradientBG 20s ease infinite;

      overflow-x:hidden;
    }

    /* أنيميشن الخلفية */
    @keyframes gradientBG {
      0%   { background-position: 0% 50% }
      50%  { background-position: 100% 50% }
      100% { background-position: 0% 50% }
    }

    /* حاوية عامة أعرض */
    .container{ width:96vw; max-width:1800px; margin:0 auto; }

    /* خلفيات زخرفية (تبقى كما هي — إن حبيت نشيلها لاحقًا خبرني) */
    .grid-bg{ position:fixed; inset:0; pointer-events:none; z-index:0;
      background-image:
        linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size:40px 40px, 40px 40px;
    }
    .blob,.blob2{ position:fixed; filter:blur(40px); opacity:.4; z-index:0; pointer-events:none; border-radius:50%; }
    .blob{ width:420px;height:420px; top:-120px; left:-120px; transform:rotate(15deg);
      background:radial-gradient(circle at 30% 30%, var(--accent), transparent 60%);}
    .blob2{ width:720px;height:720px; right:-220px; bottom:-160px;
      background:radial-gradient(circle at 70% 50%, var(--primary), transparent 60%);}
    .bg-sheen{ position:fixed; inset:0; z-index:0; pointer-events:none;
      background:linear-gradient(180deg, rgba(255,255,255,0.00) 0%, rgba(255,255,255,0.02) 35%, rgba(255,255,255,0.00) 100%); }
    @media (prefers-reduced-motion:reduce){ .blob,.blob2,.grid-bg,.bg-sheen{display:none;} }

    /* زر الشرح أعلى يسار */
    .help-btn{
      position:fixed; top:20px; left:20px; z-index:5;
      background:#1b1b1b; border:1px solid #2f2f2f; color:#e6e6e6;
      padding:10px 14px; border-radius:12px; cursor:pointer; font-size:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
    }
    .help-btn:hover{ filter:brightness(1.08); }

    .page-title{
      margin:8px auto 14px; font-size:28px; color:var(--red);
      letter-spacing:.5px; position:relative; z-index:2;
    }

    /* لوحة الاتصال */
    .chat-connect-wrap{ width:100%; margin:0 auto 10px; position:relative; z-index:2; }
    .connect-strip{
      background: linear-gradient(180deg,#1b1b1b,#161616);
      border:1px solid var(--line); color:#ddd; height:56px; border-radius:18px;
      display:flex; align-items:center; justify-content:center; font-size:20px; letter-spacing:.5px; position:relative;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
    }
    .connect-toggle{
      position:absolute; left:16px; top:50%; transform:translateY(-50%);
      width:42px; height:42px; border-radius:12px; border:1px solid #333;
      background:#0f0f0f; color:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center;
      transition:transform .25s ease, background .2s ease;
    }
    .connect-strip.open .connect-toggle{ transform:translateY(-50%) rotate(180deg); }
    .connect-dropdown{ overflow:hidden; max-height:0; transition:max-height .45s ease, opacity .35s ease; opacity:.0; }
    .connect-strip.open + .connect-dropdown{ max-height:520px; opacity:1; }

    .connect-card{
      background: rgba(20,20,20,.92); border:1px solid var(--line); border-radius:22px;
      padding:18px; margin-top:14px; box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
    }
    .connect-grid{ display:grid; gap:18px; grid-template-columns: 1fr 2fr; }
    @media (max-width:900px){ .connect-grid{ grid-template-columns:1fr; } }
    .connect-help{ background:#151515; border:1px solid #313131; border-radius:18px; padding:16px; text-align:right; font-size:16px; line-height:1.9; }
    .connect-help b{ color:#eee; }
    .connect-form{ background:#151515; border:1px solid #313131; border-radius:18px; padding:16px; }
    .connect-rows{ display:grid; gap:14px; grid-template-columns: 1fr 1fr; }
    @media (max-width:700px){ .connect-rows{ grid-template-columns:1fr; } }
    .form-row{ display:flex; flex-direction:column; gap:8px; }
    .form-row label{ font-size:14px; color:#bdbdbd; }
    .connect-input, .connect-select{ background:#101010; color:#fff; border:1px solid #2f2f2f; border-radius:12px; padding:12px 14px; font-size:18px; outline:none; }
    .connect-input:focus, .connect-select:focus{ border-color: var(--red); }
    .connect-actions{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-top:6px; }
    .connect-btn{ background:var(--red); color:#fff; border:none; border-radius:12px; padding:12px 18px; font-size:18px; cursor:pointer;
      box-shadow: 0 6px 18px rgba(255,51,51,.25); }

    .status-chip{
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:14px; font-size:15px;
      border:1px solid #2f2f2f; background:#151515; color:#bdbdbd;
      user-select:none;
    }
    .status-ok{ background:#151e15; border-color:#254a25; color:#9af59a; }
    .status-err{ background:#2a1717; border-color:#4a2525; color:#ffb3b3; }
    .status-gray{ background:#151515; border-color:#2f2f2f; color:#bdbdbd; }

    /* لوحة تحكم الستريمر (إعدادات + أزرار متناسقة) */
    .streamer-wrap{ width:100%; margin:10px auto 0; position:relative; z-index:2; }
    .streamer-strip{
      background: linear-gradient(180deg,#1b1b1b,#161616);
      border:1px solid var(--line); color:#ddd; height:56px; border-radius:18px;
      display:flex; align-items:center; justify-content:center; font-size:20px; letter-spacing:.5px; position:relative;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
    }
    .streamer-toggle{
      position:absolute; left:16px; top:50%; transform:translateY(-50%);
      width:42px; height:42px; border-radius:12px; border:1px solid #333; background:#0f0f0f; color:#fff; cursor:pointer;
      display:flex; align-items:center; justify-content:center; transition:transform .25s ease, background .2s ease;
    }
    .streamer-strip.open .streamer-toggle{ transform:translateY(-50%) rotate(180deg); }
    .streamer-dropdown{ overflow:hidden; max-height:0; transition:max-height .45s ease, opacity .35s ease; opacity:.0; }
    .streamer-strip.open + .streamer-dropdown{ max-height:900px; opacity:1; }

    .streamer-card{
      background: rgba(20,20,20,.92); border:1px solid var(--line); border-radius:22px;
      padding:18px; margin-top:14px; box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
    }
    .streamer-grid{ display:grid; gap:18px; grid-template-columns: 1.1fr 2fr; align-items:start; }
    @media (max-width:1100px){ .streamer-grid{ grid-template-columns:1fr; } }
    .streamer-settings{ background:#151515; border:1px solid #313131; border-radius:18px; padding:16px; text-align:right; }
    .streamer-settings h3{ margin:0 0 8px 0; font-size:18px; color:#eee; }
    .streamer-rows{ display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
    @media (max-width:700px){ .streamer-rows{ grid-template-columns:1fr; } }
    .switch-inline{ display:flex; align-items:center; gap:8px; background:#101010; border:1px solid #2f2f2f; padding:10px 12px; border-radius:12px; }
    .switch-inline input{ width:20px; height:20px; }

    .streamer-actions{ background:#151515; border:1px solid #313131; border-radius:18px; padding:16px; }
    .streamer-actions h3{ margin:0 0 10px 0; font-size:18px; color:#eee; text-align:right; }
    /* نفس ترتيب أزرار مربع اللعبة */
    .controls-bar{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      background:#101010; border:1px solid #2a2a2a; border-radius:14px; padding:12px;
    }
    .controls-right, .controls-left{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .sbtn{
      background:#242424; color:#eee; border:1px solid #333; border-radius:14px; padding:10px 14px; font-size:16px; cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .sbtn:hover{ filter:brightness(1.06); }
    .sbtn.primary{ background:var(--red); border-color:#6b1616; color:#fff; }
    .snote{ font-size:12px; color:#bdbdbd; margin-top:6px; text-align:right; }

    /* المسرح: أعمدة متناسقة وثابتة */
    .stage{
      width:100%; margin:20px auto 0;
      display:grid;
      grid-template-columns: clamp(240px, 18vw, 360px) 1fr clamp(240px, 18vw, 360px);
      gap:24px; align-items:start;
    }
    @media (max-width:1200px){
      .stage{ grid-template-columns: clamp(220px, 22vw, 300px) 1fr clamp(220px, 22vw, 300px); gap:18px; }
    }
    @media (max-width:980px){
      .stage{ grid-template-columns: 1fr; }
    }

    .team{
      box-sizing:border-box;
      padding:15px;border-radius:15px;text-align:center;background:#222;border:1px solid #444;
      min-height:200px;
    }
    .team-blue{ background:rgba(0,0,255,.1); border:2px solid var(--blue); }
    .team-red{ background:rgba(255,0,0,.1); border:2px solid var(--red); }
    .players-list{
      background:#333;padding:10px;border-radius:8px;min-height:80px;font-size:18px;text-align:right;
      max-height:60vh; overflow:auto;
    }

    /* منطقة اللعبة بالمنتصف */
    .game-area{
      box-sizing:border-box;
      font-size:28px;margin:0;background:#222;padding:16px 16px 22px;border-radius:15px;
      width:100%; border:2px solid var(--red); position:relative; z-index:1;
    }
    /* شريط الأزرار العلوي داخل اللعبة */
    .game-actions-bar{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;
      background:#1a1a1a; border:1px solid #333; border-radius:12px; padding:10px;
    }
    .game-actions-right, .game-actions-left{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .gbtn{ background:#242424; color:#eee; border:1px solid #333; border-radius:10px; padding:8px 12px; font-size:16px; cursor:pointer; }
    .gbtn.primary{ background:var(--red); border-color:#6b1616; color:#fff; }
    .gbtn:hover{ filter:brightness(1.06); }

    .current-player{ font-size:24px;margin:6px 0 12px;color:var(--ok) }
    .scrambled-word{ font-size:84px; font-weight:700; margin:14px 0; letter-spacing:6px; word-spacing:18px; line-height:1.15;
      display:flex; align-items:center; justify-content:center; min-height:200px; word-break:break-word; }
    .timer{ font-size:26px;color:var(--warn);margin:10px 0;font-weight:bold }
    .progress{ height:10px;width:100%;max-width:640px;background:#333;margin:8px auto;border-radius:10px;overflow:hidden;border:1px solid #444 }
    .bar{ height:100%;width:0%;background:linear-gradient(90deg,var(--red),#ff7a7a) }
    .guess-result{ font-size:22px;margin-top:8px;min-height:28px }
    .scoreboard{ margin-top:18px;font-size:22px }

    .btn-secondary{ background:#444 } .btn-yellow{ background:#b38f00 }

    .answer-box{
      position:fixed;bottom:20px;left:20px;text-align:center;font-size:20px;color:#fff;z-index:100;
      background:#222;border:1px solid #444;border-radius:10px;padding:10px 12px
    }
    .commands-highlight{ color:var(--red);font-weight:bold;margin-top:10px;display:block }
    .hint{ font-size:18px; color:#9fe8d8; margin-top:6px; }

    /* المودال */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; z-index:50; }
    .modal{
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      width:min(920px, 92vw); max-height:80vh; overflow:auto;
      background:#171717; border:1px solid #333; border-radius:20px; padding:18px 18px 22px;
      box-shadow:0 20px 60px rgba(0,0,0,.45); display:none; z-index:51; text-align:right;
    }
    .modal header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      position:sticky; top:0; background:#171717; padding-bottom:8px; margin-bottom:12px;
      border-bottom:1px solid #2a2a2a;
    }
    .modal h2{ margin:0; font-size:22px; color:#fff; }
    .modal .close{ background:#222; border:1px solid #333; color:#ddd; border-radius:10px; padding:8px 12px; cursor:pointer; }
    .modal .content{ font-size:16px; line-height:1.9; color:#eaeaea; }
    .modal .kbd{ display:inline-block; padding:2px 8px; border:1px solid #555; border-radius:6px; background:#111; font-family:monospace; font-size:14px; }
    .modal ul{ padding-inline-start:18px; margin:6px 0 0; text-align:right; }
    .modal ul li{ margin:4px 0; }
  </style>
</head>
<body>

  <!-- خلفيات -->
  <div class="grid-bg"></div><div class="blob"></div><div class="blob2"></div><div class="bg-sheen"></div>

  <button id="openHelp" class="help-btn">❔ شرح</button>

  <div class="container">
    <div class="page-title">🎯 لعبة الكلمات المبعثرة</div>

    <!-- لوحة الاتصال -->
    <div class="chat-connect-wrap">
      <div id="connectStrip" class="connect-strip">
        <button id="connectToggle" class="connect-toggle">▼</button>
        لوحة الاتصال بالشات
      </div>

      <div class="connect-dropdown">
        <div class="connect-card">
          <div class="connect-grid">
            <div class="connect-help">
              <b>طريقة الاتصال :</b><br>
              اكتب اسم قناتك، اختر المنصة، (اختياري) فعّل تذكّرني، ثم اضغط اتصال.
            </div>

            <div class="connect-form">
              <div class="connect-rows">
                <div class="form-row">
                  <label for="channelInput">اسم القناة:</label>
                  <input type="text" id="channelInput" class="connect-input" placeholder="🎮 اكتب اسم القناة">
                </div>
                <div class="form-row">
                  <label for="platformSelect">نوع المنصة:</label>
                  <select id="platformSelect" class="connect-select">
                    <option value="twitch">Twitch</option>
                    <option value="kick">Kick</option>
                  </select>
                </div>
              </div>

              <div class="connect-actions">
                <button onclick="connectChat()" class="connect-btn">اتصال</button>
                <div id="chatStatus" class="status-chip status-gray">
                  <span>متصل بـ:</span><b id="statusPlatform">—</b>
                </div>
                <label style="display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" id="rememberMe"> تذكّرني
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- لوحة تحكم الستريمر -->
    <div class="streamer-wrap">
      <div id="streamerStrip" class="streamer-strip">
        <button id="streamerToggle" class="streamer-toggle">▼</button>
        لوحة تحكّم الستريمر
      </div>

      <div class="streamer-dropdown">
        <div class="streamer-card">
          <div class="streamer-grid">
            <!-- إعدادات الجولة -->
            <div class="streamer-settings">
              <h3>⚙️ إعدادات الجولة</h3>
              <div class="streamer-rows">
                <div class="form-row">
                  <label for="roundTime">⏱️ وقت الجولة (ث)</label>
                  <input type="number" id="roundTime" class="connect-input" min="10" max="180" step="5" value="30">
                </div>
                <div class="form-row">
                  <label for="targetScore">🏆 النتيجة المطلوبة</label>
                  <input type="number" id="targetScore" class="connect-input" min="5" max="50" step="1" value="15">
                </div>
                <label class="switch-inline" for="autoTimer">
                  <input type="checkbox" id="autoTimer" checked>
                  بدء المؤقت تلقائيًا
                </label>
                <label class="switch-inline" for="autoNext">
                  <input type="checkbox" id="autoNext" checked>
                  الانتقال تلقائيًا بعد الإجابة
                </label>
              </div>
            </div>

            <!-- التحكم السريع -->
            <div class="streamer-actions">
              <h3>🎛️ التحكم السريع</h3>
              <div class="controls-bar">
                <div class="controls-right">
                  <button class="sbtn primary" onclick="startGame()">🎮 ابدأ اللعبة</button>
                </div>
                <div class="controls-left">
                  <button class="sbtn" onclick="startTimer()">⏳ ابدأ المؤقت</button>
                  <button class="sbtn" onclick="nextTurn()">⏭️ التالي</button>
                  <button class="sbtn" onclick="useHint()">💡 تلميح (−5ث)</button>
                  <button class="sbtn" onclick="resetScores()">🔄 تصفير النقاط</button>
                </div>
              </div>
              <div class="snote">نفس ترتيب الأزرار يظهر أعلى مربع اللعبة لسهولة الوصول أثناء البث.</div>
            </div>

          </div><!-- /streamer-grid -->
        </div><!-- /streamer-card -->
      </div><!-- /streamer-dropdown -->
    </div><!-- /streamer-wrap -->

    <!-- المسرح: فريق يمين – لعبة – فريق يسار -->
    <div class="stage">
      <div class="team team-blue">
        <h3>🔵 الفريق الأزرق</h3>
        <div id="bluePlayers" class="players-list"></div>
      </div>

      <div class="game-area">

        <!-- ✅ الشريط العلوي داخل مربع اللعبة -->
        <div class="game-actions-bar">
          <div class="game-actions-right">
            <button id="startButton" class="gbtn primary" onclick="startGame()">🎮 ابدأ اللعبة</button>
          </div>
          <div class="game-actions-left">
            <button class="gbtn" onclick="startTimer()">⏳ ابدأ المؤقت</button>
            <button class="gbtn" onclick="nextTurn()">⏭️ التالي</button>
            <button class="gbtn" onclick="useHint()">💡 تلميح (−5ث)</button>
          </div>
        </div>

        <div id="currentPlayer" class="current-player">⬇️ اللاعب الحالي سيظهر هنا</div>
        <div id="scrambledWord" class="scrambled-word">🔤 الكلمة هنا</div>
        <div id="timer" class="timer"></div>
        <div class="progress"><div id="bar" class="bar"></div></div>

        <div id="guessResult" class="guess-result"></div>

        <div class="scoreboard">
          🔵 الفريق الأزرق: <span id="blueScore">0</span> نقطة<br>
          🔴 الفريق الأحمر: <span id="redScore">0</span> نقطة
        </div>
      </div>

      <div class="team team-red">
        <h3>🔴 الفريق الأحمر</h3>
        <div id="redPlayers" class="players-list"></div>
      </div>
    </div><!-- /stage -->

  </div><!-- /container -->

  <div class="answer-box">
    ⚠️ الإجابة: <span id="answerText">❓</span><br>
    <button class="btn-secondary" onclick="toggleAnswer()">👁️ إخفاء/إظهار الإجابة</button>
  </div>

  <!-- نافذة الشرح -->
  <div id="helpBackdrop" class="modal-backdrop"></div>
  <div id="helpModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
    <header>
      <h2 id="helpTitle">📘 شرح اللعبة بالتفصيل</h2>
      <button id="closeHelp" class="close" aria-label="إغلاق">✖</button>
    </header>
    <div class="content">
      <p>في كل دور، تظهر كلمة <b>مبعثرة</b>. على اللاعب الحالي إعادة ترتيبها بشكل صحيح خلال الوقت المحدد.</p>
      <ul>
        <li>إضافة اللاعبين: يكتبون في الشات <code class="kbd">!ازرق</code> أو <code class="kbd">!احمر</code> للانضمام.</li>
        <li>الدور: يتناوب اللاعبون بين الفريقين تلقائيًا.</li>
        <li>الإجابة: يكتب اللاعب الحالي الكلمة الصحيحة في الشات.</li>
        <li>التلميح: يكشف أول/آخر حرف ويخصم 5 ثوانٍ.</li>
      </ul>
      <p><b>التحكم السريع:</b></p>
      <ul>
        <li>إيقاف/استئناف المؤقت: <span class="kbd">Space</span></li>
        <li>الجولة التالية: <span class="kbd">N</span></li>
        <li>تلميح: <span class="kbd">H</span></li>
      </ul>
      <p><b>الإعدادات:</b> يمكنك ضبط وقت الجولة والنتيجة المطلوبة من لوحة الستريمر.</p>
    </div>
  </div>

<script>
/* ========= الحالة ========= */
const bluePlayers=[]; const redPlayers=[];
let blueTurnOrder=[]; let redTurnOrder=[];
let turnIndex=0, currentAnswer="", blueScore=0, redScore=0;
let roundSeconds=30, targetScore=15, autoTimer=true, autoNext=true;
let timeLeft=0, timerInterval, timerRunning=false;
let twitchClient, kickSocket;
let currentPlayerName="", answeringTeam="";
const usedWords=[];

/* ========= قائمة الكلمات ========= */
/* TODO: ضع قائمة الكلمات هنا:
/* ========= قائمة الكلمات (كما هي) ========= */
const words = [/* نفس قائمتك الطويلة هنا كما أرسلتها */ 
"أمل","حياة","نور","سعادة","شمس","قمر","سماء","نجمة","بحر","نهر",
"جبل","وردة","زهرة","شجرة","غابة","طيور","أسد","نمر","فهد","ذئب",
"دب","حصان","حمار","بقرة","غزال","سمكة","حوت","دلفين","نحلة","فراشة",
"نملة","عصفور","ببغاء","صقر","بومة","ديك","دجاجة","بط","وزة","بطة",
"كلب","قطة","جمل","قرش","تمساح","سلحفاة","ثعبان","عقرب","ضفدع","قرد",
"كنغر","طاووس","نعامة","حمامة","غراب","بلبل","يمامة","دراج","دبور","جرادة",
"صرصور","يراعة","خفاش","أرنب","حرباء","غرير","لاما","موظ","ظبي","ضبع",
"تنين","أسطورة","ساحر","قلعة","عرش","تاج","ملك","ملكة","أمير","أميرة",
"وزير","جيش","سيف","درع","رمح","قوس","سهم","حربة","خوذة","فرس",
"نسر","شعلة","لهب","جمر","ريح","عاصفة","ثلج","برد","صقيع","صحراء",
"واحة","رمل","طين","بركان","زلزال","مطر","ندى","غيم","عشب","أرض",
"تربة","حديقة","مزرعة","بستان","دوحة","مدينة","قرية","بلدة","سوق","مكتبة",
"مدرسة","جامعة","مسجد","كنيسة","معبد","متحف","قصر","مسرح","مستشفى","مطعم",
"مقهى","فندق","مطار","ميناء","محطة","قطار","حافلة","سيارة","دراجة","سفينة",
"طائرة","صاروخ","قارب","غواصة","مروحية","مصباح","شمعة","بطارية","هاتف","حاسوب",
"لوحة","ساعة","كتاب","دفتر","قلم","فرشاة","ممحاة","مسطرة","مقص","مرآة",
"كرسي","طاولة","سرير","خزانة","باب","نافذة","ستارة","سجادة","وسادة","بطانية",
"حقيبة","صندوق","درج","رف","طبق","كوب","ملعقة","سكين","شوكة","قدر",
"مقلاة","غلاية","زجاجة","جرة","وعاء","مصفاة","مغسلة","ثلاجة","فرن","مكيف",
"مدفأة","مروحة","غسالة","مجفف","مكنسة","ممسحة","سلة","علبة","مغلف","مطرقة",
"مسمار","مفتاح","كماشة","منشار","مبرد","مثقاب","حبل","سلسلة","قفل","ميزان",
"ميزاب","خرطوم","برميل","دلو","سطل","اسفنجة","صابون","معجون","مرطب","مرهم",
"دواء","عطر","بخور","منشفة","شرشف","حجاب","قبعة","قميص","بنطال","تنورة",
"فستان","جاكيت","معطف","حذاء","جورب","قفاز","نظارة","حزام","محفظة",
"خاتم","قلادة","حلق","زينة","مظلة","شرفة","سطح","سرداب","قبو",
"دهليز","ردهة","صالة","مطبخ","ممر","بوابة","سور","سياج","رصيف",
"جسر","نفق","ميدان","شارع","زقاق","درب","طريق","مسار","رحلة","سفرة",
"جولة","نزهة","مغامرة","اكتشاف","بحث","لقاء","موعد","اجتماع","محادثة","نقاش",
"اتفاق","عقد","صفقة","تجارة","بيع","شراء","تبادل","هدية","تذكار","تحفة",
"صورة","رسم","تمثال","طابع","ختم","ظرف","وثيقة","بطاقة","جواز",
"ترخيص","فاتورة","إيصال","سجل","مفكرة","مذكرة","تقرير","قصة","رواية",
"مجلة","جريدة","إعلان","دعاية","شعار","علامة","رمز","خريطة","جدول","تصميم",
"خطة","برنامج","طريقة","نمط","شكل","بنية","هيكل","عمارة","زخرفة","نقش",
"تطريز","صباغة","ترميم","صيانة","تصوير","طباعة","نسخ","ترجمة","تحرير","إعداد",
"إنتاج","نشر","إذاعة","تسجيل","عرض","مشاركة","توزيع","تحميل","تشغيل","إيقاف",
"بدء","تحديث","تطوير","إصلاح","تغيير","حذف","إضافة","لصق","حفظ",
"رفع","تنزيل","إرسال","استقبال","ضبط","تهيئة","تفعيل","إلغاء","حماية",
"تشفير","برمجة","اختبار","توثيق","دعم","متابعة","إدارة","قيادة",
"تنظيم","توجيه","مراقبة","تقييم","تحليل","ابتكار","استكشاف","تعليم","تدريب","تدريس",
"شرح","توضيح","إيضاح","تحسين","تعديل","تجربة","محاولة","إنجاز","نجاح","تميز",
"شغف","إلهام","إبداع","خيال","فكر","وعي","إدراك","حكمة","معرفة","خبرة",
"موهبة","مهارة","قدرة","كفاءة","تخصص","اهتمام","فضول","رغبة","عزيمة",
"إرادة","طموح","تفاؤل","إيمان","يقين","ثقة","إخلاص","محبة",
"مودة","رحمة","عطف","حنان","رعاية","تعاون","مساعدة","تضامن","مواساة",
"صداقة","أخوة","قرابة","جار","ضيف","زميل","شريك","رفيق","معارف","ناس",
"شخص","رجل","امرأة","طفل","شاب","فتاة","كهل","شيخ","مسن","عجوز",
"رضيع","مراهق","يتيم","أرمل","أعزب","متزوج","مطلق","حبيب","خطيب","صديق",
"عدو","خصم","منافس","تابع","مستقل","محايد","زعيم","قائد","رئيس",
"وكيل","نائب","سفير","والي","حاكم","قاضي","محامي","شرطي","جندي",
"طيار","بحار","سائق","عامل","حارس","مزارع","صياد","صانع","بائع","تاجر",
"نجار","حداد","خياط","حلاق","مصور","مخرج","ممثل","مغني",
"شاعر","كاتب","مؤلف","ناقد","موسيقي","فنان","أديب","عالم","باحث","مخترع",
"مبتكر","مكتشف","مدير","مسؤول","مدرب","معلم","مرشد","واعظ","إمام",
"داعية","زاهد","حكيم","فقيه","مؤرخ","صحفي","مذيع","مراسل","محرر",
"مترجم","مدقق","ناشر","موزع","مسوق","مطور","مبرمج","مصمم","منتج","منشد",
"مؤذن","حافظ","قارئ","ناسخ","خطاط","زخرف","منقوش","كهربائي",
"سباك","بناء","راعي","مربي","طباخ","جزار","خباز",
"ساعي","مستشار","سلطان","خليفة","أستاذ","محاسب",
"طبيب","صيدلي","ممرض","جراح","معالج","خبير","فني","مهندس","مفكر","ناظر",
"مفتش","مراقب","مشغل","ملاحظ","نادل","خادم","حمال","بواب","ناطور","مشرف",
"ابتسامة","إصرار","إنجاز","إيثار","بساطة","بهجة","تحدي","تفاني","تماسك","ثبات",
"جمال","جود","حب","حلم","خجل","دعم","ذكاء","روح","زهد","سخاء",
"سلام","شجاعة","صبر","ضحك","طمأنينة","عطاء","فرح","فخر","قوة","كرم",
"لطف","مرح","نقاء","هدوء","وفاء","يسر","أمان","إبداع","براءة","تآلف",
"تسامح","تواضع","جاذبية","حكمة","خيال","دفء","رقة","شهامة","صفاء","عزيمة",
"عفوية","غرور","فطرة","قناعة","لباقة","مروءة","نبل","هيبة","وداعة","يأس",
"إتقان","بشاشة","تألق","تعاطف","جد","حزم","خبرة","دقة","رزانة","سعادة",
"شموخ","صدق","طموح","عفة","غموض","فطنة","قدر","كياسة","مثابرة","نشاط",
"همة","ألفة","بشر","تكافل","ثقة","حياة","خوف","ذوق","رحيل","زهو",
"شوق","صمود","عشق","فروسية","قدرة","كلمة","مودة","نقاش","همس","وجد",
"إحسان","بصيرة","تميز","حكمة","دلال","راحة","سحر","شغف","ضياء","عبرة",
"فن","قيمة","لغة","مهارة","نور","هوية","ابتكار","بريق","تحمل","تعلق",
"جلال","حنين","دعابة","رومانسية","سمو","شعر","صخب","عظمة","فلسفة","قبس",
"لمسة","مزاج","نغم","هبة","إرث","بسالة","تأمل","جرأة","حضور","خبر",
"دين","ريادة","سكون","شراكة","صديق","عطش","فكر","قدوة","لقاء","مبدأ",
"نضج","هيام","إشراق","بزوغ","تحقيق","تضحية","جذل","حكاية","دراية","رغبة",
"سرد","شكر","صدى","عز","فهم","قلب","مقصد","نهضة","وجدان","إلهام",
"بزوغ","تناغم","حوار","ذكاء","رواية","سعادة","شعر","صوت","عالم","فنون",
"قصة","مكتب","نهاية","هندسة","ابتكار","بحر","تاريخ","حضارة","دواء","رسم",
"سفر","شمس","صحة","علم","فلك","قمر","موسيقى","نجوم","هواء","ياقوت"
];

/* ========= أدوات ========= */
function normalizeArabic(s){ if(!s) return "";
  return s.replace(/[\u0640]/g,'').replace(/[إأآا]/g,'ا').replace(/ى/g,'ي')
          .replace(/ؤ/g,'و').replace(/ئ/g,'ي').replace(/ة/g,'ه').replace(/\s+/g,'').trim(); }
function playTone(ok=true){ try{ const c=new (window.AudioContext||window.webkitAudioContext)();
  const o=c.createOscillator(), g=c.createGain(); o.type='sine'; o.frequency=value= ok?660:220; g.gain.value=.05;
  o.connect(g); g.connect(c.destination); o.start(); setTimeout(()=>{o.stop(); c.close()}, ok?120:180);}catch{} }
function shuffleWord(w){ let a=w.split(''), s; do{ s=a.slice();
  for(let i=s.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [s[i],s[j]]=[s[j],s[i]];} }while(s.join('')===w);
  return s.join(' '); }

function updatePlayerList(team){
  const listId = team==='blue' ? "bluePlayers" : "redPlayers";
  const players = team==='blue' ? bluePlayers : redPlayers;
  document.getElementById(listId).innerHTML = players.map((p,i)=>`
    <div class="player-entry" style="display:flex;justify-content:space-between;align-items:center;margin:2px 0;">
      <span>• ${p}</span>
      <button style="background:#900;font-size:14px;padding:2px 6px;border:none;border-radius:6px;cursor:pointer" onclick="removePlayer('${team}',${i})">🗑️</button>
    </div>
  `).join("");
  saveState();
}
function removePlayer(team,index){
  let removed;
  if(team==='blue'){ removed=bluePlayers.splice(index,1)[0]; blueTurnOrder=blueTurnOrder.filter(p=>p!==removed); }
  else{ removed=redPlayers.splice(index,1)[0]; redTurnOrder=redTurnOrder.filter(p=>p!==removed); }
  updatePlayerList(team);
}

/* ========= تخزين ========= */
function saveState(){
  localStorage.setItem('wm_bluePlayers', JSON.stringify(bluePlayers));
  localStorage.setItem('wm_redPlayers', JSON.stringify(redPlayers));
  localStorage.setItem('wm_scores', JSON.stringify({blueScore,redScore}));
  localStorage.setItem('wm_settings', JSON.stringify({ roundSeconds,targetScore,autoTimer,autoNext }));
}
function loadState(){
  try{
    const bp=JSON.parse(localStorage.getItem('wm_bluePlayers')||'[]');
    const rp=JSON.parse(localStorage.getItem('wm_redPlayers')||'[]');
    bp.forEach(p=>{ if(!bluePlayers.includes(p)) bluePlayers.push(p); });
    rp.forEach(p=>{ if(!redPlayers.includes(p)) redPlayers.push(p); });
    blueTurnOrder=[...bluePlayers]; redTurnOrder=[...redPlayers];
    const sc=JSON.parse(localStorage.getItem('wm_scores')||'{}');
    if(typeof sc.blueScore==='number') blueScore=sc.blueScore;
    if(typeof sc.redScore==='number') redScore=sc.redScore;
    document.getElementById('blueScore').innerText=blueScore;
    document.getElementById('redScore').innerText=redScore;
    const st=JSON.parse(localStorage.getItem('wm_settings')||'{}');
    if(st.roundSeconds) roundSeconds=st.roundSeconds;
    if(st.targetScore) targetScore=st.targetScore;
    if(typeof st.autoTimer==='boolean') autoTimer=st.autoTimer;
    if(typeof st.autoNext==='boolean') autoNext=st.autoNext;

    document.getElementById('roundTime').value=roundSeconds;
    document.getElementById('targetScore').value=targetScore;
    document.getElementById('autoTimer').checked=autoTimer;
    document.getElementById('autoNext').checked=autoNext;

    updatePlayerList('blue'); updatePlayerList('red');
  }catch{}
}

/* ========= المؤقت ========= */
function renderBar(){ const bar=document.getElementById('bar'); const pct=roundSeconds?Math.max(0,Math.min(100,(timeLeft/roundSeconds)*100)):0; bar.style.width=pct+'%'; }
function startTimer(){
  if(timerRunning) return;
  timeLeft=roundSeconds; document.getElementById('timer').innerText=`⏳ الوقت المتبقي: ${timeLeft} ثانية`; renderBar();
  clearInterval(timerInterval); timerRunning=true;
  timerInterval=setInterval(()=>{ timeLeft--; document.getElementById('timer').innerText=`⏳ الوقت المتبقي: ${timeLeft} ثانية`; renderBar();
    if(timeLeft<=0){ clearInterval(timerInterval); timerRunning=false; document.getElementById('timer').innerText="⏳ انتهى الوقت!"; } },1000);
}
function stopTimer(){ clearInterval(timerInterval); timerRunning=false; }
function toggleTimer(){
  if(timerRunning){ stopTimer(); }
  else{
    if(timeLeft>0){ timerRunning=true; timerInterval=setInterval(()=>{ timeLeft--; document.getElementById('timer').innerText=`⏳ الوقت المتبقي: ${timeLeft} ثانية`; renderBar(); if(timeLeft<=0){ stopTimer(); document.getElementById('timer').innerText="⏳ انتهى الوقت!"; } },1000); }
    else{ startTimer(); }
  }
}

/* ========= الجولات ========= */
function startGame(){
  if(!words.length){ alert("⚠️ أضف قائمة الكلمات أولًا في متغير words."); return; }
  document.getElementById("startButton").disabled = true;
  blueTurnOrder=[...bluePlayers]; redTurnOrder=[...redPlayers]; turnIndex=0; nextTurn();
}
function pickNewWord(){
  if(!words.length){ currentAnswer=""; document.getElementById("scrambledWord").innerText="⚠️ لا توجد كلمات — أضف قائمتك"; document.getElementById("answerText").innerText="❓"; return; }
  let available=words.filter(w=>!usedWords.includes(w)); if(available.length===0){ usedWords.length=0; available=words.slice(); }
  const w=available[Math.floor(Math.random()*(available.length))]; usedWords.push(w); currentAnswer=w;
  document.getElementById("scrambledWord").innerText=shuffleWord(w); document.getElementById("answerText").innerText=w; document.getElementById("guessResult").innerText="";
}
function nextTurn(){
  stopTimer(); document.getElementById("timer").innerText=""; document.getElementById('bar').style.width='0%';
  if(blueTurnOrder.length===0 || redTurnOrder.length===0){ alert("❌ يجب وجود لاعبين في كلا الفريقين!"); return; }
  const isBlueTurn = turnIndex % 2 === 0;
  if(isBlueTurn){ const i=Math.floor(turnIndex/2)%blueTurnOrder.length; currentPlayerName=blueTurnOrder[i]; answeringTeam='blue'; }
  else{ const i=Math.floor(turnIndex/2)%redTurnOrder.length; currentPlayerName=redTurnOrder[i]; answeringTeam='red'; }
  document.getElementById("currentPlayer").innerText=`🎮 الدور الآن: ${currentPlayerName}`;
  turnIndex++; pickNewWord(); if(autoTimer) startTimer();
}

/* ========= تلميح ========= */
function useHint(){
  if(!timerRunning && timeLeft===0) return;
  timeLeft=Math.max(0,timeLeft-5); renderBar();
  const ans=currentAnswer; if(ans && ans.length>=2){
    const first=ans[0], last=ans[ans.length-1];
    document.getElementById('guessResult').innerHTML=`💡 تلميح: يبدأ بـ (<b>${first}</b>) وينتهي بـ (<b>${last}</b>). -5 ثوانٍ`;
    if(timeLeft===0){ stopTimer(); document.getElementById('timer').innerText="⏳ انتهى الوقت!"; }
  }
}

/* ========= إجابة الشات ========= */
function checkAnswer(username, content){
  if(!timerRunning) return;
  if(username!==currentPlayerName) return;
  const ok = normalizeArabic(content) === normalizeArabic(currentAnswer);
  if(ok){
    document.getElementById("guessResult").innerHTML=`✅ ${username} أجاب بشكل صحيح!`; try{new AudioContext().close()}catch{}
    if(answeringTeam==='red'){ redScore++; document.getElementById("redScore").innerText=redScore; if(redScore>=targetScore){ alert("🏆 الفريق الأحمر فاز!"); } }
    else{ blueScore++; document.getElementById("blueScore").innerText=blueScore; if(blueScore>=targetScore){ alert("🏆 الفريق الأزرق فاز!"); } }
    saveState(); if(autoNext){ setTimeout(nextTurn,1000); }
  }else{ document.getElementById("guessResult").innerText=`❌ إجابة غير صحيحة`; }
}

/* ========= أدوات أخرى ========= */
function toggleAnswer(){ const el=document.getElementById("answerText"); el.style.visibility = el.style.visibility==="hidden" ? "visible" : "hidden"; }
function resetScores(){ blueScore=0; redScore=0; document.getElementById('blueScore').innerText=blueScore; document.getElementById('redScore').innerText=redScore; saveState(); }

/* ========= قوائم منسدلة + تذكّرني ========= */
(function(){
  // اتصال
  const strip=document.getElementById('connectStrip');
  const toggleBtn=document.getElementById('connectToggle');
  toggleBtn?.addEventListener('click', ()=> strip.classList.toggle('open'));
  const remember=document.getElementById('rememberMe');
  const channel=document.getElementById('channelInput');
  try{
    const saved=localStorage.getItem('wm_saved_channel')||'';
    if(saved){ channel.value=saved; remember.checked=true; }
    remember?.addEventListener('change', ()=>{
      if(remember.checked && channel.value.trim()){ localStorage.setItem('wm_saved_channel', channel.value.trim()); }
      else{ localStorage.removeItem('wm_saved_channel'); }
    });
    channel?.addEventListener('input', ()=>{ if(remember.checked){ localStorage.setItem('wm_saved_channel', channel.value.trim()); } });
  }catch(e){}
  // ستريمر
  const sStrip = document.getElementById('streamerStrip');
  const sToggle = document.getElementById('streamerToggle');
  sToggle?.addEventListener('click', ()=> sStrip.classList.toggle('open'));
})();

/* ========= ربط الشات ========= */
function setStatus(mode, platformText){
  const chip = document.getElementById('chatStatus');
  const platform = document.getElementById('statusPlatform');
  chip.classList.remove('status-ok','status-err','status-gray');
  if(mode==='ok'){ chip.classList.add('status-ok'); platform.textContent = platformText; }
  else if(mode==='err'){ chip.classList.add('status-err'); platform.textContent = platformText || 'فشل'; }
  else { chip.classList.add('status-gray'); platform.textContent = '—'; }
}
function connectChat(){
  const platform = document.getElementById("platformSelect").value;
  const channel = document.getElementById("channelInput").value.trim();
  if(!channel){ alert("اكتب اسم القناة"); setStatus('gray'); return; }

  try{ twitchClient?.disconnect?.(); }catch{} try{ kickSocket?.close?.(); }catch{}

  if(platform==="twitch"){
    twitchClient = new tmi.Client({ channels:[channel] });
    twitchClient.connect().then(()=>{ setStatus('ok','Twitch'); }).catch(()=>{ setStatus('err','Twitch'); });
    twitchClient.on('message',(ch,tags,message,self)=>{
      const username = tags['display-name'] || (tags['username']||'').toString();
      const content = (message||"").trim();
      if(content==="!ازرق"){
        if(!bluePlayers.includes(username)){ bluePlayers.push(username); blueTurnOrder.push(username); updatePlayerList("blue"); }
      }else if(content==="!احمر"){
        if(!redPlayers.includes(username)){ redPlayers.push(username); redTurnOrder.push(username); updatePlayerList("red"); }
      }else if(timerRunning && username===currentPlayerName){
        if(normalizeArabic(content) === normalizeArabic(currentAnswer)){ checkAnswer(username, content); }
      }
    });
  }else{
    (async()=>{
      try{
        const res = await fetch(`https://kick.com/api/v2/channels/${channel}`);
        const data = await res.json();
        const roomId = data.chatroom.id;

        kickSocket = new WebSocket("wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=8.4.0-rc2&flash=false");
        kickSocket.onopen = ()=>{
          kickSocket.send(JSON.stringify({event:"pusher:subscribe",data:{auth:"",channel:`chatrooms.${roomId}.v2`}}));
          setStatus('ok','Kick');
          const ping=setInterval(()=>{
            if(kickSocket.readyState===WebSocket.OPEN){ kickSocket.send(JSON.stringify({event:"pusher:ping",data:{}})); }
            else{ clearInterval(ping); }
          },12000);
        };
        kickSocket.onmessage = (event)=>{
          const msg = JSON.parse(event.data);
          if(msg.event==="App\\Events\\ChatMessageEvent"){
            const d = JSON.parse(msg.data);
            const username = d.sender?.username || "";
            const content = (d.content||"").trim();
            if(content==="!ازرق"){
              if(!bluePlayers.includes(username)){ bluePlayers.push(username); blueTurnOrder.push(username); updatePlayerList("blue"); }
            }else if(content==="!احمر"){
              if(!redPlayers.includes(username)){ redPlayers.push(username); redTurnOrder.push(username); updatePlayerList("red"); }
            }else if(timerRunning && username===currentPlayerName){
              if(normalizeArabic(content) === normalizeArabic(currentAnswer)){ checkAnswer(username, content); }
            }
          }
        };
        kickSocket.onerror = ()=> setStatus('err','Kick');
      }catch(e){ console.error(e); setStatus('err','Kick'); }
    })();
  }
}

/* ========= المودال ========= */
(function(){
  const openBtn = document.getElementById('openHelp');
  const backdrop = document.getElementById('helpBackdrop');
  const modal = document.getElementById('helpModal');
  const closeBtn = document.getElementById('closeHelp');
  function open(){ backdrop.style.display='block'; modal.style.display='block'; }
  function close(){ backdrop.style.display='none'; modal.style.display='none'; }
  openBtn?.addEventListener('click', open);
  closeBtn?.addEventListener('click', close);
  backdrop?.addEventListener('click', close);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
})();

/* ========= اختصارات لوحة المفاتيح ========= */
document.addEventListener('keydown', (e)=>{
  if(e.target.closest('.modal')) return;
  if(e.code==="Space"){ e.preventDefault(); toggleTimer(); }
  else if(e.key==="n"||e.key==="N"){ nextTurn(); }
  else if(e.key==="h"||e.key==="H"){ useHint(); }
});

/* ========= بدء الصفحة ========= */
window.addEventListener('DOMContentLoaded', ()=>{
  // ثيم افتراضي داكن
  document.documentElement.setAttribute('data-theme','dark');
  loadState();
});
</script>
</body>
</html>
