<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StreamerTop â€” Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª (Ø£Ø­Ù…Ø± vs Ø£Ø²Ø±Ù‚)</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø´Ø§Øª: ØªØ­ØªØ§Ø¬ tmi Ù„ØªÙˆÙŠØªØ´ ÙÙ‚Ø·ØŒ ÙˆÙƒÙˆØ¯ Kick Ù…Ø¯Ù…Ø¬ Ù‡Ù†Ø§ -->
  <script src="tmi.min.js"></script>
  <style>
    :root{
      --bg:#0f1115; --panel:#141922; --panel2:#1a2030; --line:#2a3347; --muted:#9fb0d0; --text:#e9eef7;
      --dv:#ff3333; --ok:#00d86c; --blue:#2ea8ff; --red:#ff4455; --gold:#f8d35e;
    }
    *{box-sizing:border-box}
    body{margin:0;background:
      radial-gradient(1200px 600px at 10% 10%,rgba(255,255,255,.04),transparent 60%),
      radial-gradient(1200px 600px at 90% 90%,rgba(255,255,255,.05),transparent 60%),
      linear-gradient(180deg,#0f1115,#0b0d11);
      color:var(--text);font-family:'Cairo',sans-serif}
    .wrap{max-width:1200px;margin:20px auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .logo{display:flex;align-items:center;gap:10px}
    .badge{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:linear-gradient(180deg,#151a24,#10141c)}

    .card{background:linear-gradient(180deg,#141922,#0f131a);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .card h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--line);font-size:18px}
    .card .body{padding:14px 16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    label{font-size:13px;color:var(--muted)}
    input,select,button{font-family:'Cairo',sans-serif}
    input[type="number"],input[type="text"],select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#0f131a;color:var(--text)}
    button{padding:10px 14px;border:1px solid var(--line);background:#0f131a;color:var(--text);border-radius:12px;cursor:pointer;transition:.2s}
    button:hover{transform:translateY(-1px)}

    /* Ø´Ø±ÙŠØ· Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø©: Ø§Ù„Ù†ØªØ§Ø¦Ø¬ + Ø§Ù„ÙˆÙ‚Øª + Ø§Ù„Ù„Ø§Ø¹Ø¨ */
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border:1px solid var(--line);border-radius:12px;margin-bottom:10px;background:linear-gradient(180deg,#151a23,#0f131a)}
    .team{display:flex;align-items:center;gap:10px}
    .dot{width:10px;height:10px;border-radius:50%}
    .blue .dot{background:var(--blue)}
    .red .dot{background:var(--red)}
    .topbar b{font-size:20px}
    .turninfo{display:flex;gap:14px;align-items:center;color:var(--muted)}
    .turninfo b{color:var(--text)}

    .canvas-wrap{position:relative;overflow:hidden;border-radius:16px}
    canvas{display:block;width:100%;height:auto;background:radial-gradient(600px 300px at 20% 0%,rgba(255,255,255,.04),transparent 50%)}

    .help{font-size:13px;color:var(--muted);line-height:1.7}
    .kbd{font-family:ui-monospace,monospace;background:#0c1016;border:1px solid var(--line);padding:0 6px;border-radius:6px}

    /* Ù„ÙˆØ­Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© */
    .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-inline-start:6px;background:#777}
    .status-ok{background:var(--ok)}
    .status-bad{background:var(--dv)}
    .teams-lists{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px}
    .teams-lists .title{font-size:13px; color:var(--muted); margin-bottom:6px}
    .roster{display:flex;flex-wrap:wrap;gap:6px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:linear-gradient(180deg,#151a24,#10141c);font-size:12px}
    .roster .pill{padding:4px 8px}

    @media (max-width:900px){
      .wrap{padding:10px}
    }
  </style>
</head>
<body>
<div class="wrap">

  <!-- ğŸ”Œ Ù„ÙˆØ­Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù‚Ù†ÙˆØ§Øª -->
  <section class="card" style="margin-bottom:12px">
    <h3>ğŸ”Œ Ù„ÙˆØ­Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù‚Ù†ÙˆØ§Øª</h3>
    <div class="body">
      <div class="row" style="justify-content:space-between">
        <div class="team red" style="flex:0 0 auto"><span class="dot"></span> ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±</div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <span class="pill">Twitch: <span id="statusTw">ØºÙŠØ± Ù…ØªØµÙ„</span> <span id="dotTw" class="status-dot"></span></span>
          <span class="pill">Kick: <span id="statusKk">ØºÙŠØ± Ù…ØªØµÙ„</span> <span id="dotKk" class="status-dot"></span></span>
        </div>
        <div class="team blue" style="flex:0 0 auto"><span class="dot"></span> ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚</div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>ØªÙˆÙŠØªØ´ â€” Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©</label>
          <div class="row">
            <label class="pill" style="flex:0 0 auto"><input id="twEnable" type="checkbox" checked> ØªÙØ¹ÙŠÙ„</label>
            <input type="text" id="twChannel" placeholder="Ø§Ø³Ù… Ù‚Ù†Ø§Ø© ØªÙˆÙŠØªØ´" value="YOUR_TWITCH_CHANNEL">
          </div>
        </div>
        <div>
          <label>ÙƒÙŠÙƒ â€” Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©</label>
          <div class="row">
            <label class="pill" style="flex:0 0 auto"><input id="kkEnable" type="checkbox"> ØªÙØ¹ÙŠÙ„</label>
            <input type="text" id="kkChannel" placeholder="Ø§Ø³Ù… Ù‚Ù†Ø§Ø© ÙƒÙŠÙƒ" value="YOUR_KICK_CHANNEL">
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnConnect">ğŸ”— Ø§ØªØµØ§Ù„ / Ø¥Ø¹Ø§Ø¯Ø© Ø§ØªØµØ§Ù„</button>
        <label class="pill" style="flex:0 0 auto"><input id="showDotNumbers" type="checkbox"> Ø¥Ø¸Ù‡Ø§Ø± ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ù†Ù‚Ø§Ø·</label>
        <input type="number" id="dotStart" min="1" value="1" style="max-width:110px" title="Ø¨Ø¯Ø¡ Ø§Ù„ØªØ±Ù‚ÙŠÙ… Ù…Ù†">
      </div>

      <!-- Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„ÙƒÙ„ ÙØ±ÙŠÙ‚ -->
      <div class="teams-lists">
        <div>
          <div class="title">ğŸ‘¥ Ù„Ø§Ø¹Ø¨Ùˆ ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø± (<span id="redCount">0</span>)</div>
          <div class="roster" id="redList"></div>
        </div>
        <div>
          <div class="title">ğŸ‘¥ Ù„Ø§Ø¹Ø¨Ùˆ ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚ (<span id="blueCount">0</span>)</div>
          <div class="roster" id="blueList"></div>
        </div>
      </div>

      <div class="help" style="margin-top:8px">
        Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙÙŠ Ø§Ù„Ø´Ø§Øª: <span class="kbd">!Ø¯Ø®ÙˆÙ„</span>ØŒ <span class="kbd">!Ø£Ø­Ù…Ø±</span>/<span class="kbd">!Ø§Ø­Ù…Ø±</span>ØŒ <span class="kbd">!Ø£Ø²Ø±Ù‚</span>/<span class="kbd">!Ø§Ø²Ø±Ù‚</span>ØŒ 
        <span class="kbd">!Ø§Ø®ØªØ± @Ø§Ø³Ù…</span> (Ù„Ù„Ø§Ø³ØªØ±ÙŠÙ…Ø±)ØŒ <span class="kbd">!ÙˆÙ‚Øª 25</span> (Ù„Ù„Ø§Ø³ØªØ±ÙŠÙ…Ø±).<br>
        Ø§Ù„Ù„Ø¹Ø¨: <span class="kbd">1-2</span> (ØªØ¯Ø¹Ù… Ù¡-Ù¢) Ø£Ùˆ <span class="kbd">!Ø®Ø· 1,1 2,1</span> â€” Ø§Ù„ØªÙ†ÙÙŠØ° Ù…Ø³Ù…ÙˆØ­ ÙÙ‚Ø· Ù„ØµØ§Ø­Ø¨ <b>Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ</b>.
      </div>
    </div>
  </section>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ù†ØªØ§Ø¦Ø¬/Ø§Ù„ÙˆÙ‚Øª/Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙÙˆÙ‚ Ø§Ù„Ù„ÙˆØ­Ø© -->
  <div class="topbar">
    <div class="team red"><span class="dot"></span> Ø£Ø­Ù…Ø±: <b id="scoreRed">0</b></div>
    <div class="turninfo">
      <span>â±ï¸ Ø§Ù„ÙˆÙ‚Øª: <b id="timeLeft">--</b>s</span>
      <span>ğŸ¯ Ø§Ù„Ø¯ÙˆØ±: <b id="currentTurnPlayer">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</b> (<span id="turnTeamLabel">Ø£Ø²Ø±Ù‚</span>)</span>
    </div>
    <div class="team blue"><span class="dot"></span> Ø£Ø²Ø±Ù‚: <b id="scoreBlue">0</b></div>
  </div>

  <!-- Ø§Ù„Ù„ÙˆØ­Ø© -->
  <section class="card">
    <div class="canvas-wrap">
      <canvas id="board" width="900" height="900"></canvas>
    </div>
  </section>

  <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© -->
  <section class="card" id="settingsCard" style="margin-top:12px">
    <h3>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
    <div class="body">
      <div class="row">
        <div>
          <label>Ø­Ø¬Ù… Ø§Ù„Ø´Ø¨ÙƒØ© (Ù†Ù‚Ø§Ø· Ã— Ù†Ù‚Ø§Ø·)</label>
          <div class="row">
            <input type="number" id="gridW" min="2" max="12" value="5" />
            <input type="number" id="gridH" min="2" max="12" value="5" />
          </div>
        </div>
        <div>
          <label>Ø«ÙˆØ§Ù†ÙŠ Ø§Ù„Ø¯ÙˆØ±</label>
          <input type="number" id="turnSecs" min="5" max="120" value="20" />
        </div>
        <div>
          <label>Ù†Ù‚Ø§Ø· Ø§Ù„ÙÙˆØ² (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input type="number" id="targetScore" min="1" value="0" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnStart">â–¶ï¸ Ø¨Ø¯Ø¡ / Ø¥Ø¹Ø§Ø¯Ø©</button>
      </div>
    </div>
  </section>
</div>

<script>
/******************************
 *  Ø±Ø¨Ø· â€” Twitch & Kick
 ******************************/
const RABT = (() => {
  let twitchClient = null;

  // â€”â€”â€” Kick Ø¹Ø¨Ø± API + Pusher WebSocket â€”â€”â€”
  let kickSocket = null;
  let kickPingTimer = null;

  const state = {
    enabledTwitch: true,
    enabledKick: false,
    twChannel: 'YOUR_TWITCH_CHANNEL',
    kkChannel: 'YOUR_KICK_CHANNEL',
    onChat: (platform, user, text) => {}
  };

  function setDot(el, ok){
    el.classList.remove('status-ok','status-bad');
    if(ok===true) el.classList.add('status-ok');
    else if(ok===false) el.classList.add('status-bad');
  }

  function connectTwitch(){
    const statusTw = document.getElementById('statusTw');
    const dotTw = document.getElementById('dotTw');
    try{
      if(!window.tmi) throw new Error('tmi.min.js ØºÙŠØ± Ù…Ø­Ù…Ù‘ÙÙ„');
      twitchClient = new tmi.Client({
        channels: [state.twChannel],
        connection: { secure:true, reconnect:true }
      });
      twitchClient.on('connected', ()=>{ statusTw.textContent='Ù…ØªØµÙ„: '+state.twChannel; setDot(dotTw,true); });
      twitchClient.on('disconnected', ()=>{ statusTw.textContent='ØºÙŠØ± Ù…ØªØµÙ„'; setDot(dotTw,false); });
      twitchClient.on('message', (channel, tags, message, self) => {
        if(self) return;
        const user = tags['display-name'] || tags.username || 'Ù…Ø´Ø§Ø±Ùƒ';
        const txt  = (message||'').trim();
        state.onChat('twitch', user, txt);
      });
      twitchClient.connect();
    }catch(e){
      console.warn('Twitch connect error:', e);
      statusTw.textContent = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„';
      setDot(dotTw,false);
    }
  }

  // âœ… Ù†ÙØ³ Ø£Ø³Ù„ÙˆØ¨ Ù„Ø¹Ø¨ØªÙƒ: Ø¬Ù„Ø¨ roomId Ø«Ù… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ù‚Ù†Ø§Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¹Ø¨Ø± Pusher WS
  async function connectKick(){
    const statusKk = document.getElementById('statusKk');
    const dotKk = document.getElementById('dotKk');

    // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ø§ØªØµØ§Ù„ Ù‚Ø¯ÙŠÙ…
    try{ if(kickPingTimer) clearInterval(kickPingTimer); }catch{}
    try{ if(kickSocket && kickSocket.readyState===WebSocket.OPEN) kickSocket.close(); }catch{}
    kickSocket = null; kickPingTimer = null;

    try{
      // 1) Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ù†Ø§Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ chatroom.id
      const channel = state.kkChannel;
      const res = await fetch(`https://kick.com/api/v2/channels/${encodeURIComponent(channel)}`);
      const data = await res.json().catch(()=>null);
      const roomId = data?.chatroom?.id;
      if(!roomId){
        statusKk.textContent = 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ØºØ±ÙØ©';
        setDot(dotKk,false);
        return;
      }

      // 2) ÙØªØ­ WebSocket Ø¥Ù„Ù‰ Pusher ÙˆØ§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ù‚Ù†Ø§Ø© chatrooms.{roomId}.v2
      const ws = new WebSocket("wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=8.4.0-rc2&flash=false");
      kickSocket = ws;

      ws.onopen = ()=>{
        // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        ws.send(JSON.stringify({
          event:"pusher:subscribe",
          data:{auth:"", channel:`chatrooms.${roomId}.v2`}
        }));
        // ping ÙƒÙ„ 12 Ø«Ø§Ù†ÙŠØ©
        kickPingTimer = setInterval(()=>{
          if(ws.readyState===WebSocket.OPEN){
            ws.send(JSON.stringify({event:"pusher:ping", data:{}}));
          }
        }, 12000);

        statusKk.textContent = 'Ù…ØªØµÙ„: '+channel;
        setDot(dotKk,true);
      };

      ws.onmessage = (event)=>{
        let pkt;
        try{ pkt = JSON.parse(event.data); }catch{return;}
        if(pkt.event === "App\\Events\\ChatMessageEvent"){
          let d;
          try{ d = JSON.parse(pkt.data); }catch{return;}
          const user = d?.sender?.username || 'Ù…Ø´Ø§Ø±Ùƒ';
          const text = (d?.content || '').trim();
          if(text) state.onChat('kick', user, text);
        }
      };

      ws.onerror = ()=>{
        statusKk.textContent = 'Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„';
        setDot(dotKk,false);
      };
      ws.onclose = ()=>{
        statusKk.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
        setDot(dotKk,false);
        try{ if(kickPingTimer) clearInterval(kickPingTimer); }catch{}
        kickPingTimer = null;
      };
    }catch(e){
      console.warn('Kick connect error:', e);
      statusKk.textContent = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„';
      setDot(dotKk,false);
    }
  }

  function connect() {
    if(state.enabledTwitch) connectTwitch();
    if(state.enabledKick) connectKick();
  }

  function disconnect(){
    // Twitch
    try{ if(twitchClient && twitchClient.disconnect) twitchClient.disconnect(); }catch{}
    // Kick
    try{ if(kickPingTimer) clearInterval(kickPingTimer); }catch{}
    try{ if(kickSocket) kickSocket.close(); }catch{}
  }

  return { state, connect, disconnect };
})();

/*********************
 * Ø¹Ù†Ø§ØµØ± Ø§ØªØµØ§Ù„
 *********************/
const twEnable = document.getElementById('twEnable');
const kkEnable = document.getElementById('kkEnable');
const twChannel = document.getElementById('twChannel');
const kkChannel = document.getElementById('kkChannel');
const btnConnect = document.getElementById('btnConnect');

/*********************
 * Ù„Ø§Ø¹Ø¨ÙŠÙ†/ÙØ±Ù‚ + Ù‚ÙˆØ§Ø¦Ù…
 *********************/
const players = new Map(); // username -> {team:'red'|'blue'|null}
function joinPlayer(name){
  if(!players.has(name)) players.set(name,{team:null});
  refreshRosters();
}
function setTeam(name, team){
  if(!players.has(name)) joinPlayer(name);
  players.get(name).team = team;
  refreshRosters();
}
function teamOf(name){ return players.get(name)?.team || null; }
function getTeamPlayers(team){ return [...players.entries()].filter(([n,i])=>i.team===team).map(([n])=>n); }
function refreshRosters(){
  const redList = document.getElementById('redList');
  const blueList = document.getElementById('blueList');
  const redCount = document.getElementById('redCount');
  const blueCount = document.getElementById('blueCount');

  const reds = getTeamPlayers('red');
  const blues = getTeamPlayers('blue');

  redList.innerHTML = reds.map(n=>`<span class="pill">@${n}</span>`).join('');
  blueList.innerHTML = blues.map(n=>`<span class="pill">@${n}</span>`).join('');

  redCount.textContent = reds.length;
  blueCount.textContent = blues.length;
}

/*********************
 * Ø§Ù„Ù„ÙˆØ­Ø©
 *********************/
const boardEl = document.getElementById('board');
const ctx = boardEl.getContext('2d');
let SHOW_NUMBERS=false; let DOT_START=1;

let GW=5, GH=5;
const PAD = 40;
let W,H,cellW,cellH;

let HLines, VLines, boxes;

function initBoard(w,h){
  GW = Math.max(2, Math.min(12, w|0));
  GH = Math.max(2, Math.min(12, h|0));
  W = boardEl.width; H = boardEl.height;
  cellW = (W - PAD*2) / (GW-1);
  cellH = (H - PAD*2) / (GH-1);
  HLines = Array(GH).fill(0).map(()=>Array(GW-1).fill(null));
  VLines = Array(GW).fill(0).map(()=>Array(GH-1).fill(null));
  boxes  = Array(GH-1).fill(0).map(()=>Array(GW-1).fill(null));
  drawBoard();
}

function drawBoard(){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = '#0b0f15';
  ctx.fillRect(0,0,W,H);

  // Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ù…Ù…Ù„ÙˆÙƒØ©
  for(let y=0;y<GH-1;y++){
    for(let x=0;x<GW-1;x++){
      if(boxes[y][x]){
        ctx.fillStyle = boxes[y][x]==='red'? 'rgba(255,68,85,.35)' : 'rgba(46,168,255,.35)';
        const rx = PAD + x*cellW, ry = PAD + y*cellH;
        ctx.fillRect(rx, ry, cellW, cellH);
      }
    }
  }

  // Ø®Ø·ÙˆØ· Ø£ÙÙ‚ÙŠØ©
  for(let y=0;y<GH;y++){
    for(let x=0;x<GW-1;x++){
      const rx1 = PAD + x*cellW, ry = PAD + y*cellH, rx2 = PAD + (x+1)*cellW;
      const owner = HLines[y][x];
      ctx.strokeStyle = owner ? (owner==='red'? '#ff4455':'#2ea8ff') : '#2a3347';
      ctx.lineWidth = owner? 6:3;
      ctx.beginPath(); ctx.moveTo(rx1,ry); ctx.lineTo(rx2,ry); ctx.stroke();
    }
  }
  // Ø®Ø·ÙˆØ· Ø¹Ù…ÙˆØ¯ÙŠØ©
  for(let x=0;x<GW;x++){
    for(let y=0;y<GH-1;y++){
      const rx = PAD + x*cellW, ry1 = PAD + y*cellH, ry2 = PAD + (y+1)*cellH;
      const owner = VLines[x][y];
      ctx.strokeStyle = owner ? (owner==='red'? '#ff4455':'#2ea8ff') : '#2a3347';
      ctx.lineWidth = owner? 6:3;
      ctx.beginPath(); ctx.moveTo(rx,ry1); ctx.lineTo(rx,ry2); ctx.stroke();
    }
  }
  // Ù†Ù‚Ø§Ø· + Ø£Ø±Ù‚Ø§Ù…
  for(let y=0;y<GH;y++){
    for(let x=0;x<GW;x++){
      const rx = PAD + x*cellW, ry = PAD + y*cellH;
      ctx.fillStyle = '#e9eef7';
      ctx.beginPath(); ctx.arc(rx,ry,5,0,Math.PI*2); ctx.fill();
      if(SHOW_NUMBERS){
        const idx = DOT_START + y*GW + x;
        ctx.fillStyle = '#9fb0d0';
        ctx.font = '12px Cairo, sans-serif';
        ctx.textAlign = 'left'; ctx.textBaseline = 'top';
        ctx.fillText(String(idx), rx+6, ry+6);
      }
    }
  }
}

function pickLineAt(px,py){
  let best = null; let bestDist = 12;
  // Ø£ÙÙ‚ÙŠ
  for(let y=0;y<GH;y++){
    for(let x=0;x<GW-1;x++){
      const x1 = PAD + x*cellW, y1 = PAD + y*cellH, x2 = PAD + (x+1)*cellW;
      const d = distPointSegment(px,py,x1,y1,x2,y1);
      if(d<bestDist && !HLines[y][x]){ bestDist=d; best={type:'H',x,y}; }
    }
  }
  // Ø¹Ù…ÙˆØ¯ÙŠ
  for(let x=0;x<GW;x++){
    for(let y=0;y<GH-1;y++){
      const x1 = PAD + x*cellW, y1 = PAD + y*cellH, y2 = PAD + (y+1)*cellH;
      const d = distPointSegment(px,py,x1,y1,x1,y2);
      if(d<bestDist && !VLines[x][y]){ bestDist=d; best={type:'V',x,y}; }
    }
  }
  return best;
}
function distPointSegment(px,py,x1,y1,x2,y2){
  const A=px-x1, B=py-y1, C=x2-x1, D=y2-y1;
  const dot = A*C + B*D;
  const len = C*C + D*D;
  let t = len? dot/len : 0; t=Math.max(0,Math.min(1,t));
  const dx = x1 + t*C - px, dy = y1 + t*D - py;
  return Math.hypot(dx,dy);
}

function playLine(line, team){
  if(!line) return {ok:false,gained:0};
  if(line.type==='H'){
    if(HLines[line.y][line.x]) return {ok:false,gained:0};
    HLines[line.y][line.x]=team;
  }else{
    if(VLines[line.x][line.y]) return {ok:false,gained:0};
    VLines[line.x][line.y]=team;
  }
  let gained = 0;
  if(line.type==='H'){
    const y=line.y, x=line.x;
    if(y>0 && isBoxClosed(x,y-1)) { boxes[y-1][x]=team; gained++; }
    if(y<GH-1 && isBoxClosed(x,y)) { boxes[y][x]=team; gained++; }
  }else{
    const x=line.x, y=line.y;
    if(x>0 && isBoxClosed(x-1,y)) { boxes[y][x-1]=team; gained++; }
    if(x<GW-1 && isBoxClosed(x,y)) { boxes[y][x]=team; gained++; }
  }
  if(gained>0){ addScore(team,gained); checkWin(); }
  drawBoard();
  return {ok:true,gained};
}
function isBoxClosed(x,y){
  return HLines[y][x] && HLines[y+1][x] && VLines[x][y] && VLines[x+1][y];
}

/*********************
 * Ø§Ù„Ø¯ÙˆØ± ÙˆØ§Ù„Ù…Ø¤Ù‚Øª + Ø·ÙˆØ§Ø¨ÙŠØ± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
 *********************/
let turnTeam = 'blue';             // ÙŠØ¨Ø¯Ø£ Ø¨Ø§Ù„Ø£Ø²Ø±Ù‚
let timeLeft = 0, timerId=null;
let gameActive = false;
let currentPlayer = null;

let redIdx = 0, blueIdx = 0;

const timeEl = document.getElementById('timeLeft');
const turnTeamLabel = document.getElementById('turnTeamLabel');
const currentTurnPlayerEl = document.getElementById('currentTurnPlayer');

function setTurn(team, advanceIndex=false){
  turnTeam = team;
  turnTeamLabel.textContent = (team==='red'?'Ø£Ø­Ù…Ø±':'Ø£Ø²Ø±Ù‚');

  const arr = getTeamPlayers(team);
  if(arr.length===0){
    currentPlayer = null;
  }else{
    if(advanceIndex){
      if(team==='red'){ redIdx = (redIdx+1) % arr.length; }
      else { blueIdx = (blueIdx+1) % arr.length; }
    }
    const idx = (team==='red'? redIdx : blueIdx) % arr.length;
    currentPlayer = arr[idx];
  }

  updateTurnUI();
  if(gameActive) resetTimer();
}
function updateTurnUI(){
  currentTurnPlayerEl.textContent = currentPlayer ? '@'+currentPlayer : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
}
function resetTimer(){
  if(timerId) clearInterval(timerId);
  timeLeft = Math.max(5, +document.getElementById('turnSecs').value|0);
  timeEl.textContent = timeLeft;
  timerId = setInterval(()=>{
    timeLeft--;
    timeEl.textContent = timeLeft;
    if(timeLeft<=0){
      clearInterval(timerId); timerId=null;
      switchTeam(true); // Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª â†’ Ø¨Ø¯Ù‘Ù„ Ø§Ù„ÙØ±ÙŠÙ‚ ÙˆØªÙ‚Ø¯Ù‘Ù… ÙÙŠ Ø·Ø§Ø¨ÙˆØ±Ù‡
    }
  },1000);
}
function switchTeam(){
  const nextTeam = (turnTeam==='red'?'blue':'red');
  setTurn(nextTeam, /*advanceIndex*/ true);
}

/*********************
 * Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„ÙÙˆØ²
 *********************/
let scoreRed=0, scoreBlue=0;
const sr=document.getElementById('scoreRed'), sb=document.getElementById('scoreBlue');

function addScore(team,pts){ if(team==='red'){scoreRed+=pts; sr.textContent=scoreRed;} else {scoreBlue+=pts; sb.textContent=scoreBlue;} }
function checkWin(){
  const target = +document.getElementById('targetScore').value|0;
  if(target>0){
    if(scoreRed>=target){ alert('ğŸ† ÙØ§Ø² ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±!'); endGame(); }
    if(scoreBlue>=target){ alert('ğŸ† ÙØ§Ø² ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚!'); endGame(); }
  }else{
    const totalBoxes = (GW-1)*(GH-1);
    if(scoreRed+scoreBlue >= totalBoxes){
      const winner = scoreRed>scoreBlue? 'Ø§Ù„Ø£Ø­Ù…Ø±' : scoreBlue>scoreRed? 'Ø§Ù„Ø£Ø²Ø±Ù‚' : 'ØªØ¹Ø§Ø¯Ù„';
      alert('ğŸ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø© â€” Ø§Ù„ÙØ§Ø¦Ø²: '+winner);
      endGame();
    }
  }
}
function endGame(){ if(timerId) clearInterval(timerId); timerId=null; gameActive=false; }

/*********************
 * Ù†Ù‚Ø± Ø§Ù„Ù…Ø§ÙˆØ³ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±)
 *********************/
boardEl.addEventListener('click', (e)=>{
  const rect = boardEl.getBoundingClientRect();
  const scaleX = boardEl.width / rect.width; const scaleY = boardEl.height / rect.height;
  const x = (e.clientX - rect.left) * scaleX;
  const y = (e.clientY - rect.top) * scaleY;
  const picked = pickLineAt(x,y);
  if(picked){
    const res = playLine(picked, turnTeam);
    if(res.ok){
      if(res.gained>0){
        if(gameActive) resetTimer(); // Ù†ÙØ³ Ø§Ù„ÙØ±ÙŠÙ‚ ÙˆÙ†ÙØ³ Ø§Ù„Ù„Ø§Ø¹Ø¨
      }else{
        switchTeam(); // Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¢Ø®Ø± + ØªÙ‚Ø¯Ù‘Ù… ÙÙŠ Ø·Ø§Ø¨ÙˆØ±Ù‡
      }
    }
  }
});

/*********************
 * ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ù†Ù‚Ø§Ø·
 *********************/
const showDotNumbersEl = document.getElementById('showDotNumbers');
const dotStartEl = document.getElementById('dotStart');
showDotNumbersEl.addEventListener('change',()=>{ SHOW_NUMBERS = !!showDotNumbersEl.checked; drawBoard(); });
dotStartEl.addEventListener('change',()=>{ DOT_START = Math.max(1, +dotStartEl.value|0); drawBoard(); });

/*********************
 * ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© â†’ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
 *********************/
function normalizeDigits(str){
  const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9','Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'};
  return String(str).replace(/[Ù -Ù©Û°-Û¹]/g, d=>map[d] ?? d);
}

/*********************
 * Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø§Øª (Ø§Ù„Ù„Ø¹Ø¨ Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø¯ÙˆØ± ÙÙ‚Ø·)
 *********************/
function isStreamer(user){
  const owner = (RABT.state.twChannel||'').toLowerCase();
  return (user||'').toLowerCase()===owner;
}

function gridEdgeFromCoords(x1,y1,x2,y2){
  if(x1<1||x1>GW||y1<1||y1>GH||x2<1||x2>GW||y2<1||y2>GH) return null;
  if(y1===y2 && Math.abs(x1-x2)===1){
    const y=y1-1, x=Math.min(x1,x2)-1; if(HLines[y]?.[x]) return null; return {type:'H',x,y};
  }
  if(x1===x2 && Math.abs(y1-y2)===1){
    const x=x1-1, y=Math.min(y1,y2)-1; if(VLines[x]?.[y]) return null; return {type:'V',x,y};
  }
  return null;
}
function indexToXY(idx){
  const zero = idx - DOT_START; if(zero<0) return null;
  const y = Math.floor(zero / GW), x = zero % GW;
  if(y<0||y>=GH||x<0||x>=GW) return null; return {x,y};
}
function lineFromIndexPair(a,b){
  const p1=indexToXY(a), p2=indexToXY(b); if(!p1||!p2) return null;
  if(p1.y===p2.y && Math.abs(p1.x-p2.x)===1){
    const y=p1.y, x=Math.min(p1.x,p2.x); if(HLines[y]?.[x]) return null; return {type:'H',x,y};
  }
  if(p1.x===p2.x && Math.abs(p1.y-p2.y)===1){
    const x=p1.x, y=Math.min(p1.y,p2.y); if(VLines[x]?.[y]) return null; return {type:'V',x,y};
  }
  return null;
}

function handleCommand(user, text){
  const msg = (text||'').trim();
  const norm = normalizeDigits(msg);

  // Ø§Ù„ØªØ³Ø¬ÙŠÙ„/Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚ Ù„Ù„Ø¬Ù…ÙŠØ¹
  if(/^!Ø¯Ø®ÙˆÙ„$/i.test(norm)){ joinPlayer(user); return; }
  if(/^!(Ø§Ø²Ø±Ù‚|Ø£Ø²Ø±Ù‚)$/i.test(norm)){ setTeam(user,'blue'); return; }
  if(/^!(Ø§Ø­Ù…Ø±|Ø£Ø­Ù…Ø±)$/i.test(norm)){ setTeam(user,'red'); return; }

  // Ù„Ù„Ø³ØªØ±ÙŠÙ…Ø± ÙÙ‚Ø·: Ø§Ø®ØªÙŠØ§Ø± Ù„Ø§Ø¹Ø¨/ØªØºÙŠÙŠØ± ÙˆÙ‚Øª
  if(/^!Ø§Ø®ØªØ±\s+@?([^\s]+)$/i.test(norm)){
    if(!isStreamer(user)) return;
    const m=norm.match(/^!Ø§Ø®ØªØ±\s+@?([^\s]+)$/i); const target=m[1];
    if(players.has(target) && teamOf(target)===turnTeam){
      currentPlayer = target; updateTurnUI();
    }
    return;
  }
  if(/^!ÙˆÙ‚Øª\s+(\d{1,3})$/i.test(norm)){
    if(!isStreamer(user)) return;
    const secs = +norm.match(/^!ÙˆÙ‚Øª\s+(\d{1,3})$/i)[1];
    document.getElementById('turnSecs').value = Math.max(5, Math.min(300, secs));
    if(gameActive) resetTimer();
    return;
  }

  // Ù…Ù† Ù‡Ù†Ø§: Ø§Ù„Ù„Ø¹Ø¨ Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø¯ÙˆØ± ÙÙ‚Ø·
  if(!currentPlayer || (user||'').toLowerCase() !== currentPlayer.toLowerCase()) return;

  // 1-2
  if(/^\d+\s*-\s*\d+$/.test(norm)){
    const [a,b] = norm.split('-').map(s=>+s.trim());
    const line = lineFromIndexPair(a,b);
    if(!line) return;
    const res = playLine(line, turnTeam);
    if(res.ok){
      if(res.gained>0){
        if(gameActive) resetTimer(); // Ù†ÙØ³ Ø§Ù„Ù„Ø§Ø¹Ø¨/Ø§Ù„ÙØ±ÙŠÙ‚
      }else{
        switchTeam(); // Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¢Ø®Ø± ÙˆØ§Ù„ØªÙ‚Ø¯Ù‘Ù… ÙÙŠ Ø·Ø§Ø¨ÙˆØ±Ù‡
      }
    }
    return;
  }

  // !Ø®Ø· x1,y1 x2,y2
  if(/^!Ø®Ø·\s+(\d+),(\d+)\s+(\d+),(\d+)$/i.test(norm)){
    const m = norm.match(/^!Ø®Ø·\s+(\d+),(\d+)\s+(\d+),(\d+)$/i);
    const x1=+m[1], y1=+m[2], x2=+m[3], y2=+m[4];
    const line = gridEdgeFromCoords(x1,y1,x2,y2);
    if(!line) return;
    const res = playLine(line, turnTeam);
    if(res.ok){
      if(res.gained>0){
        if(gameActive) resetTimer();
      }else{
        switchTeam();
      }
    }
    return;
  }
}

/************************
 * ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø¨Ø· ÙˆØ§Ù„Ø§Ø³ØªÙ…Ø§Ø¹
 ************************/
RABT.state.onChat = (platform, user, text)=>{ handleCommand(user, text); };

btnConnect?.addEventListener('click', ()=>{
  try{ RABT.disconnect(); }catch{}
  RABT.state.enabledTwitch = !!twEnable.checked;
  RABT.state.enabledKick   = !!kkEnable.checked;
  RABT.state.twChannel = (twChannel.value||'').trim();
  RABT.state.kkChannel = (kkChannel.value||'').trim();

  SHOW_NUMBERS = !!document.getElementById('showDotNumbers')?.checked;
  DOT_START    = Math.max(1, +document.getElementById('dotStart')?.value|0);
  drawBoard();

  RABT.connect();
});

/*********************
 * ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
 *********************/
initBoard(GW,GH);
setTurn('blue'); // Ø£ÙˆÙ„ Ø¯ÙˆØ±: Ø£ÙˆÙ„ Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ù‚ (Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯)

const gridWEl = document.getElementById('gridW');
const gridHEl = document.getElementById('gridH');
document.getElementById('btnStart').onclick = ()=>{
  scoreRed=scoreBlue=0; sr.textContent='0'; sb.textContent='0';
  initBoard(+gridWEl.value, +gridHEl.value);
  redIdx=0; blueIdx=0;
  gameActive = true;
  setTurn('blue'); // Ø³ÙŠØ¹ÙŠØ¯ Ø¶Ø¨Ø· Ø§Ù„Ù…Ø¤Ù‚Øª
};
</script>
</body>
</html>
