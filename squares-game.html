<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StreamerTop â€” Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª (Ø£Ø­Ù…Ø± vs Ø£Ø²Ø±Ù‚)</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="tmi.min.js"></script>
  <style>
    /* ================= Style2026 ================= */
    :root{
      --bg:#0c0f15; --panel:#131827; --panel2:#0f1422; --line:#273149; --muted:#a7b7d6; --text:#f1f5fe;
      --dv:#ff3b4e; --ok:#00e07a; --blue:#3bb8ff; --red:#ff4d5e; --gold:#ffd96b;
      --radius:18px;

      /* âœ… Ø®Ù„ÙÙŠØ© Ø³ØªØ§ÙŠÙ„2026 */
      --bg1:#1a1a3d;   /* Ø¯Ø§ÙƒÙ† */
      --bg2:#004466;   /* Ø¯Ø§ÙƒÙ† */
      --fgText:#fff;   /* Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø®Ù„ÙÙŠØ© */
    }
    /* ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­ Ù„Ø³ØªØ§ÙŠÙ„2026 */
    [data-theme="light"]{
      --bg1:#f2f6ff;
      --bg2:#dfe9ff;
      --fgText:#111;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--fgText);
      font-family:'Cairo',sans-serif;

      /* âœ… Ø®Ù„ÙÙŠØ© Ù…ØªØ­Ø±ÙƒØ© Ù…ÙˆØ­Ù‘Ø¯Ø© */
      background: linear-gradient(-45deg, var(--bg1), var(--bg2), var(--bg1), var(--bg2));
      background-size: 400% 400%;
      animation: gradientBG 20s ease infinite;

      /* ÙƒØ§Ù† Ø³Ø§Ø¨Ù‚Ù‹Ø§: radial + linear Ø«Ø§Ø¨ØªØ© â€” ØªÙ… Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ */
    }
    /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø®Ù„ÙÙŠØ© */
    @keyframes gradientBG {
      0%   { background-position: 0% 50% }
      50%  { background-position: 100% 50% }
      100% { background-position: 0% 50% }
    }

    /* Ø¹Ø±Ø¶ Ù…ØªÙ†Ø§Ø³Ù‚ (Ù…Ùˆ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…ØªØµÙØ­) */
    .wrap{max-width:1400px;width:95vw;margin:16px auto;padding:16px}

    h1{margin:6px 0 12px;font-size:28px;color:var(--gold);text-align:center;letter-spacing:.2px;text-shadow:0 1px 0 #000}

    /* ÙƒØ±ÙˆØª Ø¹Ø§Ù…Ø© */
    .card{
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:0 10px 28px rgba(0,0,0,.28);
    }
    .card .body{padding:14px 16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    label{font-size:13px;color:var(--muted)}
    input,select,button{font-family:'Cairo',sans-serif}
    input[type="number"],input[type="text"],select{
      width:100%;padding:10px 12px;border:1px solid var(--line);
      border-radius:12px;background:#0f1524;color:var(--text)
    }
    button{
      padding:10px 14px;border:1px solid var(--line);background:#0f1524;color:var(--text);
      border-radius:12px;cursor:pointer;transition:.15s;box-shadow:0 2px 0 rgba(0,0,0,.25)
    }
    button:hover{transform:translateY(-1px)}
    button:active{transform:translateY(0)}

    /* Ø´Ø±ÙŠØ· Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø·ÙŠ */
    .bar{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:linear-gradient(180deg,#171d30,#11182a)}
    .bar-left{display:flex;align-items:center;gap:8px}
    .chev{width:34px;height:34px;border:1px solid var(--line);border-radius:10px;display:grid;place-items:center;cursor:pointer;user-select:none}
    .panel{border:1px dashed var(--line);border-radius:12px;margin-top:10px;display:none}
    .panel.open{display:block}

    /* Ø¹Ù†Ø§ØµØ± ØµØºÙŠØ±Ø© */
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:linear-gradient(180deg,#151c2e,#101728);font-size:12px}
    .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-inline-start:6px;background:#777}
    .status-ok{background:var(--ok)}
    .status-bad{background:var(--dv)}
    .kbd{font-family:ui-monospace,monospace;background:#0c1019;border:1px solid var(--line);padding:0 6px;border-radius:6px}
    .help{font-size:13px;color:var(--muted);line-height:1.7}

    /* Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø± */
    .control .body{display:flex;flex-direction:column;gap:12px}
    .quickbar{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid var(--line);border-radius:12px;padding:10px;background:linear-gradient(180deg,#151e34,#0f172a)}

    /* Ø§Ù„Ù…Ø³Ø±Ø­: ÙŠØ³Ø§Ø± Ø£Ø­Ù…Ø± â€” Ø§Ù„Ù„ÙˆØ­Ø© â€” ÙŠÙ…ÙŠÙ† Ø£Ø²Ø±Ù‚ */
    .stage{display:grid;grid-template-columns:280px 1fr 280px;gap:12px;align-items:start;margin-top:12px}
    .team-card{border:1px solid var(--line);border-radius:16px;background:linear-gradient(180deg,#141b2d,#0f1524);display:flex;flex-direction:column}
    .team-card .head{display:flex;align-items:center;gap:8px;padding:12px 14px;border-bottom:1px solid var(--line)}
    .dot{width:10px;height:10px;border-radius:50%}
    .red  .dot{background:var(--red)}
    .blue .dot{background:var(--blue)}
    .team-card.red{box-shadow:inset 0 0 0 1px rgba(255,77,94,.18)}
    .team-card.blue{box-shadow:inset 0 0 0 1px rgba(59,184,255,.18)}
    .list{padding:12px;display:flex;flex-direction:column;gap:8px;max-height:520px;overflow:auto}

    /* Ø¹Ù†ØµØ± Ù„Ø§Ø¹Ø¨ + Ø²Ø± Ø­Ø°Ù */
    .chip{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:6px 10px;border:1px solid var(--line);border-radius:12px;background:linear-gradient(180deg,#152035,#0f1729);font-size:13px
    }
    .chip b{font-weight:600}
    .del{
      flex:0 0 auto; border:1px solid #3a4360; background:#0d1322; color:#ff7a86;
      border-radius:10px; padding:4px 8px; cursor:pointer
    }
    .del:hover{background:#131a2c}

    /* Ø§Ù„Ù„ÙˆØ­Ø© */
    .board-col{display:flex;flex-direction:column;gap:10px}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:linear-gradient(180deg,#151e34,#0f172a)}
    .teamScore{display:flex;align-items:center;gap:10px}
    .turninfo{display:flex;gap:14px;align-items:center;color:var(--muted)}
    .turninfo b{color:var(--text)}
    .canvas-wrap{position:relative;overflow:hidden;border-radius:16px;border:1px solid var(--line);background:linear-gradient(180deg,#141b2d,#0f1524)}
    canvas{display:block;width:100%;height:auto;background:radial-gradient(600px 300px at 20% 0%,rgba(255,255,255,.04),transparent 50%)}

    @media (max-width:1100px){
      .stage{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<div class="wrap">

  <!-- Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© -->
  <h1>ğŸ¯ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª (Ø£Ø­Ù…Ø± vs Ø£Ø²Ø±Ù‚)</h1>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
  <section class="card" style="margin-bottom:12px">
    <div class="bar">
      <div class="bar-left">
        <div id="chevConn" class="chev" title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡">â–¾</div>
        <b>Ù„ÙˆØ­Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø§Øª</b>
      </div>
      <div class="row" style="gap:8px;flex:0 0 auto">
        <span class="pill">Twitch: <span id="statusTw">ØºÙŠØ± Ù…ØªØµÙ„</span> <span id="dotTw" class="status-dot"></span></span>
        <span class="pill">Kick: <span id="statusKk">ØºÙŠØ± Ù…ØªØµÙ„</span> <span id="dotKk" class="status-dot"></span></span>
      </div>
    </div>
    <div id="connPanel" class="panel open">
      <div class="body">
        <div class="row">
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©:</label>
            <input type="text" id="twChannel" placeholder="Ù…Ø«Ø§Ù„: medo_dv" value="YOUR_TWITCH_CHANNEL">
          </div>
          <div>
            <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØµØ©:</label>
            <select id="platformSelect">
              <option value="twitch" selected>ØªÙˆÙŠØªØ´</option>
              <option value="kick">ÙƒÙŠÙƒ</option>
              <option value="both">Ø§Ù„ÙƒÙ„ (ØªÙˆÙŠØªØ´ + ÙƒÙŠÙƒ)</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <label class="pill" style="flex:0 0 auto"><input id="rememberConn" type="checkbox"> ØªØ°ÙƒÙ‘Ø±Ù†ÙŠ</label>
          <button id="btnConnect">Ø§ØªØµØ§Ù„</button>
          <span class="pill">Ù…ØªØµÙ„ Ø¨Ù€: <b id="connectedTo">â€”</b></span>
        </div>

        <div class="help" style="margin-top:8px">
          Ø§Ù„Ø£ÙˆØ§Ù…Ø±: <span class="kbd">!Ø¯Ø®ÙˆÙ„</span>ØŒ <span class="kbd">!Ø£Ø­Ù…Ø±/!Ø§Ø²Ø±Ù‚</span>ØŒ <span class="kbd">!Ø§Ø®ØªØ± @Ø§Ø³Ù…</span>ØŒ <span class="kbd">!ÙˆÙ‚Øª 25</span> â€” Ø§Ù„Ù„Ø¹Ø¨ Ø¨ØµØ§Ø­Ø¨ Ø§Ù„Ø¯ÙˆØ± ÙÙ‚Ø·.
        </div>
      </div>
    </div>
  </section>

  <!-- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø± -->
  <section class="card control" style="margin-bottom:12px">
    <div class="bar">
      <div class="bar-left">
        <div id="chevCtrl" class="chev" title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡">â–¾</div>
        <b>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø±</b>
      </div>
      <div class="pill">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬ÙˆÙ„Ø©</div>
    </div>
    <div id="ctrlPanel" class="panel open">
      <div class="body">
        <div class="quickbar">
          <div class="quick-right">
            <button id="btnStart">â–¶ï¸ Ø§Ø¨Ø¯Ø£ / Ø¥Ø¹Ø§Ø¯Ø©</button>
          </div>
          <div class="quick-left">
            <label class="pill" style="flex:0 0 auto"><input id="showDotNumbers" type="checkbox"> Ø¥Ø¸Ù‡Ø§Ø± ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ù†Ù‚Ø§Ø·</label>
            <input type="number" id="dotStart" min="1" value="1" style="max-width:120px" title="Ø¨Ø¯Ø¡ Ø§Ù„ØªØ±Ù‚ÙŠÙ… Ù…Ù†">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Ø­Ø¬Ù… Ø§Ù„Ø´Ø¨ÙƒØ© (Ù†Ù‚Ø§Ø· Ã— Ù†Ù‚Ø§Ø·)</label>
            <div class="row">
              <input type="number" id="gridW" min="2" max="12" value="5" />
              <input type="number" id="gridH" min="2" max="12" value="5" />
            </div>
          </div>
          <div>
            <label>Ø«ÙˆØ§Ù†ÙŠ Ø§Ù„Ø¯ÙˆØ±</label>
            <input type="number" id="turnSecs" min="5" max="120" value="20" />
          </div>
          <div>
            <label>Ù†Ù‚Ø§Ø· Ø§Ù„ÙÙˆØ² (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input type="number" id="targetScore" min="1" value="0" />
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„Ù…Ø³Ø±Ø­: ÙŠØ³Ø§Ø± Ø£Ø­Ù…Ø± | Ø§Ù„Ù„ÙˆØ­Ø© | ÙŠÙ…ÙŠÙ† Ø£Ø²Ø±Ù‚ -->
  <section class="stage">
    <!-- ÙŠØ³Ø§Ø±: Ø§Ù„Ø£Ø­Ù…Ø± -->
    <aside class="team-card red">
      <div class="head"><span class="dot"></span><b>ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±</b> â€” <small>Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†: <b id="redCount">0</b></small></div>
      <div id="redList" class="list"></div>
    </aside>

    <!-- Ø§Ù„ÙˆØ³Ø·: Ø§Ù„Ù„ÙˆØ­Ø© -->
    <main class="board-col">
      <div class="topbar">
        <div class="teamScore red"><span class="dot"></span> Ø£Ø­Ù…Ø±: <b id="scoreRed">0</b></div>
        <div class="turninfo">
          <span>â±ï¸ Ø§Ù„ÙˆÙ‚Øª: <b id="timeLeft">--</b>s</span>
          <span>ğŸ¯ Ø§Ù„Ø¯ÙˆØ±: <b id="currentTurnPlayer">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</b> (<span id="turnTeamLabel">Ø£Ø²Ø±Ù‚</span>)</span>
        </div>
        <div class="teamScore blue"><span class="dot"></span> Ø£Ø²Ø±Ù‚: <b id="scoreBlue">0</b></div>
      </div>
      <div class="canvas-wrap">
        <canvas id="board" width="1100" height="900"></canvas>
      </div>
    </main>

    <!-- ÙŠÙ…ÙŠÙ†: Ø§Ù„Ø£Ø²Ø±Ù‚ -->
    <aside class="team-card blue">
      <div class="head"><span class="dot"></span><b>ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚</b> â€” <small>Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†: <b id="blueCount">0</b></small></div>
      <div id="blueList" class="list"></div>
    </aside>
  </section>
</div>

<script>
/* Ø«ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¯Ø§ÙƒÙ† Ù„Ù„Ø¨Ø§Ùƒ Ù‚Ø±Ø§ÙˆÙ†Ø¯ */
document.documentElement.setAttribute('data-theme','dark');
</script>

<script>
/*********** Ø§ØªØµØ§Ù„ Twitch & Kick ***********/
const RABT = (() => {
  let twitchClient = null, kickSocket = null, kickPingTimer = null;
  const state = { enabledTwitch:true, enabledKick:false, twChannel:'YOUR_TWITCH_CHANNEL', kkChannel:'YOUR_KICK_CHANNEL', onChat:()=>{} };

  function setDot(el, ok){ el.classList.remove('status-ok','status-bad'); if(ok===true) el.classList.add('status-ok'); else if(ok===false) el.classList.add('status-bad'); }

  function connectTwitch(){
    const statusTw = document.getElementById('statusTw'), dotTw = document.getElementById('dotTw');
    try{
      if(!window.tmi) throw new Error('tmi.min.js ØºÙŠØ± Ù…Ø­Ù…Ù‘ÙÙ„');
      const tmiClient = new tmi.Client({ channels:[state.twChannel], connection:{secure:true,reconnect:true} });
      tmiClient.on('connected', ()=>{ statusTw.textContent='Ù…ØªØµÙ„'; setDot(dotTw,true); updateConnectedLabel(); });
      tmiClient.on('disconnected', ()=>{ statusTw.textContent='ØºÙŠØ± Ù…ØªØµÙ„'; setDot(dotTw,false); });
      tmiClient.on('message', (ch,tags,msg,self)=>{ if(self) return; const u=tags['display-name']||tags.username||'Ù…Ø´Ø§Ø±Ùƒ'; state.onChat('twitch',u,(msg||'').trim()); });
      tmiClient.connect();
    }catch(e){ console.warn(e); statusTw.textContent='ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„'; setDot(dotTw,false); }
  }

  async function connectKick(){
    const statusKk = document.getElementById('statusKk'), dotKk = document.getElementById('dotKk');
    try{ if(kickPingTimer) clearInterval(kickPingTimer); }catch{} try{ if(kickSocket && kickSocket.readyState===WebSocket.OPEN) kickSocket.close(); }catch{}
    kickSocket=null; kickPingTimer=null;
    try{
      const res = await fetch(`https://kick.com/api/v2/channels/${encodeURIComponent(state.kkChannel)}`);
      const data = await res.json().catch(()=>null); const roomId = data?.chatroom?.id;
      if(!roomId){ statusKk.textContent='ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ØºØ±ÙØ©'; setDot(dotKk,false); return; }
      const ws = new WebSocket("wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=8.4.0-rc2&flash=false"); kickSocket=ws;
      ws.onopen=()=>{
        ws.send(JSON.stringify({event:"pusher:subscribe",data:{auth:"",channel:`chatrooms.${roomId}.v2`}}));
        kickPingTimer=setInterval(()=>{ if(ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify({event:"pusher:ping",data:{}})); },12000);
        statusKk.textContent='Ù…ØªØµÙ„'; setDot(dotKk,true); updateConnectedLabel();
      };
      ws.onmessage=(ev)=>{ let p; try{p=JSON.parse(ev.data);}catch{return;} if(p.event==="App\\Events\\ChatMessageEvent"){ let d; try{d=JSON.parse(p.data);}catch{return;} const u=d?.sender?.username||'Ù…Ø´Ø§Ø±Ùƒ'; const t=(d?.content||'').trim(); if(t) state.onChat('kick',u,t); } };
      ws.onerror=()=>{ statusKk.textContent='Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„'; setDot(dotKk,false); };
      ws.onclose =()=>{ statusKk.textContent='ØºÙŠØ± Ù…ØªØµÙ„'; setDot(dotKk,false); try{ if(kickPingTimer) clearInterval(kickPingTimer);}catch{} kickPingTimer=null; };
    }catch(e){ console.warn(e); statusKk.textContent='ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„'; setDot(dotKk,false); }
  }

  function updateConnectedLabel(){
    const lbl=document.getElementById('connectedTo');
    const twOk=document.getElementById('dotTw').classList.contains('status-ok');
    const kkOk=document.getElementById('dotKk').classList.contains('status-ok');
    if(lbl) lbl.textContent = twOk&&kkOk? 'ØªÙˆÙŠØªØ´ + ÙƒÙŠÙƒ' : twOk? 'ØªÙˆÙŠØªØ´' : kkOk? 'ÙƒÙŠÙƒ' : 'â€”';
  }

  return {
    state,
    connect(){ if(state.enabledTwitch) connectTwitch(); if(state.enabledKick) connectKick(); },
    disconnect(){ try{ if(twitchClient && twitchClient.disconnect) twitchClient.disconnect(); }catch{} try{ if(kickPingTimer) clearInterval(kickPingTimer);}catch{} try{ if(kickSocket) kickSocket.close(); }catch{} }
  };
})();

/*********** Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø§ØªØµØ§Ù„ ***********/
const twChannel = document.getElementById('twChannel');
const platformSelect = document.getElementById('platformSelect');
const rememberConn = document.getElementById('rememberConn');
document.getElementById('btnConnect')?.addEventListener('click', ()=>{
  try{ RABT.disconnect(); }catch{}
  const mode = platformSelect.value;
  RABT.state.enabledTwitch = (mode==='twitch' || mode==='both');
  RABT.state.enabledKick   = (mode==='kick'   || mode==='both');
  const ch = (twChannel.value||'').trim();
  RABT.state.twChannel = ch;
  RABT.state.kkChannel = ch; // Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…
  if(rememberConn.checked){ try{ localStorage.setItem('st_ch',ch); localStorage.setItem('st_mode',mode); }catch{} }
  SHOW_NUMBERS = !!document.getElementById('showDotNumbers')?.checked;
  DOT_START    = Math.max(1, +document.getElementById('dotStart')?.value|0);
  drawBoard();
  RABT.connect();
});

/*********** ÙØ±Ù‚/Ù„Ø§Ø¹Ø¨ÙŠÙ† ***********/
const players = new Map(); // name -> {team:'red'|'blue'|null}
function joinPlayer(n){
  if(gameActive) return;                 // â›” Ù…Ù‚ÙÙˆÙ„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨
  if(!players.has(n)) players.set(n,{team:null});
  refreshRosters();
}
function setTeam(n,t){
  if(gameActive) return;                 // â›” Ù…Ù‚ÙÙˆÙ„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨
  if(!players.has(n)) joinPlayer(n);
  players.get(n).team=t; refreshRosters();
}
function removePlayer(n){
  if(!players.has(n)) return;
  // Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ Ø§Ù„Ù…Ø­Ø°ÙˆÙØŒ ØµÙÙ‘Ø± Ø§Ù„Ù…Ø¤Ø´Ø±
  if(currentPlayer && currentPlayer.toLowerCase()===n.toLowerCase()){
    currentPlayer=null; updateTurnUI();
  }
  players.delete(n);
  refreshRosters();
}
function getTeamPlayers(t){ return [...players.entries()].filter(([_,i])=>i.team===t).map(([n])=>n); }

function refreshRosters(){
  const reds=getTeamPlayers('red'), blues=getTeamPlayers('blue');
  // Ø¹Ù†ØµØ± Ù„Ø§Ø¹Ø¨ Ù…Ø¹ Ø²Ø± Ø­Ø°Ù
  const mk = (name)=>`<div class="chip"><b>@${name}</b><button class="del" data-name="${name}" title="Ø­Ø°Ù Ø§Ù„Ù„Ø§Ø¹Ø¨">ğŸ—‘</button></div>`;
  document.getElementById('redList').innerHTML  = reds.map(mk).join('');
  document.getElementById('blueList').innerHTML = blues.map(mk).join('');
  document.getElementById('redCount').textContent=reds.length;
  document.getElementById('blueCount').textContent=blues.length;
}
// Ø­Ø°Ù Ø¨Ø§Ù„Ø¶ØºØ· (Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ…Ø±)
document.getElementById('redList').addEventListener('click', (e)=>{
  const btn = e.target.closest('.del'); if(!btn) return;
  const name = btn.getAttribute('data-name'); removePlayer(name);
});
document.getElementById('blueList').addEventListener('click', (e)=>{
  const btn = e.target.closest('.del'); if(!btn) return;
  const name = btn.getAttribute('data-name'); removePlayer(name);
});

/*********** Ø§Ù„Ù„ÙˆØ­Ø© ***********/
const boardEl = document.getElementById('board'), ctx = boardEl.getContext('2d');
let SHOW_NUMBERS=false, DOT_START=1, GW=5, GH=5;
const PAD=40; let W,H,cellW,cellH,HLines,VLines,boxes;

function initBoard(w,h){
  GW=Math.max(2,Math.min(12,w|0)); GH=Math.max(2,Math.min(12,h|0));
  W=boardEl.width; H=boardEl.height;
  cellW=(W-PAD*2)/(GW-1); cellH=(H-PAD*2)/(GH-1);
  HLines=Array(GH).fill(0).map(()=>Array(GW-1).fill(null));
  VLines=Array(GW).fill(0).map(()=>Array(GH-1).fill(null));
  boxes =Array(GH-1).fill(0).map(()=>Array(GW-1).fill(null));
  drawBoard();
}
function drawBoard(){
  ctx.clearRect(0,0,W,H); ctx.fillStyle='#0b0f15'; ctx.fillRect(0,0,W,H);
  for(let y=0;y<GH-1;y++) for(let x=0;x<GW-1;x++)
    if(boxes[y][x]){ ctx.fillStyle=boxes[y][x]==='red'?'rgba(255,77,94,.35)':'rgba(59,184,255,.35)'; ctx.fillRect(PAD+x*cellW, PAD+y*cellH, cellW, cellH); }
  for(let y=0;y<GH;y++) for(let x=0;x<GW-1;x++){
    const x1=PAD+x*cellW, y1=PAD+y*cellH, x2=PAD+(x+1)*cellW;
    const o=HLines[y][x]; ctx.strokeStyle=o?(o==='red'?'#ff4d5e':'#3bb8ff'):'#2a3347'; ctx.lineWidth=o?6:3;
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y1); ctx.stroke();
  }
  for(let x=0;x<GW;x++) for(let y=0;y<GH-1;y++){
    const x1=PAD+x*cellW, y1=PAD+y*cellH, y2=PAD+(y+1)*cellH;
    const o=VLines[x][y]; ctx.strokeStyle=o?(o==='red'?'#ff4d5e':'#3bb8ff'):'#2a3347'; ctx.lineWidth=o?6:3;
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x1,y2); ctx.stroke();
  }
  for(let y=0;y<GH;y++) for(let x=0;x<GW;x++){
    const rx=PAD+x*cellW, ry=PAD+y*cellH;
    ctx.fillStyle='#f1f5fe'; ctx.beginPath(); ctx.arc(rx,ry,5,0,Math.PI*2); ctx.fill();
    if(SHOW_NUMBERS){
      const idx=DOT_START+y*GW+x; ctx.fillStyle='#d8e0f3'; ctx.font='16px Cairo, sans-serif';
      ctx.textAlign='left'; ctx.textBaseline='top'; ctx.fillText(String(idx), rx+6, ry+6);
    }
  }
}
function pickLineAt(px,py){
  let best=null, bestDist=12;
  for(let y=0;y<GH;y++) for(let x=0;x<GW-1;x++){
    const x1=PAD+x*cellW, y1=PAD+y*cellH, x2=PAD+(x+1)*cellW;
    const d=distPointSegment(px,py,x1,y1,x2,y1); if(d<bestDist && !HLines[y][x]){ bestDist=d; best={type:'H',x,y}; }
  }
  for(let x=0;x<GW;x++) for(let y=0;y<GH-1;y++){
    const x1=PAD+x*cellW, y1=PAD+y*cellH, y2=PAD+(y+1)*cellH;
    const d=distPointSegment(px,py,x1,y1,x1,y2); if(d<bestDist && !VLines[x][y]){ bestDist=d; best={type:'V',x,y}; }
  }
  return best;
}
function distPointSegment(px,py,x1,y1,x2,y2){ const A=px-x1,B=py-y1,C=x2-x1,D=y2-y1, dot=A*C+B*D, len=C*C+D*D; let t=len?dot/len:0; t=Math.max(0,Math.min(1,t)); const dx=x1+t*C-px, dy=y1+t*D-py; return Math.hypot(dx,dy); }
function playLine(line,team){
  if(!line) return {ok:false,gained:0};
  if(line.type==='H'){ if(HLines[line.y][line.x]) return {ok:false,gained:0}; HLines[line.y][line.x]=team; }
  else{ if(VLines[line.x][line.y]) return {ok:false,gained:0}; VLines[line.x][line.y]=team; }
  let g=0;
  if(line.type==='H'){ const y=line.y,x=line.x; if(y>0&&isBoxClosed(x,y-1)){boxes[y-1][x]=team; g++;} if(y<GH-1&&isBoxClosed(x,y)){boxes[y][x]=team; g++;} }
  else{ const x=line.x,y=line.y; if(x>0&&isBoxClosed(x-1,y)){boxes[y][x-1]=team; g++;} if(x<GW-1&&isBoxClosed(x,y)){boxes[y][x]=team; g++;} }
  if(g>0){ addScore(team,g); checkWin(); } drawBoard(); return {ok:true,gained:g};
}
function isBoxClosed(x,y){ return HLines[y][x] && HLines[y+1][x] && VLines[x][y] && VLines[x+1][y]; }

/*********** Ø§Ù„Ø¯ÙˆØ± ÙˆØ§Ù„Ù…Ø¤Ù‚Øª ***********/
let turnTeam='blue', timeLeft=0, timerId=null, gameActive=false, currentPlayer=null, redIdx=0, blueIdx=0;
const timeEl=document.getElementById('timeLeft'), turnTeamLabel=document.getElementById('turnTeamLabel'), currentTurnPlayerEl=document.getElementById('currentTurnPlayer');

function setTurn(team,advance=false){
  turnTeam=team; turnTeamLabel.textContent=(team==='red'?'Ø£Ø­Ù…Ø±':'Ø£Ø²Ø±Ù‚');
  const arr=getTeamPlayers(team);
  if(arr.length===0){ currentPlayer=null; }
  else{
    if(advance){ if(team==='red') redIdx=(redIdx+1)%arr.length; else blueIdx=(blueIdx+1)%arr.length; }
    const idx=(team==='red'?redIdx:blueIdx)%arr.length; currentPlayer=arr[idx];
  }
  updateTurnUI();
  if(gameActive) resetTimer();
}
function updateTurnUI(){ currentTurnPlayerEl.textContent=currentPlayer? '@'+currentPlayer : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'; }
function resetTimer(){
  if(timerId) clearInterval(timerId);
  timeLeft=Math.max(5, +document.getElementById('turnSecs').value|0);
  timeEl.textContent=timeLeft;
  timerId=setInterval(()=>{ timeLeft--; timeEl.textContent=timeLeft; if(timeLeft<=0){ clearInterval(timerId); timerId=null; switchTeam(true); } },1000);
}
function switchTeam(){ setTurn(turnTeam==='red'?'blue':'red', true); }

/*********** Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„ÙÙˆØ² ***********/
let scoreRed=0, scoreBlue=0; const sr=document.getElementById('scoreRed'), sb=document.getElementById('scoreBlue');
function addScore(team,pts){ if(team==='red'){scoreRed+=pts; sr.textContent=scoreRed;} else {scoreBlue+=pts; sb.textContent=scoreBlue;} }
function checkWin(){
  const target=+document.getElementById('targetScore').value|0;
  if(target>0){ if(scoreRed>=target){ alert('ğŸ† ÙØ§Ø² ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±!'); endGame(); } if(scoreBlue>=target){ alert('ğŸ† ÙØ§Ø² ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚!'); endGame(); } }
  else{
    const total=(GW-1)*(GH-1);
    if(scoreRed+scoreBlue>=total){ const w=scoreRed>scoreBlue?'Ø§Ù„Ø£Ø­Ù…Ø±':scoreBlue>scoreRed?'Ø§Ù„Ø£Ø²Ø±Ù‚':'ØªØ¹Ø§Ø¯Ù„'; alert('ğŸ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø© â€” Ø§Ù„ÙØ§Ø¦Ø²: '+w); endGame(); }
  }
}
function endGame(){ if(timerId) clearInterval(timerId); timerId=null; gameActive=false; }

/*********** Ù†Ù‚Ø± Ø§Ù„Ù„ÙˆØ­Ø© ***********/
boardEl.addEventListener('click',(e)=>{
  const r=boardEl.getBoundingClientRect(), sx=boardEl.width/r.width, sy=boardEl.height/r.height;
  const x=(e.clientX-r.left)*sx, y=(e.clientY-r.top)*sy;
  const line=pickLineAt(x,y); if(!line) return;
  const res=playLine(line,turnTeam);
  if(res.ok){ if(res.gained>0){ if(gameActive) resetTimer(); } else { switchTeam(); } }
});

/*********** ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ù†Ù‚Ø§Ø· ***********/
const showDotNumbersEl=document.getElementById('showDotNumbers'), dotStartEl=document.getElementById('dotStart');
showDotNumbersEl.addEventListener('change',()=>{ SHOW_NUMBERS=!!showDotNumbersEl.checked; drawBoard(); });
dotStartEl.addEventListener('change',()=>{ DOT_START=Math.max(1,+dotStartEl.value|0); drawBoard(); });

/*********** Ø£Ø±Ù‚Ø§Ù… Ø¹Ø±Ø¨ÙŠØ© â†’ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ***********/
function normalizeDigits(s){ const m={'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9','Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9'}; return String(s).replace(/[Ù -Ù©Û°-Û¹]/g,d=>m[d]??d); }

/*********** Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø§Øª ***********/
function isStreamer(u){ const owner=(RABT.state.twChannel||'').toLowerCase(); return (u||'').toLowerCase()===owner; }
function gridEdgeFromCoords(x1,y1,x2,y2){ if(x1<1||x1>GW||y1<1||y1>GH||x2<1||x2>GW||y2<1||y2>GH) return null; if(y1===y2&&Math.abs(x1-x2)===1){ const y=y1-1,x=Math.min(x1,x2)-1; if(HLines[y]?.[x]) return null; return {type:'H',x,y}; } if(x1===x2&&Math.abs(y1-y2)===1){ const x=x1-1,y=Math.min(y1,y2)-1; if(VLines[x]?.[y]) return null; return {type:'V',x,y}; } return null; }
function indexToXY(idx){ const z=idx-DOT_START; if(z<0) return null; const y=Math.floor(z/GW),x=z%GW; if(y<0||y>=GH||x<0||x>=GW) return null; return {x,y}; }
function lineFromIndexPair(a,b){ const p1=indexToXY(a),p2=indexToXY(b); if(!p1||!p2) return null; if(p1.y===p2.y&&Math.abs(p1.x-p2.x)===1){ const y=p1.y,x=Math.min(p1.x,p2.x); if(HLines[y]?.[x]) return null; return {type:'H',x,y}; } if(p1.x===p2.x&&Math.abs(p1.y-p2.y)===1){ const x=p1.x,y=Math.min(p1.y,p2.y); if(VLines[x]?.[y]) return null; return {type:'V',x,y}; } return null; }

function handleCommand(user,text){
  const norm=normalizeDigits((text||'').trim());

  // â›” Ù‚ÙÙ„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨: Ù„Ø§ Ø¯Ø®ÙˆÙ„ ÙˆÙ„Ø§ ØªØºÙŠÙŠØ± ÙØ±Ù‚
  if(gameActive){
    if(/^!Ø¯Ø®ÙˆÙ„$/i.test(norm)) return;
    if(/^!(Ø§Ø²Ø±Ù‚|Ø£Ø²Ø±Ù‚|Ø§Ø­Ù…Ø±|Ø£Ø­Ù…Ø±)$/i.test(norm)) return;
  }

  if(/^!Ø¯Ø®ÙˆÙ„$/i.test(norm)){ joinPlayer(user); return; }
  if(/^!(Ø§Ø²Ø±Ù‚|Ø£Ø²Ø±Ù‚)$/i.test(norm)){ setTeam(user,'blue'); return; }
  if(/^!(Ø§Ø­Ù…Ø±|Ø£Ø­Ù…Ø±)$/i.test(norm)){ setTeam(user,'red'); return; }

  if(/^!Ø§Ø®ØªØ±\s+@?([^\s]+)$/i.test(norm)){
    if(!isStreamer(user)) return;
    const m=norm.match(/^!Ø§Ø®ØªØ±\s+@?([^\s]+)$/i); const target=m[1];
    if(players.has(target) && getTeamPlayers(turnTeam).includes(target)){ currentPlayer=target; updateTurnUI(); }
    return;
  }
  if(/^!ÙˆÙ‚Øª\s+(\d{1,3})$/i.test(norm)){
    if(!isStreamer(user)) return;
    const secs=+norm.match(/^!ÙˆÙ‚Øª\s+(\d{1,3})$/i)[1];
    document.getElementById('turnSecs').value=Math.max(5, Math.min(300, secs));
    if(gameActive) resetTimer();
    return;
  }

  if(!currentPlayer || (user||'').toLowerCase() !== currentPlayer.toLowerCase()) return;

  if(/^\d+\s*-\s*\d+$/.test(norm)){
    const [a,b]=norm.split('-').map(s=>+s.trim());
    const line=lineFromIndexPair(a,b); if(!line) return;
    const r=playLine(line,turnTeam); if(r.ok){ if(r.gained>0){ if(gameActive) resetTimer(); } else { switchTeam(); } }
    return;
  }
  if(/^!Ø®Ø·\s+(\d+),(\d+)\s+(\d+),(\d+)$/i.test(norm)){
    const m=norm.match(/^!Ø®Ø·\s+(\d+),(\d+)\s+(\d+),(\d+)$/i);
    const x1=+m[1], y1=+m[2], x2=+m[3], y2=+m[4];
    const line=gridEdgeFromCoords(x1,y1,x2,y2); if(!line) return;
    const r=playLine(line,turnTeam); if(r.ok){ if(r.gained>0){ if(gameActive) resetTimer(); } else { switchTeam(); } }
    return;
  }
}

/*********** Ø¥Ù‚Ù„Ø§Ø¹ Ø£ÙˆÙ„ÙŠ ***********/
(function(){
  try{ const sCh=localStorage.getItem('st_ch'); if(sCh) twChannel.value=sCh; const sMd=localStorage.getItem('st_mode'); if(sMd) platformSelect.value=sMd; }catch{}
  initBoard(GW,GH); setTurn('blue');
  document.getElementById('btnStart').onclick=()=>{
    // Ø¨Ø¯Ø¡/Ø¥Ø¹Ø§Ø¯Ø©
    scoreRed=scoreBlue=0; sr.textContent='0'; sb.textContent='0';
    initBoard(+document.getElementById('gridW').value, +document.getElementById('gridH').value);
    redIdx=0; blueIdx=0; gameActive=true; setTurn('blue');
  };
})();
RABT.state.onChat=(p,u,t)=>{ handleCommand(u,t); };

/* ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ */
document.getElementById('chevConn')?.addEventListener('click', ()=> document.getElementById('connPanel').classList.toggle('open'));
document.getElementById('chevCtrl')?.addEventListener('click', ()=> document.getElementById('ctrlPanel').classList.toggle('open'));
</script>
</body>
</html>
