<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StreamerTop — لعبة المربعات (أحمر vs أزرق)</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- مكتبات الشات: تحتاج tmi لتويتش فقط، وكود Kick مدمج هنا -->
  <script src="tmi.min.js"></script>
  <style>
    :root{
      --bg:#0f1115; --panel:#141922; --panel2:#1a2030; --line:#2a3347; --muted:#9fb0d0; --text:#e9eef7;
      --dv:#ff3333; --ok:#00d86c; --blue:#2ea8ff; --red:#ff4455; --gold:#f8d35e;
    }
    *{box-sizing:border-box}
    body{margin:0;background:
      radial-gradient(1200px 600px at 10% 10%,rgba(255,255,255,.04),transparent 60%),
      radial-gradient(1200px 600px at 90% 90%,rgba(255,255,255,.05),transparent 60%),
      linear-gradient(180deg,#0f1115,#0b0d11);
      color:var(--text);font-family:'Cairo',sans-serif}
    .wrap{max-width:1200px;margin:20px auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .logo{display:flex;align-items:center;gap:10px}
    .badge{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:linear-gradient(180deg,#151a24,#10141c)}

    .card{background:linear-gradient(180deg,#141922,#0f131a);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .card h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--line);font-size:18px}
    .card .body{padding:14px 16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    label{font-size:13px;color:var(--muted)}
    input,select,button{font-family:'Cairo',sans-serif}
    input[type="number"],input[type="text"],select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#0f131a;color:var(--text)}
    button{padding:10px 14px;border:1px solid var(--line);background:#0f131a;color:var(--text);border-radius:12px;cursor:pointer;transition:.2s}
    button:hover{transform:translateY(-1px)}

    /* شريط أعلى اللوحة: النتائج + الوقت + اللاعب */
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border:1px solid var(--line);border-radius:12px;margin-bottom:10px;background:linear-gradient(180deg,#151a23,#0f131a)}
    .team{display:flex;align-items:center;gap:10px}
    .dot{width:10px;height:10px;border-radius:50%}
    .blue .dot{background:var(--blue)}
    .red .dot{background:var(--red)}
    .topbar b{font-size:20px}
    .turninfo{display:flex;gap:14px;align-items:center;color:var(--muted)}
    .turninfo b{color:var(--text)}

    .canvas-wrap{position:relative;overflow:hidden;border-radius:16px}
    canvas{display:block;width:100%;height:auto;background:radial-gradient(600px 300px at 20% 0%,rgba(255,255,255,.04),transparent 50%)}

    .help{font-size:13px;color:var(--muted);line-height:1.7}
    .kbd{font-family:ui-monospace,monospace;background:#0c1016;border:1px solid var(--line);padding:0 6px;border-radius:6px}

    /* لوحة الاتصال أعلى الصفحة */
    .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-inline-start:6px;background:#777}
    .status-ok{background:var(--ok)}
    .status-bad{background:var(--dv)}
    .teams-lists{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px}
    .teams-lists .title{font-size:13px; color:var(--muted); margin-bottom:6px}
    .roster{display:flex;flex-wrap:wrap;gap:6px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:linear-gradient(180deg,#151a24,#10141c);font-size:12px}
    .roster .pill{padding:4px 8px}

    @media (max-width:900px){
      .wrap{padding:10px}
    }
  </style>
</head>
<body>
<div class="wrap">

  <!-- 🔌 لوحة الاتصال بالقنوات -->
  <section class="card" style="margin-bottom:12px">
    <h3>🔌 لوحة الاتصال بالقنوات</h3>
    <div class="body">
      <div class="row" style="justify-content:space-between">
        <div class="team red" style="flex:0 0 auto"><span class="dot"></span> فريق الأحمر</div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <span class="pill">Twitch: <span id="statusTw">غير متصل</span> <span id="dotTw" class="status-dot"></span></span>
          <span class="pill">Kick: <span id="statusKk">غير متصل</span> <span id="dotKk" class="status-dot"></span></span>
        </div>
        <div class="team blue" style="flex:0 0 auto"><span class="dot"></span> فريق الأزرق</div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>تويتش — اسم القناة</label>
          <div class="row">
            <label class="pill" style="flex:0 0 auto"><input id="twEnable" type="checkbox" checked> تفعيل</label>
            <input type="text" id="twChannel" placeholder="اسم قناة تويتش" value="YOUR_TWITCH_CHANNEL">
          </div>
        </div>
        <div>
          <label>كيك — اسم القناة</label>
          <div class="row">
            <label class="pill" style="flex:0 0 auto"><input id="kkEnable" type="checkbox"> تفعيل</label>
            <input type="text" id="kkChannel" placeholder="اسم قناة كيك" value="YOUR_KICK_CHANNEL">
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnConnect">🔗 اتصال / إعادة اتصال</button>
        <label class="pill" style="flex:0 0 auto"><input id="showDotNumbers" type="checkbox"> إظهار ترقيم النقاط</label>
        <input type="number" id="dotStart" min="1" value="1" style="max-width:110px" title="بدء الترقيم من">
      </div>

      <!-- قوائم اللاعبين لكل فريق -->
      <div class="teams-lists">
        <div>
          <div class="title">👥 لاعبو فريق الأحمر (<span id="redCount">0</span>)</div>
          <div class="roster" id="redList"></div>
        </div>
        <div>
          <div class="title">👥 لاعبو فريق الأزرق (<span id="blueCount">0</span>)</div>
          <div class="roster" id="blueList"></div>
        </div>
      </div>

      <div class="help" style="margin-top:8px">
        الأوامر في الشات: <span class="kbd">!دخول</span>، <span class="kbd">!أحمر</span>/<span class="kbd">!احمر</span>، <span class="kbd">!أزرق</span>/<span class="kbd">!ازرق</span>، 
        <span class="kbd">!اختر @اسم</span> (للاستريمر)، <span class="kbd">!وقت 25</span> (للاستريمر).<br>
        اللعب: <span class="kbd">1-2</span> (تدعم ١-٢) أو <span class="kbd">!خط 1,1 2,1</span> — التنفيذ مسموح فقط لصاحب <b>الدور الحالي</b>.
      </div>
    </div>
  </section>

  <!-- شريط النتائج/الوقت/اللاعب فوق اللوحة -->
  <div class="topbar">
    <div class="team red"><span class="dot"></span> أحمر: <b id="scoreRed">0</b></div>
    <div class="turninfo">
      <span>⏱️ الوقت: <b id="timeLeft">--</b>s</span>
      <span>🎯 الدور: <b id="currentTurnPlayer">غير محدد</b> (<span id="turnTeamLabel">أزرق</span>)</span>
    </div>
    <div class="team blue"><span class="dot"></span> أزرق: <b id="scoreBlue">0</b></div>
  </div>

  <!-- اللوحة -->
  <section class="card">
    <div class="canvas-wrap">
      <canvas id="board" width="900" height="900"></canvas>
    </div>
  </section>

  <!-- إعدادات أساسية -->
  <section class="card" id="settingsCard" style="margin-top:12px">
    <h3>⚙️ الإعدادات</h3>
    <div class="body">
      <div class="row">
        <div>
          <label>حجم الشبكة (نقاط × نقاط)</label>
          <div class="row">
            <input type="number" id="gridW" min="2" max="12" value="5" />
            <input type="number" id="gridH" min="2" max="12" value="5" />
          </div>
        </div>
        <div>
          <label>ثواني الدور</label>
          <input type="number" id="turnSecs" min="5" max="120" value="20" />
        </div>
        <div>
          <label>نقاط الفوز (اختياري)</label>
          <input type="number" id="targetScore" min="1" value="0" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnStart">▶️ بدء / إعادة</button>
      </div>
    </div>
  </section>
</div>

<script>
/******************************
 *  ربط — Twitch & Kick
 ******************************/
const RABT = (() => {
  let twitchClient = null;

  // ——— Kick عبر API + Pusher WebSocket ———
  let kickSocket = null;
  let kickPingTimer = null;

  const state = {
    enabledTwitch: true,
    enabledKick: false,
    twChannel: 'YOUR_TWITCH_CHANNEL',
    kkChannel: 'YOUR_KICK_CHANNEL',
    onChat: (platform, user, text) => {}
  };

  function setDot(el, ok){
    el.classList.remove('status-ok','status-bad');
    if(ok===true) el.classList.add('status-ok');
    else if(ok===false) el.classList.add('status-bad');
  }

  function connectTwitch(){
    const statusTw = document.getElementById('statusTw');
    const dotTw = document.getElementById('dotTw');
    try{
      if(!window.tmi) throw new Error('tmi.min.js غير محمَّل');
      twitchClient = new tmi.Client({
        channels: [state.twChannel],
        connection: { secure:true, reconnect:true }
      });
      twitchClient.on('connected', ()=>{ statusTw.textContent='متصل: '+state.twChannel; setDot(dotTw,true); });
      twitchClient.on('disconnected', ()=>{ statusTw.textContent='غير متصل'; setDot(dotTw,false); });
      twitchClient.on('message', (channel, tags, message, self) => {
        if(self) return;
        const user = tags['display-name'] || tags.username || 'مشارك';
        const txt  = (message||'').trim();
        state.onChat('twitch', user, txt);
      });
      twitchClient.connect();
    }catch(e){
      console.warn('Twitch connect error:', e);
      statusTw.textContent = 'فشل الاتصال';
      setDot(dotTw,false);
    }
  }

  // ✅ نفس أسلوب لعبتك: جلب roomId ثم الاشتراك في قناة الدردشة عبر Pusher WS
  async function connectKick(){
    const statusKk = document.getElementById('statusKk');
    const dotKk = document.getElementById('dotKk');

    // تنظيف أي اتصال قديم
    try{ if(kickPingTimer) clearInterval(kickPingTimer); }catch{}
    try{ if(kickSocket && kickSocket.readyState===WebSocket.OPEN) kickSocket.close(); }catch{}
    kickSocket = null; kickPingTimer = null;

    try{
      // 1) جلب بيانات القناة للحصول على chatroom.id
      const channel = state.kkChannel;
      const res = await fetch(`https://kick.com/api/v2/channels/${encodeURIComponent(channel)}`);
      const data = await res.json().catch(()=>null);
      const roomId = data?.chatroom?.id;
      if(!roomId){
        statusKk.textContent = 'فشل جلب الغرفة';
        setDot(dotKk,false);
        return;
      }

      // 2) فتح WebSocket إلى Pusher والاشتراك في قناة chatrooms.{roomId}.v2
      const ws = new WebSocket("wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=8.4.0-rc2&flash=false");
      kickSocket = ws;

      ws.onopen = ()=>{
        // الاشتراك
        ws.send(JSON.stringify({
          event:"pusher:subscribe",
          data:{auth:"", channel:`chatrooms.${roomId}.v2`}
        }));
        // ping كل 12 ثانية
        kickPingTimer = setInterval(()=>{
          if(ws.readyState===WebSocket.OPEN){
            ws.send(JSON.stringify({event:"pusher:ping", data:{}}));
          }
        }, 12000);

        statusKk.textContent = 'متصل: '+channel;
        setDot(dotKk,true);
      };

      ws.onmessage = (event)=>{
        let pkt;
        try{ pkt = JSON.parse(event.data); }catch{return;}
        if(pkt.event === "App\\Events\\ChatMessageEvent"){
          let d;
          try{ d = JSON.parse(pkt.data); }catch{return;}
          const user = d?.sender?.username || 'مشارك';
          const text = (d?.content || '').trim();
          if(text) state.onChat('kick', user, text);
        }
      };

      ws.onerror = ()=>{
        statusKk.textContent = 'مشكلة اتصال';
        setDot(dotKk,false);
      };
      ws.onclose = ()=>{
        statusKk.textContent = 'غير متصل';
        setDot(dotKk,false);
        try{ if(kickPingTimer) clearInterval(kickPingTimer); }catch{}
        kickPingTimer = null;
      };
    }catch(e){
      console.warn('Kick connect error:', e);
      statusKk.textContent = 'فشل الاتصال';
      setDot(dotKk,false);
    }
  }

  function connect() {
    if(state.enabledTwitch) connectTwitch();
    if(state.enabledKick) connectKick();
  }

  function disconnect(){
    // Twitch
    try{ if(twitchClient && twitchClient.disconnect) twitchClient.disconnect(); }catch{}
    // Kick
    try{ if(kickPingTimer) clearInterval(kickPingTimer); }catch{}
    try{ if(kickSocket) kickSocket.close(); }catch{}
  }

  return { state, connect, disconnect };
})();

/*********************
 * عناصر اتصال
 *********************/
const twEnable = document.getElementById('twEnable');
const kkEnable = document.getElementById('kkEnable');
const twChannel = document.getElementById('twChannel');
const kkChannel = document.getElementById('kkChannel');
const btnConnect = document.getElementById('btnConnect');

/*********************
 * لاعبين/فرق + قوائم
 *********************/
const players = new Map(); // username -> {team:'red'|'blue'|null}
function joinPlayer(name){
  if(!players.has(name)) players.set(name,{team:null});
  refreshRosters();
}
function setTeam(name, team){
  if(!players.has(name)) joinPlayer(name);
  players.get(name).team = team;
  refreshRosters();
}
function teamOf(name){ return players.get(name)?.team || null; }
function getTeamPlayers(team){ return [...players.entries()].filter(([n,i])=>i.team===team).map(([n])=>n); }
function refreshRosters(){
  const redList = document.getElementById('redList');
  const blueList = document.getElementById('blueList');
  const redCount = document.getElementById('redCount');
  const blueCount = document.getElementById('blueCount');

  const reds = getTeamPlayers('red');
  const blues = getTeamPlayers('blue');

  redList.innerHTML = reds.map(n=>`<span class="pill">@${n}</span>`).join('');
  blueList.innerHTML = blues.map(n=>`<span class="pill">@${n}</span>`).join('');

  redCount.textContent = reds.length;
  blueCount.textContent = blues.length;
}

/*********************
 * اللوحة
 *********************/
const boardEl = document.getElementById('board');
const ctx = boardEl.getContext('2d');
let SHOW_NUMBERS=false; let DOT_START=1;

let GW=5, GH=5;
const PAD = 40;
let W,H,cellW,cellH;

let HLines, VLines, boxes;

function initBoard(w,h){
  GW = Math.max(2, Math.min(12, w|0));
  GH = Math.max(2, Math.min(12, h|0));
  W = boardEl.width; H = boardEl.height;
  cellW = (W - PAD*2) / (GW-1);
  cellH = (H - PAD*2) / (GH-1);
  HLines = Array(GH).fill(0).map(()=>Array(GW-1).fill(null));
  VLines = Array(GW).fill(0).map(()=>Array(GH-1).fill(null));
  boxes  = Array(GH-1).fill(0).map(()=>Array(GW-1).fill(null));
  drawBoard();
}

function drawBoard(){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = '#0b0f15';
  ctx.fillRect(0,0,W,H);

  // المربعات المملوكة
  for(let y=0;y<GH-1;y++){
    for(let x=0;x<GW-1;x++){
      if(boxes[y][x]){
        ctx.fillStyle = boxes[y][x]==='red'? 'rgba(255,68,85,.35)' : 'rgba(46,168,255,.35)';
        const rx = PAD + x*cellW, ry = PAD + y*cellH;
        ctx.fillRect(rx, ry, cellW, cellH);
      }
    }
  }

  // خطوط أفقية
  for(let y=0;y<GH;y++){
    for(let x=0;x<GW-1;x++){
      const rx1 = PAD + x*cellW, ry = PAD + y*cellH, rx2 = PAD + (x+1)*cellW;
      const owner = HLines[y][x];
      ctx.strokeStyle = owner ? (owner==='red'? '#ff4455':'#2ea8ff') : '#2a3347';
      ctx.lineWidth = owner? 6:3;
      ctx.beginPath(); ctx.moveTo(rx1,ry); ctx.lineTo(rx2,ry); ctx.stroke();
    }
  }
  // خطوط عمودية
  for(let x=0;x<GW;x++){
    for(let y=0;y<GH-1;y++){
      const rx = PAD + x*cellW, ry1 = PAD + y*cellH, ry2 = PAD + (y+1)*cellH;
      const owner = VLines[x][y];
      ctx.strokeStyle = owner ? (owner==='red'? '#ff4455':'#2ea8ff') : '#2a3347';
      ctx.lineWidth = owner? 6:3;
      ctx.beginPath(); ctx.moveTo(rx,ry1); ctx.lineTo(rx,ry2); ctx.stroke();
    }
  }
  // نقاط + أرقام
  for(let y=0;y<GH;y++){
    for(let x=0;x<GW;x++){
      const rx = PAD + x*cellW, ry = PAD + y*cellH;
      ctx.fillStyle = '#e9eef7';
      ctx.beginPath(); ctx.arc(rx,ry,5,0,Math.PI*2); ctx.fill();
      if(SHOW_NUMBERS){
        const idx = DOT_START + y*GW + x;
        ctx.fillStyle = '#9fb0d0';
        ctx.font = '12px Cairo, sans-serif';
        ctx.textAlign = 'left'; ctx.textBaseline = 'top';
        ctx.fillText(String(idx), rx+6, ry+6);
      }
    }
  }
}

function pickLineAt(px,py){
  let best = null; let bestDist = 12;
  // أفقي
  for(let y=0;y<GH;y++){
    for(let x=0;x<GW-1;x++){
      const x1 = PAD + x*cellW, y1 = PAD + y*cellH, x2 = PAD + (x+1)*cellW;
      const d = distPointSegment(px,py,x1,y1,x2,y1);
      if(d<bestDist && !HLines[y][x]){ bestDist=d; best={type:'H',x,y}; }
    }
  }
  // عمودي
  for(let x=0;x<GW;x++){
    for(let y=0;y<GH-1;y++){
      const x1 = PAD + x*cellW, y1 = PAD + y*cellH, y2 = PAD + (y+1)*cellH;
      const d = distPointSegment(px,py,x1,y1,x1,y2);
      if(d<bestDist && !VLines[x][y]){ bestDist=d; best={type:'V',x,y}; }
    }
  }
  return best;
}
function distPointSegment(px,py,x1,y1,x2,y2){
  const A=px-x1, B=py-y1, C=x2-x1, D=y2-y1;
  const dot = A*C + B*D;
  const len = C*C + D*D;
  let t = len? dot/len : 0; t=Math.max(0,Math.min(1,t));
  const dx = x1 + t*C - px, dy = y1 + t*D - py;
  return Math.hypot(dx,dy);
}

function playLine(line, team){
  if(!line) return {ok:false,gained:0};
  if(line.type==='H'){
    if(HLines[line.y][line.x]) return {ok:false,gained:0};
    HLines[line.y][line.x]=team;
  }else{
    if(VLines[line.x][line.y]) return {ok:false,gained:0};
    VLines[line.x][line.y]=team;
  }
  let gained = 0;
  if(line.type==='H'){
    const y=line.y, x=line.x;
    if(y>0 && isBoxClosed(x,y-1)) { boxes[y-1][x]=team; gained++; }
    if(y<GH-1 && isBoxClosed(x,y)) { boxes[y][x]=team; gained++; }
  }else{
    const x=line.x, y=line.y;
    if(x>0 && isBoxClosed(x-1,y)) { boxes[y][x-1]=team; gained++; }
    if(x<GW-1 && isBoxClosed(x,y)) { boxes[y][x]=team; gained++; }
  }
  if(gained>0){ addScore(team,gained); checkWin(); }
  drawBoard();
  return {ok:true,gained};
}
function isBoxClosed(x,y){
  return HLines[y][x] && HLines[y+1][x] && VLines[x][y] && VLines[x+1][y];
}

/*********************
 * الدور والمؤقت + طوابير اللاعبين
 *********************/
let turnTeam = 'blue';             // يبدأ بالأزرق
let timeLeft = 0, timerId=null;
let gameActive = false;
let currentPlayer = null;

let redIdx = 0, blueIdx = 0;

const timeEl = document.getElementById('timeLeft');
const turnTeamLabel = document.getElementById('turnTeamLabel');
const currentTurnPlayerEl = document.getElementById('currentTurnPlayer');

function setTurn(team, advanceIndex=false){
  turnTeam = team;
  turnTeamLabel.textContent = (team==='red'?'أحمر':'أزرق');

  const arr = getTeamPlayers(team);
  if(arr.length===0){
    currentPlayer = null;
  }else{
    if(advanceIndex){
      if(team==='red'){ redIdx = (redIdx+1) % arr.length; }
      else { blueIdx = (blueIdx+1) % arr.length; }
    }
    const idx = (team==='red'? redIdx : blueIdx) % arr.length;
    currentPlayer = arr[idx];
  }

  updateTurnUI();
  if(gameActive) resetTimer();
}
function updateTurnUI(){
  currentTurnPlayerEl.textContent = currentPlayer ? '@'+currentPlayer : 'غير محدد';
}
function resetTimer(){
  if(timerId) clearInterval(timerId);
  timeLeft = Math.max(5, +document.getElementById('turnSecs').value|0);
  timeEl.textContent = timeLeft;
  timerId = setInterval(()=>{
    timeLeft--;
    timeEl.textContent = timeLeft;
    if(timeLeft<=0){
      clearInterval(timerId); timerId=null;
      switchTeam(true); // انتهى الوقت → بدّل الفريق وتقدّم في طابوره
    }
  },1000);
}
function switchTeam(){
  const nextTeam = (turnTeam==='red'?'blue':'red');
  setTurn(nextTeam, /*advanceIndex*/ true);
}

/*********************
 * النقاط والفوز
 *********************/
let scoreRed=0, scoreBlue=0;
const sr=document.getElementById('scoreRed'), sb=document.getElementById('scoreBlue');

function addScore(team,pts){ if(team==='red'){scoreRed+=pts; sr.textContent=scoreRed;} else {scoreBlue+=pts; sb.textContent=scoreBlue;} }
function checkWin(){
  const target = +document.getElementById('targetScore').value|0;
  if(target>0){
    if(scoreRed>=target){ alert('🏆 فاز فريق الأحمر!'); endGame(); }
    if(scoreBlue>=target){ alert('🏆 فاز فريق الأزرق!'); endGame(); }
  }else{
    const totalBoxes = (GW-1)*(GH-1);
    if(scoreRed+scoreBlue >= totalBoxes){
      const winner = scoreRed>scoreBlue? 'الأحمر' : scoreBlue>scoreRed? 'الأزرق' : 'تعادل';
      alert('🏁 انتهت اللعبة — الفائز: '+winner);
      endGame();
    }
  }
}
function endGame(){ if(timerId) clearInterval(timerId); timerId=null; gameActive=false; }

/*********************
 * نقر الماوس (اختياري للاختبار)
 *********************/
boardEl.addEventListener('click', (e)=>{
  const rect = boardEl.getBoundingClientRect();
  const scaleX = boardEl.width / rect.width; const scaleY = boardEl.height / rect.height;
  const x = (e.clientX - rect.left) * scaleX;
  const y = (e.clientY - rect.top) * scaleY;
  const picked = pickLineAt(x,y);
  if(picked){
    const res = playLine(picked, turnTeam);
    if(res.ok){
      if(res.gained>0){
        if(gameActive) resetTimer(); // نفس الفريق ونفس اللاعب
      }else{
        switchTeam(); // الفريق الآخر + تقدّم في طابوره
      }
    }
  }
});

/*********************
 * ترقيم النقاط
 *********************/
const showDotNumbersEl = document.getElementById('showDotNumbers');
const dotStartEl = document.getElementById('dotStart');
showDotNumbersEl.addEventListener('change',()=>{ SHOW_NUMBERS = !!showDotNumbersEl.checked; drawBoard(); });
dotStartEl.addEventListener('change',()=>{ DOT_START = Math.max(1, +dotStartEl.value|0); drawBoard(); });

/*********************
 * تحويل الأرقام العربية → الإنجليزية
 *********************/
function normalizeDigits(str){
  const map = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9','۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9'};
  return String(str).replace(/[٠-٩۰-۹]/g, d=>map[d] ?? d);
}

/*********************
 * أوامر الشات (اللعب لصاحب الدور فقط)
 *********************/
function isStreamer(user){
  const owner = (RABT.state.twChannel||'').toLowerCase();
  return (user||'').toLowerCase()===owner;
}

function gridEdgeFromCoords(x1,y1,x2,y2){
  if(x1<1||x1>GW||y1<1||y1>GH||x2<1||x2>GW||y2<1||y2>GH) return null;
  if(y1===y2 && Math.abs(x1-x2)===1){
    const y=y1-1, x=Math.min(x1,x2)-1; if(HLines[y]?.[x]) return null; return {type:'H',x,y};
  }
  if(x1===x2 && Math.abs(y1-y2)===1){
    const x=x1-1, y=Math.min(y1,y2)-1; if(VLines[x]?.[y]) return null; return {type:'V',x,y};
  }
  return null;
}
function indexToXY(idx){
  const zero = idx - DOT_START; if(zero<0) return null;
  const y = Math.floor(zero / GW), x = zero % GW;
  if(y<0||y>=GH||x<0||x>=GW) return null; return {x,y};
}
function lineFromIndexPair(a,b){
  const p1=indexToXY(a), p2=indexToXY(b); if(!p1||!p2) return null;
  if(p1.y===p2.y && Math.abs(p1.x-p2.x)===1){
    const y=p1.y, x=Math.min(p1.x,p2.x); if(HLines[y]?.[x]) return null; return {type:'H',x,y};
  }
  if(p1.x===p2.x && Math.abs(p1.y-p2.y)===1){
    const x=p1.x, y=Math.min(p1.y,p2.y); if(VLines[x]?.[y]) return null; return {type:'V',x,y};
  }
  return null;
}

function handleCommand(user, text){
  const msg = (text||'').trim();
  const norm = normalizeDigits(msg);

  // التسجيل/اختيار الفريق للجميع
  if(/^!دخول$/i.test(norm)){ joinPlayer(user); return; }
  if(/^!(ازرق|أزرق)$/i.test(norm)){ setTeam(user,'blue'); return; }
  if(/^!(احمر|أحمر)$/i.test(norm)){ setTeam(user,'red'); return; }

  // للستريمر فقط: اختيار لاعب/تغيير وقت
  if(/^!اختر\s+@?([^\s]+)$/i.test(norm)){
    if(!isStreamer(user)) return;
    const m=norm.match(/^!اختر\s+@?([^\s]+)$/i); const target=m[1];
    if(players.has(target) && teamOf(target)===turnTeam){
      currentPlayer = target; updateTurnUI();
    }
    return;
  }
  if(/^!وقت\s+(\d{1,3})$/i.test(norm)){
    if(!isStreamer(user)) return;
    const secs = +norm.match(/^!وقت\s+(\d{1,3})$/i)[1];
    document.getElementById('turnSecs').value = Math.max(5, Math.min(300, secs));
    if(gameActive) resetTimer();
    return;
  }

  // من هنا: اللعب لصاحب الدور فقط
  if(!currentPlayer || (user||'').toLowerCase() !== currentPlayer.toLowerCase()) return;

  // 1-2
  if(/^\d+\s*-\s*\d+$/.test(norm)){
    const [a,b] = norm.split('-').map(s=>+s.trim());
    const line = lineFromIndexPair(a,b);
    if(!line) return;
    const res = playLine(line, turnTeam);
    if(res.ok){
      if(res.gained>0){
        if(gameActive) resetTimer(); // نفس اللاعب/الفريق
      }else{
        switchTeam(); // الفريق الآخر والتقدّم في طابوره
      }
    }
    return;
  }

  // !خط x1,y1 x2,y2
  if(/^!خط\s+(\d+),(\d+)\s+(\d+),(\d+)$/i.test(norm)){
    const m = norm.match(/^!خط\s+(\d+),(\d+)\s+(\d+),(\d+)$/i);
    const x1=+m[1], y1=+m[2], x2=+m[3], y2=+m[4];
    const line = gridEdgeFromCoords(x1,y1,x2,y2);
    if(!line) return;
    const res = playLine(line, turnTeam);
    if(res.ok){
      if(res.gained>0){
        if(gameActive) resetTimer();
      }else{
        switchTeam();
      }
    }
    return;
  }
}

/************************
 * تفعيل الربط والاستماع
 ************************/
RABT.state.onChat = (platform, user, text)=>{ handleCommand(user, text); };

btnConnect?.addEventListener('click', ()=>{
  try{ RABT.disconnect(); }catch{}
  RABT.state.enabledTwitch = !!twEnable.checked;
  RABT.state.enabledKick   = !!kkEnable.checked;
  RABT.state.twChannel = (twChannel.value||'').trim();
  RABT.state.kkChannel = (kkChannel.value||'').trim();

  SHOW_NUMBERS = !!document.getElementById('showDotNumbers')?.checked;
  DOT_START    = Math.max(1, +document.getElementById('dotStart')?.value|0);
  drawBoard();

  RABT.connect();
});

/*********************
 * تشغيل أولي
 *********************/
initBoard(GW,GH);
setTurn('blue'); // أول دور: أول لاعب من الأزرق (إذا موجود)

const gridWEl = document.getElementById('gridW');
const gridHEl = document.getElementById('gridH');
document.getElementById('btnStart').onclick = ()=>{
  scoreRed=scoreBlue=0; sr.textContent='0'; sb.textContent='0';
  initBoard(+gridWEl.value, +gridHEl.value);
  redIdx=0; blueIdx=0;
  gameActive = true;
  setTurn('blue'); // سيعيد ضبط المؤقت
};
</script>
</body>
</html>
